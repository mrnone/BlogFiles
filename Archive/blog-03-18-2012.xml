<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:georss='http://www.georss.org/georss' xmlns:gd='http://schemas.google.com/g/2005' xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-5426686223573941509.archive</id><updated>2012-03-18T23:06:04.565+07:00</updated><category term='C++'/><category term='Cryptography'/><category term='X.509'/><category term='DirectoryServices'/><category term='ADSI'/><category term='Active Directory'/><category term='Data Transfer'/><category term='Win32'/><category term='Tools'/><category term='Multithreading'/><category term='Security'/><category term='Web Service'/><category term='.NET'/><category term='Erlang'/><title type='text'>Заметки с передовой</title><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://mrnone.blogspot.com/feeds/archive'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/archive'/><link rel='http://schemas.google.com/g/2005#post' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/archive'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author><generator version='7.00' uri='http://www.blogger.com'>Blogger</generator><entry><id>tag:blogger.com,1999:blog-5426686223573941509.layout</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#template'/><title type='text'>Шаблон: Заметки с передовой</title><content type='text'>&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!DOCTYPE html&gt;
&lt;html b:version='2' class='v2' expr:dir='data:blog.languageDirection' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b' xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'&gt;
  &lt;head&gt;
    &lt;meta content='IE=EmulateIE7' http-equiv='X-UA-Compatible'/&gt;
    &lt;b:if cond='data:blog.isMobile'&gt;
      &lt;meta content='width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0' name='viewport'/&gt;
    &lt;b:else/&gt;
      &lt;meta content='width=1100' name='viewport'/&gt;
    &lt;/b:if&gt;
    &lt;b:include data='blog' name='all-head-content'/&gt;
    &lt;title&gt;&lt;data:blog.pageTitle/&gt;&lt;/title&gt;
    &lt;b:if cond='data:blog.metaDescription != &amp;quot;&amp;quot;'&gt;
      &lt;meta expr:content='data:blog.metaDescription' name='description'/&gt;
    &lt;/b:if&gt;

    &lt;b:skin&gt;&lt;![CDATA[/*-----------------------------------------------

Blogger Template Style
Name:     Picture Window
Designer: Josh Peterson
URL:      www.noaesthetic.com
----------------------------------------------- */

/* Variable definitions
   ====================
   &lt;Variable name="keycolor" description="Main Color" type="color" default="#1a222a" value="#0d60c8"/&gt;
   &lt;Variable name="body.background" description="Body Background" type="background"
       color="$(body.background.color)" default="#111111 url(http://themes.googleusercontent.com/image?id=1OACCYOE0-eoTRTfsBuX1NMN9nz599ufI1Jh0CggPFA_sK80AGkIr8pLtYRpNUKPmwtEa) repeat-x fixed top center" value="#0d60c8 url(http://themes.googleusercontent.com/image?id=1Q9yUxs-9hVF7e99dl1rYimaYp3wqq8-tRuqrLQAkDPIYi9Vf4uKvRUQLtDz6lesfWOV3) no-repeat fixed top center /* Credit: Kativ (http://www.istockphoto.com/googleimages.php?id=3607937&amp;platform=blogger) */"/&gt;

   &lt;Group description="Page Text" selector="body"&gt;
     &lt;Variable name="body.font" description="Font" type="font"
         default="normal normal 15px Arial, Tahoma, Helvetica, FreeSans, sans-serif" value="normal normal 15px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/&gt;
     &lt;Variable name="body.text.color" description="Text Color" type="color" default="#333333" value="#434343"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Backgrounds" selector=".body-fauxcolumns-outer"&gt;
     &lt;Variable name="body.background.color" description="Outer Background" type="color" default="#296695" value="#dedede"/&gt;
     &lt;Variable name="header.background.color" description="Header Background" type="color" default="transparent" value="#1254a6"/&gt;
     &lt;Variable name="post.background.color" description="Post Background" type="color" default="#ffffff" value="#ffffff"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Links" selector=".main-outer"&gt;
     &lt;Variable name="link.color" description="Link Color" type="color" default="#336699" value="#1254a6"/&gt;
     &lt;Variable name="link.visited.color" description="Visited Color" type="color" default="#6699cc" value="#003e91"/&gt;
     &lt;Variable name="link.hover.color" description="Hover Color" type="color" default="#33aaff" value="#114bd4"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Blog Title" selector=".header h1"&gt;
     &lt;Variable name="header.font" description="Title Font" type="font"
         default="normal normal 36px Arial, Tahoma, Helvetica, FreeSans, sans-serif" value="normal normal 36px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/&gt;
     &lt;Variable name="header.text.color" description="Text Color" type="color" default="#ffffff"  value="#ffffff"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Tabs Text" selector=".tabs-inner .widget li a"&gt;
     &lt;Variable name="tabs.font" description="Font" type="font"
         default="normal normal 15px Arial, Tahoma, Helvetica, FreeSans, sans-serif" value="normal normal 15px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/&gt;
     &lt;Variable name="tabs.text.color" description="Text Color" type="color" default="#ffffff" value="$(link.color)"/&gt;
     &lt;Variable name="tabs.selected.text.color" description="Selected Color" type="color" default="$(link.color)" value="#000000"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Tabs Background" selector=".tabs-outer .PageList"&gt;
     &lt;Variable name="tabs.background.color" description="Background Color" type="color" default="transparent" value="#f5f5f5"/&gt;
     &lt;Variable name="tabs.selected.background.color" description="Selected Color" type="color" default="transparent" value="#ffffff"/&gt;
     &lt;Variable name="tabs.separator.color" description="Separator Color" type="color" default="transparent" value="#cdcdcd"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Post Title" selector="h3.post-title, .comments h4"&gt;
     &lt;Variable name="post.title.font" description="Title Font" type="font"
         default="normal normal 18px Arial, Tahoma, Helvetica, FreeSans, sans-serif" value="normal normal 18px Arial, Tahoma, Helvetica, FreeSans, sans-serif"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Date Header" selector=".date-header"&gt;
     &lt;Variable name="date.header.color" description="Text Color" type="color" default="$(body.text.color)" value="#333333"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Post" selector=".post"&gt;
     &lt;Variable name="post.footer.text.color" description="Footer Text Color" type="color" default="#999999" value="#9b9b9b"/&gt;
     &lt;Variable name="post.border.color" description="Border Color" type="color" default="#dddddd" value="#dedede"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Gadgets" selector="h2"&gt;
     &lt;Variable name="widget.title.font" description="Title Font" type="font"
        default="bold normal 13px Arial, Tahoma, Helvetica, FreeSans, sans-serif" value="normal bold 100% Arial, Tahoma, Helvetica, FreeSans, sans-serif"/&gt;
     &lt;Variable name="widget.title.text.color" description="Title Color" type="color" default="#888888" value="#6b6b6b"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Footer" selector=".footer-outer"&gt;
     &lt;Variable name="footer.text.color" description="Text Color" type="color" default="#cccccc" value="#efefef"/&gt;
     &lt;Variable name="footer.widget.title.text.color" description="Gadget Title Color" type="color" default="#aaaaaa" value="#bcbcbc"/&gt;
   &lt;/Group&gt;

   &lt;Group description="Footer Links" selector=".footer-outer"&gt;
     &lt;Variable name="footer.link.color" description="Link Color" type="color" default="#99ccee" value="#ecdfff"/&gt;
     &lt;Variable name="footer.link.visited.color" description="Visited Color" type="color" default="#77aaee" value="#b09bcd"/&gt;
     &lt;Variable name="footer.link.hover.color" description="Hover Color" type="color" default="#33aaff" value="#ffffff"/&gt;
   &lt;/Group&gt;

   &lt;Variable name="content.margin" description="Content Margin Top" type="length" default="20px" value="30px"/&gt;
   &lt;Variable name="content.padding" description="Content Padding" type="length" default="0" value="15px"/&gt;
   &lt;Variable name="content.background" description="Content Background" type="background"
       default="transparent none repeat scroll top left" value="transparent url(http://www.blogblog.com/1kt/transparent/white80.png) repeat scroll top left"/&gt;
   &lt;Variable name="content.border.radius" description="Content Border Radius" type="length" default="0" value="15px"/&gt;
   &lt;Variable name="content.shadow.spread" description="Content Shadow Spread" type="length" default="0" value="3px"/&gt;

   &lt;Variable name="header.padding" description="Header Padding" type="length" default="0" value="30px"/&gt;
   &lt;Variable name="header.background.gradient" description="Header Gradient" type="url"
       default="none" value="url(http://www.blogblog.com/1kt/transparent/header_gradient_shade.png)"/&gt;
   &lt;Variable name="header.border.radius" description="Header Border Radius" type="length" default="0" value="10px"/&gt;

   &lt;Variable name="main.border.radius.top" description="Main Border Radius" type="length" default="20px" value="0"/&gt;
   &lt;Variable name="footer.border.radius.top" description="Footer Border Radius Top" type="length" default="0" value="10px"/&gt;
   &lt;Variable name="footer.border.radius.bottom" description="Footer Border Radius Bottom" type="length" default="20px" value="10px"/&gt;
   &lt;Variable name="region.shadow.spread" description="Main and Footer Shadow Spread" type="length" default="3px" value="0"/&gt;
   &lt;Variable name="region.shadow.offset" description="Main and Footer Shadow Offset" type="length" default="1px" value="0"/&gt;

   &lt;Variable name="tabs.background.gradient" description="Tab Background Gradient" type="url" default="none" value="url(http://www.blogblog.com/1kt/transparent/tabs_gradient_shade.png)"/&gt;
   &lt;Variable name="tab.selected.background.gradient" description="Selected Tab Background" type="url"
       default="url(http://www.blogblog.com/1kt/transparent/white80.png)" value="url(http://www.blogblog.com/1kt/transparent/tabs_gradient_shade.png)"/&gt;
   &lt;Variable name="tab.background" description="Tab Background" type="background"
       default="transparent url(http://www.blogblog.com/1kt/transparent/black50.png) repeat scroll top left" value="transparent none no-repeat scroll top left"/&gt;

   &lt;Variable name="tab.border.radius" description="Tab Border Radius" type="length" default="10px"  value="0"/&gt;
   &lt;Variable name="tab.first.border.radius" description="First Tab Border Radius" type="length" default="10px"  value="10px"/&gt;
   &lt;Variable name="tabs.border.radius" description="Tabs Border Radius" type="length" default="0"  value="10px"/&gt;

   &lt;Variable name="tabs.spacing" description="Tab Spacing" type="length" default=".25em" value="0"/&gt;
   &lt;Variable name="tabs.margin.bottom" description="Tab Margin Bottom" type="length" default="0" value="0"/&gt;
   &lt;Variable name="tabs.margin.sides" description="Tab Margin Sides" type="length" default="20px" value="0"/&gt;

   &lt;Variable name="main.background" description="Main Background" type="background"
       default="transparent url(http://www.blogblog.com/1kt/transparent/white80.png) repeat scroll top left" value="transparent none repeat scroll top center"/&gt;
   &lt;Variable name="main.padding.sides" description="Main Padding Sides" type="length" default="20px" value="5px"/&gt;

   &lt;Variable name="footer.background" description="Footer Background" type="background"
       default="transparent url(http://www.blogblog.com/1kt/transparent/black50.png) repeat scroll top left" value="transparent url(http://www.blogblog.com/1kt/transparent/black50.png) repeat scroll top left"/&gt;

   &lt;Variable name="post.margin.sides" description="Post Margin Sides" type="length" default="-20px" value="-20px"/&gt;
   &lt;Variable name="post.border.radius" description="Post Border Radius" type="length" default="5px" value="10px"/&gt;
   &lt;Variable name="widget.title.text.transform" description="Widget Title Text Transform" type="string" default="uppercase" value="uppercase"/&gt;

   &lt;Variable name="mobile.background.overlay" description="Mobile Background Overlay" type="string"
       default="transparent none repeat scroll top left" value="transparent none repeat scroll top left"/&gt;

   &lt;Variable name="startSide" description="Side where text starts in blog language" type="automatic" default="left" value="left"/&gt;
   &lt;Variable name="endSide" description="Side where text ends in blog language" type="automatic" default="right" value="right"/&gt;
*/

/* Content
----------------------------------------------- */
body {
  font: $(body.font);
  color: $(body.text.color);
  background: $(body.background);
}

html body .region-inner {
  min-width: 0;
  max-width: 100%;
  width: auto;
}

.content-outer {
  font-size: 90%;
}

a:link {
  text-decoration:none;
  color: $(link.color);
}

a:visited {
  text-decoration:none;
  color: $(link.visited.color);
}

a:hover {
  text-decoration:underline;
  color: $(link.hover.color);
}

.content-outer {
  background: $(content.background);

  -moz-border-radius: $(content.border.radius);
  -webkit-border-radius: $(content.border.radius);
  -goog-ms-border-radius: $(content.border.radius);
  border-radius: $(content.border.radius);

  -moz-box-shadow: 0 0 $(content.shadow.spread) rgba(0, 0, 0, .15);
  -webkit-box-shadow: 0 0 $(content.shadow.spread) rgba(0, 0, 0, .15);
  -goog-ms-box-shadow: 0 0 $(content.shadow.spread) rgba(0, 0, 0, .15);
  box-shadow: 0 0 $(content.shadow.spread) rgba(0, 0, 0, .15);

  margin: $(content.margin) auto;
}

.content-inner {
  padding: $(content.padding);
}

/* Header
----------------------------------------------- */
.header-outer {
  background: $(header.background.color) $(header.background.gradient) repeat-x scroll top left;
  _background-image: none;

  color: $(header.text.color);

  -moz-border-radius: $(header.border.radius);
  -webkit-border-radius: $(header.border.radius);
  -goog-ms-border-radius: $(header.border.radius);
  border-radius: $(header.border.radius);
}

.Header img, .Header #header-inner {
  -moz-border-radius: $(header.border.radius);
  -webkit-border-radius: $(header.border.radius);
  -goog-ms-border-radius: $(header.border.radius);
  border-radius: $(header.border.radius);
}

.header-inner .Header .titlewrapper,
.header-inner .Header .descriptionwrapper {
  padding-left: $(header.padding);
  padding-right: $(header.padding);
}

.Header h1 {
  font: $(header.font);
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
}

.Header h1 a {
  color: $(header.text.color);
}

.Header .description {
  font-size: 130%;
}

/* Tabs
----------------------------------------------- */
.tabs-inner {
  margin: .5em $(tabs.margin.sides) $(tabs.margin.bottom);
  padding: 0;
}

.tabs-inner .section {
  margin: 0;
}

.tabs-inner .widget ul {
  padding: 0;

  background: $(tabs.background.color) $(tabs.background.gradient) repeat scroll bottom;

  -moz-border-radius: $(tabs.border.radius);
  -webkit-border-radius: $(tabs.border.radius);
  -goog-ms-border-radius: $(tabs.border.radius);
  border-radius: $(tabs.border.radius);
}

.tabs-inner .widget li {
  border: none;
}

.tabs-inner .widget li a {
  display: inline-block;

  padding: .5em 1em;
  margin-$endSide: $(tabs.spacing);

  color: $(tabs.text.color);
  font: $(tabs.font);

  -moz-border-radius: $(tab.border.radius) $(tab.border.radius) 0 0;
  -webkit-border-top-left-radius: $(tab.border.radius);
  -webkit-border-top-right-radius: $(tab.border.radius);
  -goog-ms-border-radius: $(tab.border.radius) $(tab.border.radius) 0 0;
  border-radius: $(tab.border.radius) $(tab.border.radius) 0 0;

  background: $(tab.background);

  border-$endSide: 1px solid $(tabs.separator.color);
}

.tabs-inner .widget li:first-child a {
  padding-$startSide: 1.25em;

  -moz-border-radius-top$startSide: $(tab.first.border.radius);
  -moz-border-radius-bottom$startSide: $(tabs.border.radius);
  -webkit-border-top-$startSide-radius: $(tab.first.border.radius);
  -webkit-border-bottom-$startSide-radius: $(tabs.border.radius);
  -goog-ms-border-top-$startSide-radius: $(tab.first.border.radius);
  -goog-ms-border-bottom-$startSide-radius: $(tabs.border.radius);
  border-top-$startSide-radius: $(tab.first.border.radius);
  border-bottom-$startSide-radius: $(tabs.border.radius);
}

.tabs-inner .widget li.selected a,
.tabs-inner .widget li a:hover {
  position: relative;
  z-index: 1;

  background: $(tabs.selected.background.color) $(tab.selected.background.gradient) repeat scroll bottom;
  color: $(tabs.selected.text.color);

  -moz-box-shadow: 0 0 $(region.shadow.spread) rgba(0, 0, 0, .15);
  -webkit-box-shadow: 0 0 $(region.shadow.spread) rgba(0, 0, 0, .15);
  -goog-ms-box-shadow: 0 0 $(region.shadow.spread) rgba(0, 0, 0, .15);
  box-shadow: 0 0 $(region.shadow.spread) rgba(0, 0, 0, .15);
}

/* Headings
----------------------------------------------- */
h2 {
  font: $(widget.title.font);
  text-transform: $(widget.title.text.transform);
  color: $(widget.title.text.color);
  margin: .5em 0;
}

/* Main
----------------------------------------------- */
.main-outer {
  background: $(main.background);

  -moz-border-radius: $(main.border.radius.top) $(main.border.radius.top) 0 0;
  -webkit-border-top-left-radius: $(main.border.radius.top);
  -webkit-border-top-right-radius: $(main.border.radius.top);
  -webkit-border-bottom-left-radius: 0;
  -webkit-border-bottom-right-radius: 0;
  -goog-ms-border-radius: $(main.border.radius.top) $(main.border.radius.top) 0 0;
  border-radius: $(main.border.radius.top) $(main.border.radius.top) 0 0;

  -moz-box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
  -webkit-box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
  -goog-ms-box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
  box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
}

.main-inner {
  padding: 15px $(main.padding.sides) 20px;
}

.main-inner .column-center-inner {
  padding: 0 0;
}

.main-inner .column-left-inner {
  padding-left: 0;
}

.main-inner .column-right-inner {
  padding-right: 0;
}

/* Posts
----------------------------------------------- */
h3.post-title {
  margin: 0;
  font: $(post.title.font);
}

.comments h4 {
  margin: 1em 0 0;
  font: $(post.title.font);
}

.date-header span {
  color: $(date.header.color);
}

.post-outer {
  background-color: $(post.background.color);
  border: solid 1px $(post.border.color);

  -moz-border-radius: $(post.border.radius);
  -webkit-border-radius: $(post.border.radius);
  border-radius: $(post.border.radius);
  -goog-ms-border-radius: $(post.border.radius);

  padding: 15px 20px;
  margin: 0 $(post.margin.sides) 20px;
}

.post-body {
  line-height: 1.4;
  font-size: 110%;
  position: relative;
}

.post-header {
  margin: 0 0 1.5em;

  color: $(post.footer.text.color);
  line-height: 1.6;
}

.post-footer {
  margin: .5em 0 0;

  color: $(post.footer.text.color);
  line-height: 1.6;
}

#blog-pager {
  font-size: 140%
}

#comments .comment-author {
  padding-top: 1.5em;

  border-top: dashed 1px #ccc;
  border-top: dashed 1px rgba(128, 128, 128, .5);

  background-position: 0 1.5em;
}

#comments .comment-author:first-child {
  padding-top: 0;

  border-top: none;
}

.avatar-image-container {
  margin: .2em 0 0;
}

/* Comments
----------------------------------------------- */
.comments .comments-content .icon.blog-author {
  background-repeat: no-repeat;
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAAd0SU1FB9sLFwMeCjjhcOMAAAD+SURBVDjLtZSvTgNBEIe/WRRnm3U8RC1neQdsm1zSBIU9VVF1FkUguQQsD9ITmD7ECZIJSE4OZo9stoVjC/zc7ky+zH9hXwVwDpTAWWLrgS3QAe8AZgaAJI5zYAmc8r0G4AHYHQKVwII8PZrZFsBFkeRCABYiMh9BRUhnSkPTNCtVXYXURi1FpBDgArj8QU1eVXUzfnjv7yP7kwu1mYrkWlU33vs1QNu2qU8pwN0UpKoqokjWwCztrMuBhEhmh8bD5UDqur75asbcX0BGUB9/HAMB+r32hznJgXy2v0sGLBcyAJ1EK3LFcbo1s91JeLwAbwGYu7TP/3ZGfnXYPgAVNngtqatUNgAAAABJRU5ErkJggg==);
}

.comments .comments-content .loadmore a {
  border-top: 1px solid $(link.hover.color);
  border-bottom: 1px solid $(link.hover.color);
}

.comments .continue {
  border-top: 2px solid $(link.hover.color);
}

/* Widgets
----------------------------------------------- */
.widget ul, .widget #ArchiveList ul.flat {
  padding: 0;
  list-style: none;
}

.widget ul li, .widget #ArchiveList ul.flat li {
  border-top: dashed 1px #ccc;
  border-top: dashed 1px rgba(128, 128, 128, .5);
}

.widget ul li:first-child, .widget #ArchiveList ul.flat li:first-child {
  border-top: none;
}

.widget .post-body ul {
  list-style: disc;
}

.widget .post-body ul li {
  border: none;
}

/* Footer
----------------------------------------------- */
.footer-outer {
  color:$(footer.text.color);
  background: $(footer.background);

  -moz-border-radius: $(footer.border.radius.top) $(footer.border.radius.top) $(footer.border.radius.bottom) $(footer.border.radius.bottom);
  -webkit-border-top-left-radius: $(footer.border.radius.top);
  -webkit-border-top-right-radius: $(footer.border.radius.top);
  -webkit-border-bottom-left-radius: $(footer.border.radius.bottom);
  -webkit-border-bottom-right-radius: $(footer.border.radius.bottom);
  -goog-ms-border-radius: $(footer.border.radius.top) $(footer.border.radius.top) $(footer.border.radius.bottom) $(footer.border.radius.bottom);
  border-radius: $(footer.border.radius.top) $(footer.border.radius.top) $(footer.border.radius.bottom) $(footer.border.radius.bottom);

  -moz-box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
  -webkit-box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
  -goog-ms-box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
  box-shadow: 0 $(region.shadow.offset) $(region.shadow.spread) rgba(0, 0, 0, .15);
}

.footer-inner {
  padding: 10px $(main.padding.sides) 20px;
}

.footer-outer a {
  color: $(footer.link.color);
}

.footer-outer a:visited {
  color: $(footer.link.visited.color);
}

.footer-outer a:hover {
  color: $(footer.link.hover.color);
}

.footer-outer .widget h2 {
  color: $(footer.widget.title.text.color);
}

/* Mobile
----------------------------------------------- */
html body.mobile {
  height: auto;
}

html body.mobile {
  min-height: 480px;
  background-size: 100% auto;
}

.mobile .body-fauxcolumn-outer {
  background: $(mobile.background.overlay);
}

html .mobile .mobile-date-outer, html .mobile .blog-pager {
  border-bottom: none;
  background: $(main.background);
  margin-bottom: 10px;
}

.mobile .date-outer {
  background: $(main.background);
}

.mobile .header-outer, .mobile .main-outer,
.mobile .post-outer, .mobile .footer-outer {
  -moz-border-radius: 0;
  -webkit-border-radius: 0;
  -goog-ms-border-radius: 0;
  border-radius: 0;
}

.mobile .content-outer,
.mobile .main-outer,
.mobile .post-outer {
  background: inherit;
  border: none;
}

.mobile .content-outer {
  font-size: 100%;
}

.mobile-link-button {
  background-color: $(link.color);
}

.mobile-link-button a:link, .mobile-link-button a:visited {
  color: $(post.background.color);
}

.mobile-index-contents {
  color: $(body.text.color);
}

.mobile .tabs-inner .PageList .widget-content {
  background: $(tabs.selected.background.color) $(tab.selected.background.gradient) repeat scroll bottom;
  color: $(tabs.selected.text.color);
}

.mobile .tabs-inner .PageList .widget-content .pagelist-arrow {
  border-$startSide: 1px solid $(tabs.separator.color);
}
div.sourcecode {
font-size: small;
background-color: #dddddd;
font-family: "Courier New", Courier, monospace;
padding: 0.5em;
}

span.path {
font-size: small;
background-color: #dddddd;
font-family: "Courier New", Courier, monospace;
font-style: italic;
}]]&gt;&lt;/b:skin&gt;

    &lt;b:template-skin&gt;
      &lt;b:variable default='960px' name='content.width' type='length' value='900px'/&gt;
      &lt;b:variable default='0' name='main.column.left.width' type='length' value='0px'/&gt;
      &lt;b:variable default='310px' name='main.column.right.width' type='length' value='240px'/&gt;

      &lt;![CDATA[
      body {
        min-width: $(content.width);
      }

      .content-outer, .content-fauxcolumn-outer, .region-inner {
        min-width: $(content.width);
        max-width: $(content.width);
        _width: $(content.width);
      }

      .main-inner .columns {
        padding-left: $(main.column.left.width);
        padding-right: $(main.column.right.width);
      }

      .main-inner .fauxcolumn-center-outer {
        left: $(main.column.left.width);
        right: $(main.column.right.width);
        /* IE6 does not respect left and right together */
        _width: expression(this.parentNode.offsetWidth -
            parseInt("$(main.column.left.width)") -
            parseInt("$(main.column.right.width)") + 'px');
      }

      .main-inner .fauxcolumn-left-outer {
        width: $(main.column.left.width);
      }

      .main-inner .fauxcolumn-right-outer {
        width: $(main.column.right.width);
      }

      .main-inner .column-left-outer {
        width: $(main.column.left.width);
        right: 100%;
        margin-left: -$(main.column.left.width);
      }

      .main-inner .column-right-outer {
        width: $(main.column.right.width);
        margin-right: -$(main.column.right.width);
      }

      #layout {
        min-width: 0;
      }

      #layout .content-outer {
        min-width: 0;
        width: 800px;
      }

      #layout .region-inner {
        min-width: 0;
        width: auto;
      }
      ]]&gt;
    &lt;/b:template-skin&gt;
  &lt;/head&gt;

  &lt;body expr:class='&amp;quot;loading&amp;quot; + data:blog.mobileClass'&gt;
  &lt;div class='body-fauxcolumns'&gt;
    &lt;div class='fauxcolumn-outer body-fauxcolumn-outer'&gt;
    &lt;div class='cap-top'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;div class='fauxborder-left'&gt;
    &lt;div class='fauxborder-right'/&gt;
    &lt;div class='fauxcolumn-inner'&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class='cap-bottom'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class='content'&gt;
  &lt;div class='content-fauxcolumns'&gt;
    &lt;div class='fauxcolumn-outer content-fauxcolumn-outer'&gt;
    &lt;div class='cap-top'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;div class='fauxborder-left'&gt;
    &lt;div class='fauxborder-right'/&gt;
    &lt;div class='fauxcolumn-inner'&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class='cap-bottom'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class='content-outer'&gt;
  &lt;div class='content-cap-top cap-top'&gt;
    &lt;div class='cap-left'/&gt;
    &lt;div class='cap-right'/&gt;
  &lt;/div&gt;
  &lt;div class='fauxborder-left content-fauxborder-left'&gt;
  &lt;div class='fauxborder-right content-fauxborder-right'/&gt;
  &lt;div class='content-inner'&gt;

    &lt;header&gt;
    &lt;div class='header-outer'&gt;
    &lt;div class='header-cap-top cap-top'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;div class='fauxborder-left header-fauxborder-left'&gt;
    &lt;div class='fauxborder-right header-fauxborder-right'/&gt;
    &lt;div class='region-inner header-inner'&gt;
      &lt;b:section class='header' id='header' maxwidgets='1' showaddelement='no'&gt;
&lt;b:widget id='Header1' locked='true' title='Заметки с передовой (заголовок)' type='Header'&gt;
&lt;b:includable id='main'&gt;

  &lt;b:if cond='data:useImage'&gt;
    &lt;b:if cond='data:imagePlacement == &amp;quot;BEHIND&amp;quot;'&gt;
      &lt;!--
      Show image as background to text. You can't really calculate the width
      reliably in JS because margins are not taken into account by any of
      clientWidth, offsetWidth or scrollWidth, so we don't force a minimum
      width if the user is using shrink to fit.
      This results in a margin-width's worth of pixels being cropped. If the
      user is not using shrink to fit then we expand the header.
      --&gt;
      &lt;b:if cond='data:mobile'&gt;
          &lt;div id='header-inner'&gt;
            &lt;div class='titlewrapper' style='background: transparent'&gt;
              &lt;h1 class='title' style='background: transparent; border-width: 0px'&gt;
                &lt;b:include name='title'/&gt;
              &lt;/h1&gt;
            &lt;/div&gt;
            &lt;b:include name='description'/&gt;
          &lt;/div&gt;
        &lt;b:else/&gt;
          &lt;div expr:style='&amp;quot;background-image: url(\&amp;quot;&amp;quot; + data:sourceUrl + &amp;quot;\&amp;quot;); &amp;quot;                        + &amp;quot;background-position: &amp;quot;                        + data:backgroundPositionStyleStr + &amp;quot;; &amp;quot;                        + data:widthStyleStr                        + &amp;quot;min-height: &amp;quot; + data:height                        + &amp;quot;_height: &amp;quot; + data:height                        + &amp;quot;background-repeat: no-repeat; &amp;quot;' id='header-inner'&gt;
            &lt;div class='titlewrapper' style='background: transparent'&gt;
              &lt;h1 class='title' style='background: transparent; border-width: 0px'&gt;
                &lt;b:include name='title'/&gt;
              &lt;/h1&gt;
            &lt;/div&gt;
            &lt;b:include name='description'/&gt;
          &lt;/div&gt;
        &lt;/b:if&gt;
    &lt;b:else/&gt;
      &lt;!--Show the image only--&gt;
      &lt;div id='header-inner'&gt;
        &lt;a expr:href='data:blog.homepageUrl' style='display: block'&gt;
          &lt;img expr:alt='data:title' expr:height='data:height' expr:id='data:widget.instanceId + &amp;quot;_headerimg&amp;quot;' expr:src='data:sourceUrl' expr:width='data:width' style='display: block'/&gt;
        &lt;/a&gt;
        &lt;!--Show the description--&gt;
        &lt;b:if cond='data:imagePlacement == &amp;quot;BEFORE_DESCRIPTION&amp;quot;'&gt;
          &lt;b:include name='description'/&gt;
        &lt;/b:if&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;
  &lt;b:else/&gt;
    &lt;!--No header image --&gt;
    &lt;div id='header-inner'&gt;
      &lt;div class='titlewrapper'&gt;
        &lt;h1 class='title'&gt;
          &lt;b:include name='title'/&gt;
        &lt;/h1&gt;
      &lt;/div&gt;
      &lt;b:include name='description'/&gt;
    &lt;/div&gt;
  &lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='title'&gt;
  &lt;b:if cond='data:blog.url == data:blog.homepageUrl'&gt;
    &lt;data:title/&gt;
  &lt;b:else/&gt;
    &lt;a expr:href='data:blog.homepageUrl'&gt;&lt;data:title/&gt;&lt;/a&gt;
  &lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='description'&gt;
  &lt;div class='descriptionwrapper'&gt;
    &lt;p class='description'&gt;&lt;span&gt;&lt;data:description/&gt;&lt;/span&gt;&lt;/p&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;/b:section&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class='header-cap-bottom cap-bottom'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;/header&gt;

    &lt;div class='tabs-outer'&gt;
    &lt;div class='tabs-cap-top cap-top'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;div class='fauxborder-left tabs-fauxborder-left'&gt;
    &lt;div class='fauxborder-right tabs-fauxborder-right'/&gt;
    &lt;div class='region-inner tabs-inner'&gt;
      &lt;b:section class='tabs' id='crosscol' maxwidgets='1' showaddelement='yes'&gt;
&lt;b:widget id='PageList1' locked='false' title='Страницы' type='PageList'&gt;
&lt;b:includable id='main'&gt;
  &lt;b:if cond='data:title'&gt;&lt;h2&gt;&lt;data:title/&gt;&lt;/h2&gt;&lt;/b:if&gt;
  &lt;div class='widget-content'&gt;
    &lt;b:if cond='data:mobile'&gt;
      &lt;select expr:id='data:widget.instanceId + &amp;quot;_select&amp;quot;'&gt;
        &lt;b:loop values='data:links' var='link'&gt;
          &lt;b:if cond='data:link.isCurrentPage'&gt;
            &lt;option expr:value='data:link.href' selected='selected'&gt;&lt;data:link.title/&gt;&lt;/option&gt;
          &lt;b:else/&gt;
            &lt;option expr:value='data:link.href'&gt;&lt;data:link.title/&gt;&lt;/option&gt;
          &lt;/b:if&gt;
        &lt;/b:loop&gt;
      &lt;/select&gt;
      &lt;span class='pagelist-arrow'&gt;&amp;amp;#9660;&lt;/span&gt;

    &lt;b:else/&gt;
      &lt;ul&gt;
        &lt;b:loop values='data:links' var='link'&gt;
          &lt;b:if cond='data:link.isCurrentPage'&gt;
            &lt;li class='selected'&gt;&lt;a expr:href='data:link.href'&gt;&lt;data:link.title/&gt;&lt;/a&gt;&lt;/li&gt;
          &lt;b:else/&gt;
            &lt;li&gt;&lt;a expr:href='data:link.href'&gt;&lt;data:link.title/&gt;&lt;/a&gt;&lt;/li&gt;
          &lt;/b:if&gt;
        &lt;/b:loop&gt;
      &lt;/ul&gt;
    &lt;/b:if&gt;
    &lt;b:include name='quickedit'/&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;/b:section&gt;
      &lt;b:section class='tabs' id='crosscol-overflow' showaddelement='no'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class='tabs-cap-bottom cap-bottom'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class='main-outer'&gt;
    &lt;div class='main-cap-top cap-top'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;

    &lt;div class='fauxborder-left main-fauxborder-left'&gt;
    &lt;div class='fauxborder-right main-fauxborder-right'/&gt;
    &lt;div class='region-inner main-inner'&gt;

      &lt;div class='columns fauxcolumns'&gt;

        &lt;div class='fauxcolumn-outer fauxcolumn-center-outer'&gt;
        &lt;div class='cap-top'&gt;
          &lt;div class='cap-left'/&gt;
          &lt;div class='cap-right'/&gt;
        &lt;/div&gt;
        &lt;div class='fauxborder-left'&gt;
        &lt;div class='fauxborder-right'/&gt;
        &lt;div class='fauxcolumn-inner'&gt;
        &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class='cap-bottom'&gt;
          &lt;div class='cap-left'/&gt;
          &lt;div class='cap-right'/&gt;
        &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class='fauxcolumn-outer fauxcolumn-left-outer'&gt;
        &lt;div class='cap-top'&gt;
          &lt;div class='cap-left'/&gt;
          &lt;div class='cap-right'/&gt;
        &lt;/div&gt;
        &lt;div class='fauxborder-left'&gt;
        &lt;div class='fauxborder-right'/&gt;
        &lt;div class='fauxcolumn-inner'&gt;
        &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class='cap-bottom'&gt;
          &lt;div class='cap-left'/&gt;
          &lt;div class='cap-right'/&gt;
        &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class='fauxcolumn-outer fauxcolumn-right-outer'&gt;
        &lt;div class='cap-top'&gt;
          &lt;div class='cap-left'/&gt;
          &lt;div class='cap-right'/&gt;
        &lt;/div&gt;
        &lt;div class='fauxborder-left'&gt;
        &lt;div class='fauxborder-right'/&gt;
        &lt;div class='fauxcolumn-inner'&gt;
        &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class='cap-bottom'&gt;
          &lt;div class='cap-left'/&gt;
          &lt;div class='cap-right'/&gt;
        &lt;/div&gt;
        &lt;/div&gt;

        &lt;!-- corrects IE6 width calculation --&gt;
        &lt;div class='columns-inner'&gt;

        &lt;div class='column-center-outer'&gt;
        &lt;div class='column-center-inner'&gt;
          &lt;b:section class='main' id='main' showaddelement='no'&gt;
&lt;b:widget id='Blog1' locked='true' title='Сообщения блога' type='Blog'&gt;
&lt;b:includable id='nextprev'&gt;
  &lt;div class='blog-pager' id='blog-pager'&gt;
    &lt;b:if cond='data:newerPageUrl'&gt;
      &lt;span id='blog-pager-newer-link'&gt;
      &lt;a class='blog-pager-newer-link' expr:href='data:newerPageUrl' expr:id='data:widget.instanceId + &amp;quot;_blog-pager-newer-link&amp;quot;' expr:title='data:newerPageTitle'&gt;&lt;data:newerPageTitle/&gt;&lt;/a&gt;
      &lt;/span&gt;
    &lt;/b:if&gt;

    &lt;b:if cond='data:olderPageUrl'&gt;
      &lt;span id='blog-pager-older-link'&gt;
      &lt;a class='blog-pager-older-link' expr:href='data:olderPageUrl' expr:id='data:widget.instanceId + &amp;quot;_blog-pager-older-link&amp;quot;' expr:title='data:olderPageTitle'&gt;&lt;data:olderPageTitle/&gt;&lt;/a&gt;
      &lt;/span&gt;
    &lt;/b:if&gt;

    &lt;a class='home-link' expr:href='data:blog.homepageUrl'&gt;&lt;data:homeMsg/&gt;&lt;/a&gt;

    &lt;b:if cond='data:mobileLinkUrl'&gt;
      &lt;div class='blog-mobile-link'&gt;
        &lt;a expr:href='data:mobileLinkUrl'&gt;&lt;data:mobileLinkMsg/&gt;&lt;/a&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

  &lt;/div&gt;
  &lt;div class='clear'/&gt;
&lt;/b:includable&gt;
&lt;b:includable id='shareButtons' var='post'&gt;
  &lt;b:if cond='data:top.showEmailButton'&gt;&lt;a class='goog-inline-block share-button sb-email' expr:href='data:post.sharePostUrl + &amp;quot;&amp;amp;target=email&amp;quot;' expr:title='data:top.emailThisMsg' target='_blank'&gt;&lt;span class='share-button-link-text'&gt;&lt;data:top.emailThisMsg/&gt;&lt;/span&gt;&lt;/a&gt;&lt;/b:if&gt;&lt;b:if cond='data:top.showBlogThisButton'&gt;&lt;a class='goog-inline-block share-button sb-blog' expr:href='data:post.sharePostUrl + &amp;quot;&amp;amp;target=blog&amp;quot;' expr:onclick='&amp;quot;window.open(this.href, \&amp;quot;_blank\&amp;quot;, \&amp;quot;height=270,width=475\&amp;quot;); return false;&amp;quot;' expr:title='data:top.blogThisMsg' target='_blank'&gt;&lt;span class='share-button-link-text'&gt;&lt;data:top.blogThisMsg/&gt;&lt;/span&gt;&lt;/a&gt;&lt;/b:if&gt;&lt;b:if cond='data:top.showTwitterButton'&gt;&lt;a class='goog-inline-block share-button sb-twitter' expr:href='data:post.sharePostUrl + &amp;quot;&amp;amp;target=twitter&amp;quot;' expr:title='data:top.shareToTwitterMsg' target='_blank'&gt;&lt;span class='share-button-link-text'&gt;&lt;data:top.shareToTwitterMsg/&gt;&lt;/span&gt;&lt;/a&gt;&lt;/b:if&gt;&lt;b:if cond='data:top.showFacebookButton'&gt;&lt;a class='goog-inline-block share-button sb-facebook' expr:href='data:post.sharePostUrl + &amp;quot;&amp;amp;target=facebook&amp;quot;' expr:onclick='&amp;quot;window.open(this.href, \&amp;quot;_blank\&amp;quot;, \&amp;quot;height=430,width=640\&amp;quot;); return false;&amp;quot;' expr:title='data:top.shareToFacebookMsg' target='_blank'&gt;&lt;span class='share-button-link-text'&gt;&lt;data:top.shareToFacebookMsg/&gt;&lt;/span&gt;&lt;/a&gt;&lt;/b:if&gt;&lt;b:if cond='data:top.showOrkutButton'&gt;&lt;a class='goog-inline-block share-button sb-orkut' expr:href='data:post.sharePostUrl + &amp;quot;&amp;amp;target=orkut&amp;quot;' expr:title='data:top.shareToOrkutMsg' target='_blank'&gt;&lt;span class='share-button-link-text'&gt;&lt;data:top.shareToOrkutMsg/&gt;&lt;/span&gt;&lt;/a&gt;&lt;/b:if&gt;&lt;b:if cond='data:top.showDummy'&gt;&lt;div class='goog-inline-block dummy-container'&gt;&lt;data:post.dummyTag/&gt;&lt;/div&gt;&lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='threaded_comment_js' var='post'&gt;
  &lt;script async='async' expr:src='data:post.commentSrc' type='text/javascript'/&gt;

  &lt;script type='text/javascript'&gt;
    (function() {
      var items = &lt;data:post.commentJso/&gt;;
      var msgs = &lt;data:post.commentMsgs/&gt;;
      var config = &lt;data:post.commentConfig/&gt;;

// &lt;![CDATA[
      var cursor = null;
      if (items &amp;&amp; items.length &gt; 0) {
        cursor = parseInt(items[items.length - 1].timestamp) + 1;
      }

      var bodyFromEntry = function(entry) {
        if (entry.gd$extendedProperty) {
          for (var k in entry.gd$extendedProperty) {
            if (entry.gd$extendedProperty[k].name == 'blogger.contentRemoved') {
              return '&lt;span class="deleted-comment"&gt;' + entry.content.$t + '&lt;/span&gt;';
            }
          }
        }
        return entry.content.$t;
      }

      var parse = function(data) {
        cursor = null;
        var comments = [];
        if (data &amp;&amp; data.feed &amp;&amp; data.feed.entry) {
          for (var i = 0, entry; entry = data.feed.entry[i]; i++) {
            var comment = {};
            // comment ID, parsed out of the original id format
            var id = /blog-(\d+).post-(\d+)/.exec(entry.id.$t);
            comment.id = id ? id[2] : null;
            comment.body = bodyFromEntry(entry);
            comment.timestamp = Date.parse(entry.published.$t) + '';
            if (entry.author &amp;&amp; entry.author.constructor === Array) {
              var auth = entry.author[0];
              if (auth) {
                comment.author = {
                  name: (auth.name ? auth.name.$t : undefined),
                  profileUrl: (auth.uri ? auth.uri.$t : undefined),
                  avatarUrl: (auth.gd$image ? auth.gd$image.src : undefined)
                };
              }
            }
            if (entry.link) {
              if (entry.link[2]) {
                comment.link = comment.permalink = entry.link[2].href;
              }
              if (entry.link[3]) {
                var pid = /.*comments\/default\/(\d+)\?.*/.exec(entry.link[3].href);
                if (pid &amp;&amp; pid[1]) {
                  comment.parentId = pid[1];
                }
              }
            }
            comment.deleteclass = 'item-control blog-admin';
            if (entry.gd$extendedProperty) {
              for (var k in entry.gd$extendedProperty) {
                if (entry.gd$extendedProperty[k].name == 'blogger.itemClass') {
                  comment.deleteclass += ' ' + entry.gd$extendedProperty[k].value;
                }
              }
            }
            comments.push(comment);
          }
        }
        return comments;
      };

      var paginator = function(callback) {
        if (hasMore()) {
          var url = config.feed + '?alt=json&amp;v=2&amp;orderby=published&amp;reverse=false&amp;max-results=50';
          if (cursor) {
            url += '&amp;published-min=' + new Date(cursor).toISOString();
          }
          window.bloggercomments = function(data) {
            var parsed = parse(data);
            cursor = parsed.length &lt; 50 ? null
                : parseInt(parsed[parsed.length - 1].timestamp) + 1
            callback(parsed);
            window.bloggercomments = null;
          }
          url += '&amp;callback=bloggercomments';
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = url;
          document.getElementsByTagName('head')[0].appendChild(script);
        }
      };
      var hasMore = function() {
        return !!cursor;
      };
      var getMeta = function(key, comment) {
        if ('iswriter' == key) {
          var matches = !!comment.author
              &amp;&amp; comment.author.name == config.authorName
              &amp;&amp; comment.author.profileUrl == config.authorUrl;
          return matches ? 'true' : '';
        } else if ('deletelink' == key) {
          return config.baseUri + '/delete-comment.g?blogID='
               + config.blogId + '&amp;postID=' + comment.id;
        } else if ('deleteclass' == key) {
          return comment.deleteclass;
        }
        return '';
      };

      var replybox = null;
      var replyUrlParts = null;
      var replyParent = undefined;

      var onReply = function(commentId, domId) {
        if (replybox == null) {
          // lazily cache replybox, and adjust to suit this style:
          replybox = document.getElementById('comment-editor');
          if (replybox != null) {
            replybox.height = '250px';
            replybox.style.display = 'block';
            replyUrlParts = replybox.src.split('#');
          }
        }
        if (replybox &amp;&amp; (commentId !== replyParent)) {
          document.getElementById(domId).insertBefore(replybox, null);
          replybox.src = replyUrlParts[0]
              + (commentId ? '&amp;parentID=' + commentId : '')
              + '#' + replyUrlParts[1];
          replyParent = commentId;
        }
      };

      var hash = (window.location.hash || '#').substring(1);
      var startThread, targetComment;
      if (/^comment-form_/.test(hash)) {
        startThread = hash.substring('comment-form_'.length);
      } else if (/^c[0-9]+$/.test(hash)) {
        targetComment = hash.substring(1);
      }

      // Configure commenting API:
      var configJso = {
        'maxDepth': config.maxThreadDepth
      };
      var provider = {
        'id': config.postId,
        'data': items,
        'loadNext': paginator,
        'hasMore': hasMore,
        'getMeta': getMeta,
        'onReply': onReply,
        'rendered': true,
        'initComment': targetComment,
        'initReplyThread': startThread,
        'config': configJso,
        'messages': msgs
      };

      var render = function() {
        if (window.goog &amp;&amp; window.goog.comments) {
          var holder = document.getElementById('comment-holder');
          window.goog.comments.render(holder, provider);
        }
      };

      // render now, or queue to render when library loads:
      if (window.goog &amp;&amp; window.goog.comments) {
        render();
      } else {
        window.goog = window.goog || {};
        window.goog.comments = window.goog.comments || {};
        window.goog.comments.loadQueue = window.goog.comments.loadQueue || [];
        window.goog.comments.loadQueue.push(render);
      }
    })();
// ]]&gt;
  &lt;/script&gt;
&lt;/b:includable&gt;
&lt;b:includable id='backlinks' var='post'&gt;
  &lt;a name='links'/&gt;&lt;h4&gt;&lt;data:post.backlinksLabel/&gt;&lt;/h4&gt;
  &lt;b:if cond='data:post.numBacklinks != 0'&gt;
    &lt;dl class='comments-block' id='comments-block'&gt;
      &lt;b:loop values='data:post.backlinks' var='backlink'&gt;
        &lt;div class='collapsed-backlink backlink-control'&gt;
          &lt;dt class='comment-title'&gt;
            &lt;span class='backlink-toggle-zippy'&gt;&amp;#160;&lt;/span&gt;
            &lt;a expr:href='data:backlink.url' rel='nofollow'&gt;&lt;data:backlink.title/&gt;&lt;/a&gt;
            &lt;b:include data='backlink' name='backlinkDeleteIcon'/&gt;
          &lt;/dt&gt;
          &lt;dd class='comment-body collapseable'&gt;
            &lt;data:backlink.snippet/&gt;
          &lt;/dd&gt;
          &lt;dd class='comment-footer collapseable'&gt;
            &lt;span class='comment-author'&gt;&lt;data:post.authorLabel/&gt; &lt;data:backlink.author/&gt;&lt;/span&gt;
            &lt;span class='comment-timestamp'&gt;&lt;data:post.timestampLabel/&gt; &lt;data:backlink.timestamp/&gt;&lt;/span&gt;
          &lt;/dd&gt;
        &lt;/div&gt;
      &lt;/b:loop&gt;
    &lt;/dl&gt;
  &lt;/b:if&gt;
  &lt;p class='comment-footer'&gt;
    &lt;a class='comment-link' expr:href='data:post.createLinkUrl' expr:id='data:widget.instanceId + &amp;quot;_backlinks-create-link&amp;quot;' target='_blank'&gt;&lt;data:post.createLinkLabel/&gt;&lt;/a&gt;
  &lt;/p&gt;
&lt;/b:includable&gt;
&lt;b:includable id='mobile-main' var='top'&gt;
    &lt;!-- posts --&gt;
    &lt;div class='blog-posts hfeed'&gt;

      &lt;b:include data='top' name='status-message'/&gt;

      &lt;b:if cond='data:blog.pageType == &amp;quot;index&amp;quot;'&gt;
        &lt;b:loop values='data:posts' var='post'&gt;
          &lt;b:include data='post' name='mobile-index-post'/&gt;
        &lt;/b:loop&gt;
      &lt;b:else/&gt;
        &lt;b:loop values='data:posts' var='post'&gt;
          &lt;b:include data='post' name='mobile-post'/&gt;
        &lt;/b:loop&gt;
      &lt;/b:if&gt;
    &lt;/div&gt;

   &lt;b:include name='mobile-nextprev'/&gt;
&lt;/b:includable&gt;
&lt;b:includable id='post' var='post'&gt;
  &lt;div class='post hentry'&gt;
    &lt;a expr:name='data:post.id'/&gt;
    &lt;b:if cond='data:post.title'&gt;
      &lt;h3 class='post-title entry-title'&gt;
      &lt;b:if cond='data:post.link'&gt;
        &lt;a expr:href='data:post.link'&gt;&lt;data:post.title/&gt;&lt;/a&gt;
      &lt;b:else/&gt;
        &lt;b:if cond='data:post.url'&gt;
          &lt;b:if cond='data:blog.url != data:post.url'&gt;
            &lt;a expr:href='data:post.url'&gt;&lt;data:post.title/&gt;&lt;/a&gt;
          &lt;b:else/&gt;
            &lt;data:post.title/&gt;
          &lt;/b:if&gt;
        &lt;b:else/&gt;
          &lt;data:post.title/&gt;
        &lt;/b:if&gt;
      &lt;/b:if&gt;
      &lt;/h3&gt;
    &lt;/b:if&gt;

    &lt;div class='post-header'&gt;
    &lt;div class='post-header-line-1'&gt;&lt;span class='post-icons'&gt;
        &lt;!-- email post links --&gt;
        &lt;b:if cond='data:post.emailPostUrl'&gt;
          &lt;span class='item-action'&gt;
          &lt;a expr:href='data:post.emailPostUrl' expr:title='data:top.emailPostMsg'&gt;
              &lt;img alt='' class='icon-action' height='13' src='http://img1.blogblog.com/img/icon18_email.gif' width='18'/&gt;
          &lt;/a&gt;
          &lt;/span&gt;
        &lt;/b:if&gt;

        &lt;!-- quickedit pencil --&gt;
        &lt;b:include data='post' name='postQuickEdit'/&gt;
      &lt;/span&gt; &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class='post-body entry-content' expr:id='&amp;quot;post-body-&amp;quot; + data:post.id'&gt;
      &lt;data:post.body/&gt;
      &lt;div style='clear: both;'/&gt; &lt;!-- clear for photos floats --&gt;
    &lt;/div&gt;

    &lt;b:if cond='data:post.hasJumpLink'&gt;
      &lt;div class='jump-link'&gt;
        &lt;a expr:href='data:post.url + &amp;quot;#more&amp;quot;' expr:title='data:post.title'&gt;&lt;data:post.jumpText/&gt;&lt;/a&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;div class='post-footer'&gt;
    &lt;div class='post-footer-line post-footer-line-1'&gt;&lt;span class='post-timestamp'&gt;
        &lt;b:if cond='data:top.showTimestamp'&gt;
          &lt;data:top.timestampLabel/&gt;
        &lt;b:if cond='data:post.url'&gt;
          &lt;a class='timestamp-link' expr:href='data:post.url' rel='bookmark' title='permanent link'&gt;&lt;abbr class='published' expr:title='data:post.timestampISO8601'&gt;&lt;data:post.timestamp/&gt;&lt;/abbr&gt;&lt;/a&gt;
        &lt;/b:if&gt;
        &lt;/b:if&gt;
      &lt;/span&gt; &lt;span class='post-comment-link'&gt;
        &lt;b:if cond='data:blog.pageType != &amp;quot;item&amp;quot;'&gt;
          &lt;b:if cond='data:blog.pageType != &amp;quot;static_page&amp;quot;'&gt;
            &lt;b:if cond='data:post.allowComments'&gt;
              &lt;a class='comment-link' expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'&gt;&lt;b:if cond='data:post.numComments == 1'&gt;1 &lt;data:top.commentLabel/&gt;&lt;b:else/&gt;&lt;data:post.numComments/&gt; &lt;data:top.commentLabelPlural/&gt;&lt;/b:if&gt;&lt;/a&gt;
            &lt;/b:if&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
      &lt;/span&gt; &lt;div class='post-share-buttons goog-inline-block'&gt;
        &lt;b:if cond='data:post.sharePostUrl'&gt;
          &lt;b:include data='post' name='shareButtons'/&gt;
        &lt;/b:if&gt;
      &lt;/div&gt; &lt;/div&gt;

      &lt;div class='post-footer-line post-footer-line-2'&gt;&lt;span class='post-labels'&gt;
        &lt;b:if cond='data:post.labels'&gt;
          &lt;data:postLabelsLabel/&gt;
          &lt;b:loop values='data:post.labels' var='label'&gt;
            &lt;a expr:href='data:label.url' rel='tag'&gt;&lt;data:label.name/&gt;&lt;/a&gt;&lt;b:if cond='data:label.isLast != &amp;quot;true&amp;quot;'&gt;,&lt;/b:if&gt;
          &lt;/b:loop&gt;
        &lt;/b:if&gt;
      &lt;/span&gt; &lt;/div&gt;

      &lt;div class='post-footer-line post-footer-line-3'&gt;&lt;span class='reaction-buttons'&gt;
        &lt;b:if cond='data:top.showReactions'&gt;
          &lt;table border='0' cellpadding='0' cellspacing='0' width='100%'&gt;&lt;tr&gt;
            &lt;td class='reactions-label-cell' nowrap='nowrap' valign='top' width='1%'&gt;
              &lt;span class='reactions-label'&gt;
              &lt;data:top.reactionsLabel/&gt;&lt;/span&gt;&amp;#160;&lt;/td&gt;
            &lt;td&gt;&lt;iframe allowtransparency='true' class='reactions-iframe' expr:src='data:post.reactionsUrl' frameborder='0' name='reactions' scrolling='no'/&gt;&lt;/td&gt;
           &lt;/tr&gt;&lt;/table&gt;
        &lt;/b:if&gt;
      &lt;/span&gt; &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='status-message'&gt;
  &lt;b:if cond='data:navMessage'&gt;
  &lt;div class='status-msg-wrap'&gt;
    &lt;div class='status-msg-body'&gt;
      &lt;data:navMessage/&gt;
    &lt;/div&gt;
    &lt;div class='status-msg-border'&gt;
      &lt;div class='status-msg-bg'&gt;
        &lt;div class='status-msg-hidden'&gt;&lt;data:navMessage/&gt;&lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div style='clear: both;'/&gt;
  &lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='comment-form' var='post'&gt;
  &lt;div class='comment-form'&gt;
    &lt;a name='comment-form'/&gt;
    &lt;b:if cond='data:mobile'&gt;
      &lt;h4 id='comment-post-message'&gt;
        &lt;a expr:id='data:widget.instanceId + &amp;quot;_comment-editor-toggle-link&amp;quot;' href='javascript:void(0)'&gt;&lt;data:postCommentMsg/&gt;&lt;/a&gt;&lt;/h4&gt;
      &lt;p&gt;&lt;data:blogCommentMessage/&gt;&lt;/p&gt;
      &lt;data:blogTeamBlogMessage/&gt;
      &lt;a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/&gt;
      &lt;iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410' id='comment-editor' name='comment-editor' src='' style='display: none' width='100%'/&gt;
    &lt;b:else/&gt;
      &lt;h4 id='comment-post-message'&gt;&lt;data:postCommentMsg/&gt;&lt;/h4&gt;
      &lt;p&gt;&lt;data:blogCommentMessage/&gt;&lt;/p&gt;
      &lt;data:blogTeamBlogMessage/&gt;
      &lt;a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/&gt;
      &lt;iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410' id='comment-editor' name='comment-editor' src='' width='100%'/&gt;
    &lt;/b:if&gt;
    &lt;data:post.friendConnectJs/&gt;
    &lt;data:post.cmtfpIframe/&gt;
    &lt;script type='text/javascript'&gt;
      BLOG_CMT_createIframe(&amp;#39;&lt;data:post.appRpcRelayPath/&gt;&amp;#39;, &amp;#39;&lt;data:post.communityId/&gt;&amp;#39;);
    &lt;/script&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='threaded_comments' var='post'&gt;
  &lt;div class='comments' id='comments'&gt;
    &lt;a name='comments'/&gt;
    &lt;h4&gt;
      &lt;b:if cond='data:post.numComments == 1'&gt;
        1 &lt;data:commentLabel/&gt;:
      &lt;b:else/&gt;
        &lt;data:post.numComments/&gt; &lt;data:commentLabelPlural/&gt;:
      &lt;/b:if&gt;
    &lt;/h4&gt;

    &lt;div class='comments-content'&gt;
      &lt;b:if cond='data:post.embedCommentForm'&gt;
        &lt;b:include data='post' name='threaded_comment_js'/&gt;
      &lt;/b:if&gt;
      &lt;div id='comment-holder'&gt;
         &lt;data:post.commentHtml/&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;p class='comment-footer'&gt;
      &lt;b:if cond='data:post.allowNewComments'&gt;
        &lt;b:include data='post' name='threaded-comment-form'/&gt;
      &lt;b:else/&gt;
        &lt;data:post.noNewCommentsText/&gt;
      &lt;/b:if&gt;
    &lt;/p&gt;

    &lt;b:if cond='data:showCmtPopup'&gt;
      &lt;div id='comment-popup'&gt;
        &lt;iframe allowtransparency='true' frameborder='0' id='comment-actions' name='comment-actions' scrolling='no'&gt;
        &lt;/iframe&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;div id='backlinks-container'&gt;
    &lt;div expr:id='data:widget.instanceId + &amp;quot;_backlinks-container&amp;quot;'&gt;
       &lt;b:if cond='data:post.showBacklinks'&gt;
         &lt;b:include data='post' name='backlinks'/&gt;
       &lt;/b:if&gt;
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='backlinkDeleteIcon' var='backlink'&gt;
  &lt;span expr:class='&amp;quot;item-control &amp;quot; + data:backlink.adminClass'&gt;
    &lt;a expr:href='data:backlink.deleteUrl' expr:title='data:top.deleteBacklinkMsg'&gt;
      &lt;img src='//www.blogger.com/img/icon_delete13.gif'/&gt;
    &lt;/a&gt;
  &lt;/span&gt;
&lt;/b:includable&gt;
&lt;b:includable id='mobile-nextprev'&gt;
  &lt;div class='blog-pager' id='blog-pager'&gt;
    &lt;b:if cond='data:newerPageUrl'&gt;
      &lt;div class='mobile-link-button' id='blog-pager-newer-link'&gt;
      &lt;a class='blog-pager-newer-link' expr:href='data:newerPageUrl' expr:id='data:widget.instanceId + &amp;quot;_blog-pager-newer-link&amp;quot;' expr:title='data:newerPageTitle'&gt;&amp;amp;lsaquo;&lt;/a&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;b:if cond='data:olderPageUrl'&gt;
      &lt;div class='mobile-link-button' id='blog-pager-older-link'&gt;
      &lt;a class='blog-pager-older-link' expr:href='data:olderPageUrl' expr:id='data:widget.instanceId + &amp;quot;_blog-pager-older-link&amp;quot;' expr:title='data:olderPageTitle'&gt;&amp;amp;rsaquo;&lt;/a&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;div class='mobile-link-button' id='blog-pager-home-link'&gt;
    &lt;a class='home-link' expr:href='data:blog.homepageUrl'&gt;&lt;data:homeMsg/&gt;&lt;/a&gt;
    &lt;/div&gt;

    &lt;div class='mobile-desktop-link'&gt;
      &lt;a class='home-link' expr:href='data:desktopLinkUrl'&gt;&lt;data:desktopLinkMsg/&gt;&lt;/a&gt;
    &lt;/div&gt;

  &lt;/div&gt;
  &lt;div class='clear'/&gt;
&lt;/b:includable&gt;
&lt;b:includable id='mobile-post' var='post'&gt;
  &lt;div class='date-outer'&gt;
    &lt;b:if cond='data:post.dateHeader'&gt;
      &lt;h2 class='date-header'&gt;&lt;span&gt;&lt;data:post.dateHeader/&gt;&lt;/span&gt;&lt;/h2&gt;
    &lt;/b:if&gt;
    &lt;div class='date-posts'&gt;
      &lt;div class='post-outer'&gt;

        &lt;div class='post hentry uncustomized-post-template'&gt;
          &lt;a expr:name='data:post.id'/&gt;
          &lt;b:if cond='data:post.title'&gt;
            &lt;h3 class='post-title entry-title'&gt;
              &lt;b:if cond='data:post.link'&gt;
                &lt;a expr:href='data:post.link'&gt;&lt;data:post.title/&gt;&lt;/a&gt;
              &lt;b:else/&gt;
                &lt;b:if cond='data:post.url'&gt;
                  &lt;b:if cond='data:blog.url != data:post.url'&gt;
                    &lt;a expr:href='data:post.url'&gt;&lt;data:post.title/&gt;&lt;/a&gt;
                  &lt;b:else/&gt;
                    &lt;data:post.title/&gt;
                  &lt;/b:if&gt;
                &lt;b:else/&gt;
                  &lt;data:post.title/&gt;
                &lt;/b:if&gt;
              &lt;/b:if&gt;
            &lt;/h3&gt;
          &lt;/b:if&gt;

          &lt;div class='post-header'&gt;
            &lt;div class='post-header-line-1'/&gt;
          &lt;/div&gt;

          &lt;div class='post-body entry-content' expr:id='&amp;quot;post-body-&amp;quot; + data:post.id'&gt;
            &lt;data:post.body/&gt;
            &lt;div style='clear: both;'/&gt; &lt;!-- clear for photos floats --&gt;
          &lt;/div&gt;

          &lt;div class='post-footer'&gt;
            &lt;div class='post-footer-line post-footer-line-1'&gt;
              &lt;span class='post-author vcard'&gt;
                &lt;b:if cond='data:top.showAuthor'&gt;
                  &lt;b:if cond='data:post.authorProfileUrl'&gt;
                    &lt;span class='fn'&gt;
                      &lt;a expr:href='data:post.authorProfileUrl' rel='author' title='author profile'&gt;
                        &lt;data:post.author/&gt;
                      &lt;/a&gt;
                    &lt;/span&gt;
                  &lt;b:else/&gt;
                    &lt;span class='fn'&gt;&lt;data:post.author/&gt;&lt;/span&gt;
                  &lt;/b:if&gt;
                &lt;/b:if&gt;
              &lt;/span&gt;

              &lt;span class='post-timestamp'&gt;
                &lt;b:if cond='data:top.showTimestamp'&gt;
                  &lt;data:top.timestampLabel/&gt;
                  &lt;b:if cond='data:post.url'&gt;
                    &lt;a class='timestamp-link' expr:href='data:post.url' rel='bookmark' title='permanent link'&gt;&lt;abbr class='published' expr:title='data:post.timestampISO8601'&gt;&lt;data:post.timestamp/&gt;&lt;/abbr&gt;&lt;/a&gt;
                  &lt;/b:if&gt;
                &lt;/b:if&gt;
              &lt;/span&gt;

              &lt;span class='post-comment-link'&gt;
                &lt;b:if cond='data:blog.pageType != &amp;quot;item&amp;quot;'&gt;
                  &lt;b:if cond='data:blog.pageType != &amp;quot;static_page&amp;quot;'&gt;
                    &lt;b:if cond='data:post.allowComments'&gt;
                      &lt;a class='comment-link' expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'&gt;&lt;b:if cond='data:post.numComments == 1'&gt;1 &lt;data:top.commentLabel/&gt;&lt;b:else/&gt;&lt;data:post.numComments/&gt; &lt;data:top.commentLabelPlural/&gt;&lt;/b:if&gt;&lt;/a&gt;
                    &lt;/b:if&gt;
                  &lt;/b:if&gt;
                &lt;/b:if&gt;
              &lt;/span&gt;
            &lt;/div&gt;

            &lt;div class='post-footer-line post-footer-line-2'&gt;
              &lt;b:if cond='data:top.showMobileShare'&gt;
                &lt;div class='mobile-link-button goog-inline-block' id='mobile-share-button'&gt;
                  &lt;a href='javascript:void(0);'&gt;&lt;data:shareMsg/&gt;&lt;/a&gt;
                &lt;/div&gt;
              &lt;/b:if&gt;
              &lt;b:if cond='data:top.showDummy'&gt;
                &lt;div class='goog-inline-block dummy-container'&gt;&lt;data:post.dummyTag/&gt;&lt;/div&gt;
              &lt;/b:if&gt;
            &lt;/div&gt;

          &lt;/div&gt;
        &lt;/div&gt;

        &lt;b:if cond='data:blog.pageType == &amp;quot;static_page&amp;quot;'&gt;
          &lt;b:if cond='data:post.showThreadedComments'&gt;
            &lt;b:include data='post' name='threaded_comments'/&gt;
          &lt;b:else/&gt;
            &lt;b:include data='post' name='comments'/&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
        &lt;b:if cond='data:blog.pageType == &amp;quot;item&amp;quot;'&gt;
          &lt;b:if cond='data:post.showThreadedComments'&gt;
            &lt;b:include data='post' name='threaded_comments'/&gt;
          &lt;b:else/&gt;
            &lt;b:include data='post' name='comments'/&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='postQuickEdit' var='post'&gt;
  &lt;b:if cond='data:post.editUrl'&gt;
    &lt;span expr:class='&amp;quot;item-control &amp;quot; + data:post.adminClass'&gt;
      &lt;a expr:href='data:post.editUrl' expr:title='data:top.editPostMsg'&gt;
        &lt;img alt='' class='icon-action' height='18' src='http://img2.blogblog.com/img/icon18_edit_allbkg.gif' width='18'/&gt;
      &lt;/a&gt;
    &lt;/span&gt;
  &lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='main' var='top'&gt;
  &lt;b:if cond='data:mobile == &amp;quot;false&amp;quot;'&gt;

    &lt;!-- posts --&gt;
    &lt;div class='blog-posts hfeed'&gt;

      &lt;b:include data='top' name='status-message'/&gt;

      &lt;data:defaultAdStart/&gt;
      &lt;b:loop values='data:posts' var='post'&gt;
        &lt;b:if cond='data:post.isDateStart'&gt;
          &lt;b:if cond='data:post.isFirstPost == &amp;quot;false&amp;quot;'&gt;
            &amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
        &lt;b:if cond='data:post.isDateStart'&gt;
          &amp;lt;div class=&amp;quot;date-outer&amp;quot;&amp;gt;
        &lt;/b:if&gt;
        &lt;b:if cond='data:post.dateHeader'&gt;
          &lt;h2 class='date-header'&gt;&lt;span&gt;&lt;data:post.dateHeader/&gt;&lt;/span&gt;&lt;/h2&gt;
        &lt;/b:if&gt;
        &lt;b:if cond='data:post.isDateStart'&gt;
          &amp;lt;div class=&amp;quot;date-posts&amp;quot;&amp;gt;
        &lt;/b:if&gt;
        &lt;div class='post-outer'&gt;
        &lt;b:include data='post' name='post'/&gt;
        &lt;b:if cond='data:blog.pageType == &amp;quot;static_page&amp;quot;'&gt;
          &lt;b:if cond='data:post.showThreadedComments'&gt;
            &lt;b:include data='post' name='threaded_comments'/&gt;
          &lt;b:else/&gt;
            &lt;b:include data='post' name='comments'/&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
        &lt;b:if cond='data:blog.pageType == &amp;quot;item&amp;quot;'&gt;
          &lt;b:if cond='data:post.showThreadedComments'&gt;
            &lt;b:include data='post' name='threaded_comments'/&gt;
          &lt;b:else/&gt;
            &lt;b:include data='post' name='comments'/&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
        &lt;/div&gt;
        &lt;b:if cond='data:post.includeAd'&gt;
          &lt;b:if cond='data:post.isFirstPost'&gt;
            &lt;data:defaultAdEnd/&gt;
          &lt;b:else/&gt;
            &lt;data:adEnd/&gt;
          &lt;/b:if&gt;
          &lt;div class='inline-ad'&gt;
            &lt;data:adCode/&gt;
          &lt;/div&gt;
          &lt;data:adStart/&gt;
        &lt;/b:if&gt;
      &lt;/b:loop&gt;
      &lt;b:if cond='data:numPosts != 0'&gt;
        &amp;lt;/div&amp;gt;&amp;lt;/div&amp;gt;
      &lt;/b:if&gt;
      &lt;data:adEnd/&gt;
    &lt;/div&gt;

    &lt;!-- navigation --&gt;
    &lt;b:include name='nextprev'/&gt;

    &lt;!-- feed links --&gt;
    &lt;b:include name='feedLinks'/&gt;

    &lt;b:if cond='data:top.showStars'&gt;
      &lt;script src='//www.google.com/jsapi' type='text/javascript'/&gt;
      &lt;script type='text/javascript'&gt;
        google.load(&amp;quot;annotations&amp;quot;, &amp;quot;1&amp;quot;, {&amp;quot;locale&amp;quot;: &amp;quot;&lt;data:top.languageCode/&gt;&amp;quot;});
        function initialize() {
          google.annotations.setApplicationId(&lt;data:top.blogspotReviews/&gt;);
          google.annotations.createAll();
          google.annotations.fetch();
        }
        google.setOnLoadCallback(initialize);
      &lt;/script&gt;
    &lt;/b:if&gt;

  &lt;b:else/&gt;
    &lt;b:include name='mobile-main'/&gt;
  &lt;/b:if&gt;

  &lt;b:if cond='data:top.showDummy'&gt;
    &lt;data:top.dummyBootstrap/&gt;
  &lt;/b:if&gt;

&lt;/b:includable&gt;
&lt;b:includable id='commentDeleteIcon' var='comment'&gt;
  &lt;span expr:class='&amp;quot;item-control &amp;quot; + data:comment.adminClass'&gt;
    &lt;b:if cond='data:showCmtPopup'&gt;
      &lt;div class='goog-toggle-button'&gt;
        &lt;div class='goog-inline-block comment-action-icon'/&gt;
      &lt;/div&gt;
    &lt;b:else/&gt;
      &lt;a class='comment-delete' expr:href='data:comment.deleteUrl' expr:title='data:top.deleteCommentMsg'&gt;
        &lt;img src='//www.blogger.com/img/icon_delete13.gif'/&gt;
      &lt;/a&gt;
    &lt;/b:if&gt;
  &lt;/span&gt;
&lt;/b:includable&gt;
&lt;b:includable id='feedLinks'&gt;
  &lt;b:if cond='data:blog.pageType != &amp;quot;item&amp;quot;'&gt; &lt;!-- Blog feed links --&gt;
    &lt;b:if cond='data:feedLinks'&gt;
      &lt;div class='blog-feeds'&gt;
        &lt;b:include data='feedLinks' name='feedLinksBody'/&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;b:else/&gt; &lt;!--Post feed links --&gt;
    &lt;div class='post-feeds'&gt;
      &lt;b:loop values='data:posts' var='post'&gt;
        &lt;b:if cond='data:post.allowComments'&gt;
          &lt;b:if cond='data:post.feedLinks'&gt;
            &lt;b:include data='post.feedLinks' name='feedLinksBody'/&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
      &lt;/b:loop&gt;
    &lt;/div&gt;
  &lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='threaded-comment-form' var='post'&gt;
  &lt;div class='comment-form'&gt;
    &lt;a name='comment-form'/&gt;
    &lt;b:if cond='data:mobile'&gt;
      &lt;p&gt;&lt;data:blogCommentMessage/&gt;&lt;/p&gt;
      &lt;data:blogTeamBlogMessage/&gt;
      &lt;a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/&gt;
      &lt;iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410' id='comment-editor' name='comment-editor' src='' style='display: none' width='100%'/&gt;
    &lt;b:else/&gt;
      &lt;p&gt;&lt;data:blogCommentMessage/&gt;&lt;/p&gt;
      &lt;data:blogTeamBlogMessage/&gt;
      &lt;a expr:href='data:post.commentFormIframeSrc' id='comment-editor-src'/&gt;
      &lt;iframe allowtransparency='true' class='blogger-iframe-colorize blogger-comment-from-post' frameborder='0' height='410' id='comment-editor' name='comment-editor' src='' width='100%'/&gt;
    &lt;/b:if&gt;
    &lt;data:post.friendConnectJs/&gt;
    &lt;data:post.cmtfpIframe/&gt;
    &lt;script type='text/javascript'&gt;
      BLOG_CMT_createIframe(&amp;#39;&lt;data:post.appRpcRelayPath/&gt;&amp;#39;, &amp;#39;&lt;data:post.communityId/&gt;&amp;#39;);
    &lt;/script&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='mobile-index-post' var='post'&gt;
  &lt;div class='mobile-date-outer date-outer'&gt;
    &lt;b:if cond='data:post.dateHeader'&gt;
      &lt;div class='date-header'&gt;
        &lt;span&gt;&lt;data:post.dateHeader/&gt;&lt;/span&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;div class='mobile-post-outer'&gt;
      &lt;a expr:href='data:post.url'&gt;
        &lt;h3 class='mobile-index-title entry-title'&gt;
          &lt;data:post.title/&gt;
        &lt;/h3&gt;

        &lt;div class='mobile-index-arrow'&gt;&amp;amp;rsaquo;&lt;/div&gt;

        &lt;div class='mobile-index-contents'&gt;
          &lt;b:if cond='data:post.thumbnailUrl'&gt;
            &lt;div class='mobile-index-thumbnail'&gt;
              &lt;div class='Image'&gt;
                &lt;img expr:src='data:post.thumbnailUrl'/&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/b:if&gt;

          &lt;div class='post-body'&gt;
            &lt;b:if cond='data:post.snippet'&gt;&lt;data:post.snippet/&gt;&lt;/b:if&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;div style='clear: both;'/&gt;
      &lt;/a&gt;

      &lt;div class='mobile-index-comment'&gt;
        &lt;b:if cond='data:blog.pageType != &amp;quot;static_page&amp;quot;'&gt;
          &lt;b:if cond='data:post.allowComments'&gt;
            &lt;b:if cond='data:post.numComments != 0'&gt;
              &lt;a class='comment-link' expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'&gt;&lt;b:if cond='data:post.numComments == 1'&gt;1 &lt;data:top.commentLabel/&gt;&lt;b:else/&gt;&lt;data:post.numComments/&gt; &lt;data:top.commentLabelPlural/&gt;&lt;/b:if&gt;&lt;/a&gt;
            &lt;/b:if&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='feedLinksBody' var='links'&gt;
  &lt;div class='feed-links'&gt;
  &lt;data:feedLinksMsg/&gt;
  &lt;b:loop values='data:links' var='f'&gt;
     &lt;a class='feed-link' expr:href='data:f.url' expr:type='data:f.mimeType' target='_blank'&gt;&lt;data:f.name/&gt; (&lt;data:f.feedType/&gt;)&lt;/a&gt;
  &lt;/b:loop&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='comments' var='post'&gt;
  &lt;div class='comments' id='comments'&gt;
    &lt;a name='comments'/&gt;
    &lt;b:if cond='data:post.allowComments'&gt;
      &lt;h4&gt;
        &lt;b:if cond='data:post.numComments == 1'&gt;
          1 &lt;data:commentLabel/&gt;:
        &lt;b:else/&gt;
          &lt;data:post.numComments/&gt; &lt;data:commentLabelPlural/&gt;:
        &lt;/b:if&gt;
      &lt;/h4&gt;

      &lt;b:if cond='data:post.commentPagingRequired'&gt;
        &lt;span class='paging-control-container'&gt;
          &lt;a expr:class='data:post.oldLinkClass' expr:href='data:post.oldestLinkUrl'&gt;&lt;data:post.oldestLinkText/&gt;&lt;/a&gt;
          &amp;#160;
          &lt;a expr:class='data:post.oldLinkClass' expr:href='data:post.olderLinkUrl'&gt;&lt;data:post.olderLinkText/&gt;&lt;/a&gt;
          &amp;#160;
          &lt;data:post.commentRangeText/&gt;
          &amp;#160;
          &lt;a expr:class='data:post.newLinkClass' expr:href='data:post.newerLinkUrl'&gt;&lt;data:post.newerLinkText/&gt;&lt;/a&gt;
          &amp;#160;
          &lt;a expr:class='data:post.newLinkClass' expr:href='data:post.newestLinkUrl'&gt;&lt;data:post.newestLinkText/&gt;&lt;/a&gt;
        &lt;/span&gt;
      &lt;/b:if&gt;

      &lt;div expr:id='data:widget.instanceId + &amp;quot;_comments-block-wrapper&amp;quot;'&gt;
        &lt;dl expr:class='data:post.avatarIndentClass' id='comments-block'&gt;
          &lt;b:loop values='data:post.comments' var='comment'&gt;
            &lt;dt expr:class='&amp;quot;comment-author &amp;quot; + data:comment.authorClass' expr:id='data:comment.anchorName'&gt;
              &lt;b:if cond='data:comment.favicon'&gt;
                &lt;img expr:src='data:comment.favicon' height='16px' style='margin-bottom:-2px;' width='16px'/&gt;
              &lt;/b:if&gt;
              &lt;a expr:name='data:comment.anchorName'/&gt;
              &lt;b:if cond='data:blog.enabledCommentProfileImages'&gt;
                &lt;data:comment.authorAvatarImage/&gt;
              &lt;/b:if&gt;
              &lt;b:if cond='data:comment.authorUrl'&gt;
                &lt;a expr:href='data:comment.authorUrl' rel='nofollow'&gt;&lt;data:comment.author/&gt;&lt;/a&gt;
              &lt;b:else/&gt;
                &lt;data:comment.author/&gt;
              &lt;/b:if&gt;
              &lt;data:commentPostedByMsg/&gt;
            &lt;/dt&gt;
            &lt;dd class='comment-body' expr:id='data:widget.instanceId + data:comment.cmtBodyIdPostfix'&gt;
              &lt;b:if cond='data:comment.isDeleted'&gt;
                &lt;span class='deleted-comment'&gt;&lt;data:comment.body/&gt;&lt;/span&gt;
              &lt;b:else/&gt;
                &lt;p&gt;
                  &lt;data:comment.body/&gt;
                &lt;/p&gt;
              &lt;/b:if&gt;
            &lt;/dd&gt;
            &lt;dd class='comment-footer'&gt;
              &lt;span class='comment-timestamp'&gt;
                &lt;a expr:href='data:comment.url' title='comment permalink'&gt;
                  &lt;data:comment.timestamp/&gt;
                &lt;/a&gt;
                &lt;b:include data='comment' name='commentDeleteIcon'/&gt;
              &lt;/span&gt;
            &lt;/dd&gt;
          &lt;/b:loop&gt;
        &lt;/dl&gt;
      &lt;/div&gt;

      &lt;b:if cond='data:post.commentPagingRequired'&gt;
        &lt;span class='paging-control-container'&gt;
          &lt;a expr:class='data:post.oldLinkClass' expr:href='data:post.oldestLinkUrl'&gt;
            &lt;data:post.oldestLinkText/&gt;
          &lt;/a&gt;
          &lt;a expr:class='data:post.oldLinkClass' expr:href='data:post.olderLinkUrl'&gt;
            &lt;data:post.olderLinkText/&gt;
          &lt;/a&gt;
          &amp;#160;
          &lt;data:post.commentRangeText/&gt;
          &amp;#160;
          &lt;a expr:class='data:post.newLinkClass' expr:href='data:post.newerLinkUrl'&gt;
            &lt;data:post.newerLinkText/&gt;
          &lt;/a&gt;
          &lt;a expr:class='data:post.newLinkClass' expr:href='data:post.newestLinkUrl'&gt;
            &lt;data:post.newestLinkText/&gt;
          &lt;/a&gt;
        &lt;/span&gt;
      &lt;/b:if&gt;

      &lt;p class='comment-footer'&gt;
        &lt;b:if cond='data:post.embedCommentForm'&gt;
          &lt;b:if cond='data:post.allowNewComments'&gt;
            &lt;b:include data='post' name='comment-form'/&gt;
          &lt;b:else/&gt;
            &lt;data:post.noNewCommentsText/&gt;
          &lt;/b:if&gt;
        &lt;b:else/&gt;
          &lt;b:if cond='data:post.allowComments'&gt;
            &lt;a expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'&gt;&lt;data:postCommentMsg/&gt;&lt;/a&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;

      &lt;/p&gt;
    &lt;/b:if&gt;
    &lt;b:if cond='data:showCmtPopup'&gt;
      &lt;div id='comment-popup'&gt;
        &lt;iframe allowtransparency='true' frameborder='0' id='comment-actions' name='comment-actions' scrolling='no'&gt;
        &lt;/iframe&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;div id='backlinks-container'&gt;
    &lt;div expr:id='data:widget.instanceId + &amp;quot;_backlinks-container&amp;quot;'&gt;
       &lt;b:if cond='data:post.showBacklinks'&gt;
         &lt;b:include data='post' name='backlinks'/&gt;
       &lt;/b:if&gt;
    &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;/b:section&gt;
        &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class='column-left-outer'&gt;
        &lt;div class='column-left-inner'&gt;
          &lt;aside&gt;
          &lt;macro:include id='main-column-left-sections' name='sections'&gt;
            &lt;macro:param default='0' name='num' value='0'/&gt;
            &lt;macro:param default='sidebar-left' name='idPrefix'/&gt;
            &lt;macro:param default='sidebar' name='class'/&gt;
            &lt;macro:param default='true' name='includeBottom'/&gt;
          &lt;/macro:include&gt;
          &lt;/aside&gt;
        &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class='column-right-outer'&gt;
        &lt;div class='column-right-inner'&gt;
          &lt;aside&gt;
          &lt;macro:include id='main-column-right-sections' name='sections'&gt;
            &lt;macro:param default='2' name='num' value='1'/&gt;
            &lt;macro:param default='sidebar-right' name='idPrefix'/&gt;
            &lt;macro:param default='sidebar' name='class'/&gt;
            &lt;macro:param default='true' name='includeBottom'/&gt;
          &lt;/macro:include&gt;
          &lt;/aside&gt;
        &lt;/div&gt;
        &lt;/div&gt;

        &lt;/div&gt;

        &lt;div style='clear: both'/&gt;
      &lt;!-- columns --&gt;
      &lt;/div&gt;

    &lt;!-- main --&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class='main-cap-bottom cap-bottom'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;

    &lt;footer&gt;
    &lt;div class='footer-outer'&gt;
    &lt;div class='footer-cap-top cap-top'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;div class='fauxborder-left footer-fauxborder-left'&gt;
    &lt;div class='fauxborder-right footer-fauxborder-right'/&gt;
    &lt;div class='region-inner footer-inner'&gt;
      &lt;macro:include id='footer-sections' name='sections'&gt;
        &lt;macro:param default='2' name='num' value='3'/&gt;
        &lt;macro:param default='footer' name='idPrefix'/&gt;
        &lt;macro:param default='foot' name='class'/&gt;
        &lt;macro:param default='false' name='includeBottom'/&gt;
      &lt;/macro:include&gt;
      &lt;!-- outside of the include in order to lock Attribution widget --&gt;
      &lt;b:section class='foot' id='footer-3' showaddelement='no'&gt;
&lt;b:widget id='Attribution1' locked='true' title='' type='Attribution'&gt;
&lt;b:includable id='main'&gt;
    &lt;b:if cond='data:feedbackSurveyLink'&gt;
      &lt;div class='mobile-survey-link' style='text-align: center;'&gt;
        &lt;data:feedbackSurveyLink/&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;

    &lt;div class='widget-content' style='text-align: center;'&gt;
      &lt;b:if cond='data:attribution != &amp;quot;&amp;quot;'&gt;
       &lt;data:attribution/&gt;
      &lt;/b:if&gt;
    &lt;/div&gt;

    &lt;b:include name='quickedit'/&gt;
  &lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;/b:section&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class='footer-cap-bottom cap-bottom'&gt;
      &lt;div class='cap-left'/&gt;
      &lt;div class='cap-right'/&gt;
    &lt;/div&gt;
    &lt;/div&gt;
    &lt;/footer&gt;

  &lt;!-- content --&gt;
  &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class='content-cap-bottom cap-bottom'&gt;
    &lt;div class='cap-left'/&gt;
    &lt;div class='cap-right'/&gt;
  &lt;/div&gt;
  &lt;/div&gt;
  &lt;/div&gt;

  &lt;script type='text/javascript'&gt;
    window.setTimeout(function() {
        document.body.className = document.body.className.replace(&amp;#39;loading&amp;#39;, &amp;#39;&amp;#39;);
      }, 10);
  &lt;/script&gt;
  &lt;b:include data='blog' name='google-analytics'/&gt;
&lt;/body&gt;

&lt;macro:includable id='sections' var='col'&gt;
  &lt;macro:if cond='data:col.num == 0'&gt;
  &lt;macro:else/&gt;
    &lt;b:section mexpr:class='data:col.class' mexpr:id='data:col.idPrefix + &amp;quot;-1&amp;quot;' preferred='yes' showaddelement='yes'/&gt;

    &lt;macro:if cond='data:col.num &amp;gt;= 2'&gt;
      &lt;table border='0' cellpadding='0' cellspacing='0' mexpr:class='&amp;quot;section-columns columns-&amp;quot; + data:col.num'&gt;
      &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td class='first columns-cell'&gt;
          &lt;b:section mexpr:class='data:col.class' mexpr:id='data:col.idPrefix + &amp;quot;-2-1&amp;quot;'/&gt;
        &lt;/td&gt;

        &lt;td class='columns-cell'&gt;
          &lt;b:section mexpr:class='data:col.class' mexpr:id='data:col.idPrefix + &amp;quot;-2-2&amp;quot;'/&gt;
        &lt;/td&gt;

        &lt;macro:if cond='data:col.num &amp;gt;= 3'&gt;
          &lt;td class='columns-cell'&gt;
            &lt;b:section mexpr:class='data:col.class' mexpr:id='data:col.idPrefix + &amp;quot;-2-3&amp;quot;'/&gt;
          &lt;/td&gt;
        &lt;/macro:if&gt;

        &lt;macro:if cond='data:col.num &amp;gt;= 4'&gt;
          &lt;td class='columns-cell'&gt;
            &lt;b:section mexpr:class='data:col.class' mexpr:id='data:col.idPrefix + &amp;quot;-2-4&amp;quot;'/&gt;
          &lt;/td&gt;
        &lt;/macro:if&gt;
      &lt;/tr&gt;
      &lt;/tbody&gt;
      &lt;/table&gt;

      &lt;macro:if cond='data:col.includeBottom'&gt;
        &lt;b:section mexpr:class='data:col.class' mexpr:id='data:col.idPrefix + &amp;quot;-3&amp;quot;' showaddelement='no'/&gt;
      &lt;/macro:if&gt;
    &lt;/macro:if&gt;
  &lt;/macro:if&gt;
&lt;/macro:includable&gt;

&lt;b:section-contents id='sidebar-right-1'&gt;
&lt;b:widget id='CustomSearch1' locked='false' title='' type='CustomSearch'&gt;
&lt;b:includable id='main'&gt;
    &lt;!-- only display title if it's non-empty --&gt;
    &lt;b:if cond='data:title != &amp;quot;&amp;quot;'&gt;
      &lt;h2 class='title'&gt;&lt;data:title/&gt;&lt;/h2&gt;
    &lt;/b:if&gt;

    &lt;div class='widget-content'&gt;
      &lt;div expr:id='data:widget.instanceId + &amp;quot;_form&amp;quot;'&gt;
        &lt;span class='cse-status'&gt;&lt;data:loadingMsg/&gt;&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- override gsearch.css --&gt;
    &lt;style type='text/css'&gt;
      #uds-searchControl .gs-result .gs-title,
      #uds-searchControl .gs-result .gs-title *,
      #uds-searchControl .gsc-results .gsc-trailing-more-results,
      #uds-searchControl .gsc-results .gsc-trailing-more-results * {
        color:&lt;data:linkColor/&gt;;
      }

      #uds-searchControl .gs-result .gs-title a:visited,
      #uds-searchControl .gs-result .gs-title a:visited * {
        color:&lt;data:visitedLinkColor/&gt;;
      }

      #uds-searchControl .gs-relativePublishedDate,
      #uds-searchControl .gs-publishedDate {
        color: &lt;data:dateColor/&gt;;
      }

      #uds-searchControl .gs-result a.gs-visibleUrl,
      #uds-searchControl .gs-result .gs-visibleUrl {
        color: &lt;data:urlColor/&gt;;
      }

      #uds-searchControl .gsc-results {
        border-color: &lt;data:borderColor/&gt;;
        background-color: &lt;data:backgroundColor/&gt;;
      }

      #uds-searchControl .gsc-tabhActive {
        border-color: &lt;data:borderColor/&gt;;
        border-top-color: &lt;data:activeBorderColor/&gt;;
        background-color: &lt;data:backgroundColor/&gt;;
        color: &lt;data:textColor/&gt;;
      }

      #uds-searchControl .gsc-tabhInactive {
        border-color: &lt;data:borderColor/&gt;;
        background-color: transparent;
        color: &lt;data:linkColor/&gt;;
      }

      #uds-searchClearResults {
        border-color: &lt;data:borderColor/&gt;;
      }

      #uds-searchClearResults:hover {
        border-color: &lt;data:activeBorderColor/&gt;;
      }

      #uds-searchControl .gsc-cursor-page {
        color: &lt;data:linkColor/&gt;;
      }

      #uds-searchControl .gsc-cursor-current-page {
        color: &lt;data:textColor/&gt;;
      }
    &lt;/style&gt;

    &lt;b:include name='quickedit'/&gt;
  &lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='Profile1' locked='false' title='Mr. None' type='Profile'&gt;
&lt;b:includable id='main'&gt;
    &lt;b:if cond='data:title != &amp;quot;&amp;quot;'&gt;
      &lt;h2&gt;&lt;data:title/&gt;&lt;/h2&gt;
    &lt;/b:if&gt;
    &lt;div class='widget-content'&gt;
    &lt;b:if cond='data:team == &amp;quot;true&amp;quot;'&gt; &lt;!-- team blog profile --&gt;
      &lt;ul&gt;
        &lt;b:loop values='data:authors' var='i'&gt;
          &lt;li&gt;&lt;a expr:href='data:i.userUrl'&gt;&lt;data:i.display-name/&gt;&lt;/a&gt;&lt;/li&gt;
        &lt;/b:loop&gt;
      &lt;/ul&gt;

      &lt;b:else/&gt; &lt;!-- normal blog profile --&gt;

      &lt;b:if cond='data:photo.url != &amp;quot;&amp;quot;'&gt;
        &lt;a expr:href='data:userUrl'&gt;&lt;img class='profile-img' expr:alt='data:photo.alt' expr:height='data:photo.height' expr:src='data:photo.url' expr:width='data:photo.width'/&gt;&lt;/a&gt;
      &lt;/b:if&gt;

      &lt;dl class='profile-datablock'&gt;
        &lt;dt class='profile-data'&gt;
          &lt;a class='profile-name-link' expr:href='data:userUrl' rel='author'&gt;
            &lt;data:displayname/&gt;
          &lt;/a&gt;
        &lt;/dt&gt;

        &lt;b:if cond='data:showlocation == &amp;quot;true&amp;quot;'&gt;
          &lt;dd class='profile-data'&gt;&lt;data:location/&gt;&lt;/dd&gt;
        &lt;/b:if&gt;

        &lt;b:if cond='data:aboutme != &amp;quot;&amp;quot;'&gt;&lt;dd class='profile-textblock'&gt;&lt;data:aboutme/&gt;&lt;/dd&gt;&lt;/b:if&gt;
      &lt;/dl&gt;
      &lt;a class='profile-link' expr:href='data:userUrl' rel='author'&gt;&lt;data:viewProfileMsg/&gt;&lt;/a&gt;
    &lt;/b:if&gt;

     &lt;b:include name='quickedit'/&gt;
    &lt;/div&gt;
  &lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='HTML1' locked='false' title='' type='HTML'&gt;
&lt;b:includable id='main'&gt;
  &lt;!-- only display title if it's non-empty --&gt;
  &lt;b:if cond='data:title != &amp;quot;&amp;quot;'&gt;
    &lt;h2 class='title'&gt;&lt;data:title/&gt;&lt;/h2&gt;
  &lt;/b:if&gt;
  &lt;div class='widget-content'&gt;
    &lt;data:content/&gt;
  &lt;/div&gt;

  &lt;b:include name='quickedit'/&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='Gadget1' locked='false' title='Поток сознания' type='Gadget'&gt;
&lt;b:includable id='main'&gt;  
  &lt;!-- only display title if it's non-empty --&gt;
  &lt;b:if cond='data:renderingUrl != &amp;quot;&amp;quot;'&gt;
    &lt;b:if cond='data:title != &amp;quot;&amp;quot;'&gt;
      &lt;h2 class='title'&gt;&lt;data:title/&gt;&lt;/h2&gt;
    &lt;/b:if&gt;
    &lt;b:if cond='data:gadgetSnippet != &amp;quot;&amp;quot;'&gt;
       &lt;data:gadgetSnippet/&gt;
    &lt;b:else/&gt;
      &lt;div class='widget-content'&gt;
        &lt;b:if cond='data:nonSocialFragment != &amp;quot;&amp;quot;'&gt;
          &lt;data:nonSocialFragment/&gt;
        &lt;/b:if&gt;
      &lt;/div&gt;
    &lt;/b:if&gt;
  &lt;b:else/&gt;
    &lt;data:errorMessage/&gt;
  &lt;/b:if&gt;

  &lt;b:include name='quickedit'/&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='Label1' locked='false' title='Категории' type='Label'&gt;
&lt;b:includable id='main'&gt;
  &lt;b:if cond='data:title'&gt;
    &lt;h2&gt;&lt;data:title/&gt;&lt;/h2&gt;
  &lt;/b:if&gt;
  &lt;div expr:class='&amp;quot;widget-content &amp;quot; + data:display + &amp;quot;-label-widget-content&amp;quot;'&gt;
    &lt;b:if cond='data:display == &amp;quot;list&amp;quot;'&gt;
      &lt;ul&gt;
      &lt;b:loop values='data:labels' var='label'&gt;
        &lt;li&gt;
          &lt;b:if cond='data:blog.url == data:label.url'&gt;
            &lt;span expr:dir='data:blog.languageDirection'&gt;&lt;data:label.name/&gt;&lt;/span&gt;
          &lt;b:else/&gt;
            &lt;a expr:dir='data:blog.languageDirection' expr:href='data:label.url'&gt;&lt;data:label.name/&gt;&lt;/a&gt;
          &lt;/b:if&gt;
          &lt;b:if cond='data:showFreqNumbers'&gt;
            &lt;span dir='ltr'&gt;(&lt;data:label.count/&gt;)&lt;/span&gt;
          &lt;/b:if&gt;
        &lt;/li&gt;
      &lt;/b:loop&gt;
      &lt;/ul&gt;
    &lt;b:else/&gt;
      &lt;b:loop values='data:labels' var='label'&gt;
        &lt;span expr:class='&amp;quot;label-size label-size-&amp;quot; + data:label.cssSize'&gt;
          &lt;b:if cond='data:blog.url == data:label.url'&gt;
            &lt;span expr:dir='data:blog.languageDirection'&gt;&lt;data:label.name/&gt;&lt;/span&gt;
          &lt;b:else/&gt;
            &lt;a expr:dir='data:blog.languageDirection' expr:href='data:label.url'&gt;&lt;data:label.name/&gt;&lt;/a&gt;
          &lt;/b:if&gt;
          &lt;b:if cond='data:showFreqNumbers'&gt;
            &lt;span class='label-count' dir='ltr'&gt;(&lt;data:label.count/&gt;)&lt;/span&gt;
          &lt;/b:if&gt;
        &lt;/span&gt;
      &lt;/b:loop&gt;
    &lt;/b:if&gt;
    &lt;b:include name='quickedit'/&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='PopularPosts1' locked='false' title='Избранное' type='PopularPosts'&gt;
&lt;b:includable id='main'&gt;
  &lt;b:if cond='data:title'&gt;&lt;h2&gt;&lt;data:title/&gt;&lt;/h2&gt;&lt;/b:if&gt;
  &lt;div class='widget-content popular-posts'&gt;
    &lt;ul&gt;
      &lt;b:loop values='data:posts' var='post'&gt;
      &lt;li&gt;
        &lt;b:if cond='data:showThumbnails == &amp;quot;false&amp;quot;'&gt;
          &lt;b:if cond='data:showSnippets == &amp;quot;false&amp;quot;'&gt;
            &lt;!-- (1) No snippet/thumbnail --&gt;
            &lt;a expr:href='data:post.href'&gt;&lt;data:post.title/&gt;&lt;/a&gt;
          &lt;b:else/&gt;
            &lt;!-- (2) Show only snippets --&gt;
            &lt;div class='item-title'&gt;&lt;a expr:href='data:post.href'&gt;&lt;data:post.title/&gt;&lt;/a&gt;&lt;/div&gt;
            &lt;div class='item-snippet'&gt;&lt;data:post.snippet/&gt;&lt;/div&gt;
          &lt;/b:if&gt;
        &lt;b:else/&gt;
          &lt;b:if cond='data:showSnippets == &amp;quot;false&amp;quot;'&gt;
            &lt;!-- (3) Show only thumbnails --&gt;
            &lt;div class='item-thumbnail-only'&gt;
              &lt;b:if cond='data:post.thumbnail'&gt;
                &lt;div class='item-thumbnail'&gt;
                  &lt;a expr:href='data:post.href' target='_blank'&gt;
                    &lt;img alt='' border='0' expr:height='data:thumbnailSize' expr:src='data:post.thumbnail' expr:width='data:thumbnailSize'/&gt;
                  &lt;/a&gt;
                &lt;/div&gt;
              &lt;/b:if&gt;
              &lt;div class='item-title'&gt;&lt;a expr:href='data:post.href'&gt;&lt;data:post.title/&gt;&lt;/a&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div style='clear: both;'/&gt;
          &lt;b:else/&gt;
            &lt;!-- (4) Show snippets and thumbnails --&gt;
            &lt;div class='item-content'&gt;
              &lt;b:if cond='data:post.thumbnail'&gt;
                &lt;div class='item-thumbnail'&gt;
                  &lt;a expr:href='data:post.href' target='_blank'&gt;
                    &lt;img alt='' border='0' expr:height='data:thumbnailSize' expr:src='data:post.thumbnail' expr:width='data:thumbnailSize'/&gt;
                  &lt;/a&gt;
                &lt;/div&gt;
              &lt;/b:if&gt;
              &lt;div class='item-title'&gt;&lt;a expr:href='data:post.href'&gt;&lt;data:post.title/&gt;&lt;/a&gt;&lt;/div&gt;
              &lt;div class='item-snippet'&gt;&lt;data:post.snippet/&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div style='clear: both;'/&gt;
          &lt;/b:if&gt;
        &lt;/b:if&gt;
      &lt;/li&gt;
      &lt;/b:loop&gt;
    &lt;/ul&gt;
    &lt;b:include name='quickedit'/&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='BlogArchive1' locked='false' title='Архив' type='BlogArchive'&gt;
&lt;b:includable id='main'&gt;
  &lt;b:if cond='data:title'&gt;
    &lt;h2&gt;&lt;data:title/&gt;&lt;/h2&gt;
  &lt;/b:if&gt;
  &lt;div class='widget-content'&gt;
  &lt;div id='ArchiveList'&gt;
  &lt;div expr:id='data:widget.instanceId + &amp;quot;_ArchiveList&amp;quot;'&gt;
    &lt;b:if cond='data:style == &amp;quot;HIERARCHY&amp;quot;'&gt;
     &lt;b:include data='data' name='interval'/&gt;
    &lt;/b:if&gt;
    &lt;b:if cond='data:style == &amp;quot;FLAT&amp;quot;'&gt;
      &lt;b:include data='data' name='flat'/&gt;
    &lt;/b:if&gt;
    &lt;b:if cond='data:style == &amp;quot;MENU&amp;quot;'&gt;
      &lt;b:include data='data' name='menu'/&gt;
    &lt;/b:if&gt;
  &lt;/div&gt;
  &lt;/div&gt;
  &lt;b:include name='quickedit'/&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;b:includable id='flat' var='data'&gt;
  &lt;ul class='flat'&gt;
    &lt;b:loop values='data:data' var='i'&gt;
      &lt;li class='archivedate'&gt;
        &lt;a expr:href='data:i.url'&gt;&lt;data:i.name/&gt;&lt;/a&gt; (&lt;data:i.post-count/&gt;)
      &lt;/li&gt;
    &lt;/b:loop&gt;
  &lt;/ul&gt;
&lt;/b:includable&gt;
&lt;b:includable id='menu' var='data'&gt;
  &lt;select expr:id='data:widget.instanceId + &amp;quot;_ArchiveMenu&amp;quot;'&gt;
    &lt;option value=''&gt;&lt;data:title/&gt;&lt;/option&gt;
    &lt;b:loop values='data:data' var='i'&gt;
      &lt;option expr:value='data:i.url'&gt;&lt;data:i.name/&gt; (&lt;data:i.post-count/&gt;)&lt;/option&gt;
    &lt;/b:loop&gt;
  &lt;/select&gt;
&lt;/b:includable&gt;
&lt;b:includable id='interval' var='intervalData'&gt;
  &lt;b:loop values='data:intervalData' var='i'&gt;
      &lt;ul class='hierarchy'&gt;
        &lt;li expr:class='&amp;quot;archivedate &amp;quot; + data:i.expclass'&gt;
          &lt;b:include data='i' name='toggle'/&gt;
          &lt;a class='post-count-link' expr:href='data:i.url'&gt;&lt;data:i.name/&gt;&lt;/a&gt;
            &lt;span class='post-count' dir='ltr'&gt;(&lt;data:i.post-count/&gt;)&lt;/span&gt;
          &lt;b:if cond='data:i.data'&gt;
            &lt;b:include data='i.data' name='interval'/&gt;
          &lt;/b:if&gt;
          &lt;b:if cond='data:i.posts'&gt;
            &lt;b:include data='i.posts' name='posts'/&gt;
          &lt;/b:if&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
  &lt;/b:loop&gt;
&lt;/b:includable&gt;
&lt;b:includable id='toggle' var='interval'&gt;
  &lt;b:if cond='data:interval.toggleId'&gt;
  &lt;b:if cond='data:interval.expclass == &amp;quot;expanded&amp;quot;'&gt;
    &lt;a class='toggle' href='javascript:void(0)'&gt;
      &lt;span class='zippy toggle-open'&gt;&amp;#9660;&amp;#160;&lt;/span&gt;
    &lt;/a&gt;
  &lt;b:else/&gt;
    &lt;a class='toggle' href='javascript:void(0)'&gt;
      &lt;span class='zippy'&gt;
        &lt;b:if cond='data:blog.languageDirection == &amp;quot;rtl&amp;quot;'&gt;
          &amp;#9668;&amp;#160;
        &lt;b:else/&gt;
          &amp;#9658;&amp;#160;
        &lt;/b:if&gt;
      &lt;/span&gt;
    &lt;/a&gt;
  &lt;/b:if&gt;
 &lt;/b:if&gt;
&lt;/b:includable&gt;
&lt;b:includable id='posts' var='posts'&gt;
  &lt;ul class='posts'&gt;
    &lt;b:loop values='data:posts' var='i'&gt;
      &lt;li&gt;&lt;a expr:href='data:i.url'&gt;&lt;data:i.title/&gt;&lt;/a&gt;&lt;/li&gt;
    &lt;/b:loop&gt;
  &lt;/ul&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='Followers1' locked='false' title='Читатели' type='Followers'&gt;
&lt;b:includable id='main'&gt;
  &lt;b:if cond='data:title != &amp;quot;&amp;quot;'&gt;
    &lt;b:if cond='data:codeSnippet != &amp;quot;&amp;quot;'&gt;
      &lt;h2 class='title'&gt;&lt;data:title/&gt;&lt;/h2&gt;
    &lt;b:else/&gt;
      &lt;b:if cond='data:totalFollowerCount != &amp;quot;&amp;quot;'&gt;
        &lt;h2 class='title'&gt;&lt;data:title/&gt; (&lt;data:totalFollowerCount/&gt;)&lt;/h2&gt;
      &lt;/b:if&gt;
    &lt;/b:if&gt;  
  &lt;/b:if&gt;
  &lt;div class='widget-content'&gt;
    &lt;div expr:id='data:widget.instanceId + &amp;quot;-wrapper&amp;quot;'&gt;
      &lt;b:if cond='data:codeSnippet != &amp;quot;&amp;quot;'&gt;
        &lt;div style='margin-right:2px;'&gt;
          &lt;data:codeSnippet/&gt;
        &lt;/div&gt;
      &lt;b:else/&gt;
        &lt;b:if cond='data:totalFollowerCount == &amp;quot;&amp;quot;'&gt;
          &lt;span class='item-control following-not-admin'&gt;
            &lt;b&gt;&lt;data:failureSnippet/&gt;&lt;/b&gt;
          &lt;/span&gt;
          &lt;span class='item-control blog-admin'&gt;
            &lt;b&gt;&lt;data:adminFailureSnippet/&gt;&lt;/b&gt;
          &lt;/span&gt;
        &lt;b:else/&gt;
          &lt;b:if cond='data:followingLinkPresent'&gt;
            &lt;div class='follow-this profile-link item-control following-follow-this'&gt;
              &lt;a expr:href='&amp;quot;javascript:_FollowersView._openPopup(\&amp;quot;&amp;quot; + data:followUri + &amp;quot;\&amp;quot;);&amp;quot;'&gt;
                &lt;data:followThisMessage/&gt;
              &lt;/a&gt;
            &lt;/div&gt;
            &lt;div class='follow-this profile-link item-control following-stop-following-this'&gt;
              &lt;a expr:href='&amp;quot;javascript:_FollowersView._openPopup(\&amp;quot;&amp;quot; + data:followUri + &amp;quot;\&amp;quot;);&amp;quot;'&gt;
                &lt;data:stopFollowingMessage/&gt;
              &lt;/a&gt;
            &lt;/div&gt;
          &lt;/b:if&gt;
  
          &lt;div class='followers-grid'&gt;
            &lt;b:if cond='data:totalFollowerCount == 0'&gt;
              &lt;div class='profile-link item-control following-follow-this'&gt;
                &lt;data:emptyFollowersMessage/&gt;
              &lt;/div&gt;
            &lt;/b:if&gt;
            &lt;!--
            Relies on the js written out in navbar.gxp
            --&gt;
            &lt;b:loop values='data:followers' var='follower'&gt;
              &lt;div class='follower'&gt;
                &lt;a expr:href='data:follower.profileUrl' expr:title='data:follower.displayName' rel='nofollow'&gt;
                &lt;img class='follower-img' expr:alt='data:follower.displayName' expr:height='data:follower.imageHeight' expr:onerror='&amp;quot;this.onerror=null;this.src=\&amp;quot;&amp;quot; + data:anonFollowerImageUrl + &amp;quot;\&amp;quot;;&amp;quot;' expr:onload='&amp;quot;setAttributeOnload(this, \&amp;quot;src\&amp;quot;, \&amp;quot;&amp;quot; + data:follower.imageUrl + &amp;quot;\&amp;quot;)&amp;quot;' expr:width='data:follower.imageWidth' src='http://img1.blogblog.com/img/blank.gif'/&gt;
                &lt;/a&gt;
              &lt;/div&gt;
            &lt;/b:loop&gt;
            &lt;div class='clear'/&gt;
          &lt;/div&gt;
  
          &lt;div class='followers-canvas profile-link'&gt;
            &lt;data:followersFooterMessage/&gt;
            &lt;span class='item-control following-not-admin'&gt;
              &lt;a expr:href='data:followersUri'&gt;
                &lt;data:viewAllMessage/&gt;
              &lt;/a&gt;
            &lt;/span&gt;
            &lt;span class='item-control blog-admin'&gt;
              &lt;a expr:href='data:manageFollowersUri'&gt;
                &lt;data:manageFollowersMessage/&gt;
              &lt;/a&gt;
            &lt;/span&gt;
          &lt;/div&gt;
          &lt;/b:if&gt;
      &lt;/b:if&gt;
    &lt;/div&gt;
    &lt;b:include name='quickedit'/&gt;
  &lt;/div&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;b:widget id='FollowByEmail1' locked='false' title='Рассылка на e-mail' type='FollowByEmail'&gt;
&lt;b:includable id='main'&gt;
  &lt;b:if cond='data:title != &amp;quot;&amp;quot;'&gt;&lt;h2 class='title'&gt;&lt;data:title/&gt;&lt;/h2&gt;&lt;/b:if&gt;
  &lt;div class='widget-content'&gt;
    &lt;div class='follow-by-email-inner'&gt;
      &lt;form action='http://feedburner.google.com/fb/a/mailverify' expr:onsubmit='&amp;quot;window.open(\&amp;quot;http://feedburner.google.com/fb/a/mailverify?uri=&amp;quot; + data:feedPath + &amp;quot;\&amp;quot;, \&amp;quot;popupwindow\&amp;quot;, \&amp;quot;scrollbars=yes,width=550,height=520\&amp;quot;); return true&amp;quot;' method='post' target='popupwindow'&gt;
        &lt;table width='100%'&gt;
          &lt;tr&gt;
            &lt;td&gt;
              &lt;input class='follow-by-email-address' name='email' placeholder='Email address...' type='text'/&gt;
            &lt;/td&gt;
            &lt;td width='64px'&gt;
              &lt;input class='follow-by-email-submit' type='submit' value='Submit'/&gt;
            &lt;/td&gt;
          &lt;/tr&gt;
        &lt;/table&gt;
        &lt;input expr:value='data:feedPath' name='uri' type='hidden'/&gt;
        &lt;input name='loc' type='hidden' value='en_US'/&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;span class='item-control blog-admin'&gt;
    &lt;b:include name='quickedit'/&gt;
  &lt;/span&gt;
&lt;/b:includable&gt;
&lt;/b:widget&gt;
&lt;/b:section-contents&gt;&lt;b:section-contents id='footer-1'/&gt;&lt;b:section-contents id='footer-2-1'/&gt;&lt;b:section-contents id='footer-2-2'/&gt;&lt;b:section-contents id='footer-2-3'/&gt;&lt;/html&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/template/default'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/template/default'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_PUBLISHING_MODE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Тип публикации, использованный для данного блога.</title><content type='text'>PUBLISH_MODE_BLOGSPOT</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_PUBLISHING_MODE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_PUBLISHING_MODE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_ADMIN_PERMISSION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Список сообщений администраторов по данному блогу.</title><content type='text'>akorotaeff@gmail.com</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ADMIN_PERMISSION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ADMIN_PERMISSION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_ADULT_CONTENT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, содержит ли этот блог содержание только для взрослых</title><content type='text'>false</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ADULT_CONTENT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ADULT_CONTENT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_ALTERNATE_JSRENDER_ALLOWED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Разрешена ли альтернативная обработка JavaScript</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ALTERNATE_JSRENDER_ALLOWED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ALTERNATE_JSRENDER_ALLOWED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_ANALYTICS_ACCOUNT_NUMBER</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Номер аккаунта Google Analytics для блога</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ANALYTICS_ACCOUNT_NUMBER'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ANALYTICS_ACCOUNT_NUMBER'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_ARCHIVE_DATE_FORMAT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Номер формата даты в индексе архива</title><content type='text'>9</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ARCHIVE_DATE_FORMAT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ARCHIVE_DATE_FORMAT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_ARCHIVE_FREQUENCY</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Частота архивирования блога</title><content type='text'>MONTHLY</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ARCHIVE_FREQUENCY'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_ARCHIVE_FREQUENCY'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_AUTHOR_PERMISSION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Список адресов электронной почты авторов, у которых есть разрешение на публикацию.</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_AUTHOR_PERMISSION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_AUTHOR_PERMISSION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_BACKLINKS_ALLOWED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Отображение в блоге обратных ссылок на комментарии</title><content type='text'>false</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_BACKLINKS_ALLOWED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_BACKLINKS_ALLOWED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_BY_POST_ARCHIVING</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Предоставление страницы архива для каждого сообщения</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_BY_POST_ARCHIVING'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_BY_POST_ARCHIVING'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_ACCESS</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Кто может оставлять комментарии</title><content type='text'>REGISTERED</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_ACCESS'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_ACCESS'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_CAPTCHA</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Обязательная проверка Captcha для авторов комментариев</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_CAPTCHA'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_CAPTCHA'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_EMAIL</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Список адресов электронной почты, на которые будут отправляться уведомления о новых комментариях</title><content type='text'>akorotaeff@gmail.com</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_EMAIL'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_EMAIL'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_FEED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Тип канала, предоставляемого для комментариев блога</title><content type='text'>NONE</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_FEED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_FEED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_FORM_LOCATION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Расположение формы комментария в блоге</title><content type='text'>EMBEDDED_IFRAME</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_FORM_LOCATION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_FORM_LOCATION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_MESSAGE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Сообщение комментария в блоге</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MESSAGE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MESSAGE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_MODERATION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Включение модерации комментариев</title><content type='text'>DISABLED</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MODERATION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MODERATION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_MODERATION_DELAY</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Количество дней, по истечении которых новые комментарии подвергаются модерации</title><content type='text'>14</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MODERATION_DELAY'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MODERATION_DELAY'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_MODERATION_EMAIL</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Адрес электронной почты для отправки уведомлений о новых комментариях, нуждающихся в проверке</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MODERATION_EMAIL'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_MODERATION_EMAIL'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENT_PROFILE_IMAGES</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Отображение картинок профиля в комментариях</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_PROFILE_IMAGES'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENT_PROFILE_IMAGES'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENTS_ALLOWED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, показывать ли комментарии</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENTS_ALLOWED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENTS_ALLOWED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_COMMENTS_TIME_STAMP_FORMAT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Номер формата времени публикации комментария</title><content type='text'>29</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENTS_TIME_STAMP_FORMAT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_COMMENTS_TIME_STAMP_FORMAT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_CONVERT_LINE_BREAKS</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, нужно ли преобразовывать разрывы строк в &lt;br /&gt; теги в редакторе сообщений</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CONVERT_LINE_BREAKS'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CONVERT_LINE_BREAKS'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_CUSTOM_PAGE_NOT_FOUND</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Содержание, отображаемое в тех случаях, когда запись или страница не найдены.</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CUSTOM_PAGE_NOT_FOUND'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CUSTOM_PAGE_NOT_FOUND'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_CUSTOM_ROBOTS_TXT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Файл robots.txt предоставляется поисковым системам.</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CUSTOM_ROBOTS_TXT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CUSTOM_ROBOTS_TXT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_CUSTOM_ROBOTS_TXT_ENABLED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Предоставляет ли этот блог поисковым системам файл robots.txt?</title><content type='text'>false</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CUSTOM_ROBOTS_TXT_ENABLED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_CUSTOM_ROBOTS_TXT_ENABLED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_DATE_FORMAT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Номер формата заголовка даты</title><content type='text'>26</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DATE_FORMAT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DATE_FORMAT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_DEFAULT_BACKLINKS_MODE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Режим обратных ссылок для сообщений по умолчанию</title><content type='text'>DEFAULT_HAVE_BACKLINKS</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DEFAULT_BACKLINKS_MODE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DEFAULT_BACKLINKS_MODE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_DEFAULT_COMMENTS_MODE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Режим комментариев по умолчанию для сообщений</title><content type='text'>DEFAULT_HAVE_COMMENTS</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DEFAULT_COMMENTS_MODE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DEFAULT_COMMENTS_MODE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_DESCRIPTION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Описание блога</title><content type='text'>Разработка ПО на переднем крае ИТ отрасли: проблемы, решения, технологии</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DESCRIPTION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_DESCRIPTION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_EMAIL_POST_LINKS</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, показывать ли пользователям ссылку для отправки сообщений по электронной почте</title><content type='text'>false</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_EMAIL_POST_LINKS'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_EMAIL_POST_LINKS'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_FEED_REDIRECT_URL</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>URL для перенаправления запросов на канал сообщений</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_FEED_REDIRECT_URL'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_FEED_REDIRECT_URL'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_FLOAT_ALIGNMENT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет включение плавающего выравнивания в блоге</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_FLOAT_ALIGNMENT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_FLOAT_ALIGNMENT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_LOCALE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Язык для данного блога</title><content type='text'>ru</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_LOCALE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_LOCALE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_MAX_NUM</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Максимальное количество единиц для показа на главной странице"</title><content type='text'>7</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_MAX_NUM'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_MAX_NUM'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_MAX_UNIT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Блок для отображения на главной странице</title><content type='text'>POSTS</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_MAX_UNIT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_MAX_UNIT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_META_DESCRIPTION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Метаописание блога используется в поисковых системах.</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_META_DESCRIPTION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_META_DESCRIPTION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_META_DESCRIPTION_ENABLED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>В этом блоге используется метаописание.</title><content type='text'>false</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_META_DESCRIPTION_ENABLED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_META_DESCRIPTION_ENABLED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_NAME</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Название блога</title><content type='text'>Заметки с передовой</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_NAME'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_NAME'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_PER_POST_FEED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Тип канала, предоставляемого для комментариев к отдельным сообщениям</title><content type='text'>NONE</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_PER_POST_FEED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_PER_POST_FEED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_POST_FEED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Тип канала, предоставляемого для сообщений блога</title><content type='text'>FULL</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_POST_FEED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_POST_FEED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_POST_FEED_FOOTER</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Нижний колонтитул, добавляемый в конце каждой записи канала сообщений</title><content type='text'>Перепечатка материалов допустима с указанием ссылки на первоисточник.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_POST_FEED_FOOTER'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_POST_FEED_FOOTER'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_POST_TEMPLATE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Шаблон для сообщений блога</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_POST_TEMPLATE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_POST_TEMPLATE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_PROMOTED</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, возможно ли рекламирование данного блога в Blogger</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_PROMOTED'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_PROMOTED'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_QUICK_EDITING</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, включено ли быстрое редактирование</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_QUICK_EDITING'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_QUICK_EDITING'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_READ_ACCESS_MODE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Тип доступа для читателей блога.</title><content type='text'>PUBLIC</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_READ_ACCESS_MODE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_READ_ACCESS_MODE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_READER_PERMISSION</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Список адресов электронной почты пользователей, имеющих право на чтение этого блога.</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_READER_PERMISSION'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_READER_PERMISSION'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_SEARCHABLE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет индексирование данного блога поисковыми машинами</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SEARCHABLE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SEARCHABLE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_SEND_EMAIL</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Разделенный запятыми список адресов электронной почты, на которые будут отправляться новые сообщения блогов</title><content type='text'></content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SEND_EMAIL'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SEND_EMAIL'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_SHOW_TITLE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, показывать ли поле заголовка</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SHOW_TITLE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SHOW_TITLE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_SHOW_URL</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Определяет, показывать ли поле связанной ссылки у составителя сообщения</title><content type='text'>false</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SHOW_URL'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SHOW_URL'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_SUBDOMAIN</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Субдомен BlogSpot, в котором будет опубликован ваш блог</title><content type='text'>mrnone</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SUBDOMAIN'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_SUBDOMAIN'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_TIME_STAMP_FORMAT</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Число формата отметки времени</title><content type='text'>27</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_TIME_STAMP_FORMAT'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_TIME_STAMP_FORMAT'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_TIME_ZONE</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Временная зона для этого блога</title><content type='text'>Asia/Omsk</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_TIME_ZONE'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_TIME_ZONE'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.settings.BLOG_USE_LIGHTBOX</id><published>2011-04-02T18:51:38.460+07:00</published><updated>2012-03-18T23:06:04.565+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#settings'/><title type='text'>Показывать изображения в Lightbox при нажатии</title><content type='text'>true</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_USE_LIGHTBOX'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/settings/BLOG_USE_LIGHTBOX'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-735712023979114111</id><published>2012-03-19T09:30:00.000+07:00</published><updated>2012-03-18T22:22:43.576+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><title type='text'>Асинхронно в WinAPI. Начало</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;div&gt;Различные средства параллельного программирования от библиотек вроде &lt;a href="http://msdn.microsoft.com/en-us/library/dd504870.aspx"&gt;&lt;strong&gt;Concurrency Runtime&lt;/strong&gt;&lt;/a&gt; до специализированных языков вроде &lt;strong&gt;&lt;a href="http://www.erlang.org/"&gt;Erlang&lt;/a&gt;&lt;/strong&gt; предоставляют такую типовую операцию, как отправка асинхронного сообщения потоку. А каким образом можно реализовать эту возможность, опираясь только функционал &lt;strong&gt;WinAPI&lt;/strong&gt;. Попробуем разобраться. &lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;На самом деле реализовать асинхронный обмен сообщениями между потоками не сложно. Сложно сделать это с минимальным количеством взаимных блокировок. В идеале отправка и приём сообщения не должны блокировать взаимодействующие потоки. Допустим только один тип блокировки: блокировка принимающего потока в ожидании очередного сообщения.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Не всякая классика заслуживает внимания&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Итак, какие системные средства, позволяют достичь поставленные цели? Первое что приходит в голову – это функция &lt;a href="http://msdn.microsoft.com/en-us/library/ms644946(v=vs.85).aspx"&gt;&lt;em&gt;PostThreadMessage&lt;/em&gt;&lt;/a&gt;, отправляющая сообщение в очередь сообщений потока. Это та же самая очередь, которая используется для управления графическими элементами пользовательского интерфейса. Поэтому у данного метода есть один существенный недостаток: если поток случайно (или намеренно) откроет модальное диалоговое окно, все сообщения, посланные потоку в это время будут обработаны окном и потеряны безвозвратно.&lt;br /&gt;&lt;br /&gt;На втором месте идёт тяжёлая артиллерия в лице &lt;em&gt;pipe`ов с перекрывающимся (ovelapped) доступом&lt;/em&gt;. В этом случае каналом передачи сообщений является &lt;em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/aa365590(VS.85).aspx"&gt;именованный pipe&lt;/a&gt;&lt;/em&gt;, открытый в &lt;a href="http://msdn.microsoft.com/en-us/library/aa365788(VS.85).aspx"&gt;&lt;em&gt;режиме перекрывающегося доступа&lt;/em&gt;&lt;/a&gt;. Передача и приём сообщений осуществляется с помощью операций асинхронной записи и чтения соответственно. Богатый функционал и обширные возможности этого подхода не дают одного – простоты. В случае, если передаваемые сообщения представляют собой обычные целые числа, &lt;em&gt;pipe&lt;/em&gt;`ы кажутся излишними.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Очереди разные важны, очереди разные нужны&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Метод, который я хотел рассмотреть, основа на использовании очереди &lt;em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/ms681951(VS.85).aspx"&gt;вызовов асинхронных процедур&lt;/a&gt;&lt;/em&gt; (&lt;em&gt;asynchronous procedure calls – APC&lt;/em&gt;). Подобная очередь связана с каждым потоком и активно используется операционной системой для обработки таких, например, операций, как перекрывающий ввод-вывод. Вызов асинхронной процедуры, добавленный в очередь потока, будет осуществлён в контексте выполнения этого потока.&lt;br /&gt;&lt;br /&gt;Добавлять асинхронные вызовы в очередь потока может не только система, но и любое приложение пользовательского режима. Для этого достаточно вызвать системную функция &lt;em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/ms684954(VS.85).aspx"&gt;QueueUserAPC&lt;/a&gt;&lt;/em&gt;, передав ей в качестве параметров:&lt;br /&gt;1) указатель на функцию асинхронной процедуры;&lt;br /&gt;2) описатель (&lt;em&gt;HANDLE&lt;/em&gt;) потока;&lt;br /&gt;3) произвольные данные типа &lt;em&gt;ULONG_PTR&lt;/em&gt;, которые будут переданы функции асинхронной процедуры при её вызове.&lt;br /&gt;Если вы сделаете всё правильно, то любая попытка &lt;em&gt;тревожного ожидания&lt;/em&gt; (&lt;em&gt;alertable waiting&lt;/em&gt;), в потоке, в очередь которого добавлен APC, завершиться вызовом функции асинхронной процедуры. При этом сама функция ожидания вернёт управление в поток с кодом завершения &lt;em&gt;WAIT_IO_COMPLETION&lt;/em&gt;. Инициировать тревожное ожидание можно с помощью расширенных версий синхронизирующих функций: &lt;a href="http://msdn.microsoft.com/en-us/library/ms686307(VS.85).aspx"&gt;&lt;em&gt;SleepEx&lt;/em&gt;&lt;/a&gt;&lt;em&gt;, &lt;/em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/ms687036(VS.85).aspx"&gt;&lt;em&gt;WaitForSingleObjectEx&lt;/em&gt;&lt;/a&gt;&lt;em&gt;, &lt;/em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/ms687028(VS.85).aspx"&gt;&lt;em&gt;WaitForMultipleObjectsEx&lt;/em&gt;&lt;/a&gt; и так далее. Каждая из них имеет дополнительный параметр &lt;em&gt;bAlertable&lt;/em&gt; типа &lt;em&gt;BOOL,&lt;/em&gt; передача ему значения &lt;em&gt;TRUE&lt;/em&gt; вызывает ожидание в тревожном состоянии.&lt;br /&gt;&lt;br /&gt;Не сложно заметить, что комбинации указателя на функцию и параметра типа &lt;em&gt;ULONG_PTR&lt;/em&gt; уже достаточно, чтобы наладить передачу простейших асинхронных сообщений. Во многих случаях этого оказывается вполне достаточно. Тем более, что сама функция является частью передаваемого сообщения. Ниже пример простейшей реализации данного подхода.&lt;br /&gt;&lt;br /&gt;Для начала определим передаваемые сообщения и одну асинхронную процедуру, которая будет их принимать и обрабатывать:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;enum&lt;/span&gt; WorkMessage { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; stand_up, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; dress, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; cook, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; eat, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; dish_up, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; wash, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; close_the_door, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; drive, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; work &lt;br /&gt;}; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;void&lt;/span&gt; __stdcall printMessage(ULONG_PTR data) &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"[0x"&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::hex &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::setw(&lt;span style="color: maroon;"&gt;8&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::setfill(&lt;span style="color: maroon;"&gt;'0'&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; ::GetCurrentThreadId() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"] Message: "&lt;/span&gt; &amp;lt;&amp;lt; (WorkMessage)data &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;} &lt;/div&gt;&lt;br /&gt;Теперь определим рабочий поток – потребитель сообщений. Он достаточно примитивен: после запуска сообщает о своей готовности с помощью объекта-события &lt;em&gt;onStart&lt;/em&gt;; после чего ожидает в тревожном режиме перехода в сигнальное состояние объекта-события &lt;em&gt;onExit&lt;/em&gt;, сигнализирующего о завершении работы. Причём ожидание запускается в цикле:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;unsigned&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;int&lt;/span&gt; __stdcall simpleConsumer(&lt;span style="color: blue;"&gt;void&lt;/span&gt; *data) &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ControlEvents events = *&lt;span style="color: blue;"&gt;reinterpret_cast&lt;/span&gt;&amp;lt;ControlEvents*&amp;gt;(data); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"[0x"&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::hex &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::setw(&lt;span style="color: maroon;"&gt;8&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::setfill(&lt;span style="color: maroon;"&gt;'0'&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; ::GetCurrentThreadId() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"] Consumer."&lt;/span&gt; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::SetEvent(events.onStart); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD result = ERROR_SUCCESS, waitRes; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;while&lt;/span&gt; (WAIT_OBJECT_0 != (waitRes = &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::WaitForSingleObjectEx(events.onExit, INFINITE, true))) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (WAIT_IO_COMPLETION != waitRes) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// error happens&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; result = ::GetLastError(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;break&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; result; &lt;br /&gt;} &lt;/div&gt;&lt;br /&gt;Самая сложная – это функция, запускающая поток обработки и отправляющая ему сообщения. Причём её самая сложная часть – это обработка ошибок, связанных с созданием потока и объектов-событий: &lt;br /&gt;&lt;div class="sourcecode"&gt;DWORD &lt;br /&gt;simpleAPCProducer() &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;typedef&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::vector&amp;lt;WorkMessage&amp;gt; TWorkMessages; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; TWorkMessages works; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.reserve(&lt;span style="color: maroon;"&gt;12&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(stand_up); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(dress); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(cook); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(eat); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(dish_up); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(wash); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(close_the_door); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(drive); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(work); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(work); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(work); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.push_back(work); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ControlEvents events = {&lt;span style="color: maroon;"&gt;0&lt;/span&gt;}; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; HANDLE workerThreadH = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD ret = ERROR_SUCCESS; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;try&lt;/span&gt; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; events.onExit = ::CreateEvent(&lt;span style="color: maroon;"&gt;0&lt;/span&gt;, true, false, &lt;span style="color: maroon;"&gt;0&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (&lt;span style="color: maroon;"&gt;0&lt;/span&gt; == events.onExit) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw&lt;/span&gt; ::GetLastError(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; events.onStart = ::CreateEvent(&lt;span style="color: maroon;"&gt;0&lt;/span&gt;, true, false, &lt;span style="color: maroon;"&gt;0&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (&lt;span style="color: maroon;"&gt;0&lt;/span&gt; == events.onStart) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw&lt;/span&gt; ::GetLastError(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"[0x"&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::hex &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::setw(&lt;span style="color: maroon;"&gt;8&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::setfill(&lt;span style="color: maroon;"&gt;'0'&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; ::GetCurrentThreadId() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"] Producer."&lt;/span&gt; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; workerThreadH = &lt;span style="color: blue;"&gt;reinterpret_cast&lt;/span&gt;&amp;lt;HANDLE&amp;gt;( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; _beginthreadex(&lt;span style="color: maroon;"&gt;0&lt;/span&gt;, &lt;span style="color: maroon;"&gt;0&lt;/span&gt;, &amp;amp;simpleConsumer, &amp;amp;events, &lt;span style="color: maroon;"&gt;0&lt;/span&gt;, &lt;span style="color: maroon;"&gt;0&lt;/span&gt;)); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (&lt;span style="color: maroon;"&gt;0&lt;/span&gt; == workerThreadH) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw&lt;/span&gt; ::GetLastError(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (WAIT_OBJECT_0 != ::WaitForSingleObject( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; events.onStart, INFINITE)) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw&lt;/span&gt; ::GetLastError(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;for&lt;/span&gt;(TWorkMessages::const_iterator it = works.begin(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; works.end() != it; ++it) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::QueueUserAPC( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;amp;printMessage, workerThreadH, (ULONG_PTR)*it); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// wait a litle&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::Sleep(&lt;span style="color: maroon;"&gt;1000&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;catch&lt;/span&gt; (DWORD errCode) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ret = errCode; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (&lt;span style="color: maroon;"&gt;0&lt;/span&gt; != events.onExit) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (&lt;span style="color: maroon;"&gt;0&lt;/span&gt; != workerThreadH) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::SetEvent(events.onExit); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (WAIT_OBJECT_0 != ::WaitForSingleObject( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; workerThreadH, &lt;span style="color: maroon;"&gt;5000&lt;/span&gt;)) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::TerminateThread(workerThreadH, &lt;span style="color: maroon;"&gt;1&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(workerThreadH); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(events.onExit); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (&lt;span style="color: maroon;"&gt;0&lt;/span&gt; != events.onStart) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(events.onStart); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; ret; &lt;br /&gt;} &lt;/div&gt;&lt;br /&gt;В следующий раз я рассмотрю более сложный вариант реализации обмена асинхронными сообщениями с помощью APC, позволяющий передавать сообщения любой длинны, а не только &lt;em&gt;sizeof(ULONG_PTR)&lt;/em&gt;.&lt;/div&gt;&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/735712023979114111'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/735712023979114111'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7581608963459088431</id><published>2012-01-18T09:30:00.000+07:00</published><updated>2012-01-18T09:30:00.554+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Erlang'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>MapReduce и Erlang – лучше когда вместе</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Пришла пора добавить немного кода к &lt;a href="http://mrnone.blogspot.com/2011/12/mapreduce.html"&gt;рассказанной в прошлый раз теории&lt;/a&gt;. Вот только идея написать &lt;strong&gt;MapReduce&lt;/strong&gt; на &lt;strong&gt;C++&lt;/strong&gt; или &lt;strong&gt;C#&lt;/strong&gt; мне показалась слишком банальной и тривиальной. Захотелось немного экзотики. Если уж реализовывать "супер распределённый" алгоритм, то только на языке, который считается одним из наиболее приспособленных к параллельным вычислениям. Я говорю об &lt;strong&gt;Erlang&lt;/strong&gt;`е.&amp;nbsp;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Вот такой вот странный зверь – Erlang.&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;&lt;strong&gt;Erlang&lt;/strong&gt; – это функциональный язык, специально заточенный для нужд многопоточной разработки. По праву одним из самых лучшим инструментов для параллельного программирования его делают ряд особенностей, перечисленных ниже.&lt;br /&gt;&lt;br /&gt;1. Встроенные в язык средства управления потоками – в &lt;strong&gt;Erlang&lt;/strong&gt;`е они называются легковесными процессами – выполняют за вас такие рутинные операции, как: организация пулов, распределение задач между физическими потоками операционной системы, масштабирование на несколько ядер и даже физических машин. Чтобы создать новый процесс достаточно вызвать встроенную функцию &lt;em&gt;spawn&lt;/em&gt; следующим образом:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;Pid&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;spawn&lt;/span&gt;(&lt;span style="color: #c0504d;"&gt;module&lt;/span&gt;, &lt;span style="color: #c0504d;"&gt;function&lt;/span&gt;, &lt;span style="color: blue;"&gt;ArgsList&lt;/span&gt;)&lt;/div&gt;А чтобы поток создался на другом физическом хосте, где запущена виртуальная машина &lt;strong&gt;Erlang&lt;/strong&gt;`а и которой доступен ваш модуль &lt;em&gt;module&lt;/em&gt; с функцией &lt;em&gt;function&lt;/em&gt;, достаточно лишь слегка модифицировать изначальный код:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;Pid&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;spawn&lt;/span&gt;(&lt;strong&gt;&lt;span style="color: #800040;"&gt;instance@HOST&lt;/span&gt;&lt;/strong&gt;, &lt;span style="color: #c0504d;"&gt;module&lt;/span&gt;, &lt;span style="color: #c0504d;"&gt;function&lt;/span&gt;, &lt;span style="color: blue;"&gt;ArgsList&lt;/span&gt;)&lt;/div&gt;Где &lt;em&gt;instance&lt;/em&gt; – это имя экземпляра виртуальной машины Erlang`а, запущенной на физическом хосте с именем &lt;em&gt;HOST&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;2. Поддержка на уровне языка механизма обмена асинхронными сообщениями позволяет вам не думать об организации очереди сообщений, решении проблемы гарантированности доставки, блокировках и так далее. Для передачи сообщений в синтаксисе языка выделен специальный оператор – '!'. Следующая строчка кода отправляет сообщение &lt;em&gt;Message&lt;/em&gt; потоку с идентификатором &lt;em&gt;Pid&lt;/em&gt;:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;Pid&lt;/span&gt; ! &lt;span style="color: blue;"&gt;Message&lt;/span&gt;&lt;/div&gt;Забавно, что в качестве сообщения могут выступать данные &lt;u&gt;любого&lt;/u&gt; типа.&lt;br /&gt;&lt;br /&gt;Для приёма сообщений служит ключевое слово &lt;em&gt;receive&lt;/em&gt;. Например, в следующем примере демонстрируется приём сообщений 2-ух типов – атома '&lt;em&gt;stop&lt;/em&gt;' (что такое атом я расскажу чуть ниже) и кортежа, состоящего из атома '&lt;em&gt;work&lt;/em&gt;' и произвольных данных:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;receive&lt;/span&gt;&lt;/strong&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;em&gt;&lt;span style="color: #800040;"&gt;stop&lt;/span&gt;&lt;/em&gt; -&amp;gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;process_stop&lt;/span&gt;(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;em&gt;{&lt;span style="color: #800040;"&gt;work&lt;/span&gt;, &lt;span style="color: blue;"&gt;X&lt;/span&gt;}&lt;/em&gt; -&amp;gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;process_work&lt;/span&gt;(&lt;em&gt;&lt;span style="color: blue;"&gt;X&lt;/span&gt;&lt;/em&gt;), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;consumer_impl&lt;/span&gt;() &lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;end&lt;/span&gt;&lt;/strong&gt;;&lt;/div&gt;&lt;br /&gt;3. Приложение на &lt;strong&gt;Erlang&lt;/strong&gt;`е оперирует только неизменяемыми (&lt;em&gt;immutable&lt;/em&gt;) переменными. Это означает, что значение, присвоенное переменной единожды, не может быть изменено впоследствии. Это ограничение позволяет избежать таких проблем, как: &lt;em&gt;side&lt;/em&gt;-эффекты, конкуренция за ресурсы и блокировки.&lt;br /&gt;&lt;br /&gt;4. Виртуальная машина &lt;strong&gt;Erlang&lt;/strong&gt;`а и его сборщик мусора были изначально спроектированы с прицелом на многопоточную разработку и системы мягкого реального времени. Более подробно про эти особенности можно прочитать &lt;a href="http://rsdn.ru/forum/philosophy/2261047.1.aspx"&gt;здесь&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;Ещё несколько деталей синтаксиса языка, чтобы дальнейший код был более понятен. Любая переменная должна начинаться с большой буквы:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;Operation&lt;/span&gt; = &lt;span style="color: #800040;"&gt;work&lt;/span&gt;&lt;/div&gt;Значение в правой части выражения – это &lt;em&gt;атом&lt;/em&gt;, специальный тип данных в &lt;strong&gt;Erlang&lt;/strong&gt;`е, представляющий собой просто имя. В отличии от переменных атомы начинаются с маленькой буквы: &lt;em&gt;done&lt;/em&gt;, &lt;em&gt;stop&lt;/em&gt;, &lt;em&gt;work&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Функция определяется следующим образом:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #c0504d;"&gt;process_work&lt;/span&gt;(&lt;span style="color: blue;"&gt;X&lt;/span&gt;) –&amp;gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;io:format&lt;/span&gt;(&lt;span style="color: green;"&gt;"Do work: ~p~n"&lt;/span&gt;, [&lt;span style="color: blue;"&gt;X&lt;/span&gt;]), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #800040;"&gt;done&lt;/span&gt;.&lt;/div&gt;Данные, записанные в последней строке, считаются неявно возвращаемыми из функции. В данном примере – это атом &lt;em&gt;'done&lt;/em&gt;'.&lt;br /&gt;&lt;br /&gt;Комментарии помечаются символом % в начале строки. Более подробную информацию о языке можно найти на &lt;a href="http://www.erlang.org/doc/"&gt;сайте разработчиков&lt;/a&gt;. На RSDN.RU есть неплохой перевод на русский язык статьи "Getting Started with Erlang User's Guide" из каталога официальной документации: &lt;a href="http://www.rsdn.ru/article/erlang/GettingStartedWithErlang.xml"&gt;"Начала работы с Erlang"&lt;/a&gt;&lt;strong&gt;&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;MapReduce в 50 строк&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Итак, вернёмся к &lt;strong&gt;MapReduce&lt;/strong&gt; и попытаемся с его помощью посчитать количество различных слов в романе "&lt;em&gt;Война и мир&lt;/em&gt;".&lt;br /&gt;&lt;br /&gt;Для начала определим функцию мастера:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;% Master takes Input and 2 lambdas: Map-function and Reduce-function&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;master&lt;/span&gt;(&lt;span style="color: blue;"&gt;Input&lt;/span&gt;, &lt;span style="color: blue;"&gt;Map&lt;/span&gt;, &lt;span style="color: blue;"&gt;Reduce&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;em&gt;&lt;span style="color: #666666;"&gt;% run map&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;MapCount&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;run_map&lt;/span&gt;(&lt;span style="color: blue;"&gt;Input&lt;/span&gt;, &lt;span style="color: blue;"&gt;Map&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;em&gt;&lt;span style="color: #666666;"&gt;% collect map results and sort them using a lambda for comparison&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;MapResults&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;lists:sort&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;fun&lt;/span&gt;({&lt;span style="color: blue;"&gt;LeftKey&lt;/span&gt;, _}, {&lt;span style="color: blue;"&gt;RightKey&lt;/span&gt;, _}) -&amp;gt; &lt;span style="color: blue;"&gt;LeftKey&lt;/span&gt; =&amp;lt; &lt;span style="color: blue;"&gt;RightKey&lt;/span&gt;&amp;nbsp;&lt;span style="color: red;"&gt;end&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;wait_results&lt;/span&gt;(&lt;span style="color: blue;"&gt;MapCount&lt;/span&gt;, [])),&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;em&gt;&lt;span style="color: #666666;"&gt;% run reduce&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;ReduceCount&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;MapResults&lt;/span&gt;, &lt;span style="color: blue;"&gt;Reduce&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;em&gt;&lt;span style="color: #666666;"&gt;% collect results&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;wait_results&lt;/span&gt;(&lt;span style="color: blue;"&gt;ReduceCount&lt;/span&gt;, []).&lt;/div&gt;Функция мастера принимает 3 параметра: список обрабатываемых элементов и 2 лямбда-функции. Первая лямбда-функция должна реализовывать процедуру &lt;strong&gt;Map&lt;/strong&gt;, вторая – &lt;strong&gt;Reduce&lt;/strong&gt;. Вместо того, чтобы непрерывно группировать результат, получаемый от &lt;strong&gt;Map&lt;/strong&gt;-агентов, мастер складывает все ответы в единый список (формируется внутри функции &lt;em&gt;wait_results&lt;/em&gt;), который сортирует по ключу перед вызовом фазы &lt;strong&gt;Reduce&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Функция &lt;em&gt;run_map&lt;/em&gt; достаточно проста для понимания и не требует дополнительных комментариев:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #c0504d;"&gt;run_map&lt;/span&gt;(&lt;span style="color: blue;"&gt;Input&lt;/span&gt;, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/em&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;% for each elemt in list call a lambda which&lt;br /&gt;&lt;span style="color: #666666;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; % &lt;/span&gt;calls spawn_worker function&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;/em&gt;&lt;span style="color: #c0504d;"&gt;lists:foreach&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;fun&lt;/span&gt;(&lt;span style="color: blue;"&gt;Element&lt;/span&gt;) -&amp;gt; &lt;span style="color: #c0504d;"&gt;spawn_worker&lt;/span&gt;(&lt;span style="color: blue;"&gt;Element&lt;/span&gt;, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;) &lt;span style="color: red;"&gt;end&lt;/span&gt;, &lt;span style="color: blue;"&gt;Input&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;length&lt;/span&gt;(&lt;span style="color: blue;"&gt;Input&lt;/span&gt;).&lt;/div&gt;&lt;br /&gt;Гораздо больший интерес представляет собой функция &lt;em&gt;run_reduce&lt;/em&gt;. Если быть точным, то в приложении определено 2 функции run_reduce – 2-я и 3-я аргументами. Причём вторая функция имеет несколько специализаций для конкретных значений передаваемых аргументов:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;([{&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;Value&lt;/span&gt;} | &lt;span style="color: blue;"&gt;SortedList&lt;/span&gt;], &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, [&lt;span style="color: blue;"&gt;Value&lt;/span&gt;], &lt;span style="color: blue;"&gt;SortedList&lt;/span&gt;, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;, 0).&lt;br /&gt;&lt;br /&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;% This set of run_reduce functions groups the received&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #666666;"&gt;% sorted list by Key and calls spawn_worker for each&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #666666;"&gt;% pair {Key, ValuesList}&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;ValueList&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [{&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;Value&lt;/span&gt;} | &lt;span style="color: blue;"&gt;SortedList&lt;/span&gt;], &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;, &lt;span style="color: blue;"&gt;Count&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, [&lt;span style="color: blue;"&gt;Value&lt;/span&gt; | &lt;span style="color: blue;"&gt;ValueList&lt;/span&gt;],&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;SortedList&lt;/span&gt;, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;, &lt;span style="color: blue;"&gt;Count&lt;/span&gt;);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;ValueList&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [{&lt;span style="color: blue;"&gt;NewKey&lt;/span&gt;, &lt;span style="color: blue;"&gt;Value&lt;/span&gt;} | &lt;span style="color: blue;"&gt;SortedList&lt;/span&gt;], &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;, &lt;span style="color: blue;"&gt;Count&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;spawn_worker&lt;/span&gt;({&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;ValueList&lt;/span&gt;}, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;NewKey&lt;/span&gt;, [&lt;span style="color: blue;"&gt;Value&lt;/span&gt;], &lt;span style="color: blue;"&gt;SortedList&lt;/span&gt;, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;, &lt;span style="color: blue;"&gt;Count&lt;/span&gt; + 1);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;run_reduce&lt;/span&gt;(&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;ValueList&lt;/span&gt;, [], &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;, &lt;span style="color: blue;"&gt;Count&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;spawn_worker&lt;/span&gt;({&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;ValueList&lt;/span&gt;}, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Count&lt;/span&gt; + 1.&lt;/div&gt;Данный набор функций перебирает список пар, отсортированных по первому значению пары – ключу, строит по данному ключу группировку и для каждой новой пары вида &lt;em&gt;{Ключ, Список Значений}&lt;/em&gt; вызывает функцию &lt;em&gt;spawn_work&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Функция &lt;em&gt;spawn_work&lt;/em&gt; вызывается и из функции &lt;em&gt;run_map&lt;/em&gt;, и из функции &lt;em&gt;run_reduce&lt;/em&gt;:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;% Function which schedules a worker process.&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #666666;"&gt;% It receives an Element which should be processed and&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #666666;"&gt;% a worker function (Map or Reduce)&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;spawn_worker&lt;/span&gt;(&lt;span style="color: blue;"&gt;Element&lt;/span&gt;, &lt;span style="color: blue;"&gt;Fun&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #666666;"&gt;&lt;em&gt;% get current PID&lt;/em&gt;&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;CurrentPID&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;self&lt;/span&gt;(),&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #666666;"&gt;&lt;em&gt;% define 2 lambdas: Emit and Worker&lt;/em&gt;&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Emit&lt;/span&gt; =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;fun&lt;/span&gt;(&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;Val&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;CurrentPID&lt;/span&gt; ! {&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;Val&lt;/span&gt;}&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;end&lt;/span&gt;,&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Worker&lt;/span&gt; =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;fun&lt;/span&gt;() -&amp;gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #666666;"&gt;% Worker calls the received function and&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #666666;"&gt;% pass Element and Emit as an arguments&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;/em&gt;&lt;span style="color: blue;"&gt;Fun&lt;/span&gt;(&lt;span style="color: blue;"&gt;Element&lt;/span&gt;, &lt;span style="color: blue;"&gt;Emit&lt;/span&gt;),&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #666666;"&gt;% notify parent that worker is done&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;/em&gt;&lt;span style="color: blue;"&gt;CurrentPID&lt;/span&gt; ! &lt;span style="color: #800040;"&gt;worker_done&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;end&lt;/span&gt;,&lt;br /&gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; % schedule the worker process&lt;/em&gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/em&gt;&lt;span style="color: #c0504d;"&gt;spawn&lt;/span&gt;(&lt;span style="color: red;"&gt;fun&lt;/span&gt;() -&amp;gt; &lt;span style="color: blue;"&gt;Worker&lt;/span&gt;() &lt;span style="color: red;"&gt;end&lt;/span&gt;).&lt;/div&gt;Она подготавливает 2 лямбда-функции: &lt;em&gt;Emit&lt;/em&gt; и &lt;em&gt;Worker&lt;/em&gt;, которые использует для запуска нового процесса (лямбда &lt;em&gt;Worker&lt;/em&gt;) и передачи в качестве параметра функции-обработчику (лямбда &lt;em&gt;Emit&lt;/em&gt;). Эти лямбда-функции нужны для формирования корректных сообщений мастеру. Функция-обработчик (&lt;em&gt;Map &lt;/em&gt;или &lt;em&gt;Reduce&lt;/em&gt;) будет просто вызывать лямбду &lt;em&gt;Emit&lt;/em&gt;, когда у неё будут готовы данные для отправки мастеру.&lt;br /&gt;&lt;br /&gt;В случае обоих фаз мастер собирает результаты с помощью функции &lt;em&gt;wait_results&lt;/em&gt;. Эта функция слушает сообщения от агентов и складывает ответы в возвращаемый список:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;% This instance of wait_results is called when&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #666666;"&gt;% the 1st argument is 0&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;wait_results&lt;/span&gt;(0, &lt;span style="color: blue;"&gt;Results&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Results&lt;/span&gt;;&lt;br /&gt;&lt;br /&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;% This instance of wait_results is called when&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #666666;"&gt;% the 1st element is not 0&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;wait_results&lt;/span&gt;(&lt;span style="color: blue;"&gt;Count&lt;/span&gt;, &lt;span style="color: blue;"&gt;Results&lt;/span&gt;) –&amp;gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; %&lt;span style="color: #666666;"&gt; wait for messages&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&lt;em&gt;&lt;span style="color: #666666;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;/em&gt;&lt;span style="color: red;"&gt;receive&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;Val&lt;/span&gt;} –&amp;gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %&lt;span style="color: #666666;"&gt; extend Results list with the received pair&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %&lt;span style="color: #666666;"&gt; and call wait_results recursively&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;wait_results&lt;/span&gt;(&lt;span style="color: blue;"&gt;Count&lt;/span&gt;, [{&lt;span style="color: blue;"&gt;Key&lt;/span&gt;, &lt;span style="color: blue;"&gt;Val&lt;/span&gt;} | &lt;span style="color: blue;"&gt;Results&lt;/span&gt;]);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #800040;"&gt;worker_done&lt;/span&gt; –&amp;gt;&lt;br /&gt;&lt;em&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %&lt;span style="color: #666666;"&gt; some worker is done: decrease count of&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; %&lt;span style="color: #666666;"&gt; worker and call wait_results recursively&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;wait_results&lt;/span&gt;(&lt;span style="color: blue;"&gt;Count&lt;/span&gt; - 1, &lt;span style="color: blue;"&gt;Results&lt;/span&gt;)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;end&lt;/span&gt;.&lt;/div&gt;&lt;br /&gt;И наконец функции read_words и count_words, выступающие в качестве рабочих функций Map и Reduce агентов соответственно:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #c0504d;"&gt;read_words&lt;/span&gt;(&lt;span style="color: blue;"&gt;FileName&lt;/span&gt;, &lt;span style="color: blue;"&gt;Emit&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;span style="color: purple;"&gt;ok&lt;/span&gt;, &lt;span style="color: blue;"&gt;FileContent&lt;/span&gt;} = &lt;span style="color: #c0504d;"&gt;file:read_file&lt;/span&gt;(&lt;span style="color: blue;"&gt;FileName&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Words&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;string:tokens&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;erlang:binary_to_list&lt;/span&gt;(&lt;span style="color: blue;"&gt;FileContent&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;" \t\n\r,.;:-!?\"'()"&lt;/span&gt;),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #c0504d;"&gt;lists:foreach&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;fun&lt;/span&gt;(&lt;span style="color: blue;"&gt;Word&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;if&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Word&lt;/span&gt; /= &lt;span style="color: green;"&gt;""&lt;/span&gt; -&amp;gt; &lt;span style="color: blue;"&gt;Emit&lt;/span&gt;(&lt;span style="color: blue;"&gt;Word&lt;/span&gt;, 1);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Word&lt;/span&gt; == &lt;span style="color: green;"&gt;""&lt;/span&gt; -&amp;gt; &lt;span style="color: purple;"&gt;false&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;end&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;end&lt;/span&gt;, &lt;span style="color: blue;"&gt;Words&lt;/span&gt;).&lt;br /&gt;&lt;br /&gt;&lt;span style="color: #c0504d;"&gt;count_words&lt;/span&gt;({&lt;span style="color: blue;"&gt;Word&lt;/span&gt;, &lt;span style="color: blue;"&gt;Counts&lt;/span&gt;}, &lt;span style="color: blue;"&gt;Emit&lt;/span&gt;) -&amp;gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;Emit&lt;/span&gt;(&lt;span style="color: blue;"&gt;Word&lt;/span&gt;, &lt;span style="color: #c0504d;"&gt;length&lt;/span&gt;(&lt;span style="color: blue;"&gt;Counts&lt;/span&gt;)).&lt;/div&gt;&lt;br /&gt;Теперь можно вызвать функцию мастер, передав ей список файлов и 2 функции – read_words и count_words:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;Results&lt;/span&gt; = &lt;span style="color: #c0504d;"&gt;master&lt;/span&gt;([&lt;span style="color: green;"&gt;"p1.txt"&lt;/span&gt;, &lt;span style="color: green;"&gt;"p2.txt"&lt;/span&gt;, &lt;span style="color: green;"&gt;"p3.txt"&lt;/span&gt;],&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: red;"&gt;fun&lt;/span&gt; &lt;span style="color: #c0504d;"&gt;read_words&lt;/span&gt;/2, &lt;span style="color: red;"&gt;fun&lt;/span&gt; &lt;span style="color: #c0504d;"&gt;count_words&lt;/span&gt;/2)&lt;/div&gt;&lt;br /&gt;Для простоты эксперимента, чтобы не загромождать код лишней работой, связанной с обработкой кодировок, я взял электронную версию английского перевода романа "Война и мир", разбил текст руками на 5 примерно равных частей и запустил вычисление с включенным таймером (функция timer:tc). &lt;br /&gt;&lt;br /&gt;Результат весьма впечатляющий:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: green;"&gt;5&amp;gt; {WPTiming, ok} = timer:tc(mapreduce, main, [["wp1.txt", "wp2.txt", "wp3.txt", "wp4.txt", "wp5.txt"]]).&lt;br /&gt;{4078000,ok}&lt;br /&gt;6&amp;gt; WPTiming / 1000000 .&lt;br /&gt;4.078&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;На полный подсчёт понадобилось чуть больше 4 секунд на машине с 2-ух ядерным &lt;strong&gt;Intel Core 2 Duo&lt;/strong&gt;. По-моему, это круто.&lt;br /&gt;&lt;br /&gt;Архив с полным исходным текстом приложения и тестовыми данными можно скачать &lt;a href="http://dl.dropbox.com/u/26827843/BlogFiles/mapreduce.zip"&gt;здесь&lt;/a&gt;.&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2012/01/mapreduce-erlang.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7581608963459088431'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7581608963459088431'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2012/01/mapreduce-erlang.html' title='MapReduce и Erlang – лучше когда вместе'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-2652208706618021890</id><published>2011-12-12T09:30:00.000+07:00</published><updated>2011-12-12T09:30:01.058+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>Кратко о MapReduce</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Среди всех параллельных алгоритмов, реализации которых легко масштабируются на произвольное количество ядер, &lt;em&gt;MapReduce&lt;/em&gt; можно назвать одним из самым свежих. Компания &lt;strong&gt;Google&lt;/strong&gt; представила его в 2004 году. Давайте попробуем разобраться: что это такое и зачем оно нужно. &lt;div&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;&lt;br /&gt;Что такое MapReduce?&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;На самом деле &lt;em&gt;MapReduce&lt;/em&gt; – это скорее целая схема построения разнообразных алгоритмов для многопоточной обработки больших объёмов данных. Единственное условие: вычисления должны быть представимы в виде 2-ух последовательных операций, называемых &lt;em&gt;Map&lt;/em&gt; и &lt;em&gt;Reduce&lt;/em&gt;. Но обо всём по порядку.&lt;br /&gt;&lt;br /&gt;Основными фигурантами реализации &lt;em&gt;MapReduce&lt;/em&gt; являются: &lt;em&gt;master&lt;/em&gt;-агент, множество &lt;em&gt;map&lt;/em&gt;-агентов и ещё большее множество &lt;em&gt;reduce&lt;/em&gt;-агентов. Как не сложно будет заметить: каждый из этих агентов может выполняться независимо от большинства других,&amp;nbsp;то есть параллельно.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;На первом шаге&lt;/u&gt; &lt;em&gt;master&lt;/em&gt;-агент принимает &lt;em&gt;задание&lt;/em&gt;, например: список файлов, подлежащих обработке. Затем он создаёт некоторое количество &lt;em&gt;map&lt;/em&gt;-агентов – их число определяется объёмом и расположением входных данных, например: по одному &lt;em&gt;map&lt;/em&gt;-агенту для каждого файла, поступившего на вход. Каждый агент получает свою порцию входного задания, например: одно имя файла из общего списка. После этого &lt;em&gt;master&lt;/em&gt; засыпает в ожидании результатов от агентов.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;На втором шаге&lt;/u&gt; каждый &lt;em&gt;map&lt;/em&gt;-агент должен обработать свою порцию данных некоторым специфичным образом и вернуть результат мастеру в виде списка пар (&lt;em&gt;ключ&lt;/em&gt;, &lt;em&gt;значение&lt;/em&gt;). В самом простейшем случае в качестве ключей могут выступать слова из обрабатываемого текстового файла. Значение – это любая информация, которая потребуется на следующих шагах. Например, чтобы посчитать, сколько раз каждое слово встречается во всех входных файлах, каждый &lt;em&gt;map&lt;/em&gt;-агент для каждого слова из обрабатываемого им файла должен вернуть: (слово, 1). То есть, для такого файла:  &lt;br /&gt;&lt;div class="sourcecode"&gt;Hello, mad, mad, mad, mad world! Hello!&lt;/div&gt;map-агент должен вернуть:  &lt;br /&gt;&lt;div class="sourcecode"&gt;(Hello, 1), (mad, 1), (mad, 1), (mad, 1), (mad, 1) (world, 1), (Hello, 1)&lt;/div&gt;&lt;br /&gt;&lt;u&gt;На третьем шаге&lt;/u&gt; master принимает ответы от всех map-агентов и группирует их по ключам, собирая &lt;em&gt;значения&lt;/em&gt; для одного ключа в единый список. Возвращаясь к нашему примеру, получается следующее:  &lt;br /&gt;&lt;div class="sourcecode"&gt;{Hello, (1, 1)}, {mad, (1, 1, 1, 1)}, {world, (1)}&lt;/div&gt;&lt;br /&gt;На практике этот шаг, может быть частично совмещён с предыдущим (и как правило это всегда так и бывает). Дело в том, что &lt;em&gt;map&lt;/em&gt;-агенты вместо того, чтобы формировать ответ в виде законченного списка, могут отправлять каждую пару мастеру независимо, например в виде асинхронного сообщения. Таким образом мастер может выполнять группировку данных, параллельно с работающими &lt;em&gt;map&lt;/em&gt;-агентами.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;На четвёртом шаге&lt;/u&gt; для каждого ключа мастер создаёт своего &lt;em&gt;reduce&lt;/em&gt;-агента и передаёт ему на обработку ключ и список ассоциированных с ним значений. &lt;em&gt;Reduce&lt;/em&gt;-агентам остаётся обработать список значений и вернуть мастеру результат в виде &lt;strong&gt;одной&lt;/strong&gt; пары (ключ, новое значение). То есть, в случае нашего примера мастер создаст 3 reduce-агента и передаст им соответственно:  &lt;br /&gt;&lt;div class="sourcecode"&gt;{Hello, (1, 1)}&lt;br /&gt;{mad, (1, 1, 1, 1)}&lt;br /&gt;{world, (1)}&lt;/div&gt;Чтобы подсчитать количество вхождений каждого слова, &lt;em&gt;reduce&lt;/em&gt;-агентам нужно всего лишь сложить все значения из списка и вернуть полученный результат мастеру: &lt;br /&gt;&lt;div class="sourcecode"&gt;(Hello, 2)&lt;br /&gt;(mad, 4)&lt;br /&gt;(world, 1)&lt;/div&gt;&lt;br /&gt;Этот список пар и будет конечным результатом.&lt;br /&gt;&lt;span style="color: red;"&gt;&lt;span style="color: black;"&gt;&lt;/span&gt;&lt;br /&gt;&lt;strong&gt;А оно надо?&lt;/strong&gt;&lt;/span&gt;&lt;br /&gt;Не сложно заметить, что &lt;em&gt;MapReduce&lt;/em&gt; является частным случаем &lt;em&gt;Data Flow&lt;/em&gt; подхода, который, &lt;a href="http://mrnone.blogspot.com/2011/10/data-flow.html"&gt;как известно&lt;/a&gt;, позволяет распараллелить обработку зависимых данных без &lt;em&gt;Lock Convoys &lt;/em&gt;и при этом достаточно неплохо масштабируется.&lt;br /&gt;&lt;br /&gt;Есть ещё один – не такой очевидный плюс. Представьте себе, что файлов, которые нужно обработать, несколько сотен тысяч. Объём каждого измеряется сотнями мегабайт. Даже просто проиндексировать все слова в этом случае будет проблематично: вам банально не хватит объёма памяти, доступной на вашей машине. Агенты в рамках MapReduce настолько не зависимы друг от друга, что это позволяет легко выносить их работу на другие сервера, тем самым распределяя вычисления не только между потоками, но и между хостами. В этом случае проблемы с недостатком памяти уже не будет.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/12/mapreduce.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/2652208706618021890'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/2652208706618021890'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/12/mapreduce.html' title='Кратко о MapReduce'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1521667034760278535</id><published>2011-11-14T09:30:00.000+07:00</published><updated>2011-11-14T09:30:00.703+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='C++'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>Параллельный зоопарк</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Рассказывая про методы многопоточного программирования в предыдущих заметках, я регулярно обращался за помощью к библиотеке &lt;a href="http://msdn.microsoft.com/en-us/library/dd504870.aspx"&gt;&lt;strong&gt;Concurrency Runtime&lt;/strong&gt;&lt;/a&gt;. Эта прекрасная библиотека имеет 2 недостатка: во-первых, она доступна только в составе &lt;strong&gt;Microsoft Visual Studio &lt;/strong&gt;&lt;strong&gt;2010&lt;/strong&gt; и выше; во-вторых, она работает только в &lt;strong&gt;ОС Windows&lt;/strong&gt; начиная с версии &lt;strong&gt;XP&lt;/strong&gt; с 3-им сервис-паком. В данной заметке я хочу рассмотреть некоторые альтернативные библиотеки, для многопоточного программирования, лишённые таких ограничений. &lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;&lt;br /&gt;Intel Threading Building Blocks&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Библиотека &lt;strong&gt;&lt;a href="http://threadingbuildingblocks.org/"&gt;Threading Building Blocks&lt;/a&gt;&lt;/strong&gt; от &lt;strong&gt;Intel&lt;/strong&gt; является наиболее серьёзным конкурентом &lt;strong&gt;Concurency Runtime&lt;/strong&gt;`у от &lt;strong&gt;Microsoft&lt;/strong&gt;. Местами она даже превосходит последнюю по функционалу. В частности &lt;strong&gt;TBB&lt;/strong&gt; содержит гораздо более богатый набор синхронизирующих примитивов, включая абстракцию для &lt;em&gt;interlocked&lt;/em&gt;-операций (класс &lt;em&gt;tbb::atomic&lt;/em&gt;), полностью отсутствующую в &lt;strong&gt;Concurrency Runtime&lt;/strong&gt;. Другой пример полезной функциональности, имеющейся в &lt;strong&gt;TBB&lt;/strong&gt; и незаслуженно обойдённой в библиотеке от &lt;strong&gt;Microsoft&lt;/strong&gt; – это &lt;strong&gt;Thread Local Storage&lt;/strong&gt;. В TBB он реализуется с помощью 2&lt;sup&gt;&lt;span style="font-size: x-small;"&gt;ух&lt;/span&gt;&lt;/sup&gt; классов: &lt;em&gt;&lt;a href="http://threadingbuildingblocks.org/files/documentation/a00128.html"&gt;tbb::combinable&lt;/a&gt;&lt;/em&gt; и &lt;em&gt;&lt;u&gt;&lt;a href="http://threadingbuildingblocks.org/files/documentation/a00138.html"&gt;tbb::enumerable_thread_specific&lt;/a&gt;&lt;/u&gt;&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;На первый взгляд может показаться, что &lt;strong&gt;TBB&lt;/strong&gt; содержит гораздо больше параллельных алгоритмов, чем &lt;a href="http://msdn.microsoft.com/en-us/library/dd492418.aspx"&gt;&lt;strong&gt;Parallel Patterns Library&lt;/strong&gt;&lt;/a&gt; (часть &lt;strong&gt;Concurency Runtime&lt;/strong&gt;). Но присмотревшись внимательнее, понимаешь, что единственным уникальным алгоритмом, не имеющим аналога в &lt;strong&gt;PPL&lt;/strong&gt;, является &lt;em&gt;&lt;a href="http://threadingbuildingblocks.org/files/documentation/a00233.html#g49edcf9447cd91a9527a3f8e8512b7aa"&gt;tbb::parallel_sort&lt;/a&gt;&lt;/em&gt;. Всё остальное многообразие алгоритмов (&lt;em&gt;&lt;a href="http://threadingbuildingblocks.org/files/documentation/a00233.html"&gt;tbb::parallel_for, tbb::parallel_reduce, tbb::parallel_scan, tbb::parallel_do, tbb::parallel_for_each и tbb::parallel_invoke&lt;/a&gt;&lt;/em&gt;&lt;em&gt;&lt;/em&gt;) функционально сводится к 3&lt;sup&gt;&lt;span style="font-size: x-small;"&gt;ём&lt;/span&gt;&lt;/sup&gt; алгоритмам из &lt;strong&gt;PPL&lt;/strong&gt;: &lt;a href="http://msdn.microsoft.com/en-us/library/dd505035.aspx"&gt;&lt;em&gt;Concurrency::parallel_for&lt;/em&gt;&lt;/a&gt;, &lt;a href="http://msdn.microsoft.com/en-us/library/dd492857.aspx"&gt;&lt;em&gt;Concurrency::parallel_for_each&lt;/em&gt;&lt;/a&gt; и &lt;a href="http://msdn.microsoft.com/en-us/library/dd504887.aspx"&gt;&lt;em&gt;Concurrency::parallel_invoke&lt;/em&gt;&lt;/a&gt;. Практически все итерирующие алгоритмы &lt;strong&gt;TBB&lt;/strong&gt; позволяют с определённой степенью настраивать стратегию разделения итерируемой последовательности между потоками. Для этого введён набор классов-диапазонов (например, &lt;em&gt;tbb::blocked_range&lt;/em&gt;) и классов-разделителей (например, &lt;em&gt;tbb::auto_partinioner&lt;/em&gt;). Использование данной возможности усложняет код, но при этом совершенно бесполезно для большинства решаемых задач. Сравните два функционально-идентичных примера: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: green;"&gt;// iterate from 1 to 1000 and execute&lt;/span&gt; &lt;br /&gt;&lt;span style="color: green;"&gt;// the lambda-function for each number&lt;/span&gt; &lt;br /&gt;tbb::parallel_for( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: maroon;"&gt;1&lt;/span&gt;, &lt;span style="color: maroon;"&gt;1000&lt;/span&gt;, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; [](&lt;span style="color: blue;"&gt;int&lt;/span&gt; i){ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&amp;lt;&amp;lt; ::GetCurrentThreadId() &amp;lt;&amp;lt; ": " &amp;lt;&amp;lt; i&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }); &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// split range [1, 1000) into several ranges with size &amp;lt;= 250,&lt;/span&gt; &lt;br /&gt;&lt;span style="color: green;"&gt;// iterate over these ranges and execute the lambda-function&lt;/span&gt; &lt;br /&gt;&lt;span style="color: green;"&gt;// for each SUB-RANGE&lt;/span&gt; &lt;br /&gt;tbb::parallel_for( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; tbb::blocked_range&amp;lt;&lt;span style="color: blue;"&gt;int&lt;/span&gt;&amp;gt;(&lt;span style="color: maroon;"&gt;1&lt;/span&gt;, &lt;span style="color: maroon;"&gt;1000&lt;/span&gt;, &lt;span style="color: maroon;"&gt;250&lt;/span&gt;), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; [](&lt;span style="color: blue;"&gt;const&lt;/span&gt; tbb::blocked_range&amp;lt;&lt;span style="color: blue;"&gt;int&lt;/span&gt;&amp;gt; range){ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;for&lt;/span&gt; (&lt;span style="color: blue;"&gt;int&lt;/span&gt; i = range.begin(); i != range.end(); ++i) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&amp;lt;&amp;lt; ::GetCurrentThreadId() &amp;lt;&amp;lt; ": " &amp;lt;&amp;lt; i&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }); &lt;/div&gt;&lt;br /&gt;С агентами и &lt;em&gt;Data Flow&lt;/em&gt; парадигмой в &lt;strong&gt;TBB&lt;/strong&gt; гораздо хуже. Агентов нет совсем. Конвейеры данных под именем &lt;em&gt;pipeline&lt;/em&gt; имеют весьма ограниченную реализацию, перегруженную низкоуровневыми деталями: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::stringstream buffer; &lt;br /&gt;buffer &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;"This is a test for the data-flow pattern."&lt;/span&gt;; &lt;br /&gt;&lt;br /&gt;tbb::filter_t&amp;lt;&lt;span style="color: blue;"&gt;void&lt;/span&gt;, &lt;span style="color: blue;"&gt;char&lt;/span&gt;&amp;gt; reader( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// this means to execute the body in serial&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// and save order of returned elements&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; tbb::filter::serial_in_order, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; [&amp;amp;buffer](tbb::flow_control&amp;amp; fc) -&amp;gt; &lt;span style="color: blue;"&gt;char&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;while&lt;/span&gt;(buffer != &lt;span style="color: maroon;"&gt;0&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;char&lt;/span&gt; ch; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; buffer.get(ch); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (buffer.good()) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; ch; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; fc.stop(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style="color: maroon;"&gt;'\0'&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } ); &lt;br /&gt;&lt;br /&gt;tbb::filter_t&amp;lt;&lt;span style="color: blue;"&gt;char&lt;/span&gt;, &lt;span style="color: blue;"&gt;char&lt;/span&gt;&amp;gt; transformer( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// this means to execute the body in parallel&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// for the elements which were returned on the&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// previouse step&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; tbb::filter::parallel, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; [] (&lt;span style="color: blue;"&gt;char&lt;/span&gt; ch) -&amp;gt; &lt;span style="color: blue;"&gt;char&lt;/span&gt; { &lt;span style="color: blue;"&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::toupper(ch); } ); &lt;br /&gt;&lt;br /&gt;tbb::filter_t&amp;lt;&lt;span style="color: blue;"&gt;char&lt;/span&gt;, &lt;span style="color: blue;"&gt;void&lt;/span&gt;&amp;gt; writer( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// this means to execute the body in serial&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// for the elements which were returned on the&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// previouse step in the same order as&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// they were returned from the the 1st filter&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// before the transformation&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; tbb::filter::serial_in_order, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; [] (&lt;span style="color: blue;"&gt;char&lt;/span&gt; ch) { &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; ch; }); &lt;br /&gt;&lt;br /&gt;tbb::parallel_pipeline(&lt;span style="color: maroon;"&gt;10&lt;/span&gt;, reader &amp;amp; transformer &amp;amp; writer); &lt;/div&gt;&lt;br /&gt;Библиотека доступна для следующих операционных систем: &lt;strong&gt;Windows&lt;/strong&gt;, &lt;strong&gt;Linux&lt;/strong&gt; и &lt;strong&gt;MacOS X&lt;/strong&gt;. И даже есть надежда, что будет работать на последних версиях процессоров &lt;strong&gt;AMD&lt;/strong&gt;, а не только &lt;strong&gt;Intel&lt;/strong&gt; (хотя вот этот момент я бы тщательно проверил, прежде чем начинать использование). Поэтому, если в вашем приложении вы хотите использовать параллельные алгоритмы, конкурентные контейнеры, &lt;em&gt;Data Flow&lt;/em&gt; подход, &lt;u&gt;но вам нужна поддержка нескольких операционных систем&lt;/u&gt;, выбор в пользу &lt;strong&gt;TBB&lt;/strong&gt; очевиден. Если же операционная система одна – &lt;strong&gt;Windows&lt;/strong&gt;, то я бы остановился на &lt;strong&gt;Concurrency Runtime&lt;/strong&gt;. В конце-концов есть шанс, что в этом случае ваше приложение побежит даже на &lt;strong&gt;ARM&lt;/strong&gt;-процессорах, после выхода &lt;strong&gt;Windows 8&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;OpenMP&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;&lt;strong&gt;OpenMP&lt;/strong&gt; – это стандарт API, разработанный в 1997 году для написания портируемых многопоточных приложений. Изначально он предназначался для языка &lt;strong&gt;Fortran&lt;/strong&gt;. Но уже год спустя (в 1998-ом) появилась реализация стандарта для &lt;strong&gt;С/C++&lt;/strong&gt;. Самая последняя версия – &lt;strong&gt;OpenMP 3.0&lt;/strong&gt; – увидела свет в 2008-ом году. Самой же массовой и широко используемой версией на данный момент является 2-ая версия стандарта: &lt;strong&gt;OpenMP 2.0&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Стандарт представляет собой совокупность библиотечных функций, переменных окружения и директив компилятора для языков &lt;strong&gt;C/C++&lt;/strong&gt; и &lt;strong&gt;Fortran&lt;/strong&gt;. В случае &lt;strong&gt;С++&lt;/strong&gt; функции подключаются с помощью заголовочного файла &lt;em&gt;omp.h&lt;/em&gt;, а директивы компилятора выполнены как расширения директивы &lt;em&gt;#pragma&lt;/em&gt; с ключевым словом &lt;em&gt;omp&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Возможности &lt;strong&gt;OpenMP&lt;/strong&gt; по сравнению с &lt;strong&gt;Concurrency Runtime&lt;/strong&gt; и &lt;strong&gt;TBB&lt;/strong&gt; весьма ограничены. По-сути он содержит лишь платформо-независимые средства для параллельного запуска блоков кода, включая организацию простейших параллельных циклов, синхронизации и доступа к памяти. Главный плюс &lt;strong&gt;OpenMP&lt;/strong&gt; – это простота использования и прозрачность получаемого кода. Вот как будет выглядеть пример перебора чисел от 1 до 1000 с выводом на консоль, если реализовать его с помощью &lt;strong&gt;OpenMP&lt;/strong&gt; (сравните с аналогичной реализацией для TBB, приведённой выше):  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;#pragma omp parallel for&lt;/span&gt; &lt;br /&gt;&lt;span style="color: blue;"&gt;for&lt;/span&gt; (&lt;span style="color: blue;"&gt;int&lt;/span&gt; i = &lt;span style="color: maroon;"&gt;1&lt;/span&gt;; i &amp;lt; &lt;span style="color: maroon;"&gt;1000&lt;/span&gt;; ++i) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; ::GetCurrentThreadId() &amp;lt;&amp;lt; &lt;span style="color: maroon;"&gt;": "&lt;/span&gt; &amp;lt;&amp;lt; i &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;} &lt;/div&gt;&lt;br /&gt;Список компиляторов, поддерживающих &lt;strong&gt;OpenMP&lt;/strong&gt;, весьма обширен. Он включает и &lt;strong&gt;Visual С++&lt;/strong&gt;, и &lt;strong&gt;GCC&lt;/strong&gt;, и &lt;strong&gt;Intel Compiler&lt;/strong&gt; (причём как для &lt;strong&gt;C++&lt;/strong&gt;, так и для &lt;strong&gt;Fortran&lt;/strong&gt;). Аналогично обстоят дела и с платформами: &lt;strong&gt;Windows&lt;/strong&gt;, &lt;strong&gt;Linux&lt;/strong&gt;, &lt;strong&gt;Solaris&lt;/strong&gt;, &lt;strong&gt;MacOS X&lt;/strong&gt;, &lt;strong&gt;AIX&lt;/strong&gt;. Более детальную информацию &lt;a href="http://openmp.org/wp/openmp-compilers/"&gt;можно найти здесь&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Boost.Threads&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Без краткого упоминания &lt;strong&gt;Boost.Threads&lt;/strong&gt; данный обзор был бы не полным. Но упоминание будет действительно кратким.&lt;br /&gt;&lt;br /&gt;В состав &lt;strong&gt;Boost&lt;/strong&gt; входит небольшой набор примитивов для многопоточной разработки, позволяющий абстрагироваться от конкретной платформы. Сюда входят: класс потока – &lt;em&gt;class thread&lt;/em&gt;; стандартная абстракция для группирования потоков (песочница), позволяющая реализовать операции группового ожидания и прерывания – &lt;em&gt;class thread_group&lt;/em&gt;; некоторое количество разнообразных синхронизирующих примитивов и функций ожидания; &lt;strong&gt;Thread Local Storage&lt;/strong&gt; – &lt;em&gt;class thread_specific_ptr&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Подобный функционал есть у многих продвинутых платформо-независимых библиотек классов для &lt;strong&gt;C++&lt;/strong&gt;. Более того, новый стандарт &lt;strong&gt;C++&lt;/strong&gt; от 2011 года содержит часть аналогичных возможностей в составе стандартной библиотеки, а именно: класс потока, TLS, синхронизирующие примитивы.&lt;br /&gt;&lt;br /&gt;Таким образом, если вам необходимы всего лишь элементарные примитивы для многопоточной разработки, вроде потоков и мьютексов, и вам важна портируемость, я бы предложил воспользоваться &lt;strong&gt;boost&lt;/strong&gt;`ом, тем более он содержит много полезного кроме многопоточности. Другой вариант: найти реализацию стандартной библиотеки &lt;strong&gt;C++&lt;/strong&gt;, соответствующую последнему стандарту.&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/11/blog-post.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1521667034760278535'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1521667034760278535'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/11/blog-post.html' title='Параллельный зоопарк'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-493042754671777293</id><published>2011-10-24T09:30:00.000+07:00</published><updated>2011-10-24T09:30:00.161+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='C++'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>Data Flow, или Данные управляют командами. Практика</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;div&gt;В &lt;a href="http://mrnone.blogspot.com/2011/10/data-flow.html"&gt;прошлый раз&lt;/a&gt; я рассказывал о &lt;em&gt;Data Flow&lt;/em&gt; подходе в разработке многозадачных приложений. Та заметка получилась совершенно без кода и примеров. В этот раз постараюсь исправиться – кода будет много. И весь код будет посвящён иллюстрации всё той же темы: &lt;em&gt;Data Flow&lt;/em&gt; или &lt;em&gt;конвейер данных&lt;/em&gt;.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;&lt;br /&gt;&lt;br /&gt;Задача&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Итак, нам нужно написать командный интерпретатор, обрабатывающий текстовый поток команд, разделённых символом перевода строки. Каждая команда должна быть: прочитана, распознана и выполнена. Результат выполнения записывается в выходной поток. Причём ответы должны поступать на выход в том же порядке, в котором команды поступали на вход.&lt;br /&gt;&lt;br /&gt;Напомню: чтобы максимально задействовать возможности современных многоядерных машин, устранить &lt;em&gt;Lock Convoy&lt;/em&gt; при синхронизации данных на выходе и удовлетворить требование о строгой последовательности вывода результата, я решил воспользоваться техникой &lt;em&gt;Data Flow&lt;/em&gt;. Процесс обработки команды состоит из 4-ёх последовательных операций, которые зависят друг от друга только входными и выходными данными: &lt;u&gt;считать команду&lt;/u&gt;, &lt;u&gt;распознать команду&lt;/u&gt;, &lt;u&gt;выполнить команду&lt;/u&gt; и &lt;u&gt;записать результат&lt;/u&gt;. Любые 2 соседние операции могут выполняться одновременно (параллельно) обрабатывая 2 идущие друг за другом команды: когда выполняется 1-ая команда, интерпретатор может распознавать 2-ую.&lt;br /&gt;&lt;br /&gt;Чтобы конвейер работал, кто-то должен поставлять ему данные, а именно: последовательно перебирать строки в потоке, отправляя каждую из них на вход конвейеру. Как не сложно заметить, этот кто-то в том числе позаботится и о считывании команды – первой операции конвейера. На эту роль наилучшим образом подходит агент. Кстати, создавая разных агентов для разных входных потоков, можно совершенно бесплатно получить поддержку нескольких одновременных сессий.&lt;br /&gt;&lt;br /&gt;Финальное решение видеться следующим:  &lt;br /&gt;&lt;ul&gt;&lt;li&gt;основной поток исполнения (в данном случае – это основной поток приложения, в реальной жизни – это может быть поток, принявший соединение из сокета или что-то в этом роде) создаёт агента, передаёт ему входной поток данных и ожидает поступления результатов, чтобы отправить их на выход;  &lt;/li&gt;&lt;li&gt;агент перебирает строки во входном потоке и для каждой строки запускает конвейер, состоящий из 2-ух операций – распознавание команды и исполнение команды;  &lt;/li&gt;&lt;li&gt;результат выполнения команды c последнего шага конвейера передаётся асинхронно в основной поток, запустивший всю операцию, где он считывается и отправляется на выход.&lt;/li&gt;&lt;/ul&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;&lt;br /&gt;&lt;br /&gt;Решение&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Для начала определим базовый класс с интерфейсом для объектов-команд:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; command; &lt;br /&gt;&lt;span style="color: blue;"&gt;typedef&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;shared_ptr&lt;/span&gt;&amp;lt;command&amp;gt; command_ptr; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; command &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; ~command() { } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt;&amp;amp; name() &lt;span style="color: blue;"&gt;const&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; name_; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; command_ptr clone(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;arg) &lt;span style="color: blue;"&gt;const&lt;/span&gt; = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; execute() &lt;span style="color: blue;"&gt;const&lt;/span&gt; = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;;&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;protected&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;explicit&lt;/span&gt; command(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;name) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; : name_(name) { }&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;private&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; name_; &lt;br /&gt;};&lt;/div&gt;Обратите внимание на 2 чисто-виртуальных метода: &lt;em&gt;clone&lt;/em&gt; и &lt;em&gt;execute&lt;/em&gt;. Данный класс сочетает в себе сразу 2 стандартных шаблона проектирования из &lt;a href="http://en.wikipedia.org/wiki/Design_Patterns_(book)"&gt;каталога "банды четырёх"&lt;/a&gt;: &lt;a href="http://ooad.asf.ru/Pattern.aspx?IdKat=7&amp;amp;IdPat=30"&gt;&lt;em&gt;Prototype&lt;/em&gt;&lt;/a&gt; и &lt;a href="http://ooad.asf.ru/Pattern.aspx?IdKat=7&amp;amp;IdPat=33"&gt;&lt;em&gt;Command&lt;/em&gt;&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;Определим классы для команд &lt;em&gt;gettime&lt;/em&gt; и &lt;em&gt;echo&lt;/em&gt;:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: green;"&gt;// Usage: gettime [gmt]&lt;/span&gt; &lt;br /&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; get_time : &lt;span style="color: blue;"&gt;public&lt;/span&gt; command &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;const&lt;/span&gt; get_time SAMPLE;&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; command_ptr clone(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;arg) &lt;span style="color: blue;"&gt;const&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; command_ptr(&lt;span style="color: blue;"&gt;new&lt;/span&gt; get_time(arg)); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; execute() &lt;span style="color: blue;"&gt;const&lt;/span&gt;;&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;private&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;explicit&lt;/span&gt; get_time(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;arg = &lt;span style="color: maroon;"&gt;""&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; : command(&lt;span style="color: maroon;"&gt;"gettime"&lt;/span&gt;), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; gmt_(&lt;span style="color: maroon;"&gt;"gmt"&lt;/span&gt; == arg), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; bad_argument_(!gmt_ &amp;amp;&amp;amp; !arg.empty()) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;bool&lt;/span&gt; gmt_; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;bool&lt;/span&gt; bad_argument_; &lt;br /&gt;}; &lt;br /&gt;&lt;span style="color: blue;"&gt;const&lt;/span&gt; get_time get_time::SAMPLE; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// Usage: echo &amp;lt;text&amp;gt;&lt;/span&gt; &lt;br /&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; echo : &lt;span style="color: blue;"&gt;public&lt;/span&gt; command &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;const&lt;/span&gt; echo SAMPLE; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; command_ptr clone(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;arg) &lt;span style="color: blue;"&gt;const&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; command_ptr(&lt;span style="color: blue;"&gt;new&lt;/span&gt; echo(arg)); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; execute() &lt;span style="color: blue;"&gt;const&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; text_; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;private&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;explicit&lt;/span&gt; echo(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;arg = &lt;span style="color: maroon;"&gt;""&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; : command(&lt;span style="color: maroon;"&gt;"echo"&lt;/span&gt;), text_(arg) { } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; text_; &lt;br /&gt;}; &lt;br /&gt;&lt;span style="color: blue;"&gt;const&lt;/span&gt; echo echo::SAMPLE; &lt;/div&gt;&lt;br /&gt;Ещё нам понадобится класс представляющий собой &lt;em&gt;"ошибочную команду"&lt;/em&gt;, результатом исполнения которой будет сообщение об ошибке:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; bad_command : &lt;span style="color: blue;"&gt;public&lt;/span&gt; command &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; NAME; &lt;br /&gt;&lt;br /&gt;... &lt;br /&gt;};&lt;/div&gt;&lt;br /&gt;Теперь пришла пора заняться конвейером и агентом. В очередной раз я упрощу себе задачу и воспользуюсь возможностями &lt;a href="http://msdn.microsoft.com/en-us/library/dd492627.aspx"&gt;&lt;em&gt;Asynchronous Agents Library (AAL)&lt;/em&gt;&lt;/a&gt;. На этот раз, помимо уже известного класса &lt;em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/dd551463.aspx"&gt;Concurrency::agent&lt;/a&gt;&lt;/em&gt;, в построении конвейера мне помогут классы блоков сообщений: &lt;a href="http://msdn.microsoft.com/en-us/library/dd504833.aspx#transformer"&gt;&lt;em&gt;Concurrency::transformer&lt;/em&gt;&lt;/a&gt; и &lt;a href="http://msdn.microsoft.com/en-us/library/dd504833.aspx#unbounded_buffer"&gt;&lt;em&gt;Concurrency::unbounded_buffer&lt;/em&gt;&lt;/a&gt;. &lt;em&gt;"Блоки сообщений"&lt;/em&gt; могут сцепляться друг с другом образуя конвейер (для этого используются либо функций &lt;em&gt;link_target&lt;/em&gt; / &lt;em&gt;link_source&lt;/em&gt;, либо перегруженные версии конструкторов). Библиотека &lt;strong&gt;AAL&lt;/strong&gt; включает множество разнообразных блоков сообщений. Все они умеют принимать некоторые данные, обрабатывать их и отправлять результат стоящему за ними очередному блоку. Различия заключаются в способе обработки.&lt;br /&gt;&lt;br /&gt;Блок класса &lt;em&gt;transformer&lt;/em&gt; исполняет над полученными данными определённую при его конструировании функцию. Причём выполняется эта функция в отдельном потоке. Этот класс представляет собой шаблон, первый аргумент которого определяет тип данных, принимаемых блоком, второй – тип преобразованных данных, поступающих на выход. Блок класса &lt;em&gt;unbound_buffer&lt;/em&gt; принимает и хранит данные определённого типа.&lt;br /&gt;&lt;br /&gt;Итак, нам нужно определить агента, который будет содержать 2 сцепленных блока сообщений типа &lt;em&gt;Concurrency::transformer&lt;/em&gt;: один для функции &lt;em&gt;parse_command&lt;/em&gt;, другой для функции &lt;em&gt;run_command&lt;/em&gt;. К последнему блоку необходимо прицепить &lt;em&gt;Concurrency::unbound_buffer&lt;/em&gt;, для аккумулирования результата. Вот этот агент:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; command_processor : &lt;span style="color: blue;"&gt;public&lt;/span&gt; Concurrency::agent &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;typedef&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::map&amp;lt;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt;, &lt;span style="color: blue;"&gt;const&lt;/span&gt; command*&amp;gt; commands_dict; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// t_line::first - line&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// t_line::second - "end of file" flag&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;typedef&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::pair&amp;lt;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt;, &lt;span style="color: blue;"&gt;bool&lt;/span&gt;&amp;gt; t_line; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// t_command::first - command&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// t_command::second - "end of file" flag&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;typedef&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::pair&amp;lt;command_ptr, &lt;span style="color: blue;"&gt;bool&lt;/span&gt;&amp;gt; t_command; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;explicit&lt;/span&gt; command_processor(&lt;span style="color: blue;"&gt;std&lt;/span&gt;::istream &amp;amp;input); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; ~command_processor() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::agent::wait(&lt;span style="color: blue;"&gt;this&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;void&lt;/span&gt; register_command( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; &amp;amp;name, &lt;span style="color: blue;"&gt;const&lt;/span&gt; command *cmd) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; COMMANDS[name] = cmd; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; read(&lt;span style="color: blue;"&gt;bool&lt;/span&gt; &amp;amp;next) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Read results from output_.&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// This operation blocks a thread if output_ is empty.&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::pair&amp;lt;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt;, &lt;span style="color: blue;"&gt;bool&lt;/span&gt;&amp;gt; out =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::receive(output_); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; next = out.second; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; out.first; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;protected&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;void&lt;/span&gt; run(); &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;private&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt; t_line run_command(&lt;span style="color: blue;"&gt;const&lt;/span&gt; t_command &amp;amp;command); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt; t_command parse_command(&lt;span style="color: blue;"&gt;const&lt;/span&gt; t_line &amp;amp;line); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;static&lt;/span&gt; commands_dict COMMANDS; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::istream &amp;amp;input_; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// receive: t_line&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::unbounded_buffer&amp;lt;t_line&amp;gt; output_; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// receive: t_comand; send: t_line - result&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::transformer&amp;lt;t_command, t_line&amp;gt; runner_; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// receive: t_line - unparsed command; send: t_command&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::transformer&amp;lt;t_line, t_command&amp;gt; parser_; &lt;br /&gt;}; &lt;br /&gt;&lt;br /&gt;command_processor::command_processor(&lt;span style="color: blue;"&gt;std&lt;/span&gt;::istream &amp;amp;input) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; : input_(input), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// the output buffer:&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; output_(), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// the run step is linked with the output buffer:&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; runner_(run_command, &amp;amp;output_), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// the execute step is linked with the run step:&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; parser_(parse_command, &amp;amp;runner_) &lt;br /&gt;{ } &lt;/div&gt;&lt;br /&gt;Наибольший интерес в этом классе представляет декларация объектов &lt;em&gt;runner_&lt;/em&gt; и &lt;em&gt;parser_&lt;/em&gt; и их инициализация в конструкторе, приводящая к образованию конвейера.&lt;br /&gt;&lt;br /&gt;Агент принимает входные данные в конструкторе в виде текстового потока. Считывание и разбор на строки осуществляется в методе run, после чего каждая строка отправляется на начало конвейера – объект parser_ – с помощью функции Concurrency::asend:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;void&lt;/span&gt; command_processor::run() &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; line; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;do&lt;/span&gt;&amp;nbsp; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;char&lt;/span&gt; ch = L&lt;span style="color: maroon;"&gt;'\0'&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; input_.get(ch); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (ch == &lt;span style="color: maroon;"&gt;'\n'&lt;/span&gt; || input_.eof()) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// send line to parser&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; t_line new_line = &lt;span style="color: blue;"&gt;std&lt;/span&gt;::make_pair( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line, !input_.eof()); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::asend( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; parser_, new_line); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line.clear(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;else&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;if&lt;/span&gt; (input_.good()) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line += ch; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;else&lt;/span&gt; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// send "bad command" to parser and stop processing&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; t_line abort_line = &lt;span style="color: blue;"&gt;std&lt;/span&gt;::make_pair( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; bad_command::NAME, false); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::asend( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; parser_, abort_line); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;while&lt;/span&gt; (input_ != &lt;span style="color: maroon;"&gt;0&lt;/span&gt;); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; done(); &lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Каждый из методов parse_command и run_command просто преобразует поступающие на вход данные. При этом ни один из них не содержит никакой специфики многопоточной обработки данных. Каждый из этих методов может быть вызван в однопоточном окружении, например для целей отладки и юнит-тестирования:  &lt;br /&gt;&lt;div class="sourcecode"&gt;command_processor::t_command &lt;br /&gt;command_processor::parse_command( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; command_processor::t_line &amp;amp;line) &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// detect the command's name&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; size_t pos = line.first.find_first_of(&lt;span style="color: maroon;"&gt;" \t"&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; name = line.first.substr(&lt;span style="color: maroon;"&gt;0&lt;/span&gt;, pos); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// detect the command's arguments&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; pos = line.first.find_first_not_of(&lt;span style="color: maroon;"&gt;" \t"&lt;/span&gt;, pos); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt; arg = &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt;::&lt;span style="color: blue;"&gt;npos&lt;/span&gt; == pos &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ? &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;string&lt;/span&gt;() : line.first.substr(pos); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// get the command object&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; commands_dict::const_iterator it = COMMANDS.find(name); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (COMMANDS.end() != it) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::make_pair( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; it-&amp;gt;second-&amp;gt;clone(arg), line.second); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// bad command&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::make_pair( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; command_ptr(&lt;span style="color: blue;"&gt;new&lt;/span&gt; bad_command(line.first)), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line.second); &lt;br /&gt;} &lt;br /&gt;&lt;br /&gt;command_processor::t_line &lt;br /&gt;command_processor::run_command( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; command_processor::t_command &amp;amp;command) &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::make_pair( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; command.first-&amp;gt;execute(), command.second); &lt;br /&gt;} &lt;/div&gt;&lt;br /&gt;И завершающий аккорд –&amp;nbsp;инициализация агента и вывод результата в теле основного потока приложения: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: green;"&gt;// open file stream&lt;/span&gt; &lt;br /&gt;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;ifstream&lt;/span&gt; data; &lt;br /&gt;data.exceptions(&lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;ios&lt;/span&gt;::badbit); &lt;br /&gt;data.open(filename); &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// register all known commands&lt;/span&gt; &lt;br /&gt;command_processor::register_command( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; get_time::SAMPLE.name(), &amp;amp;get_time::SAMPLE); &lt;br /&gt;command_processor::register_command( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; echo::SAMPLE.name(), &amp;amp;echo::SAMPLE); &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// start&lt;/span&gt; &lt;br /&gt;command_processor processor(data); &lt;br /&gt;processor.start(); &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// read result and write into console&lt;/span&gt; &lt;br /&gt;&lt;span style="color: blue;"&gt;bool&lt;/span&gt; next; &lt;br /&gt;&lt;span style="color: blue;"&gt;do&lt;/span&gt; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; processor.read(next) &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;} &lt;span style="color: blue;"&gt;while&lt;/span&gt; (next);&lt;/div&gt;&lt;br /&gt;Полный код приложения можно скачать &lt;a href="http://dl.dropbox.com/u/26827843/BlogFiles/DataFlow.zip"&gt;здесь&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Критика&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Внимательный читатель мог заметить одно узкое место данного подхода. Если какой-то элемент конвейера начнёт длительную обработку данных или уснёт в ожидание ресурса, то весь конвейер встанет. Очевидно, что для таких случаев Data Flow подход в чистом виде совершенно не годится. Придётся совмещать различные техники и идти на компромиссы. К сожалению строгого рецепта для такого смешения не существует.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/10/data-flow_24.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/493042754671777293'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/493042754671777293'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/10/data-flow_24.html' title='Data Flow, или Данные управляют командами. Практика'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-9023059761508857339</id><published>2011-10-03T09:30:00.000+07:00</published><updated>2011-10-24T12:12:03.242+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>Data Flow, или Данные управляют командами. Теория</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Заметку про &lt;a href="http://mrnone.blogspot.com/2011/09/blog-post_14.html"&gt;асинхронных агентов&lt;/a&gt; я начал с описания недостатка модели рабочих элементов. Поэтому, чтобы сохранить традицию, заметку о &lt;strong&gt;Data Flow&lt;/strong&gt; я начну с критики агентов. А что, вы серьёзно ожидали, что таковой не будет?&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Когда традиционные модели не могут…&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Главным достоинством агентов называлась возможность организации сложных взаимодействий и настройки зависимостей. Но что, если эти зависимости слишком строгие?&lt;br /&gt;&lt;br /&gt;Рассмотрим следующий пример. Допустим, вы разрабатываете некоторый командный интерпретатор. Ему на вход поступает последовательный поток команд в текстовой форме. Команды отделены друг от друга символом перевода строки. Интерпретатор должен распознать команду, выполнить её и записать результат выполнения в выходной поток. Большинство программистов поступит традиционно: они создадут агента, который будет принимать на вход очередную строку (выше мы договорились, что одна строка – одна команда), распознавать команду, выполнять её и отправлять результат на выход. Другой агент будет считывать строки из входного потока данных и порождать агентов-исполнителей.&lt;br /&gt;&lt;br /&gt;&lt;div class="separator" style="clear: both; text-align: center;"&gt;&lt;a href="http://3.bp.blogspot.com/-EpJWqccdLiM/ToiFvOKC8ZI/AAAAAAAAAJQ/1Shgwk5_RPA/s1600/workitems.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"&gt;&lt;img border="0" src="http://3.bp.blogspot.com/-EpJWqccdLiM/ToiFvOKC8ZI/AAAAAAAAAJQ/1Shgwk5_RPA/s1600/workitems.png" /&gt;&lt;/a&gt;&lt;/div&gt;Но постойте, если команды поступают последовательно в определённом порядке, то клиент, выдавший их, ожидает, что ответы будут поступать в том же самом порядке: результат выполнения первой команды должен появиться в выходном потоке первым, результат второй команды – вторым и так далее. Выходит, что агент-исполнитель не может отправить результат выполнения команды на выход, когда ему вздумается. Как минимум он должен синхронизировать свои действия с остальными агентами. Подобная синхронизация сама по себе приводит к тому, что все агенты выстраиваются в очередь и начинают &lt;u&gt;последовательно по одному&lt;/u&gt; отправлять результат на выход. При этом одной синхронизации не достаточно – она лишь решает задачу атомарности записи результата одним агентом, чтобы гарантировать корректный порядок мы должны ввести очерёдность команд и так далее и тому подобное. При этом мы не учли возможность зависимости команд друг от друга. &lt;u&gt;Многопоточное&lt;/u&gt; ли получилось в этом случае приложение? Однозначно – ДА! А вот &lt;u&gt;многозадачное&lt;/u&gt; ли?… Скорее - нет…&lt;br /&gt;&lt;br /&gt;На самом деле я немного слукавил в начале, сказав про критику агентов. Данная проблема характерна для любой классической модели многопоточной разработки. Она носит название &lt;em&gt;Lock Convoys&lt;/em&gt; – это ситуация, при которой потоки выстраиваются в очередь на одной взаимоисключающей блокировке. А при реализации вышеозначенного интерпретатора, агента можно легко заменить рабочим элементом, чтобы получить ровно такую же ошибку.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Развернём разум на 90 градусов&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Разрешите представить: модель &lt;em&gt;Data Flow&lt;/em&gt; или &lt;em&gt;конвейер обработки&lt;/em&gt;. Чтобы её понять и увидеть параллельность, нужно начать мыслить чуть-чуть по иному. Эта модель предписывает разбивать крупную задачу со всеми внутренними зависимостями на мелкие, таким образом, чтобы каждая подзадача зависела от предыдущей только входными данными. Выстроив подзадачи одну за другой, вы получаете &lt;u&gt;последовательный&lt;/u&gt; конвейер обработки данных. Каждый узел конвейера (задача) запускается только при поступлении на вход всех необходимых данных, он обрабатывает их совершенно независимо и передаёт на вход следующему узлу.&lt;br /&gt;&lt;br /&gt;А где же параллельность, спросит читатель, если данные обрабатываются &lt;u&gt;последовательно&lt;/u&gt;? Всё очень просто. Если каждый узел конвейера запускать в отдельном потоке, то на вход конвейеру данные можно подавать непрерывно. В этом случае каждый узел в любой момент времени будет обрабатывать некоторую порцию данных. Просто для разных узлов это будут разные данные.&lt;br /&gt;&lt;br /&gt;Возвращаясь к примеру с командным интерпретатором, мы можем выделить следующие узлы конвейера: &lt;br /&gt;&lt;ol&gt;&lt;li&gt;&lt;em&gt;узел-читатель&lt;/em&gt; – считывает очередную строку;&lt;/li&gt;&lt;li&gt;&lt;em&gt;узел-парсер&lt;/em&gt; – выполняет разбор строки и формирует объект-команду;&lt;/li&gt;&lt;li&gt;&lt;em&gt;узел-исполнитель&lt;/em&gt; – исполняет команду, поступившую ему на вход в виде объекта, и отправляет результат дальше по конвейеру;&lt;/li&gt;&lt;li&gt;&lt;em&gt;узел-писатель&lt;/em&gt; – записывает в выходной поток результат, поступивший ему от предыдущего узла.&lt;/li&gt;&lt;/ol&gt;&lt;table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style="text-align: center;"&gt;&lt;a href="http://1.bp.blogspot.com/-MUelO9OEwP4/ToiHc9GvZRI/AAAAAAAAAJU/ddamZhCtIKY/s1600/dataflow.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"&gt;&lt;img border="0" src="http://1.bp.blogspot.com/-MUelO9OEwP4/ToiHc9GvZRI/AAAAAAAAAJU/ddamZhCtIKY/s1600/dataflow.png" /&gt;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class="tr-caption" style="text-align: center;"&gt;Командный интерпретатор, выполненный в&amp;nbsp;аржитектуре Data Flow&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;br /&gt;В результате такого представления нашей задачи мы, с одной стороны, остались в рамках многопоточной реализации: пока &lt;em&gt;узел-исполнитель&lt;/em&gt; обрабатывает очередную команду, &lt;em&gt;узел-парсер&lt;/em&gt; разбирает следующую строку, а в это время &lt;em&gt;узел-писатель&lt;/em&gt; записывает результат обработки предыдущей команды. С другой стороны, обрабатывая команды последовательно (хоть и параллельно &lt;img border="0" src="http://4.bp.blogspot.com/-n7uFgfAuLOI/Tl6HEBri66I/AAAAAAAAAI8/UubijpeWBAs/s1600/smile.png" /&gt;), мы добились последовательного вывода результатов без блокировок, очередей и дополнительных буферов. Тем самым упростили код и избавились от дорогих операций ожидания. Более того, мы ещё и решили проблему зависимости команд друг от друга. По-моему здорово.&lt;br /&gt;&lt;br /&gt;&lt;div style="text-align: right;"&gt;&lt;a href="http://mrnone.blogspot.com/2011/10/data-flow_24.html"&gt;Продолжение следует…&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/10/data-flow.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/9023059761508857339'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/9023059761508857339'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/10/data-flow.html' title='Data Flow, или Данные управляют командами. Теория'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author><media:thumbnail xmlns:media='http://search.yahoo.com/mrss/' url='http://3.bp.blogspot.com/-EpJWqccdLiM/ToiFvOKC8ZI/AAAAAAAAAJQ/1Shgwk5_RPA/s72-c/workitems.png' height='72' width='72'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-284730263263096821</id><published>2011-09-14T09:30:00.000+07:00</published><updated>2011-10-03T11:55:10.566+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='C++'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>Агент Асинхронность, ваш выход!</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;В &lt;a href="http://mrnone.blogspot.com/2011/09/blog-post.html"&gt;предыдущей заметке&lt;/a&gt; я постарался объяснить, почему попытка решить задачу распараллеливания "в лоб" может потерпеть фиаско. И рассказал о модели рабочих элементов – самом распространённом паттерне параллельного мира, призванном эффективно решать задачу масштабирования. Пришла пора поговорить о его недостатке...&lt;br /&gt;&lt;div&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Независимость – это когда от тебя ничего не зависит...&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Подход, связанный с разбиение многопоточного приложения на &lt;em&gt;задачи&lt;/em&gt;, прекрасно работает ровно до тех пор, пока задачи более-менее не зависимы друг от друга. Но, как только возникнет необходимость организовать взаимодействие между &lt;em&gt;рабочими элементами&lt;/em&gt;, вы столкнётесь с проблемой. Точно с такой же проблемой в своё время столкнулись программисты древности, использовавшие парадигму &lt;em&gt;процедурного программирования&lt;/em&gt;. Это не что иное, как проблема связывания данных с функциями. Ответом на этот вызов явился &lt;em&gt;объектно-ориентированный подход&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;По аналогии с классическими парадигмами программирования, можно сказать, что модель рабочих элементов является процедурным подходом в разработке многопоточных приложений. Решить его проблемы призвана &lt;em&gt;модель асинхронных агентов&lt;/em&gt; (или &lt;em&gt;модель актёров&lt;/em&gt;) – &lt;em&gt;объектно-ориентированная парадигма&lt;/em&gt; параллельного мира.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Поручите работу агентам.&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Асинхронный агент или актёр – это объект. Любой агент реализует ровно одну задачу. При этом все вычисления в рамках этой задачи осуществляются в отдельном потоке (который, как водится, предоставляется агенту из пула во временное пользование). В процессе выполнения задачи агент может менять своё внутреннее состояние, сосредоточенное в полях данных. Внешние наблюдатели через вызов публичных методов агента могут запрашивать его состояние или отправлять ему сообщения, влияющие на вычисления. Любой публичный метод агента умеет либо возвращать внутреннее состояние, либо передавать данные выполняющейся задаче (некоторые методы совмещают обе эти функции): &lt;u&gt;ни один публичный метод не выполняет никаких вычислений&lt;/u&gt;. Задача, реализуемая агентом, может быть как конечной (в этом случае агент может перейти из состояния "&lt;em&gt;запущен&lt;/em&gt;" в состояние "&lt;em&gt;завершён&lt;/em&gt;"), так и выполняемой непрерывно (в этом случае задача завершается принудительно, например, при уничтожении агента).&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Тяжело в учении, легко на работе...&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Иногда бывает проще воспринимать подобные вещи, глядя на реальный пример. Поэтому чтобы проиллюстрировать сказанное, я реализую паттерн "&lt;strong&gt;Producer / Consumer&lt;/strong&gt;" с помощью асинхронных агентов. Если кто забыл, то суть этого паттерна заключается в разнесении по разным потокам поставщика (&lt;em&gt;Producer&lt;/em&gt;`а) и потребителя (&lt;em&gt;Consumer&lt;/em&gt;`а) данных. Я не буду реализовывать инфраструктуру асинхронных агентов с нуля, а воспользуюсь возможностями &lt;a href="http://msdn.microsoft.com/en-us/library/dd492627.aspx"&gt;&lt;em&gt;Asynchronous Agents Library (AAL)&lt;/em&gt;&lt;/a&gt;, поставляющейся вместе с &lt;strong&gt;MS Visual Studio 2010&lt;/strong&gt;. В качестве эксперимента я решу таким мудрёным способом простую задачу подсчёта числа слов в текстовом файле.&lt;br /&gt;&lt;br /&gt;Агент &lt;em&gt;Producer&lt;/em&gt; будет считывать данные из переданного ему текстового файла и построчно передавать их объекту &lt;em&gt;Consumer&lt;/em&gt;`у, который будет подсчитывать число слов в очередной строке (для простоты примем, что файл не содержит переносов слов).&lt;br /&gt;&lt;br /&gt;Для начала определим интерфейс &lt;em&gt;Consumer&lt;/em&gt;`а:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; i_lines_processor &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; ~i_lines_processor() { } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;void&lt;/span&gt; submit_line(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::wstring &amp;amp;) = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;void&lt;/span&gt; complete() = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;}; &lt;/div&gt;&lt;em&gt;Producer&lt;/em&gt; будет вызывать метод &lt;em&gt;submit_line&lt;/em&gt; для каждой очередной прочитанной строки и завершит обработку вызовом метода &lt;em&gt;complete&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Реализация агента &lt;em&gt;Producer&lt;/em&gt;`а (или &lt;em&gt;reader&lt;/em&gt;`а в данном случае) весьма тривиальна:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; reader_agent : &lt;span style="color: blue;"&gt;public&lt;/span&gt; Concurrency::agent &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; reader_agent( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wistream &amp;amp;input, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; i_lines_processor &amp;amp;processor) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; : input_(input), processor_(processor) { } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; ~reader_agent() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::agent::wait(&lt;span style="color: blue;"&gt;this&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;protected&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;void&lt;/span&gt; run() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wstring line; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;do&lt;/span&gt;&amp;nbsp; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;wchar_t&lt;/span&gt; ch = L&lt;span style="color: maroon;"&gt;'\0'&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; input_.get(ch); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (ch == L&lt;span style="color: maroon;"&gt;'\n'&lt;/span&gt; || input_.eof()) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; processor_.submit_line(line); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line.clear(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;else&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;if&lt;/span&gt; (input_.good()) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line += ch; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;while&lt;/span&gt; (input_ != &lt;span style="color: maroon;"&gt;0&lt;/span&gt;); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; processor_.complete(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; done(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;private&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wistream &amp;amp;input_; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; i_lines_processor &amp;amp;processor_; &lt;br /&gt;};&lt;/div&gt;&lt;br /&gt;Самым интересным в этом коде является наследование от класса &lt;em&gt;Concurrency::agent&lt;/em&gt; и реализация метода &lt;em&gt;run&lt;/em&gt;. Это и есть простейшая реализация асинхронного агента с помощью &lt;strong&gt;AAL&lt;/strong&gt;. Как несложно догадаться метод &lt;em&gt;run&lt;/em&gt; как раз и содержит все вычисления, которые будут производиться асинхронно.&lt;br /&gt;&lt;br /&gt;Теперь можно реализовать &lt;em&gt;Consumer&lt;/em&gt;`а данных, в данном примере его я назвал просто &lt;em&gt;counter&lt;/em&gt;`ом:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;class&lt;/span&gt; counter_agent : &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;public&lt;/span&gt; i_lines_processor, &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;public&lt;/span&gt; Concurrency::agent &lt;br /&gt;{ &lt;br /&gt;&lt;span style="color: blue;"&gt;public&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt; ~counter_agent() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::agent::wait(&lt;span style="color: blue;"&gt;this&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;void&lt;/span&gt; submit_line(&lt;span style="color: blue;"&gt;const&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::wstring &amp;amp;line) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// send a new line into the agent's body&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::send(lines_, line + L&lt;span style="color: maroon;"&gt;"\n"&lt;/span&gt;); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;virtual&lt;/span&gt;&amp;nbsp;&lt;span style="color: blue;"&gt;void&lt;/span&gt; complete() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// 3 line fides will indicate the end of file&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::send(lines_, &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wstring(L&lt;span style="color: maroon;"&gt;"\n\n\n"&lt;/span&gt;)); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;int&lt;/span&gt; get_count() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// obtain the result&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; Concurrency::receive(count_); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;protected&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;void&lt;/span&gt; run() &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wstring line; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;int&lt;/span&gt; count = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// obtain the next line&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;while&lt;/span&gt; ((line = Concurrency::receive(lines_)) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; != L&lt;span style="color: maroon;"&gt;"\n\n\n"&lt;/span&gt;) &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;int&lt;/span&gt; word_size = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::for_each( &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; line.begin(), line.end(), &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; [&amp;amp;] (&lt;span style="color: blue;"&gt;wchar_t&lt;/span&gt; ch) { &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;int&lt;/span&gt; code = &lt;span style="color: blue;"&gt;std&lt;/span&gt;::char_traits&amp;lt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;wchar_t&lt;/span&gt;&amp;gt;::to_int_type(ch); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (iswalnum(code)) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; word_size++; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;else&lt;/span&gt; { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (word_size != &lt;span style="color: maroon;"&gt;0&lt;/span&gt;) { &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; count++; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; word_size = &lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// send result to reader&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::send(count_, count); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; done(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;private&lt;/span&gt;: &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// received lines&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::unbounded_buffer&amp;lt;&lt;span style="color: blue;"&gt;std&lt;/span&gt;::wstring&amp;gt; lines_; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// result&lt;/span&gt; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Concurrency::single_assignment&amp;lt;&lt;span style="color: blue;"&gt;int&lt;/span&gt;&amp;gt; count_; &lt;br /&gt;};&lt;/div&gt;&lt;br /&gt;В данном классе следует обратить внимание на операции по синхронизации данных в поток агента и возврату результата из него: функции &lt;em&gt;Concurrency::send&lt;/em&gt; и &lt;em&gt;Concurrency::receive&lt;/em&gt;, а также классы инкапсулирующие данные – &lt;em&gt;Concurrency::unbounded_buffer&lt;/em&gt; и &lt;em&gt;Concurrency::single_assignment&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Осталось добавить необходимые заголовки:  &lt;br /&gt;&lt;div class="sourcecode"&gt;#&lt;span style="color: blue;"&gt;include&lt;/span&gt; &amp;lt;agents.h&amp;gt; &lt;br /&gt;&lt;br /&gt;#&lt;span style="color: blue;"&gt;include&lt;/span&gt; &amp;lt;algorithm&amp;gt; &lt;br /&gt;#&lt;span style="color: blue;"&gt;include&lt;/span&gt; &amp;lt;cwchar&amp;gt; &lt;br /&gt;#&lt;span style="color: blue;"&gt;include&lt;/span&gt; &amp;lt;fstream&amp;gt; &lt;br /&gt;#&lt;span style="color: blue;"&gt;include&lt;/span&gt; &amp;lt;iostream&amp;gt; &lt;br /&gt;#&lt;span style="color: blue;"&gt;include&lt;/span&gt; &amp;lt;string&amp;gt;&lt;/div&gt;&lt;br /&gt;И добавить код запускающий агентов:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;int&lt;/span&gt; _tmain(&lt;span style="color: blue;"&gt;int&lt;/span&gt; argc, _TCHAR* argv[]) &lt;br /&gt;{ &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wifstream data; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; data.exceptions(&lt;span style="color: blue;"&gt;std&lt;/span&gt;::ios::badbit); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; data.open(&lt;span style="color: maroon;"&gt;"bigtest.txt"&lt;/span&gt;); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; counter_agent counter; &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; reader_agent reader(data, counter); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; counter.start(); &lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; reader.start(); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::wcout &amp;lt;&amp;lt; counter.get_count() &amp;lt;&amp;lt; &lt;span style="color: blue;"&gt;std&lt;/span&gt;::&lt;span style="color: blue;"&gt;endl&lt;/span&gt;; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt;&amp;nbsp;&lt;span style="color: maroon;"&gt;0&lt;/span&gt;; &lt;br /&gt;} &lt;/div&gt;&lt;br /&gt;Если вы теперь скомпилируете этот код и запустите на процессоре с несколькими ядрами, вы сможете наблюдать, как ваше приложение загрузит сразу 2 ядра на 100%.&lt;br /&gt;&lt;div style="text-align: right;"&gt;&lt;br /&gt;&lt;a href="http://mrnone.blogspot.com/2011/10/data-flow.html"&gt;Продолжение следует...&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html' title='Агент Асинхронность, ваш выход!'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-743359487197980193</id><published>2011-09-01T10:00:00.003+07:00</published><updated>2011-10-03T11:54:51.374+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><category scheme='http://www.blogger.com/atom/ns#' term='C++'/><category scheme='http://www.blogger.com/atom/ns#' term='Multithreading'/><title type='text'>Сделайте мне параллельно</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Мир изменился – закон Мура перестал работать. Производители чипов более не могут увеличивать тактовую частоту процессоров с такой интенсивностью, с которой они это делали в конце 90-ых. Чтобы удовлетворить всё нарастающие аппетиты индустрии в новых мощностях, они вынуждены пойти по пути наращивания числа ядер. Для программиста этот путь означает следующее: если раньше он мог быть абсолютно уверен, что через полгода на новом процессоре даже без усилий с его стороны приложение будет работать в разы быстрее, то теперь, если он не позаботится заранее о хорошей степени параллелизма своего приложения, замена процессора на более новый не приведёт к росту производительности. Так как же добиться правильного параллелизма – об этом и поговорим в этот раз.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Алгоритмический параллелизм. Вы уверены?…&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Мой первый реальный опыт в написании многопоточного приложения был связан с разработкой какой-то казуальной игрушки. Она немного подтормаживала, поэтому пришла идея – разбить её на 2 потока: один поток должен был обсчитывать логику, второй отрисовывать графику. Тогда это действительно помогло. Этот метод называется алгоритмическим распараллеливанием. Большинство программистов в то время делало точно также, многие продолжают делать и сейчас.&lt;br /&gt;&lt;br /&gt;Так чем же плох данный способ? – Тем же самым! Какая разница: один поток или два, если их число фиксировано и постоянно – увеличение числа ядер не приведёт к росту производительности. Одним из важнейших критериев хорошего многозадачного приложения является &lt;strong&gt;масштабируемость&lt;/strong&gt;, то есть способность исполняться на стольких процессорах (или ядрах), сколько ему предложат. Очевидно, что приложение с фиксированным количеством потоков не удовлетворяет этому критерию.&lt;br /&gt;&lt;br /&gt;Идея распараллелить алгоритм приходит в голову программиста самой первой. И человечество даже знает целых 2 алгоритма, которые распараллеливаются с хорошей степенью масштабируемости: перемножение матриц и быстрая сортировка…&lt;br /&gt;&lt;br /&gt;Естественно это был &lt;a href="https://picasaweb.google.com/lh/photo/Z9YydObDe6-tqvZliueifAntgGSpbgRAYId1rxu57gs?feat=directlink"&gt;сарказм&lt;/a&gt;, и таких алгоритмов чуть больше, но на оттачивание каждого из них ушли годы, и по каждому из них было написано пара докторских диссертаций. В промышленной разработке всё чуть более приземлённее: у вас не бывает столько времени (если только вы не работаете в &lt;strong&gt;Google&lt;/strong&gt; &lt;img border="0" src="http://4.bp.blogspot.com/-n7uFgfAuLOI/Tl6HEBri66I/AAAAAAAAAI8/UubijpeWBAs/s1600/smile.png" /&gt;) – вы должны принять решение и закодировать результат за несколько дней. Поэтому к услугам алгоритмического параллелизма вы обращаетесь лишь тогда, когда у вас возникает необходимость в использовании подобного готового алгоритма. Например, если ваш алгоритм включает цикл с независимыми шагами, то вы смело можете применять параллельный цикл. Для этого вы можете воспользоваться алгоритмами &lt;em&gt;parallel_for&lt;/em&gt; или &lt;em&gt;parallel_for_each&lt;/em&gt; из &lt;a href="http://msdn.microsoft.com/en-us/library/dd492418.aspx"&gt;&lt;em&gt;Parallel Patterns Library&lt;/em&gt;&lt;/a&gt;, если пишете на C++, или задействовать статические методы &lt;em&gt;For&lt;/em&gt; и &lt;em&gt;ForEach&lt;/em&gt; класса &lt;a href="http://msdn.microsoft.com/ru-ru/library/system.threading.tasks.parallel.aspx"&gt;&lt;em&gt;System.Threading.Tasks.Parallel&lt;/em&gt;&lt;/a&gt; в приложении на &lt;strong&gt;.NET&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Пулы и задачи – рабочие лошадки параллельного мира&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Концепция задач или рабочих элементов является самой распространённой моделью построения многопоточного приложения. В её основе лежит следующая идея: если представить приложение как множество многократно повторяемых слабо-зависимых процедур, то каждую из этих процедур можно выполнить в отдельном потоке. Реализовать такой подход гораздо проще, чем придумать эффективный параллельный алгоритм, потому что каждая из этих процедур может выполнять свой достаточно сложный блок функциональности.&lt;br /&gt;&lt;br /&gt;Процедуры, на которые разбивается приложение, носят название &lt;em&gt;задач&lt;/em&gt; или &lt;em&gt;рабочих элементов&lt;/em&gt;. Их количество в приложении никак не зависит от числа доступных процессоров или ядер. Просто, когда возникает необходимость, вы передаёте очередную сформированную задачу в очередь исполнения. Задачи извлекаются из этой очереди одна за другой в порядке поступления и обрабатываются в параллельных потоках (как правило, потоки извлекаются из специального пула и возвращаются в него обратно, после завершения обработки очередной задачи). Причём количество одновременно обрабатываемых задач (количество потоков в пуле) зависит от числа доступных процессоров. Таким нехитрым способом достигается желанная масштабируемость.&lt;br /&gt;&lt;br /&gt;Идеально, если разбиение на задачи обусловлено обработкой некоторых входных данных. Например, в случае платёжной системы, типичным кандидатом на вынесение в отдельную задачу является процедура обработки денежной транзакции. В этом случае увеличение числа ядер приведёт к увеличению одновременно обрабатываемых транзакций, что означает увеличение общей производительности системы.&lt;br /&gt;&lt;br /&gt;На уровне &lt;strong&gt;Win32 API&lt;/strong&gt; концепция пулов и задач доступна для использования как &lt;a href="http://msdn.microsoft.com/en-us/library/ms686766(VS.85).aspx"&gt;&lt;strong&gt;Thread Pool API&lt;/strong&gt;&lt;/a&gt;. Если вы пишите на C++, то можете обратиться к &lt;a href="http://msdn.microsoft.com/en-us/library/dd492427.aspx"&gt;возможностям по управлению задачами&lt;/a&gt; из уже упомянутой &lt;a href="http://msdn.microsoft.com/en-us/library/dd492418.aspx"&gt;&lt;em&gt;Parallel Patterns Library&lt;/em&gt;&lt;/a&gt;. В случае &lt;strong&gt;.NET&lt;/strong&gt; приложения аналогичные возможности вам предоставляет класс &lt;a href="http://msdn.microsoft.com/ru-ru/library/system.threading.tasks.task.aspx"&gt;&lt;em&gt;System.Threading.Tasks.Task&lt;/em&gt;&lt;/a&gt;, кстати, его неплохое описание можно найти в &lt;strong&gt;MSDN Magazine&lt;/strong&gt; в статье &lt;a href="http://msdn.microsoft.com/ru-ru/magazine/ff959203.aspx"&gt;"Упрощение асинхронного программирования с помощью задач"&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;&lt;div style="text-align: right;"&gt;Продолжение (&lt;a href="http://mrnone.blogspot.com/2011/09/blog-post_14.html"&gt;асинхронные агенты&lt;/a&gt; и &lt;a href="http://mrnone.blogspot.com/2011/10/data-flow.html"&gt;data flow&lt;/a&gt;) следует...&lt;/div&gt;&lt;div align="left" style="text-align: right;"&gt;&lt;br /&gt;&lt;/div&gt;&lt;div style="text-align: left;"&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/743359487197980193'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/743359487197980193'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post.html' title='Сделайте мне параллельно'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author><media:thumbnail xmlns:media='http://search.yahoo.com/mrss/' url='http://4.bp.blogspot.com/-n7uFgfAuLOI/Tl6HEBri66I/AAAAAAAAAI8/UubijpeWBAs/s72-c/smile.png' height='72' width='72'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-4293926312325761664</id><published>2011-08-08T09:00:00.001+07:00</published><updated>2011-08-08T09:00:00.908+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Active Directory'/><title type='text'>Подводный камни Active Directory: версионность объектов, как она есть</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Если вы решаете задачу синхронизации объектов в &lt;strong&gt;Active Directory&lt;/strong&gt; или просто следите за их изменениями для иных нужд, то в какой-то момент времени вам непременно придёт в голову &lt;em&gt;"гениальная"&lt;/em&gt; идея: постойте, &lt;strong&gt;AD&lt;/strong&gt; просто обязана содержать встроенный механизм версионности объектов, почему бы не воспользоваться им для оптимизации поиска изменившихся объектов?&lt;br /&gt;&lt;br /&gt;&lt;div&gt;&lt;a name='more'&gt;&lt;/a&gt;Быстрый поиск в Интернете даст утвердительный ответ на ваше предположение. Так и есть: контроль версионности объектов в &lt;strong&gt;Active Directory&lt;/strong&gt; реализуется через значение целочисленного атрибута &lt;em&gt;uSNChanged&lt;/em&gt;. И реализуется он вот таким нехитрым способом: контроллер домена изменяет значение этого свойства при любом изменении объекта. Причём новое значение всегда больше предыдущего и больше текущих значений этого атрибута всех остальных объектов, контролируемых этим контроллером домена.&lt;br /&gt;&lt;br /&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;Тот, кто прочитал больше одной заметки с передовой, знает, что практически у любой темы есть своё &lt;strong&gt;НО&lt;/strong&gt;. Этот случай – не исключение. Большинство описаний атрибута &lt;em&gt;uSNChanged&lt;/em&gt; в Интернете не упоминают того факта, что он &lt;u&gt;не реплицируемый&lt;/u&gt;. Каждый контроллер домена содержит свою уникальную версию атрибута &lt;em&gt;uSNChanged&lt;/em&gt; для каждого объекта! Поэтому сравнивать между собой можно лишь значения этого атрибута, полученные в разное время, но с одного и того же контроллера домена.&lt;br /&gt;&lt;br /&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;Итак, если вам понадобится следить за версионностью объектов в &lt;strong&gt;Active Directory&lt;/strong&gt; и выбирать лишь те объекты, которые были изменены со времени последнего сравнения, поступайте следующим образом:&lt;br /&gt;&lt;ol style="text-align: left;"&gt;&lt;li&gt;При первом запуске извлеките из объекта &lt;em&gt;rootDSE&lt;/em&gt; и запомните имя связанного контроллера домена и значение атрибута &lt;em&gt;highestCommittedUSN&lt;/em&gt; – это максимальное на текущий момент значение &lt;em&gt;uSNChanged&lt;/em&gt; для данного контроллера.&lt;/li&gt;&lt;li&gt;При последующих запусках используйте имя контроллера домена из &lt;em&gt;rootDSE&lt;/em&gt; для поиска в вашем хранилище предыдущего максимального значения &lt;em&gt;uSNChanged&lt;/em&gt;. Если такое не обнаруживается, то повторяйте для нового контроллера процедуру инициализации из 1-ого пункта.&lt;/li&gt;&lt;li&gt;В случае обнаружения сохранённого максимального значения &lt;em&gt;uSNChanged&lt;/em&gt;, сравните его с новым значением &lt;em&gt;highestCommittedUSN&lt;/em&gt; из &lt;em&gt;rootDSE&lt;/em&gt;. Если новое значение оказывается больше предыдущего – это означает, что в &lt;strong&gt;Active Directory&lt;/strong&gt; произошли изменения, в этом случае выполните поиск всех объектов, значение uSNChanged которых больше сохранённого – это и есть искомые объекты.&lt;/li&gt;&lt;li&gt;Запомните новое значение &lt;em&gt;highestCommittedUSN&lt;/em&gt;.&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;&lt;div&gt;Как несложно догадаться, явное связывание с постоянным контроллером домена упрощает данный алгоритм и делает его чуть более эффективным. Это наблюдение является ещё одним аргументом за подобную стратегию выбора контроллера домена в дополнение к &lt;a href="http://mrnone.blogspot.com/2011/05/directoryservices.html"&gt;уже обсуждавшимся ранее проблемам с производительностью при поиске&lt;/a&gt;, когда выбор контроллера остаётся на совести ADSI.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/08/active-directory.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/4293926312325761664'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/4293926312325761664'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/08/active-directory.html' title='Подводный камни Active Directory: версионность объектов, как она есть'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7647860783603630756</id><published>2011-07-31T12:05:00.000+07:00</published><updated>2011-07-31T12:05:10.895+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Security'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><category scheme='http://www.blogger.com/atom/ns#' term='Active Directory'/><title type='text'>Windows: теория и практика синхронизации паролей</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;div&gt;28 июня этого года компания &lt;strong&gt;Microsoft&lt;/strong&gt; запустила новый облачный сервис &lt;strong&gt;Office 365&lt;/strong&gt;. Ожидается, что его основными потребителями станут предприятия, желающие сэкономить время и средства на поддержании собственной инфраструктуры офисного ПО. Поэтому, одной из важнейших задач, возникающей в подобном контексте использования, является синхронизация с облаком службы каталогов &lt;strong&gt;Active Directory&lt;/strong&gt; предприятия. Для её решения подписчикам предоставляется специальное приложение, автоматизирующее данный процесс. Но оно имеет очень смешное ограничение, а именно: оно не умеет синхронизировать пароли пользователей. Компания &lt;strong&gt;Parallels&lt;/strong&gt;, в которой я имею честь работать, имеет аналогичное решение в составе продукта &lt;strong&gt;Parallels Operations Automation&lt;/strong&gt; уже более полутора лет. Вот только наше приложение &lt;strong&gt;Customer Directory Integration&lt;/strong&gt;, в отличие от &lt;strong&gt;Microsoft Directory Sync&lt;/strong&gt;, достаточно легко справляется с задачей синхронизации паролей. В этой заметке я хочу приоткрыть завесу тайны над тем, как оно это делает.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;&lt;br /&gt;Теория&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;У данной задачи может быть и более приземлённое практическое применение, нежели перенос пользователей локальной &lt;strong&gt;Active Directory&lt;/strong&gt; в облако. Например, это может быть автоматическая синхронизация паролей между &lt;strong&gt;Active Directory&lt;/strong&gt; и используемыми в вашей компании системами контроля версий и отслеживания ошибок. Удобно, не правда ли, когда все применяемые в работе компоненты имеют единые атрибуты безопасности?&lt;br /&gt;&lt;br /&gt;&lt;a href="http://mrnone.blogspot.com/2011/05/blog-post.html"&gt;Однажды&lt;/a&gt; я уже касался темы хранения паролей в ОС &lt;strong&gt;Windows&lt;/strong&gt;. Из той заметки вполне очевидно следует, что восстановить пароль из хэша, сохранённого в недрах операционной системы, весьма трудно. И начиная с определённых длин пароля, эта задача становится практически неразрешимой. Поэтому о таком методе синхронизации можно смело забыть.&lt;br /&gt;&lt;br /&gt;Точно также можно смело забыть о попытках перехватить пароль в момент его ввода пользователем при включении компьютера. Операционная система гарантирует, что единственный компонент, имеющий к нему доступ, - это процесс &lt;em&gt;WinLogon&lt;/em&gt; и его расширители. Но даже если вы напишете свой &lt;em&gt;Credential Provider&lt;/em&gt; (расширитель &lt;em&gt;WinLogon&lt;/em&gt;), который сможет перехватывать пароли, толку от него будет маловато. Чтобы этот метод работал, ваш расширитель должен быть установлен на всех компьютерах всех пользователей доменов. А что, если кто-то принципиально пользуется только своим лэптопом и считает неприемлемым устанавливать какие-то сомнительные утилиты, влияющие на процесс входа в систему? Более того, все расширители должны уметь связываться с неким единым центром и передавать ему данные.&lt;br /&gt;&lt;br /&gt;В процедуре управления паролем есть один момент времени, когда пароль вполне легально доступен контроллеру доменов в открытом виде. При создании нового пользователя или изменении пароля у существующего, контроллер доменов должен иметь явный доступ к паролю для того, чтобы проверить пароль на соответствие политикам управления паролями (минимальная длинна, набор используемых символов и так далее), вычислить хэш и сохранить его во внутреннее хранилище. Было бы здорово получить доступ к паролю в этот самый момент. И к счастью такая возможность существует. Она реализуется с помощью &lt;em&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/ms721882(VS.85).aspx"&gt;Фильтров Паролей (Password Filters)&lt;/a&gt;&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Фильтры паролей предназначены в основном для реализации собственных политик управления паролями. Более того, стандартные политики реализованы через эту же самую технологию. Мы же в &lt;strong&gt;Parallels&lt;/strong&gt; воспользовались этой возможностью для решения задачи синхронизации паролей. При таком подходе необходимо всего лишь установить приложение фильтра на каждый контроллер домена, а не на каждую рабочую станцию каждого сотрудника.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Практика&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Так что же представляет из себя фильтр паролей? По сути, это всего лишь динамически линкуемая библиотека (&lt;em&gt;DLL&lt;/em&gt;), реализующая и экспортирующая наружу функции со следующими сигнатурами: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;BOOLEAN&lt;/span&gt; &lt;span style="color: blue;"&gt;NTAPI&lt;/span&gt;&lt;br /&gt;InitializeChangeNotify();&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;BOOLEAN NTAPI&lt;/span&gt;&lt;br /&gt;PasswordFilter(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;PUNICODE_STRING&lt;/span&gt; AccountName,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;PUNICODE_STRING&lt;/span&gt; FullName,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;PUNICODE_STRING&lt;/span&gt; Password,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;BOOLEAN&lt;/span&gt; SetOperation&lt;br /&gt;);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;NTSTATUS NTAPI&lt;/span&gt;&lt;br /&gt;PasswordChangeNotify(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;PUNICODE_STRING&lt;/span&gt; UserName,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;ULONG&lt;/span&gt; RelativeId,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; __in &lt;span style="color: blue;"&gt;PUNICODE_STRING&lt;/span&gt; NewPassword&lt;br /&gt;); &lt;/div&gt;&lt;br /&gt;Достаточно просто поместить такую библиотеку в каталог &lt;span class="path"&gt;%SystemRoot%\System32&lt;/span&gt; контроллера доменов, а её имя (без разрешения &lt;em&gt;.dll&lt;/em&gt;) добавить к списку фильтров в под-ключе &lt;em&gt;Notification Packages&lt;/em&gt; ключа реестра &lt;span class="path"&gt;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa&lt;/span&gt; и перезагрузить систему (естественно эти операции нужно повторить на всех контроллерах доменов сети предприятия). При следующей загрузке данная библиотека будет подгружена в контекст процесса &lt;em&gt;LSA&lt;/em&gt; (&lt;em&gt;Local Security Authority&lt;/em&gt;), о чём она будет уведомлена вызовом функции &lt;em&gt;InitializeChangeNotify&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Но самое интересное начнёт происходить в тот момент, когда какой-нибудь пользователь домена решит сменить свой пароль. После того, как он введёт новый пароль &lt;u&gt;на своей машине&lt;/u&gt;, процесс &lt;em&gt;LSA&lt;/em&gt; его локальной системы свяжется с процессом &lt;em&gt;LSA&lt;/em&gt; контроллера доменов по защищённому каналу и передаст ему новый пароль в открытом виде. Процесс &lt;em&gt;LSA&lt;/em&gt; контроллера доменов опросит все загруженные парольные фильтры, последовательно вызывая для всех функцию &lt;em&gt;PasswordFilter&lt;/em&gt;. Если парольный фильтр не возражает против смены пароля, он должен вернуть значение &lt;em&gt;TRUE&lt;/em&gt;. В противном случае фильтр может вернуть значение &lt;em&gt;FALSE&lt;/em&gt;, например, если пароль не соответствует политикам безопасности. Если хоть один фильтр вернёт значение &lt;em&gt;FALSE&lt;/em&gt;, процесс &lt;em&gt;LSA&lt;/em&gt; прекратит дальнейший опрос фильтров и прервёт процедуру смены пароля. Пользователь в этом случае увидит стандартное сообщение о том, что его пароль слишком слабый и не соответствует установленным в системе политикам безопасности.&lt;br /&gt;&lt;br /&gt;Если все фильтры подтверждают возможность смены пароля, процесс &lt;em&gt;LSA&lt;/em&gt; завершает процедуру, вычисляя хэш нового пароля и замещая им старое значение в своей базе. После этого он ещё раз последовательно обходит все фильтры, уведомляя их с помощью вызова функции &lt;em&gt;PasswordChangeNotify &lt;/em&gt;о фиксации пароля. Единственным возможным значением, возвращённым из этой функции, может быть лишь &lt;em&gt;STATUS_SUCCESS&lt;/em&gt;. На практике же, процесс LSA просто игнорирует результат вызова этой функции. Это означает, что ни один фильтр больше никак не может предотвратить смену пароля. Поэтому именно данную функцию можно смело использовать для перехвата пароля с целью дальнейшей синхронизации.&lt;br /&gt;&lt;br /&gt;Аналогичным образом обрабатывается и пароль любого вновь создаваемого пользователя домена. Отличие заключается лишь в том, что в этом случае пароль вводится непосредственно на контроллере домена и попадает в его &lt;em&gt;LSA&lt;/em&gt; напрямую.&lt;br /&gt;&lt;br /&gt;Замечательно, а что же делать с теми пользователями, которые существуют давно и пароль менять не собираются? Мы попросим их это сделать принудительно. Если у соответствующего объекта-пользователя в &lt;strong&gt;Active Directory&lt;/strong&gt; обнулить свойство &lt;em&gt;pwdLastSet&lt;/em&gt;, то при следующем входе под этой учётной записью, система сообщит, что пароль устарел, и попросит ввести новый. Собственно это именно то, чего мы и добивались.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Легко в учении - тяжело в бою&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;В заключении хочу обратить внимание на некоторые подводные камни, сопровождающие реализацию своего парольного фильтра.&lt;br /&gt;&lt;br /&gt;Во-первых, имейте в виду: &lt;em&gt;LSA&lt;/em&gt; подгружает парольные фильтры на достаточно ранних стадиях загрузки системы. Поэтому когда ваш фильтр получаете уведомление о загрузке - &lt;em&gt;InitializeChangeNotify&lt;/em&gt; - огромная часть системных компонентов и сервисов ещё не доступна, что может приводить к весьма неожиданным побочным эффектам. Например, в виде сервиса реализован &lt;em&gt;Windows Event Log.&lt;/em&gt; Поэтому любые попытки отправлять в него сообщения на этапе инициализации фильтра в лучшем случае будут завершаться ничем, в худшем приводить к падениям.&lt;br /&gt;&lt;br /&gt;Во-вторых, фильтр исполняется в контексте процесса критичного для функционирования всей системы. Если одна из функций &lt;em&gt;PasswordFilter&lt;/em&gt; или &lt;em&gt;PasswordChangeNotify&lt;/em&gt; завершится падением, это приведёт к остановке процесса &lt;em&gt;LSA&lt;/em&gt;, в след за которым последует перезагрузка всей системы. К счастью последствия от падения функции &lt;em&gt;InitializeChangeNotify&lt;/em&gt; будут не столь ужасны: ваш фильтр всего лишь не будет загружен.&lt;br /&gt;&lt;br /&gt;В-третьих, фильтр, как и весь процесс &lt;em&gt;LSA&lt;/em&gt;, исполняется под учётной записью локальной системы. Это означает, что удалённые операции в пределах домена, инициированные вашим фильтром, будут исполняться под доменной учётной записью компьютера.&lt;br /&gt;&lt;br /&gt;Ну и в завершении: всё сказанное справедливо не только для контроллеров доменов, но и для прочих серверов и даже для клиентских систем. Парольные фильтры могут быть установлены на любой машине, и будут задействованы любой &lt;em&gt;LSA&lt;/em&gt;.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/07/windows.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7647860783603630756'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7647860783603630756'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/windows.html' title='Windows: теория и практика синхронизации паролей'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-2917122871198736080</id><published>2011-07-16T01:32:00.001+07:00</published><updated>2011-07-16T14:04:44.534+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Cryptography'/><category scheme='http://www.blogger.com/atom/ns#' term='Security'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><title type='text'>Виды информационных угроз и методы борьбы</title><content type='html'>&lt;div&gt;Вчера я читал студентам Летней школы &lt;strong&gt;Parallels&lt;/strong&gt; лекцию: "&lt;em&gt;Виды информационных угроз и методы борьбы&lt;/em&gt;". Презентацию к этой лекции можно скачать: &lt;a href="http://dl.dropbox.com/u/26827843/BlogFiles/school-parallels-security.pptx"&gt;здесь в формате PowerPoint`а&lt;/a&gt;&amp;nbsp;или &lt;a href="http://dl.dropbox.com/u/26827843/BlogFiles/school-parallels-security.pdf"&gt;здесь в PDF&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;Скорее всего, суровым гикам с богатым жизненным опытом материал покажется не особо интересным (он ориентирован на студентов 2-ого – 5-ого курса), но вот начинающим будет весьма полезно посмотреть.&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html' title='Виды информационных угроз и методы борьбы'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1873272504733193060</id><published>2011-07-01T16:44:00.003+07:00</published><updated>2011-07-01T17:04:58.489+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Data Transfer'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='C++'/><title type='text'>Зачем нужен Apache Thrift?…</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;div&gt;В &lt;a href="http://mrnone.blogspot.com/2011/05/google-protobuf.html"&gt;одной из прошлых заметок&lt;/a&gt; я рассказывал о &lt;strong&gt;Google Protocol Buffers&lt;/strong&gt;. В качестве альтернативы последнему иногда упоминают &lt;strong&gt;&lt;a href="http://thrift.apache.org/"&gt;Apache Thrift&lt;/a&gt;&lt;/strong&gt;. Я проанализировал его возможности и в этой заметке хочу высказать свои мысли по поводу данной технологии.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Такой же, но другой… Совсем другой.&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Точно так же, как и &lt;strong&gt;Protobuf&lt;/strong&gt;, &lt;strong&gt;Thrift&lt;/strong&gt; имеет специальный декларативный язык, позволяющий определить протокол передачи данных, и собственный компилятор, позволяющий сгенерировать код для 15 различных языков (по крайней мере, это было именно так для последней стабильной сборки с версией &lt;u&gt;0.6.1&lt;/u&gt;, которую я использовал для экспериментов). В число поддерживаемых языков входят, как весьма экзотические: &lt;strong&gt;OCaml&lt;/strong&gt; или &lt;strong&gt;Smalltalk&lt;/strong&gt;, так и более привычные: &lt;strong&gt;С++&lt;/strong&gt;, &lt;strong&gt;Java&lt;/strong&gt;, &lt;strong&gt;C#&lt;/strong&gt;, &lt;strong&gt;Python&lt;/strong&gt;. Но, если &lt;strong&gt;Protobuf&lt;/strong&gt; в первую очередь позиционируется именно как средство определения протоколов для сериализации и десериализации данных, которые вы можете передавать и принимать по любому удобному вам каналу. То &lt;strong&gt;Thrift&lt;/strong&gt; представляет собой полноценный легковесный &lt;strong&gt;RPC&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Помимо передаваемых данных, в файле декларации вы можете определить интерфейсы сервера, принимающего эти данные:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;struct&lt;/span&gt;&amp;nbsp;&lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;1:&lt;/strong&gt; &lt;span style="color: blue;"&gt;optional string&lt;/span&gt; domain,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;2:&lt;/strong&gt; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; account,&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;service&lt;/span&gt;&amp;nbsp;&lt;span style="color: #2b91af;"&gt;UserManager&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;bool&lt;/span&gt; Save(&lt;strong&gt;1:&lt;/strong&gt;&lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt; login, &lt;strong&gt;2:&lt;/strong&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; password, &lt;strong&gt;2:&lt;/strong&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; name)&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Именно этот способ использования является основным. В таком качестве &lt;strong&gt;Thrift&lt;/strong&gt; скорее является аналогом &lt;strong&gt;CORBA&lt;/strong&gt; или &lt;strong&gt;SOAP&lt;/strong&gt;, а не &lt;strong&gt;Protobuf&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Надо отметить, что &lt;strong&gt;Protobuf&lt;/strong&gt; тоже содержит &lt;strong&gt;RPC&lt;/strong&gt; составляющую, и вы можете определять серверные интерфейсы в его файлах декларации. Но эта возможность используется не так часто, по сравнению с обычной сериализацией данных.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Долой интерфейсы!&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Но моей целью была именно сериализация / десериализация, как в &lt;strong&gt;Protobuf&lt;/strong&gt;. Поэтому я решил попробовать обойтись без определения интерфейсов. Ведь, в конце концов, не зря же &lt;strong&gt;Thrift&lt;/strong&gt; называют альтернативой именно &lt;strong&gt;Protobuf&lt;/strong&gt;'у, а не &lt;strong&gt;CORBA&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;&lt;a href="http://2.bp.blogspot.com/-6YXLDwhoRoo/Tg2bYO05dHI/AAAAAAAAAFA/rhSxM04l9nc/s1600/UserStruct.gif" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"&gt;&lt;img border="0" src="http://2.bp.blogspot.com/-6YXLDwhoRoo/Tg2bYO05dHI/AAAAAAAAAFA/rhSxM04l9nc/s1600/UserStruct.gif" /&gt;&lt;/a&gt;В качестве эксперимента я взял &lt;a href="http://mrnone.blogspot.com/2011/05/google-protobuf.html#user-sample"&gt;пример из заметки&lt;/a&gt; про &lt;strong&gt;Protobuf&lt;/strong&gt; и попытался переписать определение структур &lt;em&gt;User&lt;/em&gt;, &lt;em&gt;Login&lt;/em&gt; и &lt;em&gt;PhoneNumber&lt;/em&gt; для &lt;strong&gt;Thrift&lt;/strong&gt;. Здесь меня ждал первый неприятный сюрприз. Директива &lt;em&gt;include&lt;/em&gt;, прекрасно работающая в случае декларации интерфейсов, отказывалась "включать" структуры. Если структура &lt;em&gt;PhoneNumber&lt;/em&gt; располагалась в другом файле, который включался в компилируемый файл с определением структуры &lt;em&gt;User&lt;/em&gt;, то компиляция завершалась сообщением об ошибке: &lt;em&gt;Type "PhoneNumber" has not been defined&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Попытка найти ответ в документации не привела ни к чему: документация скудна, особенно в сравнении с документацией по &lt;strong&gt;Protobuf&lt;/strong&gt;'у (это явилось вторым разочарованием). Поэтому я просто поместил все описания в один файл (&lt;em&gt;user.thrift&lt;/em&gt;):&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;namespace cpp&lt;/span&gt; ad.sync&lt;br /&gt;&lt;span style="color: blue;"&gt;namespace csharp&lt;/span&gt; ad.sync&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;enum&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Type&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; HOME = &lt;span style="color: #a31515;"&gt;0&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; WORK = &lt;span style="color: #a31515;"&gt;1&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; MOBILE = &lt;span style="color: #a31515;"&gt;2&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; IPPHONE = &lt;span style="color: #a31515;"&gt;3&lt;/span&gt;,&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;struct&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;1:&lt;/strong&gt; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; number,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;2:&lt;/strong&gt; &lt;span style="color: blue;"&gt;optional&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Type&lt;/span&gt; type = &lt;span style="color: #a31515;"&gt;0&lt;/span&gt;,&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;struct&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;1:&lt;/strong&gt; &lt;span style="color: blue;"&gt;optional string&lt;/span&gt; domain,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;2:&lt;/strong&gt; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; account,&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;struct&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;User&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;1:&lt;/strong&gt; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; id,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;2:&lt;/strong&gt; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; ldap,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;3:&lt;/strong&gt; &lt;span style="color: blue;"&gt;required&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt; login,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;4:&lt;/strong&gt; &lt;span style="color: blue;"&gt;optional string&lt;/span&gt; display_name,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;5:&lt;/strong&gt; &lt;span style="color: blue;"&gt;list&lt;/span&gt;&amp;lt;&lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt;&amp;gt; phoneNumber,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;6:&lt;/strong&gt; &lt;span style="color: blue;"&gt;list&lt;/span&gt;&amp;lt;&lt;span style="color: blue;"&gt;string&lt;/span&gt;&amp;gt; memberOf,&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Обратите внимание на весьма странное решение с пространствами имён. Нельзя определить единое пространство имён для всех структур (и интерфейсов) в рамках &lt;em&gt;thrift&lt;/em&gt;-файла. Зато можно задать (а можно и не задавать) отдельное пространство имён со своим именем и уровнем вложенности для каждого поддерживаемого языка.&lt;br /&gt;&lt;br /&gt;После компиляции в код на C++:&lt;br /&gt;&lt;div class="sourcecode"&gt;thrift-0.6.1.exe -o Messages --gen cpp user.thrift&lt;/div&gt;я получил по одному классу для каждой структуры, объявленной в файле &lt;em&gt;user.thrift&lt;/em&gt;. Беглый анализ этих классов показал, что для операций чтения и записи пригодны лишь следующие два метода:&lt;br /&gt;&lt;div class="sourcecode"&gt;uint32_t read(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::apache::thrift::protocol::TProtocol* iprot); &lt;br /&gt;uint32_t write(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::apache::thrift::protocol::TProtocol* oprot) &lt;span style="color: blue;"&gt;const&lt;/span&gt;;&lt;/div&gt;Каждый из них требует некий протокол в качестве единственного входного аргумента.&lt;br /&gt;&lt;br /&gt;Библиотека &lt;strong&gt;Thrift&lt;/strong&gt; для &lt;strong&gt;C++&lt;/strong&gt; содержит несколько классов, реализующих интерфейс &lt;em&gt;TProtocol&lt;/em&gt;. Объекты этих классов определяют формат представления данных: бинарный, JSON и так далее. Все реализации протоколов в свою очередь требуют объект реализующий интерфейс &lt;em&gt;TTransport&lt;/em&gt;. Именно транспорт в архитектуре &lt;strong&gt;Thrift&lt;/strong&gt; определяет, куда будут сохранены или переданы данные. Среди множества "сетевых" транспортов, вроде &lt;em&gt;THttpTransport&lt;/em&gt;, выделяются 2 транспорта с именами &lt;em&gt;TMemoryBuffer&lt;/em&gt; и &lt;em&gt;TFileTransport&lt;/em&gt;, позволяющих сохранить данные, если верить описанию, в буфер в памяти и в файл. Это должно быть именно тем, что нам нужно.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Фальстарт!&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Итак, всё, что нам нужно – это создать проект &lt;strong&gt;C++&lt;/strong&gt; в &lt;strong&gt;Visual Studio&lt;/strong&gt;, включить в него сгенерированные файлы, проект библиотеки &lt;strong&gt;Thrift&lt;/strong&gt; и всё скомпилировать... Не тут-то было! В этом месте меня постигло самое главное разочарование: библиотека &lt;strong&gt;Thrift&lt;/strong&gt; не имеет реализации под &lt;strong&gt;Windows&lt;/strong&gt;. Чтобы скомпилировать и запустить под &lt;strong&gt;Windows&lt;/strong&gt; приложение, использующее &lt;strong&gt;Thrift&lt;/strong&gt;, вам понадобится развернуть &lt;strong&gt;cygwin&lt;/strong&gt;. Причём, как несложно догадаться, вам придётся распространять &lt;strong&gt;cygwin&lt;/strong&gt; вместе с вашим готовым продуктом. Сомнительное удовольствие, если учесть, что есть более дружелюбные альтернативы.&lt;br /&gt;&lt;br /&gt;Я допускаю, что необходимые классы можно аккуратно извлечь из остальной реализации &lt;strong&gt;Thrift&lt;/strong&gt;, тем более что их не так много. Кто-нибудь более настойчивый может это сделать. Вам необходимы классы из файлов: &lt;em&gt;TBinaryProtocol.*, TProtocol.h, TVirtualProtocol.h, TProtocolException.h, TBufferTransports.*, TTransport.h, TVirtualTransport.h, TTransportException.*&lt;/em&gt;. Но такое решение чревато проблемами. Не факт, что вы сможете повторить подобное художественное выпиливание, если в будущем захотите обновить, используемую библиотеку до новой версии. Поэтому я просто не стал тратить на это время и перешёл к плану B.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Идём другим путём.&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;К моему глубокому удивлению &lt;strong&gt;Thrift&lt;/strong&gt; имеет полноценную реализацию для &lt;strong&gt;C#&lt;/strong&gt;. Правда, прежде чем скомпилировать библиотеку, пришлось немного поправить файлы проектов руками, а именно: удалить комментарии с лицензионным соглашением, ибо моя &lt;strong&gt;Visual Studio 2010 Express&lt;/strong&gt; считала ошибкой формата расположение комментария в начале файла. Ещё пришлось исключить из сборки не собирающийся проект с тестами (надо отметить, что тесты не собирались и в случае с &lt;strong&gt;Google Protobuf&lt;/strong&gt; – очевидно, это массовое заболевание подобных библиотек). После этого я успешно скомпилировал проект в библиотеку &lt;em&gt;Thrift.dll&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Итак, компилируем user.thrift в классы C#:&lt;br /&gt;&lt;div class="sourcecode"&gt;thrift-0.6.1.exe -o Messages --gen csharp user.thrift&lt;/div&gt;Создаём новый проект, в него включаем сгенерированные классы и полученную библиотеку. Всё, что нам осталось – это написать код сериализации и десериализации. Аналогом &lt;strong&gt;C++&lt;/strong&gt; классов &lt;em&gt;TMemoryBuffer&lt;/em&gt; и &lt;em&gt;TFileTransport &lt;/em&gt;в &lt;strong&gt;C#&lt;/strong&gt; является класс &lt;em&gt;TStreamTransport&lt;/em&gt;. Вот пример его использования:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; filePath = &lt;span style="color: #a31515;"&gt;@"message.dat"&lt;/span&gt;;&lt;br /&gt;&lt;br /&gt;ad.sync.&lt;span style="color: #2b91af;"&gt;User&lt;/span&gt; user = &lt;span style="color: blue;"&gt;new&lt;/span&gt; ad.sync.&lt;span style="color: #2b91af;"&gt;User&lt;/span&gt;();&lt;br /&gt;user.Id = &lt;span style="color: #2b91af;"&gt;Guid&lt;/span&gt;.NewGuid().ToString();&lt;br /&gt;user.&lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt; = &lt;span style="color: blue;"&gt;new&lt;/span&gt; ad.sync.&lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt;();&lt;br /&gt;user.&lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt;.Account = &lt;span style="color: #a31515;"&gt;"jdoe"&lt;/span&gt;;&lt;br /&gt;user.&lt;span style="color: #2b91af;"&gt;Login&lt;/span&gt;.Domain = &lt;span style="color: #a31515;"&gt;"neverhood"&lt;/span&gt;;&lt;br /&gt;user.Display_name = &lt;span style="color: #a31515;"&gt;"John Doe"&lt;/span&gt;;&lt;br /&gt;user.MemberOf = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;List&lt;/span&gt;&amp;lt;&lt;span style="color: blue;"&gt;string&lt;/span&gt;&amp;gt;();&lt;br /&gt;user.MemberOf.Add(&lt;span style="color: #a31515;"&gt;"User"&lt;/span&gt;);&lt;br /&gt;user.MemberOf.Add(&lt;span style="color: #a31515;"&gt;"Management"&lt;/span&gt;);&lt;br /&gt;user.&lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt; = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;List&lt;/span&gt;&amp;lt;ad.sync.&lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt;&amp;gt;();&lt;br /&gt;ad.sync.&lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt; phoneNumber =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; ad.sync.&lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt;();&lt;br /&gt;phoneNumber.&lt;span style="color: #2b91af;"&gt;Type&lt;/span&gt; = ad.sync.&lt;span style="color: #2b91af;"&gt;Type&lt;/span&gt;.WORK;&lt;br /&gt;phoneNumber.Number = &lt;span style="color: #a31515;"&gt;"+5 (555) 123x45x67"&lt;/span&gt;;&lt;br /&gt;user.&lt;span style="color: #2b91af;"&gt;PhoneNumber&lt;/span&gt;.Add(phoneNumber);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;using&lt;/span&gt; (&lt;span style="color: #2b91af;"&gt;Stream&lt;/span&gt; stream = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;FileStream&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; filePath, FileMode.Create))&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Thrift.Transport.TTransport transport =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; Thrift.Transport.&lt;span style="color: #2b91af;"&gt;TStreamTransport&lt;/span&gt;(&lt;span style="color: blue;"&gt;null&lt;/span&gt;, stream);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Thrift.Protocol.TProtocol protocol =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; Thrift.Protocol.&lt;span style="color: #2b91af;"&gt;TBinaryProtocol&lt;/span&gt;(transport);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; user.Write(protocol);&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;ad.sync.&lt;span style="color: #2b91af;"&gt;User&lt;/span&gt; anotherUser = &lt;span style="color: blue;"&gt;new&lt;/span&gt; ad.sync.&lt;span style="color: #2b91af;"&gt;User&lt;/span&gt;();&lt;br /&gt;&lt;span style="color: blue;"&gt;using&lt;/span&gt; (&lt;span style="color: #2b91af;"&gt;Stream&lt;/span&gt; stream = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;FileStream&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; filePath, FileMode.Open))&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Thrift.Transport.TTransport transport =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; Thrift.Transport.&lt;span style="color: #2b91af;"&gt;TStreamTransport&lt;/span&gt;(stream, &lt;span style="color: blue;"&gt;null&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Thrift.Protocol.TProtocol protocol =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; Thrift.Protocol.&lt;span style="color: #2b91af;"&gt;TBinaryProtocol&lt;/span&gt;(transport);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; anotherUser.Read(protocol);&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Это же решение можно использовать и в проектах на &lt;strong&gt;C++&lt;/strong&gt; под &lt;strong&gt;Windows&lt;/strong&gt;. Только использовать придётся &lt;strong&gt;C++/CLI&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Выводы…&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Выводы не утешительные. Реализация технологии мне показалась достаточно сырой: странное поведение компилятора &lt;em&gt;thrift&lt;/em&gt;-файлов, откровенные ошибки в файлах проектов. Очень скудная документация: разбираться приходится, ориентируясь на примеры и комментарии в коде реализации библиотеки. Всё это не оставляет впечатления серьёзности проекта. Уже этого достаточно, чтобы отказаться от использования &lt;strong&gt;Apache Thrift&lt;/strong&gt; в коммерческой разработке, по крайней мере, в его нынешнем состоянии.&lt;br /&gt;&lt;br /&gt;В самом первом предложении на главной странице проекта декларируется его основное преимущество: Фреймворк для масштабируемой мульти-языковой разработки сервисов. Но на поверку заявленная поддержка нескольких языков оказалась не полной. Весьма показателен пример с требованием &lt;strong&gt;cygwin&lt;/strong&gt;'а для разработки под &lt;strong&gt;Windows&lt;/strong&gt; на &lt;strong&gt;C++&lt;/strong&gt;. Это требование, по сути, ставит крест на подобном использовании Фреймворка. Действительно, если это не портирование существующего проекта, то зачем мне тащить со своим приложением cygwin? Я просто выберу другую технологию.&lt;br /&gt;&lt;br /&gt;Чтобы окончательно разувериться в поддержки нескольких языков, достаточно обратиться к &lt;a href="http://wiki.apache.org/thrift/LibraryFeatures?action=show&amp;amp;redirect=LanguageSupport"&gt;таблице реализованных возможностей на сайте проекта&lt;/a&gt;. Из неё недвусмысленным образом становится ясно, что единственный язык, для которого реализована вся функциональность – это &lt;strong&gt;Java&lt;/strong&gt;. Поэтому, прежде чем использовать ту или иную функцию Фреймворка в разных языках, проверьте – реализована ли она.&lt;br /&gt;&lt;br /&gt;Проигрывает &lt;strong&gt;Thrift&lt;/strong&gt; и в сравнении с &lt;strong&gt;Protobuf&lt;/strong&gt;. При общей схожести предоставляемого функционала, &lt;strong&gt;Protobuf&lt;/strong&gt; проще в использовании. В нём действительно реализована поддержка множества платформ и языков. Что не включено в основную библиотеку, давно реализовано множеством дополнений. &lt;strong&gt;Protobuf&lt;/strong&gt;, в отличие от &lt;strong&gt;Thrift&lt;/strong&gt;, имеет вполне сносную документацию.&lt;br /&gt;&lt;br /&gt;Ну и последнее. Мне не понятно, зачем нужна ещё одна &lt;strong&gt;RPC&lt;/strong&gt; технология, причём поддерживаемая только одним производителем, если у нас есть более традиционные и поддерживаемые многими аналоги: &lt;strong&gt;CORBA&lt;/strong&gt;, &lt;strong&gt;SOAP&lt;/strong&gt;, &lt;strong&gt;XML RPC&lt;/strong&gt; и так далее. Если мне понадобится скорость, а не удобство, то данные я буду передавать напрямую через сокеты. Для сериализации в этом случае можно использовать действительно кросс-платформенный &lt;strong&gt;Protobuf&lt;/strong&gt;, &lt;strong&gt;JSON&lt;/strong&gt; (множество реализаций которого доступно для разных языков и платформ) или на худой конец &lt;strong&gt;XML&lt;/strong&gt; (если использовать &lt;strong&gt;SAX&lt;/strong&gt; вместо &lt;strong&gt;DOM&lt;/strong&gt; и не увлекаться проверкой по &lt;strong&gt;DTD&lt;/strong&gt;, то &lt;strong&gt;XML&lt;/strong&gt; вполне быстр и пригоден для передачи данных).&lt;br /&gt;&lt;br /&gt;Итак, если вам непременно необходимо написать сервер на &lt;strong&gt;Smalltalk&lt;/strong&gt; и клиента на &lt;strong&gt;OCaml&lt;/strong&gt;, то &lt;strong&gt;Apache Thrift&lt;/strong&gt; – это именно ваш вариант (но не наоборот, ибо реализация &lt;strong&gt;Thrift&lt;/strong&gt; для &lt;strong&gt;Smalltalk&lt;/strong&gt; не содержит клиентских компонентов). Во всех остальных случаях, я бы выбрал другую, более традиционную связку языков и технологий. Ещё раз подчёркиваю, что всё сказанное касается исключительно нынешнего положения дел. Вполне возможно, что в будущем, когда &lt;strong&gt;Apache Thrift&lt;/strong&gt; повзрослеет, я изменю своё мнение.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html' title='Зачем нужен Apache Thrift?…'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author><media:thumbnail xmlns:media='http://search.yahoo.com/mrss/' url='http://2.bp.blogspot.com/-6YXLDwhoRoo/Tg2bYO05dHI/AAAAAAAAAFA/rhSxM04l9nc/s72-c/UserStruct.gif' height='72' width='72'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-277763288564627600</id><published>2011-06-22T10:13:00.003+07:00</published><updated>2011-06-22T10:26:27.440+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='DirectoryServices'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='Active Directory'/><title type='text'>Странный DirectoryServices. Совет третий: помните - данных может быть больше, чем дозволено</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Горе тому серверу, который&amp;nbsp;на просьбу клиента вернуть всё, действительно возвращает &lt;u&gt;все данные&lt;/u&gt;. Это прямой путь к атаке типа &lt;i&gt;Deny of Service&lt;/i&gt;. Любой разработчик должен позаботиться об устойчивости своего сервиса и не допускать передачи неограниченного объёма данных. Не является исключением и &lt;b&gt;Active Directory Domain Service&lt;/b&gt;. По умолчанию любая операция поиска возвращает не более чем 1000 элементов. Давайте рассмотрим, как &lt;u&gt;правильно&lt;/u&gt; обойти это ограничение и получить действительно все объекты, не нарушив производительности контроллера доменов.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;b&gt;&lt;span style="color: red;"&gt;По умолчанию всё – это не больше 1000?&lt;/span&gt;&lt;/b&gt;&lt;br /&gt;Кому-то эта тема покажется тривиальной, но дело в том, что очень много программистов совершают подобную ошибку. Более того, подобный грех есть даже за программистами &lt;b&gt;Microsoft&lt;/b&gt;. Так, например, оснастка &lt;i&gt;DSA.MSC&lt;/i&gt; в &lt;b&gt;Windows Server 2003&lt;/b&gt; не умела возвращать все элементы организации, если их было больше &lt;i&gt;максимального размера страницы поиска&lt;/i&gt;, то есть 1000 штук по умолчанию. Что не так уж и много в случае достаточно крупного провайдера хостинга, на котором мы обнаружили&amp;nbsp;данную особенность.&lt;br /&gt;&lt;br /&gt;К счастью, если вы столкнётесь с подобным, некорректно написанным приложением от 3-ей стороны, вы можете обойти это ограничение, изменив максимальный размер страницы поиска. Он хранится в &lt;b&gt;Active Directory&lt;/b&gt; в виде одного из значений атрибута &lt;i&gt;lDAPAdminLimits&lt;/i&gt; объекта класса &lt;i&gt;queryPolicy&lt;/i&gt; в контейнере &lt;i&gt;CN=Query-Policies,CN=Directory Service,CN=Windows NT,CN=Services&lt;/i&gt; в контексте имён конфигурации. Хорошую статью на эту тему можно найти на &lt;a href="http://support.microsoft.com/kb/315071/en-us"&gt;сайте поддержки &lt;b&gt;Microsoft&lt;/b&gt;&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;&lt;span style="color: red;"&gt;Всё – это всё… но понемногу…&lt;/span&gt;&lt;/b&gt;&lt;br /&gt;Чтобы пользователям вашего приложения не пришлось обходить ограничение 1000-и элементов исправлением политик &lt;b&gt;AD&lt;/b&gt;, необходимо научиться обходить это ограничение программно. К счастью делается это очень просто: достаточно включить режим постраничного возврата результатов поиска.&lt;br /&gt;&lt;br /&gt;Для этих целей используется свойство &lt;i&gt;PageSize&lt;/i&gt; класса &lt;i&gt;System.DirectorySearcher&lt;/i&gt;. При создании объекта класса &lt;i&gt;DirectorySearcher&lt;/i&gt;, значение этого свойства равно 0, что означает: "режим постраничного поиска отключен". Чтобы включить постраничный поиск, необходимо присвоить этому свойству любое не нулевое значение. Присвоенное значение будет задавать размер страницы:&lt;br /&gt;&lt;div class="sourcecode"&gt;searcher.PageSize = &lt;span style="color: #a31515;"&gt;1000&lt;/span&gt;;&lt;/div&gt;&lt;br /&gt;Подобный способ является очевидным изъяном в интерфейсе класса &lt;i&gt;DirectorySearcher&lt;/i&gt;, поскольку вся остальная работа со страницами полностью скрыта от пользователей класса, и нигде более информация о размере страницы вам не понадобится. Поэтому, наиболее очевидное решение – это присваивать данному свойству значение размера страницы по умолчанию, то есть 1000. Если конечно вы не хотите разбирать значение атрибута &lt;i&gt;lDAPAdminLimits&lt;/i&gt; соответствующей политики.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;&lt;span style="color: red;"&gt;Лимит, да не тот.&lt;/span&gt;&lt;/b&gt;&lt;br /&gt;Класс &lt;i&gt;DirectorySearcher&lt;/i&gt; содержит ещё одно свойство, влияющее на размер результата, – &lt;i&gt;SizeLimit&lt;/i&gt;. Это свойство весьма путанно и, в общем случае, не вполне корректно &lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.directorysearcher.sizelimit.aspx"&gt;описано в &lt;b&gt;MSDN&lt;/b&gt;&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;При прочтении документации, может сложиться впечатление, что именно оно отвечает за предельное количество загружаемых объектов. И если присвоить этому свойству максимально возможное значение, то это решит проблему 1000 элементов. Но, как было сказано ранее, при выключенном постраничном поиске количество возвращённых элементов определяется максимальным размером страницы результатов поиска, задаваемым с помощью политик запросов, а не значением &lt;i&gt;SizeLimit&lt;/i&gt; класса &lt;i&gt;DirectorySearcher&lt;/i&gt;.&lt;br /&gt;&lt;br /&gt;Свойство &lt;i&gt;SizeLimit&lt;/i&gt; всего лишь позволяет ограничить размер результата фиксированным количеством элементов. В функциональном плане оно напоминает оператор &lt;i&gt;TOP&lt;/i&gt; в &lt;i&gt;SQL&lt;/i&gt; запросах. При этом если его значение превысит заданный вами размер страницы, то оно будет проигнорировано.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;&lt;span style="color: red;"&gt;А что насчёт альтернатив?&lt;/span&gt;&lt;/b&gt;&lt;br /&gt;Возможность постраничного поиска не является уникальной особенностью &lt;b&gt;Active Directory&lt;/b&gt;. Это стандартная функция протокола &lt;b&gt;LDAP&lt;/b&gt; 3-ей версии. Она называется "&lt;i&gt;LDAP Control Extension for Simple Paged Results Manipulation&lt;/i&gt;" и описана в &lt;a href="http://www.ietf.org/rfc/rfc2696.txt"&gt;RFC 2696&lt;/a&gt;. Поэтому не удивительно, что она доступна и для классов пространства имён &lt;i&gt;DirectoryServices.Protocols&lt;/i&gt;, который я упоминал в одной из &lt;a href="http://mrnone.blogspot.com/2011/05/directoryservicesprotocols.html"&gt;прошлых заметок&lt;/a&gt;. Более того, в рамках &lt;b&gt;Active Directory&lt;/b&gt; для данного интерфейса действует точно такое же ограничение, как и для &lt;i&gt;DirectoryServices&lt;/i&gt; / &lt;i&gt;ADSI&lt;/i&gt;: если не включить постраничный поиск, количество возвращённых элементов будет ограничено максимальным размером страницы.&lt;br /&gt;&lt;br /&gt;Поскольку &lt;i&gt;SearchRequest&lt;/i&gt; является более низкоуровневым интерфейсом, поэтому процедура включения постраничного поиска для него чуть сложнее, чем при использовании DirectorySearcher'а. Кроме того, он не прячет за своим фасадом обработку результатов, возлагая на программиста ответственность за самостоятельную загрузку всех страниц с данными:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #2b91af;"&gt;SearchRequest&lt;/span&gt; request = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;SearchRequest&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; searchPath,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; filter,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; SearchScope.Subtree,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new string&lt;/span&gt; { &lt;span style="color: #a31515;"&gt;"distinguishedName"&lt;/span&gt; });&lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// Enable a paged search; page size is 1000&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #2b91af;"&gt;PageResultRequestControl&lt;/span&gt; paging =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;PageResultRequestControl&lt;/span&gt;(&lt;span style="color: #a31515;"&gt;1000&lt;/span&gt;);&lt;br /&gt;request.Controls.Add(paging);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// Iterate over all returned pages&lt;/span&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;do&lt;/span&gt;&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Send the search request&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; SearchResponse response = (SearchResponse)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; connection.SendRequest(request);&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (ResultCode.Success != response.ResultCode)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Exception&lt;/span&gt;(&lt;span style="color: #2b91af;"&gt;String&lt;/span&gt;.Format(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"Search operation fails: {0}"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; response.ResultCode));&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Check that server supports the paged search&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (response.Controls.Length != &lt;span style="color: #a31515;"&gt;1&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; || !(response.Controls[&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;]&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;is&lt;/span&gt; PageResultResponseControl))&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Exception&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"Server does not support a paged search"&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Process all entities&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;foreach&lt;/span&gt; (&lt;span style="color: #2b91af;"&gt;SearchResultEntry&lt;/span&gt; entry &lt;span style="color: blue;"&gt;in&lt;/span&gt; response.Entries)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt; distinguishedName = entry.Attributes[&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"distinguishedName"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;].ToString();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; System.&lt;span style="color: #2b91af;"&gt;Console&lt;/span&gt;.WriteLine(distinguishedName);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Prepare a request for the next page&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; PageResultResponseControl responseControl =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (PageResultResponseControl)response.Controls[&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; paging.Cookie = responseControl.Cookie;&lt;br /&gt;}&lt;br /&gt;&lt;span style="color: blue;"&gt;while&lt;/span&gt; (paging.Cookie.Length != &lt;span style="color: #a31515;"&gt;0&lt;/span&gt;); &lt;span style="color: green;"&gt;// there are no more pages&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;В конце хочу лишь добавить, что самый лучший способ обойти ограничение 1000 элементов – это не писать запросов, которые возвращают такое количество объектов.&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/277763288564627600'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/277763288564627600'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html' title='Странный DirectoryServices. Совет третий: помните - данных может быть больше, чем дозволено'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-8054678116893339981</id><published>2011-06-06T09:00:00.001+07:00</published><updated>2011-06-06T09:00:00.454+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='DirectoryServices'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='ADSI'/><category scheme='http://www.blogger.com/atom/ns#' term='Active Directory'/><title type='text'>Странный DirectoryServices. Совет второй: прогревайте кэш атрибутов руками</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Продолжим &lt;a href="http://mrnone.blogspot.com/2011/05/directoryservices.html"&gt;начатую тему&lt;/a&gt;. Вы знаете, что происходит, когда запрашиваешь тот или иной атрибут &lt;strong&gt;Active Directory&lt;/strong&gt; у объекта типа &lt;em&gt;DirectoryEntry&lt;/em&gt;, и почему большая часть программ делает это неоптимальным образом? А как сделать правильно? Поговорим об этом.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Кэш кэшу рознь.&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Давайте вспомним, как выглядит типичный код, запрашивающий атрибуты объекта &lt;strong&gt;Active Directory&lt;/strong&gt; через класс &lt;em&gt;DirectoryEntry&lt;/em&gt;:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt; entry = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"LDAP://CN=John Doe,CN=Users,DC=neverhood,DC=org"&lt;/span&gt;);&lt;br /&gt;&lt;span style="color: blue;"&gt;object&lt;/span&gt; displayNameProp = entry.Properties[&lt;span style="color: #a31515;"&gt;"displayName"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;br /&gt;&lt;span style="color: blue;"&gt;object&lt;/span&gt; homePhoneProp = entry.Properties[&lt;span style="color: #a31515;"&gt;"homePhone"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;br /&gt;&lt;span style="color: blue;"&gt;object&lt;/span&gt; adminDescrProp = entry.Properties[&lt;span style="color: #a31515;"&gt;"adminDescription"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;br /&gt;Всё довольно просто, поэтому мало кто задумывается, что же скрывается за этой простотой. А тут есть над чем подумать. Ведь каждый атрибут хранится на удалённом контроллере доменов. Список атрибутов расширяем – стало быть, не ограничен.&lt;br /&gt;&lt;br /&gt;Перспектива малоприятная, как может показаться на первый взгляд: либо отдельный запрос к контроллеру доменов при обращении к каждому атрибуту, либо загрузка всех атрибутов при создании объекта. На самом деле ситуация немного лучше. При запросе первого атрибута, внутри объекта &lt;em&gt;DirectoryEntry&lt;/em&gt; происходит вызов метода &lt;em&gt;IADs::GetInfo&lt;/em&gt; соответствующего &lt;strong&gt;ADSI&lt;/strong&gt; объекта. Согласно документации этот метод загружает поддерживаемые атрибуты во внутренний кэш &lt;strong&gt;ADSI&lt;/strong&gt; объекта. На практике же это означает загрузку всех атрибутов, имеющих заданные значения. Если у вас в домене установлен &lt;strong&gt;Microsoft Exchange&lt;/strong&gt; и ещё пару приложений уровня предприятия, расширяющих схему, то число загружаемых атрибутов легко может достигнуть сотни.&lt;br /&gt;Значение любого запрашиваемого атрибута сначала ищется в загруженном кэше. И если только оно там не обнаруживается, выполняется отдельный запрос к контроллеру домена, результат этого запроса тоже кэшируется.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Долой автопилот! Даёшь ручное управление!&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Как не сложно догадаться, если вы будете запрашивать некоторый атрибут, значение которого в большинстве случаев окажется незаданным, вы всегда будете иметь 2 обращения к контроллеру доменов на каждый объект. Причём первый запрос будет загружать кучу ненужной вам информации. Исправить ситуацию может один метод класса DirectoryEntry, на который мало кто обращает внимание:  &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;public void&lt;/span&gt; RefreshCache(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt;[] propertyNames&lt;br /&gt;); &lt;/div&gt;&lt;br /&gt;Из сигнатуры этот метода становится понятно, что он выполняет загрузку в кэш только тех атрибутов, список которых вы передадите ему в качестве параметра. Более того, он это делает одним обращением к контроллеру домена с помощью метода &lt;em&gt;IADs::GetInfoEx&lt;/em&gt;. Никакой лишней дополнительно информации не загружается. Таким образом, пример, приведённый выше, можно переписать так: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt; entry = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"LDAP://CN=John Doe,CN=Users,DC=neverhood,DC=org"&lt;/span&gt;);&lt;br /&gt;entry.RefreshCache(&lt;span style="color: blue;"&gt;new string&lt;/span&gt;[]{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"displayName"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"homePhone"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"adminDescription"&lt;/span&gt;});&lt;br /&gt;&lt;span style="color: blue;"&gt;object&lt;/span&gt; displayNameProp = entry.Properties[&lt;span style="color: #a31515;"&gt;"displayName"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;br /&gt;&lt;span style="color: blue;"&gt;object&lt;/span&gt; homePhoneProp = entry.Properties[&lt;span style="color: #a31515;"&gt;"homePhone"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;br /&gt;&lt;span style="color: blue;"&gt;object&lt;/span&gt; adminDescrProp = entry.Properties[&lt;span style="color: #a31515;"&gt;"adminDescription"&lt;/span&gt;][&lt;span style="color: #a31515;"&gt;0&lt;/span&gt;];&lt;/div&gt;&lt;br /&gt;Этот вариант будет работать быстрее, и расходовать гораздо меньше памяти, особенно на больших коллекциях объектов.  &lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/8054678116893339981'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/8054678116893339981'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices.html' title='Странный DirectoryServices. Совет второй: прогревайте кэш атрибутов руками'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-593018713968120811</id><published>2011-05-30T08:00:00.008+07:00</published><updated>2011-05-30T08:00:00.168+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='DirectoryServices'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='ADSI'/><category scheme='http://www.blogger.com/atom/ns#' term='Active Directory'/><title type='text'>Странный DirectoryServices. Совет первый: выражайтесь яснее, где искать</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;В &lt;a href="http://mrnone.blogspot.com/2011/05/directoryservicesprotocols.html"&gt;прошлый раз&lt;/a&gt; я вскользь упомянул про подводные камни, встречающиеся на пути программиста, решившего использоваться классы пространства имён &lt;em&gt;System.DirectoryServices&lt;/em&gt; или &lt;strong&gt;DCOM&lt;/strong&gt; объекты &lt;strong&gt;ADSI&lt;/strong&gt;, что, по сути, то же самое. Данная тема заслуживает отдельного рассмотрения. Поэтому эту и несколько следующих заметок я посвящу ей.&lt;br /&gt;&lt;div&gt;Сегодня я хочу рассмотреть весьма распространённую ошибку, связанную с особенностью выбора контроллера домена, на котором будет осуществляться поиск. В большинстве случаев программист полагается на настройки по умолчанию и может получить существенное падение производительности при определённых конфигурациях. Самое неприятное то, что отследить такую ошибку на этапе тестирования очень сложно.&lt;br /&gt;&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Как делает большинство?&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Рассмотрим стандартный код поиска с помощью классов из пространства имён &lt;em&gt;System.DirectoryServices&lt;/em&gt;: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt; rootDSE = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt;(&lt;span style="color: #a31515;"&gt;"LDAP://rootDSE"&lt;/span&gt;);&lt;br /&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; domainContextLDAP = &lt;span style="color: #a31515;"&gt;"LDAP://"&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; + rootDSE.Properties[&lt;span style="color: #a31515;"&gt;"rootDomainNamingContext"&lt;/span&gt;].Value;&lt;br /&gt;&lt;br /&gt;&lt;span style="color: #2b91af;"&gt;String&lt;/span&gt;[] properties = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;String&lt;/span&gt;[] {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"objectGUID"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"displayName"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"givenName"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"sn"&lt;/span&gt; };&lt;br /&gt;&lt;span style="color: #2b91af;"&gt;DirectorySearcher&lt;/span&gt; searcher = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;DirectorySearcher&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt;(domainContextLDAP),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"(objectClass=person)"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; properties,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; SearchScope.Subtree);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;using&lt;/span&gt; (&lt;span style="color: #2b91af;"&gt;SearchResultCollection&lt;/span&gt; searchResultCol&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; = searcher.FindAll())&lt;br /&gt;{&lt;br /&gt;&lt;span style="color: green;"&gt;// ...&lt;/span&gt;&lt;br /&gt;}&lt;/div&gt;Всё в порядке? Нет, нет и нет! В данном коде пропущена существенная деталь – не указан контроллер домена, на котором будет выполняться поиск. В этом случае может быть задействован &lt;u&gt;любой&lt;/u&gt; контроллер домена в текущем сайте. И абсолютно не обязательно, что это будет ближайший к вам сервер. Сайт в большой организации может покрывать несколько офисов в пределах города, а каждый офис может иметь свой контроллер домена – любой из них может быть выбран для выполнения операции поиска. Вес и приоритет &lt;strong&gt;SRV&lt;/strong&gt; записей домена могут повлиять на результат выбора, но в любом случае этот параметр не подлежит конфигурированию на стороне клиента и потому полагаться на него не стоит. Опасность заключается в том, что данный код вполне себе работоспособен, и наблюдать падение производительности вы можете лишь на определённых конфигурациях, причём характерных весьма большим предприятиям. Поэтому отдел контроля качества легко может пропустить данную проблему.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Мы пойдём другим путём.&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Но постойте, как же указать сервер, если ни класс &lt;em&gt;DirectoryEntry&lt;/em&gt;, ни класс &lt;em&gt;DirectorySearcher&lt;/em&gt; не содержат в своих интерфейсах подобного свойства? Всё очень просто. В данном примере для инициализации объекта типа &lt;em&gt;DirectoryEntry&lt;/em&gt; применяется так называемый &lt;em&gt;serverless&lt;/em&gt; формат записи &lt;strong&gt;LDAP&lt;/strong&gt; пути: &lt;em&gt;&lt;u&gt;LDAP://CN=Users,DC=neverhood,DC=org&lt;/u&gt;&lt;/em&gt;. Полный LDAP путь позволяет указать не только адрес или имя контроллера домена, но даже порт, на котором слушает сервис: &lt;br /&gt;&lt;div class="sourcecode"&gt;LDAP://[HostName[:Port]/]DistinguishedName&lt;/div&gt;Пример: &lt;em&gt;&lt;u&gt;LDAP://dc1-nsib.neverhood.org/CN=Users,DC=neverhood,DC=org&lt;/u&gt;&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Содержимое объекта &lt;strong&gt;rootDSE&lt;/strong&gt; чуть более предсказуемо, чем результат выбора контроллера домена по-умолчанию. И что более важно, оно зависит от контекста безопасности текущего потока, а не от настроек приоритетов серверов. В частности свойство &lt;em&gt;dnsHostName&lt;/em&gt; содержит адрес контроллера домена, через который был осуществлён вход в систему. А это в свою очередь поддаётся конфигурированию на клиенте. И можно надеяться, что при грамотно настроенной конфигурации, сервер, используемый по умолчанию для входа в систему, всегда ближайший. Поэтому код, вычисляющий контекст поиска можно переписать следующим образом: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt; rootDSE = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;DirectoryEntry&lt;/span&gt;(&lt;span style="color: #a31515;"&gt;"LDAP://rootDSE"&lt;/span&gt;);&lt;br /&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; domainContextLDAP = &lt;span style="color: #a31515;"&gt;"LDAP://"&lt;/span&gt;&lt;br /&gt;&lt;strong&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;u&gt;+ rootDSE.Properties[&lt;span style="color: #a31515;"&gt;"dnsHostName"&lt;/span&gt;].Value.ToString() + &lt;span style="color: #a31515;"&gt;"/"&lt;/span&gt;&lt;br /&gt;&lt;/u&gt;&lt;/strong&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; + rootDSE.Properties[&lt;span style="color: #a31515;"&gt;"rootDomainNamingContext"&lt;/span&gt;].Value; &lt;/div&gt;&lt;br /&gt;Чтобы не быть голословным, напоследок приведу простые замеры. Для тестирования использовалась топология, в которой сайт охватывал несколько территориально распределённых офисов. Каждый из офисов содержал свой контроллер доменов. Рабочая машина была сконфигурирована таким образом, что для входа в систему использовался ближайший из них. Приложение выполняла поиск и перебор всех объектов в домене. В первом случае использовалось &lt;em&gt;serverless&lt;/em&gt; связывание, во втором контроллер домена указывался явно: &lt;br /&gt;&lt;div class="sourcecode"&gt;Search context: LDAP://DC=neverhood,DC=org&lt;br /&gt;Time left: 00:00:24.5233572&lt;br /&gt;Entities number: 6234&lt;br /&gt;Press any key...&lt;br /&gt;&lt;br /&gt;Search context: LDAP://dc1-nsib.neverhood.org/DC=neverhood,DC=org&lt;br /&gt;Time left: 00:00:06.8716871&lt;br /&gt;Entities number: 6234&lt;br /&gt;Press any key...&lt;/div&gt;По-моему цифры говорят сами за себя.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservices.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/593018713968120811'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/593018713968120811'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservices.html' title='Странный DirectoryServices. Совет первый: выражайтесь яснее, где искать'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-8835827328102571278</id><published>2011-05-23T08:00:00.002+07:00</published><updated>2011-05-23T08:10:53.545+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='Active Directory'/><title type='text'>DirectoryServices.Protocols – малоизвестная альтернатива</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Все знают о существовании пространства имён &lt;em&gt;System.DirectoryServices&lt;/em&gt;. Оно содержит набор классов, являющихся тонкой обёрткой над &lt;strong&gt;ADSI&lt;/strong&gt; – &lt;strong&gt;DCOM&lt;/strong&gt;-ориентированном API для работы с &lt;strong&gt;Active Directory&lt;/strong&gt;. Но &lt;strong&gt;ADSI&lt;/strong&gt; не единственный интерфейс, который можно использовать для общения с контроллерами домена. Помимо него в состав &lt;strong&gt;WinSDK&lt;/strong&gt; входит библиотека &lt;a href="http://msdn.microsoft.com/en-us/library/aa367008(VS.85).aspx"&gt;&lt;strong&gt;LDAP API&lt;/strong&gt;&lt;/a&gt;, реализующая 3-ю версию &lt;strong&gt;LDAP&lt;/strong&gt; API в соответствии с &lt;a href="http://tools.ietf.org/rfc/rfc2251.txt"&gt;RFC 2251&lt;/a&gt;. С её помощью приложение на &lt;strong&gt;C++&lt;/strong&gt; может получить доступ к любому &lt;strong&gt;LDAP&lt;/strong&gt; серверу под управлением любой операционной системы. Но что делать, если платформа приложения – &lt;strong&gt;.NET&lt;/strong&gt;, а язык разработки – &lt;strong&gt;C#&lt;/strong&gt;? Ответ на этот вопрос находится в пространстве имён &lt;em&gt;System.DirectoryServices.Protocols&lt;/em&gt;.&lt;br /&gt;&lt;div&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Что внутри?&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Пространство имён &lt;em&gt;System.DirectoryServices.Protocols&lt;/em&gt;&lt;strong&gt; &lt;/strong&gt;содержит множество классов. Та часть, которая интересует нас в данный момент, является тонкой обёрткой над вышеупомянутой &lt;strong&gt;LDAP API&lt;/strong&gt;. Другая его часть предоставляет доступ к протоколу &lt;strong&gt;Directory Services Markup Language (DSML) V2&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;В отличие от классов &lt;em&gt;DirectoryServices&lt;/em&gt;, представляющих сущности в &lt;strong&gt;Active Directory&lt;/strong&gt; и находящихся на вершине иерархии, классы &lt;em&gt;DirectoryServices.Protocols&lt;/em&gt; максимально приближены к транспортному уровню и ориентированы на представление операций, а не объектов. Для того, чтобы выполнить некое действие, вы должны создать соответствующий объект-запрос, сконфигурировать его и передать на исполнение. Результат вы получите в виде другого объекта, представляющего ответ сервера. В таблице ниже приведены имена классов, представляющих собой запросы и ответы, для наиболее часто используемых операций:&lt;br /&gt;&lt;table border="0" cellpadding="2" cellspacing="1" style="width: 528px;"&gt;&lt;tbody&gt;&lt;tr bgcolor="black"&gt; &lt;td valign="top" width="177"&gt;&lt;span style="color: white;"&gt;&lt;strong&gt;Операция&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt; &lt;td valign="top" width="172"&gt;&lt;span style="color: white;"&gt;&lt;strong&gt;Запрос&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt; &lt;td valign="top" width="173"&gt;&lt;span style="color: white;"&gt;&lt;strong&gt;Ответ&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr bgcolor="#dddddd"&gt; &lt;td valign="top" width="177"&gt;Создание&lt;/td&gt; &lt;td valign="top" width="172"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.addrequest.aspx"&gt;AddRequest&lt;/a&gt;&lt;/td&gt; &lt;td valign="top" width="173"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.addresponse.aspx"&gt;AddResponse&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr bgcolor="#dddddd"&gt; &lt;td valign="top" width="177"&gt;Удаление&lt;/td&gt; &lt;td valign="top" width="172"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.deleterequest.aspx"&gt;DeleteRequest&lt;/a&gt;&lt;/td&gt; &lt;td valign="top" width="173"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.deleteresponse.aspx"&gt;DeleteResponse&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr bgcolor="#dddddd"&gt; &lt;td valign="top" width="177"&gt;Редактирование&lt;/td&gt; &lt;td valign="top" width="172"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.modifyrequest.aspx"&gt;ModifyRequest&lt;/a&gt;&lt;/td&gt; &lt;td valign="top" width="173"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.modifyresponse.aspx"&gt;ModifyResponse&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr bgcolor="#dddddd"&gt; &lt;td valign="top" width="177"&gt;Поиск&lt;/td&gt; &lt;td valign="top" width="172"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.searchrequest.aspx"&gt;SearchRequest&lt;/a&gt;&lt;/td&gt; &lt;td valign="top" width="174"&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.directoryservices.protocols.searchresponse.aspx"&gt;SearchResponse&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;br /&gt;Давайте посмотрим, как пользоваться этими классами, на примере наиболее типичной операции – поиска. Перейдём сразу к коду: &lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: black;"&gt;&lt;span style="color: blue;"&gt;void&lt;/span&gt; PrintAllUsers(&lt;span style="color: blue;"&gt;string&lt;/span&gt; ldapServer, &lt;span style="color: blue;"&gt;string&lt;/span&gt; searchContext)&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #2b91af;"&gt;LdapConnection&lt;/span&gt; connection = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;LdapConnection&lt;/span&gt;(ldapServer);&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt;[] properties = &lt;span style="color: blue;"&gt;new string&lt;/span&gt;[] {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"displayName"&lt;/span&gt;, &lt;span style="color: #a31515;"&gt;"userPrincipalName"&lt;/span&gt; };&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;try&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #2b91af;"&gt;SearchRequest&lt;/span&gt; request = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;SearchRequest&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; searchContext,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"(objectClass=user)"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; SearchScope.Subtree,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; properties);&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Enable a paging&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #2b91af;"&gt;PageResultRequestControl&lt;/span&gt; paging&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;PageResultRequestControl&lt;/span&gt;(&lt;span style="color: #a31515;"&gt;1000&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; request.Controls.Add(paging);&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;while&lt;/span&gt; (&lt;span style="color: blue;"&gt;true&lt;/span&gt;)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; SearchResponse response = (SearchResponse)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; connection.SendRequest(request);&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (response.Controls.Length != &lt;span style="color: #a31515;"&gt;1&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; || !(response.Controls[&lt;span style="color: #a31515;"&gt; 0&lt;/span&gt;]&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;is&lt;/span&gt; PageResultResponseControl))&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Server does not support a paging&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;Exception&lt;/span&gt;(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"Server does not support a paging"&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;foreach&lt;/span&gt; (&lt;span style="color: #2b91af;"&gt;SearchResultEntry&lt;/span&gt; entry &lt;span style="color: blue;"&gt;in&lt;/span&gt; response.Entries)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt; displayName = GetStringAttr(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; entry, &lt;span style="color: #a31515;"&gt;"displayName"&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt; upn = GetStringAttr(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; entry, &lt;span style="color: #a31515;"&gt;"userPrincipalName"&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; System.&lt;span style="color: #2b91af;"&gt;Console&lt;/span&gt;.WriteLine(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"User '{0}' has UPN '{1}'"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; displayName,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; upn);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; PageResultResponseControl pageResponse =&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (PageResultResponseControl)response.Controls[&lt;span style="color: #a31515;"&gt; 0&lt;/span&gt;];&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (pageResponse.Cookie.Length == &lt;span style="color: #a31515;"&gt; 0&lt;/span&gt;)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Search complete&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;break&lt;/span&gt;;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: green;"&gt;// Request the next page&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; paging.Cookie = pageResponse.Cookie;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;catch&lt;/span&gt; (&lt;span style="color: #2b91af;"&gt;Exception&lt;/span&gt; e)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #2b91af;"&gt;Console&lt;/span&gt;.WriteLine(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #a31515;"&gt;"Unexpected exception occurred:\n\t{0}: {1}"&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; e.GetType().Name,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; e.Message);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; GetStringAttr(&lt;span style="color: #2b91af;"&gt;SearchResultEntry&lt;/span&gt; entry, &lt;span style="color: blue;"&gt;string&lt;/span&gt; name)&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; entry.Attributes.Contains(name)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ? entry.Attributes[name][&lt;span style="color: #a31515;"&gt; 0&lt;/span&gt;].ToString()&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; : &lt;span style="color: #a31515;"&gt;"&amp;lt;unknown&amp;gt;"&lt;/span&gt;;&lt;br /&gt;} &lt;br /&gt;&lt;/span&gt;&lt;/div&gt;Как ясно из названия, функция &lt;em&gt;PrintAllUsers&lt;/em&gt; выводит на консоль всех пользователей, которых она находит по указанному пути на переданном &lt;strong&gt;LDAP&lt;/strong&gt; сервере. Первым делом функция создаёт объект типа &lt;em&gt;LdapConnection&lt;/em&gt;, для установления соединения с &lt;strong&gt;LDAP&lt;/strong&gt; сервером (в данном примере предполагается, что текущий пользователь имеет доступ к указанному &lt;strong&gt;LDAP&lt;/strong&gt; серверу, в противном случае в конструктор &lt;em&gt;LdapConnection&lt;/em&gt; необходимо передать информацию для аутентификации). Затем создаётся объект типа &lt;em&gt;SearchRequest&lt;/em&gt;, для которого настраивается постраничный способ возврата информации с помощью объекта типа &lt;em&gt;PageResultRequestControl.&lt;br /&gt;&lt;/em&gt;Объекты управления наряду с запросами и ответами также являются типичными представители пространства имён &lt;em&gt;DirectoryServices.Protocols&lt;/em&gt;. Они регулируют различные аспекты поведения клиента и сервера, например, применение &lt;em&gt;ShowDeletedControl&lt;/em&gt; включает поиск удалённых объектов (tombstone).&lt;br /&gt;Далее запрос отправляется серверу с помощью метода &lt;em&gt;SendRequest&lt;/em&gt;, реализованного в классе &lt;em&gt;LdapConnection&lt;/em&gt;. Результатом исполнения этого метода будет объект типа &lt;em&gt;SearchResponse&lt;/em&gt;, содержащий ответ сервера со списком пользователей. Дальнейшие операции связаны с выводом данных и инициированием запроса следующей страницы.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Но зачем?&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Очевидно, что программировать с помощью высокоуровневых сущностей пространства имён &lt;em&gt;DirectoryServices&lt;/em&gt; проще, чем опускаться до уровня ответов и запросов из &lt;em&gt;DirectoryServices.Protocols&lt;/em&gt;. Тогда встаёт вопрос, чем же последние могут быть полезны? Во-первых, это уже упомянутая ранее возможность взаимодействия с &lt;strong&gt;LDAP&lt;/strong&gt; серверами "&lt;em&gt;другой породы&lt;/em&gt;".&lt;br /&gt;&lt;br /&gt;Вторая причина не так очевидна. &lt;strong&gt;ADSI&lt;/strong&gt;, лежащая в основе &lt;em&gt;DirectoryServices&lt;/em&gt;, славится своей неочевидностью в управлении памятью, что может приводить к её явному перерасходу. За примером далеко ходить не нужно, коль уж мы начали с поиска, поиском и закончим.&lt;br /&gt;Приблизительным аналогом класса &lt;em&gt;SearchResponse&lt;/em&gt; в пространстве имён &lt;em&gt;DirectoryServices&lt;/em&gt; является класс &lt;em&gt;SearchResultCollection.&lt;/em&gt; Он точно также принимает и сохраняет результат операции поиска. Но в отличие от &lt;em&gt;SearchResponse&lt;/em&gt;, который всегда хранит только одну возвращённую &lt;em&gt;страницу&lt;/em&gt; фиксированного размера, &lt;em&gt;SearchResultCollection&lt;/em&gt; удерживает ссылки на все найденные объекты со всеми полученными атрибутами. Таким образом, вы не можете освободить объекты, которые уже обработали, и вынуждены держать их в памяти до полного завершения. А что если количество объектов измеряется десятками тысяч и они содержат сотни массивных атрибутов? Сам по себе перерасход памяти хоть и неприятен, но не критичен. Критичной является ситуация, когда объём потребляемой памяти напрямую зависит от внешнего фактора, и ваше приложение не имеет возможности на это повлиять. В своё время это было решающим аргументом в пользу использования &lt;em&gt;DirectoryService.Protocols&lt;/em&gt; в утилите &lt;strong&gt;Customer Directory Integration&lt;/strong&gt; входящей в состав &lt;strong&gt;Parallels Operations Automation&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Ну и последнее. Откровенно говоря, то, что программировать с помощью &lt;strong&gt;ADSI&lt;/strong&gt; и классов &lt;em&gt;DirectoryServices&lt;/em&gt; проще, – это миф. Она содержит такое количество подводных камней, прикрытых высокими абстракциями, что порой проще опуститься на самый низкий уровень, дабы понимать, что на самом деле ты делаешь.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservicesprotocols.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/8835827328102571278'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/8835827328102571278'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservicesprotocols.html' title='DirectoryServices.Protocols – малоизвестная альтернатива'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-4240642747344171721</id><published>2011-05-15T21:47:00.002+07:00</published><updated>2011-07-01T01:08:13.959+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Data Transfer'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='C++'/><title type='text'>Google Protobuf - замена вашему велосипеду</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Как часто приходится сталкивать с проблемой &lt;em&gt;сериализации&lt;/em&gt; / &lt;em&gt;десериализации&lt;/em&gt; данных? И если в &lt;strong&gt;.NET&lt;/strong&gt; подобная проблема решена более-менее стандартно, то, как быть, если вы пишите код на &lt;strong&gt;C++&lt;/strong&gt;? Или ещё хуже: вам необходимо обмениваться сообщениями между сервером, написанным на &lt;strong&gt;C++&lt;/strong&gt; и клиентом, написанным на &lt;strong&gt;C#&lt;/strong&gt;. Некоторое время назад я открыл для себя такую вещь, как &lt;strong&gt;Google Protocol Buffers&lt;/strong&gt;. В этой заметке я постараюсь рассказать, что это такое и зачем оно может быть полезно.   &lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Велосипед не нужно изобретать – на нём нужно ездить!&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Чтобы понять, чем же хорош &lt;strong&gt;Google Protobuf&lt;/strong&gt;, нужно осознать, чем плохи реализации собственных протоколов и библиотек &lt;em&gt;сериализации&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Главная проблема собственных реализаций в том, что их нужно реализовывать. Я предпочитаю тратить время на более интересные занятия, нежели в очередной раз писать ручной &lt;em&gt;сериализатор&lt;/em&gt; / &lt;em&gt;десериализатор&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Вторая проблема не так очевидна, но она напрямую следует из первой. В какой момент вы задумываетесь о возможности расширения вашего протокола? Хорошо, если вашей квалификации оказалось достаточно, чтобы подумать о проблеме расширения заранее, и снабдить ваш протокол необходимыми свойствами (как минимум вы добавили номер версии в заголовок). Отлично, если вы придумали, как сохранить обратную совместимость между версиями. Но это всё равно не спасёт, если какая-то из частей вашей системы, не будучи обновлённой (потому что обновление ей не требуется), начнём падать, при получении сообщений в новом формате. Просто кто-то из самых лучших побуждений встроил в неё жёсткую проверку версий.&lt;br /&gt;В этом плане показателен пример &lt;strong&gt;XML&lt;/strong&gt;`я. Расширять протоколы на базе &lt;strong&gt;XML&lt;/strong&gt;`я легко – просто добавляем новый тэг, не так ли? Да, но до тех пор, пока вы не додумались вставить проверку по &lt;strong&gt;DTD&lt;/strong&gt;! Как вы помните, данная проверка любезно сообщает вам не только об отсутствии необходимых элементов, но и о наличии неожидаемых и даже о неправильном порядке следования тэгов. Поэтому при расширении такого протокола, вы будете вынуждены обновлять все компоненты системы, даже если изменения имеют обратную совместимость, и новые элементы нужны только некоторым частям.&lt;br /&gt;&lt;br /&gt;Ну и наконец, третья проблема: кросс-платформенность. Допустим, вы имеете стабильную систему, написанную на &lt;strong&gt;C++&lt;/strong&gt;; реализация вашего протокола отлажена и не даёт сбоев; клиенты довольны. И вдруг у вас появляется новый компонент, написанный на &lt;strong&gt;Java&lt;/strong&gt;! Вам придётся пройти весь путь по реализации и отладки протокола с самого начала. И в будущем решать проблему совместимости для 2-ух платформ, вместо одной.&lt;br /&gt;&lt;br /&gt;Если вы успешно решите все эти проблемы, то вы окажетесь в одном шаге от собственной реализации того, что называется &lt;strong&gt;Google Protocol Buffers&lt;/strong&gt;. Поэтому вы можете сильно сэкономить время и стоимость разработки, если сразу воспользуетесь его возможностями.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Приготовились…&lt;br /&gt;&lt;/span&gt;&lt;/strong&gt;&lt;strong&gt;Google Protobuf&lt;/strong&gt; позволяет вам определить протокол передачи данных между различными частями системы на декларативном языке и сгенерировать по этому описанию набор классов для &lt;em&gt;сериализации&lt;/em&gt; и &lt;em&gt;десериализации&lt;/em&gt;. &lt;a href="http://code.google.com/p/protobuf/"&gt;Официальная реализация от &lt;strong&gt;Google&lt;/strong&gt;&lt;/a&gt; поддерживает 3 языка: &lt;strong&gt;С++&lt;/strong&gt;, &lt;strong&gt;Java&lt;/strong&gt; и &lt;strong&gt;Python&lt;/strong&gt;. Кроме этого, энтузиастами создана и поддерживается версия &lt;strong&gt;Protobuf&lt;/strong&gt; для &lt;strong&gt;.NET&lt;/strong&gt;: &lt;a href="http://code.google.com/p/protobuf-net/"&gt;Protobuf-net&lt;/a&gt;. Классы, сгенерированные для разных языков, совместимы на уровне формата передаваемых данных. Это означает, что информация &lt;em&gt;сериализованная&lt;/em&gt; с помощью сгенерированного &lt;strong&gt;C++&lt;/strong&gt; класса, легко &lt;em&gt;десериализуется&lt;/em&gt; в &lt;strong&gt;Java&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Итак, посмотрим, что же это такое. Для начала скачаем исходники со &lt;a href="http://code.google.com/p/protobuf/downloads/list"&gt;страницы загрузок проекта&lt;/a&gt; и соберём необходимые библиотеки и компилятор &lt;em&gt;protoc&lt;/em&gt;, который используется для генерации классов реализации по описанию протокола. Для тестирования я использовал версию &lt;em&gt;2.3.0&lt;/em&gt;, как наиболее проверенную и отлаженную. Список файлов содержит 3 идентичных архива с исходными кодами, отличающимися только типом архиватора: &lt;em&gt;protobuf-2.3.0.tar.bz2&lt;/em&gt;, &lt;em&gt;protobuf-2.3.0.tar.gz&lt;/em&gt; и &lt;em&gt;protobuf-2.3.0.zip&lt;/em&gt;. И один архив &lt;em&gt;protoc-2.3.0-win32.zip &lt;/em&gt;с &lt;strong&gt;Windows&lt;/strong&gt; сборкой компилятора &lt;em&gt;protoc&lt;/em&gt;, смысла в котором нет никакого.&lt;br /&gt;Распакованный архив исходных файлов в числе прочего содержит каталог &lt;em&gt;vsprojects&lt;/em&gt;, содержащий проекты, для сборки &lt;strong&gt;Protobuf&lt;/strong&gt; в &lt;strong&gt;Visual Studio&lt;/strong&gt;. Файлы проектов в формате &lt;strong&gt;Visual Studio 2008&lt;/strong&gt;, поэтому владельцы более поздних версий студии пройдут через автоматическую процедуру преобразования при первом открытии файла &lt;em&gt;protobuf.sln&lt;/em&gt;, владельцы же &lt;strong&gt;Visual Studio 2005&lt;/strong&gt; должны будут преобразовать проекты вручную с помощью прилагаемого скрипта &lt;em&gt;convert2008to2005.sh&lt;/em&gt; (для его запуска нужен &lt;strong&gt;CygWin&lt;/strong&gt;). Открытый solution содержит 3 библиотеки &lt;strong&gt;protobuf&lt;/strong&gt;`а: &lt;em&gt;libprotobuf&lt;/em&gt;, &lt;em&gt;libprotobuf-lite&lt;/em&gt; и &lt;em&gt;libprotoc&lt;/em&gt;; компилятор &lt;em&gt;protoc&lt;/em&gt; и несколько проектов с тестами. Поскольку последние отказались собираться в моей &lt;strong&gt;Visual Studio 2010 Express&lt;/strong&gt;, я их отключил – на работоспособность библиотек это не повлияло.&lt;br /&gt;Собираем весь solution (необходимо собрать обе конфигурации – &lt;em&gt;Debug&lt;/em&gt; и &lt;em&gt;Release&lt;/em&gt;, потому что &lt;em&gt;Release&lt;/em&gt; версия библиотек окажется не совместимой с &lt;em&gt;Debug&lt;/em&gt; версией вашего проекта и наоборот). Запускаем &lt;em&gt;extract_includes.bat&lt;/em&gt; (находится в том же каталоге &lt;em&gt;vsprojects&lt;/em&gt;) – он скопирует все необходимые заголовки в каталог &lt;em&gt;include&lt;/em&gt;. Теперь собранные библиотеки, скопированные заголовки и компилятор &lt;em&gt;protoc&lt;/em&gt; можно использовать в своём проекте. На самом деле библиотека нужна ровно одна – &lt;em&gt;libprotobuf.lib&lt;/em&gt;. Библиотека &lt;em&gt;libprotobuf-lite.lib&lt;/em&gt; представляет собой облегчённую версию с урезанным функционалом, а библиотека &lt;em&gt;libprotoc.lib&lt;/em&gt; предназначена для компиляции компилятора.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Поехали!&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Формат сообщений в &lt;strong&gt;Protobuf&lt;/strong&gt; описывается на специальном декларативном языке, который в чём-то напоминает декларацию структур в языке &lt;strong&gt;C++&lt;/strong&gt;. Эти декларации сохраняются в файл с расширением &lt;em&gt;.proto&lt;/em&gt; и компилируются в исходные коды на выбранном языке с помощью компилятора &lt;em&gt;protoc&lt;/em&gt;. &lt;a name="user-sample"&gt;Для тестирования я подготовил декларацию, описывающую некоторые свойства пользователя в &lt;strong&gt;Active Directory&lt;/strong&gt; (файл user.proto)&lt;/a&gt;:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;package&lt;/span&gt; ad.sync;&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;import&lt;/span&gt; "phone_number.proto";&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;message&lt;/span&gt; User {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; id = 1;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; ldap = 2;&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;message&lt;/span&gt; Login {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;optional string&lt;/span&gt; domain = 1;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; account = 2;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;required&lt;/span&gt; Login login = 3;&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;optional string&lt;/span&gt; display_name = 4;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;repeated&lt;/span&gt; PhoneNumber phoneNumber = 5;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;repeated string&lt;/span&gt; memberOf = 6;&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Декларация телефонного номера вынесена в отдельный файл – &lt;br /&gt;&lt;div class="sourcecode"&gt;phone_number.proto:&lt;br /&gt;&lt;span style="color: blue;"&gt;package&lt;/span&gt; ad.sync;&lt;br /&gt;&lt;br /&gt;&lt;span style="color: blue;"&gt;message&lt;/span&gt; PhoneNumber {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;required string&lt;/span&gt; number = 1;&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;enum&lt;/span&gt; Type {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; HOME = 0;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; WORK = 1;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; MOBILE = 2;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; IPPHONE = 3;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;optional&lt;/span&gt; Type type = 2 [&lt;span style="color: blue;"&gt;default&lt;/span&gt; = HOME];&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Компилируем оба proto-файла в классы реализации:&lt;br /&gt;&lt;div class="sourcecode"&gt;protoc.exe --proto_path=ProtoBufTest\Proto&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; --cpp_out=ProtoBufTest\Messages&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; --error_format=msvs&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ProtoBufTest\Proto\phone_number.proto&lt;br /&gt;protoc.exe --proto_path=ProtoBufTest\Proto&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; --cpp_out=ProtoBufTest\Messages&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; --error_format=msvs&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ProtoBufTest\Proto\user.proto&lt;/div&gt;&lt;br /&gt;Подключаем к проекту все файлы, сгенерированные в каталог &lt;em&gt;ProtoBufTest\Messages&lt;/em&gt;, и всё – теперь мы можем сериализовать и десериализовать данные, согласно нашей декларации. Давайте попробуем сохранить сообщение в файл из приложения на &lt;strong&gt;C++&lt;/strong&gt;:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: black;"&gt;&lt;span style="color: green;"&gt;// Fill data&lt;/span&gt;&lt;br /&gt;user.set_id(&lt;span style="color: #a31515;"&gt;"1234"&lt;/span&gt;);&lt;br /&gt;user.set_ldap(&lt;span style="color: #a31515;"&gt;"LDAP://CN=JDoe,CN=Users,DC=neverhood,DC=org"&lt;/span&gt;);&lt;br /&gt;user.mutable_login()-&amp;gt;set_domain(&lt;span style="color: #a31515;"&gt;"neverhood"&lt;/span&gt;);&lt;br /&gt;user.mutable_login()-&amp;gt;set_account(&lt;span style="color: #a31515;"&gt;"jdoe"&lt;/span&gt;);&lt;br /&gt;user.set_display_name(&lt;span style="color: #a31515;"&gt;"John Doe"&lt;/span&gt;);&lt;br /&gt;user.add_phonenumber()-&amp;gt;set_number(&lt;span style="color: #a31515;"&gt;"+7 (123) 456-78-90"&lt;/span&gt;);&lt;br /&gt;ad::sync::PhoneNumber *workPhone = user.add_phonenumber();&lt;br /&gt;workPhone-&amp;gt;set_number(&lt;span style="color: #a31515;"&gt;"+7 (123) 444-55-66"&lt;/span&gt;);&lt;br /&gt;workPhone-&amp;gt;set_type(ad::sync::PhoneNumber::WORK);&lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// And save to a file stream&lt;/span&gt;&lt;br /&gt;std::ofstream fileStream(&lt;span style="color: #a31515;"&gt;"user.msg"&lt;/span&gt;, std::ios_base::binary);&lt;br /&gt;user.SerializeToOstream(&amp;amp;fileStream);&lt;br /&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style="color: grey; font-size: xx-small;"&gt;* This source code was highlighted with &lt;a href="http://virtser.net/blog/post/source-code-highlighter.aspx"&gt;&lt;span style="color: grey; font-size: xx-small;"&gt;Source Code Highlighter&lt;/span&gt;&lt;/a&gt;.&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;А прочитаем сохранённое сообщение в приложении на &lt;strong&gt;C#&lt;/strong&gt; (для этого воспользуемся библиотекой &lt;em&gt;Protobuf-net&lt;/em&gt;, которую я упоминал выше):&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: black;"&gt;&lt;span style="color: #2b91af;"&gt;FileStream&lt;/span&gt; fileStream = &lt;span style="color: blue;"&gt;new&lt;/span&gt; &lt;span style="color: #2b91af;"&gt;FileStream&lt;/span&gt;(&lt;span style="color: #a31515;"&gt;"user.msg"&lt;/span&gt;, &lt;span style="color: #2b91af;"&gt;FileMode&lt;/span&gt;.Open);&lt;br /&gt;&lt;br /&gt;ad.sync.User user = ProtoBuf.Serializer.Deserialize&amp;lt;ad.sync.User&amp;gt;(fileStream);&lt;br /&gt;&lt;span style="color: #2b91af;"&gt;Console&lt;/span&gt;.WriteLine(&lt;span style="color: #a31515;"&gt;"ID: "&lt;/span&gt; + user.id);&lt;br /&gt;&lt;span style="color: #2b91af;"&gt;Console&lt;/span&gt;.WriteLine(&lt;span style="color: #a31515;"&gt;"Display name:"&lt;/span&gt; + user.display_name);&lt;br /&gt;&lt;span style="color: #2b91af;"&gt;Console&lt;/span&gt;.WriteLine(&lt;span style="color: #a31515;"&gt;"LDAP:"&lt;/span&gt; + user.ldap);&lt;br /&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style="color: grey; font-size: xx-small;"&gt;* This source code was highlighted with &lt;a href="http://virtser.net/blog/post/source-code-highlighter.aspx"&gt;&lt;span style="color: grey; font-size: xx-small;"&gt;Source Code Highlighter&lt;/span&gt;&lt;/a&gt;.&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;Результат выполнения приложения на &lt;strong&gt;C#&lt;/strong&gt;:&lt;br /&gt;&lt;div class="sourcecode"&gt;ID: 1234&lt;br /&gt;Display name:John Doe&lt;br /&gt;LDAP:LDAP://CN=JDoe,CN=Users,DC=neverhood,DC=org&lt;/div&gt;&lt;br /&gt;Потрясающе – оно работает! Чтобы написать такое с нуля понадобится гораздо больше времени.&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/05/google-protobuf.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/4240642747344171721'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/4240642747344171721'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/google-protobuf.html' title='Google Protobuf - замена вашему велосипеду'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5808803381947946524</id><published>2011-05-09T03:45:00.000+07:00</published><updated>2011-05-09T03:45:35.697+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Security'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><title type='text'>Чудеса аутентификации. Чудо второе: доступ запрещён</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Допустим, вы пишете клиент-серверное приложение, причём серверная часть состоит из нескольких компонентов. После получения запроса, сервис, реализующий внешний интерфейс, выполняет &lt;em&gt;олицетворение&lt;/em&gt; (&lt;em&gt;impersonation&lt;/em&gt;) клиента и отправляет запросы к остальным частям сервера по мере необходимости. Рассмотрим типичную ситуацию: всё прекрасно работало, пока серверные компоненты были развёрнуты на одной машине в вашем тестовом окружении, но как только сервер попал в отдел контроля качества, и его части оказались на разных машинах (он стал действительно распределённым), клиент начал получать ошибку "&lt;em&gt;Access denied&lt;/em&gt;". Даже программисты с хорошим опытом зачастую попадают в подобную ловушку и не могут сразу ответить, что же идёт не так. &lt;div&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Impersonation vs Delegation&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Типичным примером описанной проблемы является ошибка отказа доступа при попытке обращения сервера от имени клиента к сервисам &lt;strong&gt;Active Directory&lt;/strong&gt; через &lt;strong&gt;ADSI&lt;/strong&gt; или &lt;strong&gt;.NET&lt;/strong&gt; классы из пространства имён &lt;em&gt;System.DirectoryServices&lt;/em&gt;, которые являются всего лишь тонкой обёрткой вокруг всё того же &lt;strong&gt;ADSI&lt;/strong&gt;. Всё работает до той поры, пока сервер запускается на контроллере домена. Как только он оказывается на любой другой машине домена, всё разваливается на глазах.&lt;br /&gt;&lt;br /&gt;Данная проблема хорошо известна под названием "&lt;em&gt;Проблемы двойного прыжка&lt;/em&gt;" или "&lt;em&gt;Double hop problem&lt;/em&gt;". Дело в том, что существует два уровня олицетворения клиента: собственно &lt;em&gt;олицетворение&lt;/em&gt; (&lt;em&gt;impersonation&lt;/em&gt;) и &lt;em&gt;делегирование&lt;/em&gt; (&lt;em&gt;delegation&lt;/em&gt;). Первый уровень олицетворения позволяет серверу выполнять &lt;u&gt;локальные&lt;/u&gt; операции от имени клиента. И только &lt;u&gt;делегирование&lt;/u&gt; позволяет серверу представляться клиентом при выполнении &lt;u&gt;удалённых&lt;/u&gt; операций. Поскольку обращение к сервисам &lt;strong&gt;Active Directory&lt;/strong&gt; через &lt;strong&gt;ADSI&lt;/strong&gt; подразумевает удалённый вызов (это не что иное, как обращение к &lt;strong&gt;DCOM&lt;/strong&gt; объектам), то все попытки сервера осуществить подобный вызов от имени клиента при отключенной возможности делегирования завершатся с ошибкой "&lt;em&gt;Access denied&lt;/em&gt;".&lt;br /&gt;&lt;br /&gt;Делегирование возможно при соблюдении следующих условий: &lt;br /&gt;&lt;ol&gt;&lt;li&gt;В домене используется протокол аутентификации &lt;strong&gt;Kerberos&lt;/strong&gt;.&lt;/li&gt;&lt;li&gt;Клиент явно разрешает серверу использовать свой маркер для делегирования. В случае &lt;strong&gt;DCOM&lt;/strong&gt;, например, это можно сделать, с помощью функций &lt;a href="http://msdn.microsoft.com/en-us/library/ms693736(VS.85).aspx"&gt;&lt;em&gt;CoInitializeSecurity&lt;/em&gt;&lt;/a&gt; или &lt;a href="http://msdn.microsoft.com/en-us/library/ms692692(VS.85).aspx"&gt;&lt;em&gt;CoSetProxyBlanket&lt;/em&gt;&lt;/a&gt; (в обоих случаях достигается передачей значения &lt;em&gt;RPC_C_IMP_LEVEL_DELEGATE&lt;/em&gt; через атрибут &lt;em&gt;dwImpLevel&lt;/em&gt;).&lt;/li&gt;&lt;li&gt;Учётная запись пользователя &lt;u&gt;не отмечена&lt;/u&gt; в &lt;strong&gt;Active Directory&lt;/strong&gt; как "&lt;em&gt;Account is sensitive and cannot be delegated&lt;/em&gt;".&lt;/li&gt;&lt;li&gt;Учётная запись сервера отмечена в &lt;strong&gt;Active Directory&lt;/strong&gt; как "&lt;em&gt;Trust computer for delegation&lt;/em&gt;" (настройки доступны на вкладке &lt;em&gt;Delegation&lt;/em&gt; свойств хоста в &lt;strong&gt;Active Directory&lt;/strong&gt;).&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Kerberos и делегирование&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Делегирование возможно только в рамках применения протокола &lt;strong&gt;Kerberos&lt;/strong&gt; - это единственный провайдер в ОС &lt;strong&gt;Windows&lt;/strong&gt;, поддерживающий данный тип олицетворения. Необходимо отметить, что в числе настроек "&lt;em&gt;Constrained delegation&lt;/em&gt;" (вкладка &lt;strong&gt;Delegation&lt;/strong&gt; свойств хоста), есть возможность выбрать опцию "&lt;em&gt;Use any authentication protocol&lt;/em&gt;". Эта опция означает использование &lt;em&gt;преобразование протоколов&lt;/em&gt; (&lt;em&gt;protocol transition&lt;/em&gt;) и подразумевает преобразование любого протокола аутентификации, используемого клиентом, в протокол &lt;strong&gt;Kerberos&lt;/strong&gt;.&lt;br /&gt;Требование &lt;strong&gt;Kerberos&lt;/strong&gt; возникло не случайно. Делегирование полностью основано на особенностях данного протокола. Постараюсь кратко изложить его суть. Протокол &lt;strong&gt;Kerberos&lt;/strong&gt; является частным случаем протокола &lt;em&gt;Нидхема - Шрёдера&lt;/em&gt;, он состоит из нескольких фаз: &lt;br /&gt;&lt;ol&gt;&lt;li&gt;Аутентификация в домене и получение &lt;em&gt;Билета для получения билетов&lt;/em&gt; (&lt;em&gt;Ticket Granting Ticket - TGT&lt;/em&gt;).&lt;/li&gt;&lt;li&gt;Получение &lt;em&gt;Билета для доступа к сервису&lt;/em&gt; (&lt;em&gt;Client to Server Ticket&lt;/em&gt; - &lt;em&gt;CST&lt;/em&gt;).&lt;/li&gt;&lt;li&gt;Обращение к сервису.&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;Билет является основополагающим элементом в протоколе &lt;strong&gt;Kerberos&lt;/strong&gt;. Он выдаётся клиенту, для дальнейшего предоставления удалённому сервису. Каждый билет, в том числе и &lt;em&gt;Билет для получения билетов&lt;/em&gt; (&lt;em&gt;TGT&lt;/em&gt;), содержит в открытом виде домен и имя пользователя, которому данный билет был предоставлен. Помимо открытых полей он содержит следующие поля, зашифрованные секретным ключом того сервиса, которому билет адресован:  &lt;br /&gt;&lt;ul&gt;&lt;li&gt;флаги;&lt;/li&gt;&lt;li&gt;сессионный ключ;&lt;/li&gt;&lt;li&gt;домен и имя пользователя (копия открытых полей);&lt;/li&gt;&lt;li&gt;время действия билета (начало и конец);&lt;/li&gt;&lt;li&gt;адрес клиентского хоста, которому был выдан билет;&lt;/li&gt;&lt;li&gt;данные для авторизации (например, перечень групп, в которые входит данный пользователь).&lt;/li&gt;&lt;/ul&gt;&lt;br /&gt;В качестве секретного ключа клиента используется хэш пароля, вычисленный операционной системой при входе пользователя на клиентскую машину. Билеты выдаются Центром Распространения Ключей (Key Distribution Center - &lt;em&gt;KDC&lt;/em&gt;), роль которого исполняет контроллер домена. Ему известны секретные ключи всех серверов и хэши паролей всех пользователей домена.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;Получение TGT&lt;/u&gt;  &lt;br /&gt;&lt;ol&gt;&lt;li&gt;Клиентская операционная система отправляет запрос на получение &lt;em&gt;TGT&lt;/em&gt;, содержащий учётные данные пользователя, сразу после ввода пользователем пароля при входе в систему.&lt;/li&gt;&lt;li&gt;&lt;em&gt;KDC&lt;/em&gt; генерирует сессионный ключ &lt;em&gt;Kck&lt;/em&gt; для обмена сообщениями между клиентом и &lt;em&gt;KDC&lt;/em&gt; и записывает его в формируемый билет &lt;em&gt;TGT&lt;/em&gt;. Закрытые поля &lt;em&gt;TGT&lt;/em&gt; шифруются своим секретным ключом &lt;em&gt;KDC&lt;/em&gt;. Ключ &lt;em&gt;Kck&lt;/em&gt; шифруется хэшем пароля пользователя, который имеется в наличии у &lt;em&gt;KDC&lt;/em&gt;, и данная информация вместе с TGT отправляется клиенту.&lt;/li&gt;&lt;li&gt;Клиент расшифровывает сессионный ключ &lt;em&gt;Kck&lt;/em&gt; своей копией хэша пароля и запоминает его вместе с &lt;em&gt;TGT&lt;/em&gt;.&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;&lt;u&gt;Получение CST&lt;/u&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;Клиент отправляет &lt;em&gt;KDC&lt;/em&gt; следующие сообщения: &lt;em&gt;TGT&lt;/em&gt; и идентификатор сервиса, к которому необходим доступ; аутентификатор клиента (идентификатор клиента и временной штамп), зашифрованный ключом &lt;em&gt;Kck&lt;/em&gt;.&lt;/li&gt;&lt;li&gt;&lt;em&gt;KDC&lt;/em&gt; расшифровывает &lt;em&gt;TGT&lt;/em&gt; своим ключом, извлекает из него сессионный ключ &lt;em&gt;Kck;&lt;/em&gt; расшифровывает аутентификатор клиента, сравнивает IP адрес клиента с IP адресом из &lt;em&gt;TGT&lt;/em&gt;, проверяет временной штамп (он должен отличаться от текущего времени &lt;em&gt;KDC&lt;/em&gt; не более чем на 5 минут).&lt;/li&gt;&lt;li&gt;Если все проверки успешны, &lt;em&gt;KDC&lt;/em&gt; берёт идентификатор запрашиваемого сервера, определяет его секретный ключ, генерирует сессионный ключ &lt;em&gt;Kcs&lt;/em&gt; для обмена сообщениями между клиентом и сервером и прописывает его в формируемый билет &lt;em&gt;CST&lt;/em&gt;. &lt;em&gt;CST&lt;/em&gt; шифруется ключом сервера, &lt;em&gt;Kcs&lt;/em&gt; шифруется хэшем пароля клиента и оба сообщения отправляются в ответ на полученный запрос.&lt;/li&gt;&lt;li&gt;Клиент расшифровывает сессионный ключ &lt;em&gt;Kcs&lt;/em&gt; своей копией хэша пароля и запоминает его вместе с &lt;em&gt;CST.&lt;/em&gt;&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;&lt;u&gt;Обращение к сервису&lt;/u&gt; &lt;br /&gt;&lt;ol&gt;&lt;li&gt;Клиент отправляет серверу &lt;em&gt;CST&lt;/em&gt; и свой аутентификатор, зашифрованный ключом &lt;em&gt;Kcs&lt;/em&gt;.&lt;/li&gt;&lt;li&gt;Сервер расшифровывает &lt;em&gt;CST&lt;/em&gt; своим ключом, извлекает из него сессионный ключ &lt;em&gt;Kcs&lt;/em&gt;, расшифровывает аутентификатор клиента и проверяет временной штамп. Если требуется взаимная аутентификация, то формирует ответ, содержащий временной штамп клиента +1, зашифрованный сессионным ключом &lt;em&gt;Kcs&lt;/em&gt;.&lt;/li&gt;&lt;li&gt;Клиент проверяет ответ сервера, и соединение считается установленным. В дальнейшем сессионный ключ Kcs используется для шифрования и / или подписания сообщений между клиентом и сервером.&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;Итак, где же в этой цепочке появляется делегирование? Если все условия для делегирования выполнены, то &lt;em&gt;KDC&lt;/em&gt;, выписывая клиенту &lt;em&gt;TGT&lt;/em&gt;, добавляет к его флагам ключ &lt;em&gt;FORWARDABLE&lt;/em&gt;. Если клиент хочет предоставить серверу право делегирования, вместе с &lt;em&gt;CST&lt;/em&gt; он отправляет &lt;em&gt;TGT&lt;/em&gt; и ключ &lt;em&gt;Kck&lt;/em&gt; зашифрованный ключом &lt;em&gt;Kcs&lt;/em&gt;. Сервер использует &lt;em&gt;TGT&lt;/em&gt; и ключ &lt;em&gt;Kck &lt;/em&gt;для получения CST от имени клиента на доступ к любому удалённому ресурсу. Флаг &lt;em&gt;FORWARDABLE, &lt;/em&gt;включённый в состав TGT, информирует KDC о необходимости пропустить проверку IP адресов. Полученный таким образом билет сервер использует для доступа к нужному ресурсу так, как будто бы аутентификацию прошёл сам клиент.&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/05/blog-post_09.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5808803381947946524'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5808803381947946524'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/blog-post_09.html' title='Чудеса аутентификации. Чудо второе: доступ запрещён'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-453154434345604068</id><published>2011-05-01T06:02:00.002+07:00</published><updated>2011-05-09T03:48:45.841+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Security'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><title type='text'>Чудеса аутентификации. Чудо первое: доступ разрешён</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Как-то раз я поспорил с одним коллегой о том, каким образом &lt;strong&gt;ОС&lt;/strong&gt; &lt;strong&gt;Windows&lt;/strong&gt; хэширует пароли, а именно: &lt;em&gt;солит&lt;/em&gt; она их или нет. Коллега, будучи весьма опытным человеком, с абсолютной уверенностью утверждал, что хэш пароля просто обязан быть солёным. Его уверенность базировалась на теории о том, что без применения &lt;em&gt;соли&lt;/em&gt; данные по хэшу легко вскрываются атакой со словарём. Вот только эта теория никак не могла объяснить такую странность:&amp;nbsp; &lt;ul&gt;&lt;li&gt;есть 2 хоста, не включённых в домен, – &lt;em&gt;AliceHost&lt;/em&gt; и &lt;em&gt;BobHost&lt;/em&gt;;&lt;/li&gt;&lt;li&gt;на обоих хостах есть одноимённые пользователи с одинаковыми паролями: &lt;em&gt;AliceHost\user&lt;/em&gt; и &lt;em&gt;BobHost\user;&lt;/em&gt;&lt;/li&gt;&lt;li&gt;на хосте &lt;em&gt;AliceHost&lt;/em&gt; есть сетевая папка &lt;em&gt;\\AliceHost\Folder&lt;/em&gt;, доступ к которой предоставлен только пользователю &lt;em&gt;AliceHost\user&lt;/em&gt;;&lt;/li&gt;&lt;li&gt;если на хосте BobHost осуществить вход пользователем BobHost\user, то вы легко получите доступ к папке &lt;em&gt;\\AliceHost\Folder.&lt;/em&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Хэши&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Очевидно, что подобный трюк возможен лишь в 2-ух случаях:  &lt;br /&gt;&lt;ul&gt;&lt;li&gt;пароль хранится открытым текстом или кэшируется в сессии,&lt;/li&gt;&lt;li&gt;хэши паролей на обоих хостах совпадают.&lt;/li&gt;&lt;/ul&gt;Первый вариант можно даже не рассматривать, как совершенно абсурдный. Реальность гораздо проще: &lt;strong&gt;ОС Windows&lt;/strong&gt; действительно не осуществляет никаких модификаций пароля перед хэшированием. Поэтому на разных хостах для одного и того же пароля мы будем иметь один и тот же хэш. Если быть точнее, то хэша может быть два: &lt;strong&gt;LM хэш&lt;/strong&gt; и &lt;strong&gt;NT хэш&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Для вычисления &lt;strong&gt;LM хэша&lt;/strong&gt; применяется алгоритм &lt;a href="http://en.wikipedia.org/wiki/Data_Encryption_Standard"&gt;&lt;strong&gt;DES&lt;/strong&gt;&lt;/a&gt;, при этом хэшируются только первые 14 символов пароля, преобразованные к верхнему регистру. Этот хэш был разработан для очень старых версий &lt;strong&gt;ОС Windows&lt;/strong&gt;. Его криптографическая надёжность не выдерживает никакой критики, на современных системах он отключен в конфигурации по умолчанию (&lt;strong&gt;Windows Vista&lt;/strong&gt; и выше), включать и использовать не рекомендуется и здесь более упоминаться не будет.&lt;br /&gt;&lt;strong&gt;NT хэш&lt;/strong&gt; гораздо проще и надёжнее. Он представляет собой &lt;strong&gt;&lt;a href="http://en.wikipedia.org/wiki/MD4"&gt;MD4&lt;/a&gt;&lt;/strong&gt; хэш над паролем, преобразованным в &lt;strong&gt;Unicode&lt;/strong&gt; строку. Максимальная длина пароля – 128 символов. &lt;strong&gt;NT хэш&lt;/strong&gt; в отличие от &lt;strong&gt;LM хэша&lt;/strong&gt; чувствителен к регистру символов. Длина обоих хэшей равна 16 байтам.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Протоколы&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Основными протоколами сетевой аутентификации в &lt;strong&gt;ОС Windows&lt;/strong&gt; являются: &lt;strong&gt;Kerberos&lt;/strong&gt;, &lt;strong&gt;NTLMv1&lt;/strong&gt; и &lt;strong&gt;NTLMv2&lt;/strong&gt;. Протокол &lt;a href="http://en.wikipedia.org/wiki/Kerberos_(protocol)"&gt;&lt;strong&gt;Kerberos&lt;/strong&gt;&lt;/a&gt; применяется только для аутентификации в домене &lt;strong&gt;Active Directory&lt;/strong&gt;. Он является международным стандартом и достаточно хорошо описан. Здесь я его рассматривать не буду.&lt;br /&gt;&lt;br /&gt;Протокол &lt;strong&gt;NTLM&lt;/strong&gt; является закрытым протоколом компании &lt;strong&gt;Microsoft&lt;/strong&gt;, вся имеющаяся о нём информация была получена методом reverse engineering`а. Он&amp;nbsp;применяется практически всегда, когда не возможно использование протокола &lt;strong&gt;Kerberos&lt;/strong&gt;, например, вне домена &lt;strong&gt;Active Directory&lt;/strong&gt;.&amp;nbsp;Впервые данный протокол появился в &lt;strong&gt;Windows NT 3.5&lt;/strong&gt;. Первая версия протокола используется до сих пор и сейчас известна под названием &lt;strong&gt;NTLMv1&lt;/strong&gt;. Аутентификация выполняется следующим образом: &lt;br /&gt;&lt;ol&gt;&lt;li&gt;Клиент отправляет серверу запрос на аутентификацию.&lt;/li&gt;&lt;li&gt;В ответ на запрос сервер отвечает случайным 8-байтным числом – &lt;em&gt;server challenge&lt;/em&gt;.&lt;/li&gt;&lt;li&gt;Клиент берёт 16-байтный &lt;strong&gt;NT хэш&lt;/strong&gt; пароля, дополняет его нулями до 21-ого байта и полученную последовательность разбивает на 3 части по 7 байтов. Каждая из этих частей используется как ключ для независимого шифрования ответа сервера алгоритмом &lt;strong&gt;DES&lt;/strong&gt;. Три полученных шифрованных последовательности соединяются в одно 24-байтное значение, которое отправляется серверу.&lt;/li&gt;&lt;li&gt;Сервер выполняет аналогичное преобразование своего ответа, используя свою версию &lt;strong&gt;NT хэша&lt;/strong&gt;. Если полученное значение совпадает с ответом клиента, то аутентификация считается успешной.&lt;/li&gt;&lt;/ol&gt;Одного этого описания уже достаточно, чтобы объяснить парадокс, приведённый в начале этой заметки: вне домена &lt;strong&gt;Active Directory&lt;/strong&gt; хост &lt;em&gt;BobHost&lt;/em&gt; имеет всю необходимую информацию, чтобы осуществить аутентификацию&amp;nbsp;пользователем &lt;em&gt;user&lt;/em&gt; на хосте &lt;em&gt;AliceHost&lt;/em&gt; по протоколу &lt;strong&gt;NTLM&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Протокол &lt;strong&gt;NTLMv2&lt;/strong&gt; доступен опционально, начиная с версии &lt;strong&gt;ОС Windows NT 4 SP4&lt;/strong&gt;. Начиная с &lt;strong&gt;Windows Vista&lt;/strong&gt;, он является основным и включен в конфигурации по умолчанию – это означает, что данные операционные системы по умолчанию более не посылают запросов и откликов по протоколу &lt;strong&gt;NTLMv1&lt;/strong&gt;. Данная версия протокола сложнее и надёжнее. Её можно описать следующим образом: &lt;br /&gt;&lt;ol&gt;&lt;li&gt;Клиент отправляет серверу запрос на аутентификацию.&lt;/li&gt;&lt;li&gt;В ответ на запрос сервер отвечает случайным 8-байтным числом – &lt;em&gt;server challenge&lt;/em&gt;.&lt;/li&gt;&lt;li&gt;Клиент берёт &lt;strong&gt;NT хэш&lt;/strong&gt; пароля, дополняет его именами пользователя и домена и вычисляет для этих идентификационных данных &lt;a href="http://en.wikipedia.org/wiki/HMAC"&gt;&lt;strong&gt;HMAC&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt;-&lt;/strong&gt;&lt;a href="http://en.wikipedia.org/wiki/MD5"&gt;&lt;strong&gt;MD5&lt;/strong&gt;&lt;/a&gt; хэш. Затем он генерирует 8-байтное случайное число (&lt;em&gt;client challenge&lt;/em&gt;). Эта информация будет использоваться для формирования 2-ух частей ответа.&lt;/li&gt;&lt;li&gt;Первая часть ответа включает хэш идентификационных данных, полученных на шаге 3, &lt;em&gt;server challenge&lt;/em&gt; и &lt;em&gt;client challenge&lt;/em&gt;. Эти данные хэшируются алгоритмом &lt;strong&gt;HMAC-MD5&lt;/strong&gt;, после чего клиент приписывает к ним &lt;em&gt;client challenge &lt;/em&gt;в открытом виде (это необходимо, что сервер мог выполнить проверку).&lt;/li&gt;&lt;li&gt;Вторая часть ответа включает хэш идентификационных данных, &lt;em&gt;server challenge&lt;/em&gt; и &lt;em&gt;client challenge 2&lt;/em&gt;. Как и в случае первой части данные хэшируются алгоритмом &lt;strong&gt;HMAC-MD5&lt;/strong&gt;, после чего в конец дописывается &lt;em&gt;client challenge 2&lt;/em&gt; в открытом виде. В свою очередь client challenge 2 содержит следующие данные: фиксированный заголовок, текущее время, &lt;em&gt;client challenge&lt;/em&gt; и имя домена.&lt;/li&gt;&lt;li&gt;Обе части отправляются серверу.&lt;/li&gt;&lt;li&gt;Сервер формирует аналогичные хэши, используя свою версию NT хэша пароля пользователя, имена пользователя и домена и переданные в открытом виде &lt;em&gt;client challenge&lt;/em&gt; и &lt;em&gt;client challenge 2&lt;/em&gt;. Если полученное значение совпадает с ответом клиента, то аутентификация считается успешной.&lt;/li&gt;&lt;/ol&gt;&lt;div style="text-align: right;"&gt;&lt;a href="http://mrnone.blogspot.com/2011/05/blog-post_09.html"&gt;Продолжение следует...&lt;/a&gt;&lt;/div&gt;&lt;ol&gt;&lt;/ol&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/05/blog-post.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/453154434345604068'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/453154434345604068'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/blog-post.html' title='Чудеса аутентификации. Чудо первое: доступ разрешён'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7355111403481319955</id><published>2011-04-24T23:52:00.003+07:00</published><updated>2011-04-26T11:02:38.950+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Security'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><title type='text'>UAC и CreateProcessAsUser – добавим привилегий</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;В &lt;a href="http://mrnone.blogspot.com/2011/04/uac-createprocessasuser.html"&gt;прошлой заметке&lt;/a&gt; речь шла о том, что представляет собой токен учётной записи с административными привилегиями при включенной службе &lt;strong&gt;Контроля Учётной записи Пользователя&lt;/strong&gt; (&lt;strong&gt;UAC&lt;/strong&gt;). Как после авторизации получить доступ к неограниченному токену и почему его нельзя использовать для запуска приложения, если у вас нет привилегии &lt;em&gt;"Act as a part of operation system"&lt;/em&gt; (&lt;em&gt;SeTcbPrivilege&lt;/em&gt;). Пришла пора рассмотреть альтернативный путь.&lt;br /&gt;&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Акт второй - сетевой&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Данный метод, также как и предыдущий, предполагает наличие у вызывающей стороны определённой привилегии, а именно: &lt;em&gt;SeAssignPrimaryToken&lt;/em&gt;. Эта привилегия по умолчанию предоставлена только учётным записям &lt;em&gt;&lt;u&gt;локальной системы&lt;/u&gt;&lt;/em&gt; (&lt;em&gt;LocalSystem&lt;/em&gt;) и &lt;em&gt;&lt;u&gt;локального сервиса&lt;/u&gt;&lt;/em&gt; (&lt;em&gt;LocalService&lt;/em&gt;). Но она не обладает такой мощью, как &lt;em&gt;SeTcbPrivilege&lt;/em&gt;, поэтому данное решение в большинстве случаев предпочтительнее. Привилегию можно назначит программно с помощью функции &lt;a href="http://msdn.microsoft.com/en-us/library/ms721786(VS.85).aspx"&gt;&lt;em&gt;LsaAddAccountRights&lt;/em&gt;&lt;/a&gt;. Это в свою очередь предполагает, что приложение исполняется в &lt;strong&gt;elevation mode&lt;/strong&gt; под учётной записью с административными правами. &lt;br /&gt;&lt;br /&gt;Нужно помнить, что все вновь назначенные привилегии применяются к учётной записи только при последующем входе в систему. На активные сессии подобные назначения не влияют. Поэтому назначать привилегию пользователю, под которым в данный момент исполняется приложение, бессмысленно. Зато её можно назначить той учётной записи, которую мы хотим использовать для вызова &lt;em&gt;CreateProcessAsUser&lt;/em&gt;. Если сделать это до выполнения функции &lt;em&gt;LogonUser&lt;/em&gt;, то после авторизации мы получим токен с необходимой нам привилегией. Всё что нам останется сделать – это &lt;em&gt;имперсонировать&lt;/em&gt; его и вызвать &lt;em&gt;CreateProcessAsUser&lt;/em&gt;. &lt;br /&gt;&lt;br /&gt;Как я уже говорил, ограничения &lt;strong&gt;UAC&lt;/strong&gt; применяются только к учётным записям, осуществившим интерактивный вход в систему. В терминах &lt;strong&gt;WinAPI&lt;/strong&gt; – это означает, что был произведён вызов функции &lt;em&gt;LogonUser&lt;/em&gt; с указанием &lt;em&gt;LOGON32_LOGON_INTERACTIVE&lt;/em&gt; в качестве типа входа (4-ый параметр). Альтернативный подход заключается в том, чтобы выполнить сетевой вход вместо интерактивного. В этом случае полученный токен не будет ограниченным даже для пользователей с административными правами. Для этого при вызове функции &lt;em&gt;LogonUser &lt;/em&gt;необходимо в качестве типа входа указать &lt;em&gt;LOGON32_LOGON_NETWORK&lt;/em&gt;. &lt;br /&gt;&lt;br /&gt;Сетевой тип входа по сравнению с интерактивным имеет следующие преимущества и ограничения: &lt;br /&gt;&lt;ul&gt;&lt;li&gt;он выполняется значительно быстрее;&lt;/li&gt;&lt;li&gt;полученный токен является &lt;em&gt;токеном имперсонирования&lt;/em&gt; (&lt;em&gt;impersonation token&lt;/em&gt;), поэтому перед вызовом функции &lt;em&gt;CreateProcessAsUser&lt;/em&gt; его необходимо преобразовать в&lt;em&gt; основной токен&lt;/em&gt; (&lt;em&gt;primary token&lt;/em&gt;) с помощью функции &lt;a href="http://msdn.microsoft.com/en-us/library/aa378184(VS.85).aspx"&gt;&lt;em&gt;DuplicateTokenEx&lt;/em&gt;&lt;/a&gt;;&lt;/li&gt;&lt;li&gt;его нельзя использовать для обращения к защищённым сетевым ресурсам.&lt;/li&gt;&lt;/ul&gt;&lt;br /&gt;Таким образом, функция запуска приложения может выглядеть следующим образом:  &lt;br /&gt;&lt;div class="sourcecode"&gt;DWORD&lt;br /&gt;runAs(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;appPath,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;login,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;password,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;domain)&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wstring app = L&lt;span style="color: #c0504d;"&gt;"\""&lt;/span&gt; + appPath + L&lt;span style="color: #c0504d;"&gt;"\""&lt;/span&gt;; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // Assign the SeAssignPrimaryToken privilege for the user&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // which will be used to logon&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD privError = addUserPrivilege(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; domain, login, SE_ASSIGNPRIMARYTOKEN_NAME);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (ERROR_SUCCESS != privError) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wcerr &amp;lt;&amp;lt; L&lt;span style="color: #c0504d;"&gt;"Cannot assign the "&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; L&lt;span style="color: #c0504d;"&gt;"SE_ASSIGNPRIMARYTOKEN_NAME privilege: "&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; privError;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; privError;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // Logon&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; HANDLE token = 0;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; BOOL logonRes = ::LogonUser(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; login.c_str(),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; domain.c_str(),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; password.c_str(),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; LOGON32_LOGON_NETWORK,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; LOGON32_PROVIDER_DEFAULT,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;amp;token);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD logonError = ::GetLastError();&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // The obtained token is unrestricted with all administrative&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // rights. Also it contains the SeAssignPrimaryToken&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // privilege and we can remove it from&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // the account now (this will not affect our token)&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; privError = removeUserPrivilege(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; domain, login, SE_ASSIGNPRIMARYTOKEN_NAME);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (ERROR_SUCCESS != privError) {&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // this is strange, but we can continue...&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wcerr &amp;lt;&amp;lt; L&lt;span style="color: #c0504d;"&gt;"Cannot remove the "&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; L&lt;span style="color: #c0504d;"&gt;"SE_ASSIGNPRIMARYTOKEN_NAME privilege: "&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;lt;&amp;lt; privError;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // now check the logon result - may be it fails&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (!logonRes) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wcerr &amp;lt;&amp;lt; L&lt;span style="color: #c0504d;"&gt;"LogonUser fails: "&lt;/span&gt; &amp;lt;&amp;lt; logonError;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; logonError;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // impersonate the obtained token, so the&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // SeAssignPrimaryToken privilege will be available for our&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // application&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (!::ImpersonateLoggedOnUser(token)) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD err = ::GetLastError();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wcerr &amp;lt;&amp;lt; L&lt;span style="color: #c0504d;"&gt;"ImpersonateLoggedOnUser fails: "&lt;/span&gt; &amp;lt;&amp;lt; err;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(token);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; err;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; HANDLE createProcToken = 0; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // convert the obtained token into primary&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (!::DuplicateTokenEx(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; token,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; MAXIMUM_ALLOWED,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 0,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; SecurityDelegation,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; TokenPrimary,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;amp;createProcToken)) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD err = ::GetLastError();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wcerr &amp;lt;&amp;lt; L&lt;span style="color: #c0504d;"&gt;"DuplicateTokenEx fails: "&lt;/span&gt; &amp;lt;&amp;lt; err;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::RevertToSelf();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(token);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; err;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // start an application&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; STARTUPINFO si = {0};&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; si.cb = &lt;span style="color: blue;"&gt;sizeof&lt;/span&gt;(STARTUPINFO);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; PROCESS_INFORMATION pi; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD result = ERROR_SUCCESS;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (!::CreateProcessAsUser(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; createProcToken,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; appPath.c_str(),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; (LPTSTR)(app.c_str()),&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 0, 0, &lt;span style="color: blue;"&gt;false&lt;/span&gt;, 0, 0, 0, &amp;amp;si, &amp;amp;pi)) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD err = ::GetLastError();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; std::wcerr &amp;lt;&amp;lt; L&lt;span style="color: #c0504d;"&gt;"CreateProcessAsUser fails: " &lt;/span&gt;&amp;lt;&amp;lt; err;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; result = err;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // cleanup&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::RevertToSelf();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(createProcToken);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(token); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::WaitForSingleObject(pi.hProcess, INFINITE);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(pi.hProcess);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; ::CloseHandle(pi.hThread); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; result;&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;Ну и на закуску. Если всё-таки ни одно из приведённых решений не подходит по тем или иным причинам, всегда можно явно запросить запуск приложения в &lt;em&gt;elevated mode&lt;/em&gt; (программно вызвать функцию &lt;em&gt;"Запуск от имени Администратора"&lt;/em&gt; / &lt;em&gt;"Run as Administration"&lt;/em&gt;):&lt;br /&gt;&lt;div class="sourcecode"&gt;DWORD&lt;br /&gt;RunWithElevation(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; HWND hwnd, // can be 0&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;app,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;parameters = L&lt;span style="color: #c0504d;"&gt;""&lt;/span&gt;,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;const&lt;/span&gt; std::wstring &amp;amp;directory = L&lt;span style="color: #c0504d;"&gt;""&lt;/span&gt;)&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; SHELLEXECUTEINFO executeInfo = {0};&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.cbSize = &lt;span style="color: blue;"&gt;sizeof&lt;/span&gt;(SHELLEXECUTEINFO); &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.fMask = 0;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.hwnd = hwnd; &lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // this instructs shell to display the&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // elevation agreement request&lt;/span&gt;&lt;br /&gt;&lt;strong&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.lpVerb = L&lt;span style="color: #c0504d;"&gt;"runas"&lt;/span&gt;;&lt;/strong&gt; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.lpFile = app.c_str();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.lpParameters = parameters.empty()&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ? 0 : parameters.c_str();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.lpDirectory = directory.empty()&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; ? 0 : directory.c_str();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; executeInfo.nShow = SW_NORMAL; &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (!::ShellExecuteEx( &amp;amp;executeInfo )) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; ::GetLastError();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; ERROR_SUCCESS;&lt;br /&gt;}&lt;br /&gt;&lt;br /&gt;&lt;span style="color: green;"&gt;// ...&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;DWORD res = RunWithElevation(0, appPath);&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/04/uac-createprocessasuser_24.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7355111403481319955'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7355111403481319955'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/uac-createprocessasuser_24.html' title='UAC и CreateProcessAsUser – добавим привилегий'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7443475636955424900</id><published>2011-04-18T04:30:00.003+07:00</published><updated>2011-04-25T00:03:09.678+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Security'/><category scheme='http://www.blogger.com/atom/ns#' term='Win32'/><title type='text'>UAC и CreateProcessAsUser - кто кого?</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Кто&amp;nbsp;знает, как запустить процесс от имени другого пользователя? А если это &lt;strong&gt;Windows 7&lt;/strong&gt; с включенным &lt;strong&gt;UAC&lt;/strong&gt;,&amp;nbsp;а ваш пользователь имеет административные привилегии, потерять которые в запущенном процессе вы не хотите? Итак, дано: &lt;strong&gt;Windows 7&lt;/strong&gt;, &lt;strong&gt;UAC&lt;/strong&gt;, логин и пароль&amp;nbsp;учётной записи&amp;nbsp;с административными привилегиями, &lt;strong&gt;WinAPI&lt;/strong&gt; и полная свобода действий. Требуется: программным путём запустить процесс от имени этого пользователя. Давайте разбираться.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Акт первый - интерактивный&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Сначала вспомним, как работает &lt;strong&gt;UAC&lt;/strong&gt;. При интерактивном входе с использованием административной учётной записи создаётся два токена: обычный и ограниченный. Ограниченный токен возвращается в качестве результата функции &lt;em&gt;LogonUser&lt;/em&gt;, он же, в частности, используется системой для запуска приложений в интерактивной сессии по умолчанию. При запросе&amp;nbsp;пользователя на запуск приложения в&amp;nbsp;&lt;em&gt;elevated&lt;/em&gt;-режиме, система извлекает основной токен и использует его для создания процесса. Наибольший интерес в данном случае представляет то, откуда именно извлекается основной токен. Это так называемый &lt;em&gt;linked&lt;/em&gt; (&lt;em&gt;связанный&lt;/em&gt;)&amp;nbsp;токен, доступ к которому можно получить с помощью функции &lt;em&gt;GetTokenInformation&lt;/em&gt; следующим образом:&lt;br /&gt;&lt;div class="sourcecode"&gt;HANDLE getLinkedToken(HANDLE token)&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; TOKEN_LINKED_TOKEN linkedToken;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD retSize = 0;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (!::GetTokenInformation(token, TokenLinkedToken,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;amp;linkedToken, &lt;span style="color: blue;"&gt;sizeof&lt;/span&gt;(linkedToken), &amp;amp;retSize)) {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; DWORD error = ::GetLastError();&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (ERROR_NO_SUCH_LOGON_SESSION != error) {&lt;br /&gt;&lt;span style="color: #38761d;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // there are no linked token: UAC disabled,&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #38761d;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // or standard user account is used, or ...&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; 0;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;else if&lt;/span&gt; (ERROR_INVALID_PARAMETER != error) {&lt;br /&gt;&lt;span style="color: #38761d;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // linked tokens are not supported: program is executed&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #38761d;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // on an old operation system&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; 0;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; } &lt;span style="color: blue;"&gt;else&lt;/span&gt; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #38761d;"&gt;// report error&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw&lt;/span&gt; std::runtime_error(formatWinError(error));&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (0 == linkedToken.LinkedToken&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; || INVALID_HANDLE_VALUE == linkedToken.LinkedToken) {&lt;br /&gt;&lt;span style="color: #38761d;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // report unexpected error: linkedToken.LinkedToken&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #38761d;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // contains an invalid token&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw&lt;/span&gt; std::runtime_error(&lt;span style="color: #990000;"&gt;"Linked token is invalid"&lt;/span&gt;);&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; linkedToken.LinkedToken&lt;br /&gt;}&lt;/div&gt;&lt;br /&gt;Казалось бы вот оно счастье. Но любые попытки создать процесс, используя данный токен скорее всего будут завершаться с ошибкой &lt;em&gt;ERROR_BAD_TOKEN_TYPE&lt;/em&gt;. Дело в том, что в обычной ситуации функция &lt;em&gt;GetTokenInformation&lt;/em&gt; возвращает так называемый &lt;em&gt;identification&lt;/em&gt;-токен (попробуйте запросить &lt;em&gt;TokenImpersonationLevel&lt;/em&gt; этого токена с помощью той же функции &lt;em&gt;GetTokenInformation&lt;/em&gt;). Всё, что вы можете сделать с этим токеном - это&amp;nbsp;узнать его SID, прочитать в какие группы он входит и какими привилегиями обладает. Ни имперсонировать его, ни запустить с его помощью процесс, ни даже конвертировать его в &lt;em&gt;основной&lt;/em&gt; (&lt;em&gt;primary&lt;/em&gt;)&amp;nbsp;токен с помощью функции &lt;em&gt;DuplicateToken&lt;/em&gt; &lt;u&gt;вы не сможете&lt;/u&gt;.&lt;br /&gt;&lt;br /&gt;И только если у вас есть привилегия &lt;em&gt;SeTcbPrivilege&lt;/em&gt;, &lt;em&gt;linked&lt;/em&gt;-токен, возвращённый функцией &lt;em&gt;GetTokenInfromation&lt;/em&gt;, оказывается &lt;em&gt;основным&lt;/em&gt; токеном. Вот только по умолчанию этой привилегией обладает единственный пользователь в системе -&amp;nbsp;&lt;em&gt;Local System&lt;/em&gt;. И даже если&amp;nbsp;вы выдадите её своему пользователю,&amp;nbsp;вопреки всем рекомендациям, советующим не делать этого ни при каких условиях, она точно будет&amp;nbsp;ограничена UAC`ом при интерактивном входе в систему. Единственное место, где вы имеете шанс воспользоваться подобной возможностью - это сервис, работающий под учётной записью &lt;em&gt;Local System&lt;/em&gt;. Надо отдать должное &lt;strong&gt;UAC&lt;/strong&gt;`у - даже там вам могут пригодиться подобные приседания.&lt;br /&gt;&lt;br /&gt;&lt;div style="text-align: right;"&gt;&lt;a href="http://mrnone.blogspot.com/2011/04/uac-createprocessasuser_24.html"&gt;Продолжение следует...&lt;/a&gt;&lt;/div&gt;&lt;em&gt;&lt;/em&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/04/uac-createprocessasuser.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7443475636955424900'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/7443475636955424900'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/uac-createprocessasuser.html' title='UAC и CreateProcessAsUser - кто кого?'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-6088160702421092292</id><published>2011-04-13T15:02:00.001+07:00</published><updated>2011-05-22T02:08:12.073+07:00</updated><app:control xmlns:app='http://purl.org/atom/app#'><app:draft>yes</app:draft></app:control><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><title type='text'>[Рыба] Модули PowerShell`а - утверждения</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Модуль - это &lt;u&gt;всегда&lt;/u&gt; каталог, который&amp;nbsp;содержит по крайней мере один файл с &lt;u&gt;именем, совпадающем с именем каталога,&lt;/u&gt; и расширением &lt;em&gt;psm1&lt;/em&gt;. &lt;u&gt;Имя модуля - это имя его каталога&lt;/u&gt;.Чтобы заимпортировать модуль только по имени, путь до каталога, в котором находится каталог модуля, должен присутствовать в переменной &lt;em&gt;$env:PSModulePath&lt;/em&gt;. Процедура импорта ищет модули только по путям, перечисленным в переменной &lt;em&gt;$env:PSModulePath&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Если имя &lt;em&gt;psm1&lt;/em&gt;-файла отличается от имени каталога в котором он находится, то импорт только по имени не работает, ибо это модулем не считается, какие бы пути в переменной &lt;em&gt;$env:PSModulePath &lt;/em&gt;не были бы прописаны&amp;nbsp;(get-module -listAvailable не возвращает такой модуль в списке доступных). Чтобы заимпортировать этот файл, переменная &lt;em&gt;$env:PSModulePath &lt;/em&gt;должна содержать путь до каталога, в котором располагается каталог этого файла. Импорт возможен по имени &amp;lt;Каталог&amp;gt;\&amp;lt;Имя-файла&amp;gt;. Если файл имеет расширение, отличное от &lt;em&gt;psm1&lt;/em&gt; (например, &lt;em&gt;ps1&lt;/em&gt;), то тогда импорт возможен по имени: &amp;lt;Каталог&amp;gt;\&amp;lt;Имя-файла&amp;gt;.&amp;lt;Расширение&amp;gt;.&lt;br /&gt;&lt;br /&gt;Пример:&lt;br /&gt;C:\Modules\&lt;u&gt;MyModule&lt;/u&gt;\&lt;u&gt;MyModule&lt;/u&gt;.psm1 - модуль&lt;br /&gt;&lt;em&gt;$env:PSModulePath&lt;/em&gt; содержит путь &lt;u&gt;C:\Modules&lt;/u&gt;.&lt;br /&gt;Возможен импорт:&lt;br /&gt;Import-Module MyModule&lt;br /&gt;&lt;br /&gt;C:\Modules\&lt;u&gt;Utils&lt;/u&gt;\&lt;u&gt;ADUtils&lt;/u&gt;.psm1 - не модуль&lt;br /&gt;&lt;em&gt;$env:PSModulePath&lt;/em&gt; содержит путь &lt;u&gt;C:\Modules&lt;/u&gt;.&lt;br /&gt;Возможен импорт:&lt;br /&gt;Import-Module Utils\ADUtils&lt;br /&gt;&lt;br /&gt;C:\Modules\&lt;u&gt;Utils&lt;/u&gt;\File&lt;u&gt;Utils&lt;/u&gt;.ps1 - не модуль&lt;br /&gt;&lt;em&gt;$env:PSModulePath&lt;/em&gt; содержит путь &lt;u&gt;C:\Modules&lt;/u&gt;.&lt;br /&gt;Возможен импорт:&lt;br /&gt;Import-Module Utils\FileUtils.ps1&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;Проверить:&lt;br /&gt;что будет, если модуль помимо основного скрипта (имя которого совпадает с имением каталога) содержит ещё psm1 и ps1 файлы. Есть подозрение, что они заимпортируются автоматом.&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/6088160702421092292'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/6088160702421092292'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1241930567975428822</id><published>2011-04-13T01:27:00.000+07:00</published><updated>2011-04-13T01:27:29.743+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Tools'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='Web Service'/><title type='text'>Играем в SOAP клиента CURL`ём и игнорируем SSL сертификат</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Сегодня я тестировал один очень удалённый &lt;strong&gt;Web Service&lt;/strong&gt;, и мне понадобилось сделать странные вещи. Во-первых, отменить проверку &lt;strong&gt;SSL&lt;/strong&gt; сертификата в клиенте, написанном на &lt;strong&gt;C#&lt;/strong&gt;. Во-вторых, отправить вручную сформированный &lt;strong&gt;SOAP&lt;/strong&gt; запрос.&lt;br /&gt;&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;span style="color: red;"&gt;&lt;strong&gt;Странная вещь №1.&lt;/strong&gt; Зачем проверять сертификат?&amp;nbsp;Мы уверены - он некорректный!&lt;/span&gt;&lt;br /&gt;Первым делом я быстро набросал простейшего клиент &lt;strong&gt;Web Service&lt;/strong&gt;`а на &lt;strong&gt;C#&lt;/strong&gt;, запустил его и тут же получил по рукам: &lt;strong&gt;SSL&lt;/strong&gt; сертификат был совершенно невалидный. Он был &lt;em&gt;self signed&lt;/em&gt;, давно устарел и вообще выписан на другой хост. Позвать &lt;strong&gt;Web Service&lt;/strong&gt; мучительно хотелось.&amp;nbsp;А поскольку до этого мне попадались либо только свои, либо только приличные &lt;strong&gt;Web Service&lt;/strong&gt;`ы, то я полез в документацию на предмет поиска атрибута, позволяющего ослабить уровень проверки.&lt;br /&gt;&lt;br /&gt;Атрибута в документации не&amp;nbsp;нашлось. Нашлось большее -&amp;nbsp;делегат, позволяющий&amp;nbsp;задать свою процедуру&amp;nbsp;проверки сертификата, располагающийся в классе &lt;strong&gt;System.Net.ServicePointManager&lt;/strong&gt;:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;public static&lt;/span&gt; RemoteCertificateValidationCallback ServerCertificateValidationCallback { &lt;span style="color: blue;"&gt;get&lt;/span&gt;; &lt;span style="color: blue;"&gt;set&lt;/span&gt;; }&lt;/div&gt;&lt;br /&gt;Тип делегата описан в пространстве имён &lt;strong&gt;System.Net.Security&lt;/strong&gt; следующим образом:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;public delegate bool&lt;/span&gt; RemoteCertificateValidationCallback(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Object sender,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; X509Certificate certificate,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; X509Chain chain,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; SslPolicyErrors sslPolicyErrors&lt;br /&gt;);&lt;/div&gt;&lt;br /&gt;Если функция проверки принимает решение, что сертификат корректен, она должна вернуть &lt;em&gt;true&lt;/em&gt;. Таким образом, чтобы полностью отменить проверку, естественно только в тестовых целях, необходимо сделать следующее:&lt;br /&gt;&lt;div class="sourcecode"&gt;ServicePointManager.ServerCertificateValidationCallback = &lt;span style="color: blue;"&gt;delegate&lt;/span&gt; (&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; Object sender,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; X509Certificate certificate,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; X509Chain chain,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; SslPolicyErrors sslPolicyErrors)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #38761d;"&gt;// Yes, I know it is very-very bad and&amp;nbsp;strange,&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; // but I need this for testing purposes...&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return true&lt;/span&gt;;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; };&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&lt;span style="color: red;"&gt;&lt;strong&gt;Странная вещь №2.&lt;/strong&gt; Я генерирую SOAP-запросы блокнотом, а вы?&lt;/span&gt;&lt;br /&gt;Не спрашивайте, зачем мне это понадобилось, но вторая странная вещь заключалась в необходимости сформировать и отправить &lt;strong&gt;Web Service&lt;/strong&gt;`у синтаксически неверный &lt;strong&gt;SOAP &lt;/strong&gt;запрос. Естественно ни одна из имеющихся у меня в наличии библиотек для написания &lt;strong&gt;Web Service&lt;/strong&gt;`ов:&amp;nbsp;ни &lt;strong&gt;.NET Web Services&lt;/strong&gt;, ни &lt;strong&gt;gSOAP&lt;/strong&gt;, ни &lt;strong&gt;Axis&lt;/strong&gt; - такую вольность мне не позволила. Тогда я обратил внимание на универсальное средство для отправки некорректных запросов - &lt;strong&gt;curl&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Действительно, ведь чем, по сути, является &lt;strong&gt;SOAP&lt;/strong&gt; запрос? Это всего лишь &lt;strong&gt;XML&lt;/strong&gt; документ, переданный &lt;strong&gt;Web Service&lt;/strong&gt;`у по &lt;strong&gt;HTTP&lt;/strong&gt; методом &lt;strong&gt;POST&lt;/strong&gt;. Всё дело в волшебных заголовках. Ключевым из них является заголовок &lt;em&gt;SOAPAction&lt;/em&gt;, который принимает строку вида &lt;em&gt;"&amp;lt;WebServiceURL&amp;gt;/&amp;lt;CallingMethodName&amp;gt;"&lt;/em&gt;. Справедливости ради необходимо отметить, что некоторый &lt;strong&gt;Web Service&lt;/strong&gt;`ы, судя по всему&amp;nbsp;написанные на &lt;strong&gt;Axis&lt;/strong&gt;`е, полностью игнорируют это значения, проверяя лишь факт наличия данного заголовка. Так или иначе, но полная команда для отправки &lt;strong&gt;SOAP&lt;/strong&gt; запроса, написанного в блокноте и сохранённого в файл &lt;em&gt;InvalidRequest.xml &lt;/em&gt;выглядит так:&lt;br /&gt;&lt;div class="sourcecode"&gt;C:\&amp;gt;curl.exe -i -H "Content-Type: text/xml; charset=utf-8" -H "&lt;strong&gt;SOAPAction: https://neverhood.org/webservice/EchoService/echo&lt;/strong&gt;" -d@InvalidRequest.xml -v  https://neverhood.org/webservice/EchoService&lt;/div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/04/soap-curl-ssl.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1241930567975428822'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1241930567975428822'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/soap-curl-ssl.html' title='Играем в SOAP клиента CURL`ём и игнорируем SSL сертификат'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1097041149736262163</id><published>2011-04-11T03:56:00.004+07:00</published><updated>2011-04-16T01:38:57.107+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Cryptography'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='X.509'/><title type='text'>Проблемы сертификации: Эпизод III - Такой маленький ключ</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Проблема, о которой я&amp;nbsp;рассказывал в &lt;a href="http://mrnone.blogspot.com/2011/04/ii.html"&gt;прошлый раз&lt;/a&gt;, возникает исключительно при попытке расшифровать сообщение. На этот раз речь пойдёт об ошибке шифрования алгоритмом &lt;strong&gt;RSA&lt;/strong&gt;, а именно: &lt;em&gt;"Key not valid for use in specified state"&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Key not valid for use in specified state&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Не знаю, какие ещё &lt;em&gt;состояния&lt;/em&gt; ключа имели в виду разработчики &lt;strong&gt;CryptoAPI&lt;/strong&gt;, все те разы, когда с ней сталкивался я, она означала следующее:&amp;nbsp;ключ &lt;strong&gt;RSA&lt;/strong&gt; слишком мал, чтобы зашифровать предоставленный блок данных.&lt;br /&gt;&lt;br /&gt;Алгоритм &lt;strong&gt;RSA&lt;/strong&gt; относится к блочным алгоритмам шифрования. Это означает, что он может быть применён только к блокам данных фиксированного размера. Размер шифруемого блока в алгоритме &lt;strong&gt;RSA&lt;/strong&gt; равен размеру ключа. Так для 1024 битного ключа размер блока равен 128 байтам (&lt;em&gt;1024 бит / 8 = 128 байт&lt;/em&gt;). Причина этого ограничения лежит в особенностях алгоритма: уменьшение объёма шифруемых данных приводит к падению стойкости шифра. Поэтому, чтобы не уменьшать надёжность, размер блока данных строго фиксирован.&lt;br /&gt;&lt;br /&gt;На практике полезный объём шифруемых данных оказывается и того меньше. Чтобы предотвратить &lt;em&gt;атаки по словарю&lt;/em&gt;, &lt;em&gt;атаки с применением известного исходного текста&lt;/em&gt;, шифруемые данные всегда дополняются произвольным &lt;em&gt;сальтом&lt;/em&gt;. Если шифруемых данных недостаточно для заполнения целого блока, то они дополняются до полного блока произвольными данными. Это означает, что блок должен содержать ещё и информацию о размере&amp;nbsp;реальных данных, чтобы при расшифровке их можно было отделить от дополнения. Таким образом, шифруемый блок всегда будет содержать следующую информацию: размер полезных данных (заголовок), полезные данные, сальт и данные &lt;em&gt;дополнения&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Применение алгоритма &lt;strong&gt;RSA&lt;/strong&gt; регламентировано стандартом &lt;strong&gt;PKCS#1&lt;/strong&gt;. На текущий момент&amp;nbsp;актуальны&amp;nbsp;3&amp;nbsp;версии этого стандарта: &lt;em&gt;1.5&lt;/em&gt;, &lt;em&gt;2.0&lt;/em&gt; и &lt;em&gt;2.1&lt;/em&gt;. Более подробно можно прочитать на &lt;a href="http://www.rsa.com/rsalabs/node.asp?id=2125"&gt;оффициальном сайте стандарта&lt;/a&gt;. Класс &lt;strong&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.rsacryptoserviceprovider.aspx"&gt;&lt;em&gt;RSACryptoServiceProvider&lt;/em&gt;&lt;/a&gt;&lt;/strong&gt; из&amp;nbsp;пространства имён &lt;strong&gt;&lt;em&gt;System.Security.Cryptography&lt;/em&gt;&lt;/strong&gt; &lt;strong&gt;.NET Framework&lt;/strong&gt;`а предоставляет возможность шифрования данных алгоритмом &lt;strong&gt;RSA&lt;/strong&gt; по стандарту &lt;strong&gt;PKCS#1&lt;/strong&gt; версий &lt;em&gt;1.5&lt;/em&gt; и &lt;em&gt;2.0&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;PKCS#1&amp;nbsp;v. 1.5&lt;/strong&gt; отводит на сальт и заголовок 11 байт. Таким образом, максимальный объём данных, которые могут поместиться в одном блоке, вычисляется следующим образом:&lt;br /&gt;&lt;div class="sourcecode"&gt;(размер ключа в битах / 8) - 11 байт&lt;/div&gt;Для ключа в 1024 бита это будет: &lt;em&gt;1024 / 8 - 11 = 117 байт&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Для того, чтобы зашифровать данные с применением этой версии стандарта, необходимо вызвать метод &lt;strong&gt;&lt;a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.rsacryptoserviceprovider.encrypt.aspx"&gt;&lt;em&gt;Encrypt&lt;/em&gt;&lt;/a&gt;&lt;/strong&gt; класса &lt;strong&gt;&lt;em&gt;RSACryptoServiceProvider&lt;/em&gt;&lt;/strong&gt;, передав ему &lt;strong&gt;&lt;em&gt;false&lt;/em&gt;&lt;/strong&gt; в качестве второго параметра:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;byte&lt;/span&gt;[] cipheredData = rsaCryptoProviderObj.Encrypt(data, &lt;strong&gt;&lt;span style="color: blue;"&gt;false&lt;/span&gt;&lt;/strong&gt;);&lt;/div&gt;&lt;br /&gt;&lt;strong&gt;PKCS#1 v. 2.0&lt;/strong&gt;&amp;nbsp;чуть сложнее. Он подразумевает использование &lt;strong&gt;Optimal Asymmetric Encryption Padding &lt;/strong&gt;- особую схему шифрования, увеличивающую стойкость шифра. Максимальный размер полезных данных для него вычисляется следующим образом:&lt;br /&gt;&lt;div class="sourcecode"&gt;(размер ключа в битах / 8) - 2 - 2 * (размер хэша, используемого для вычисления &lt;strong&gt;OAEP&lt;/strong&gt; дополнения)&lt;/div&gt;Как правило, в &lt;strong&gt;OAEP&lt;/strong&gt; схеме используется алгоритм &lt;strong&gt;SHA1&lt;/strong&gt; с длинной хэша 20 байт. Таким образом, для ключа длиной 1024 бита имеем: &lt;em&gt;1024 / 8 - 2 - 2 * 20 = 86 байт&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Чтобы применить эту схему шифрования, нужно передать &lt;strong&gt;&lt;em&gt;true&lt;/em&gt;&lt;/strong&gt; в качестве значения 2-ого&amp;nbsp;параметра при вызове метода &lt;strong&gt;&lt;em&gt;Encrypt&lt;/em&gt;&lt;/strong&gt; класса &lt;strong&gt;&lt;em&gt;RSACryptoServiceProvider&lt;/em&gt;&lt;/strong&gt;:&lt;br /&gt;&lt;div class="sourcecode"&gt;&lt;span style="color: blue;"&gt;byte&lt;/span&gt;[] cipheredData = rsaCryptoProviderObj.Encrypt(data, &lt;strong&gt;&lt;span style="color: blue;"&gt;true&lt;/span&gt;&lt;/strong&gt;);&lt;/div&gt;&lt;br /&gt;Таким образом, чтобы получить вышеозначенную ошибку, достаточно передать на вход методу &lt;strong&gt;&lt;em&gt;RSACryptoServiceProvider.Encrypt&lt;/em&gt;&lt;/strong&gt; больше 117 байт в первом случае и больше 86 байт во втором, что не так уж и много.&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/04/iii.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1097041149736262163'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/1097041149736262163'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/iii.html' title='Проблемы сертификации: Эпизод III - Такой маленький ключ'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5406950059007455601</id><published>2011-04-07T01:28:00.002+07:00</published><updated>2011-04-13T22:43:43.588+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Cryptography'/><category scheme='http://www.blogger.com/atom/ns#' term='X.509'/><title type='text'>Проблемы сертификации: Эпизод II - Правила использования</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;a href="http://mrnone.blogspot.com/2011/04/i.html"&gt;В прошлой&amp;nbsp;заметке&lt;/a&gt; я рассказывал о не очевидных причинах возникновения ошибки&amp;nbsp;&lt;em&gt;"Keyset does not exist"&lt;/em&gt; и о методах борьбы с ней. А именно: речь шла о правах доступа к файлу приватного ключа сертификата. Продолжая начатую тему странных сообщений &lt;strong&gt;CryptoAPI&lt;/strong&gt;, я хочу рассказать о не менее загадочной ошибке - &lt;em&gt;"Bad key"&lt;/em&gt;.&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Bad key&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Текст сообщения об ошибке, возникающей при попытке расшифровать данные, поражает своей&amp;nbsp;лаконичностью - предположить можно всё что угодно. При этом не имеет значения, каким средством дешифрования вы пользовались:&amp;nbsp;нативной функцией &lt;em&gt;&lt;strong&gt;CryptDecrypt&lt;/strong&gt;&lt;/em&gt; из библиотеки &lt;strong&gt;CryptoAPI&lt;/strong&gt;, или методом &lt;a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.rsacryptoserviceprovider.decrypt.aspx"&gt;&lt;strong&gt;&lt;em&gt;&lt;span style="color: #3366cc;"&gt;Decrypt&lt;/span&gt;&lt;/em&gt;&lt;/strong&gt;&lt;/a&gt; класса &lt;strong&gt;&lt;em&gt;RSACryptoServiceProvider&lt;/em&gt;&lt;/strong&gt; из пространства имён &lt;strong&gt;&lt;em&gt;System.Security.Cryptography&lt;/em&gt;&lt;/strong&gt;. На самом же деле данная ошибка с высокой долей вероятности означает, что используемый сертификат всего-навсего не предназначен для обмена данными.&lt;br /&gt;&lt;br /&gt;Эта проблема наиболее характерна для тестовых сертификатов, сгенерированных утилитой &lt;em&gt;&lt;u&gt;makecert.exe&lt;/u&gt;&lt;/em&gt;, и применяемых отделом контроля качества. Но бывает, что в данную ловушку попадает и клиент. Если приложению требуется сертификат для шифрования / де-шифрования, то достаточно всего лишь&amp;nbsp;предложить ему воспользоваться &lt;em&gt;sign-only&lt;/em&gt; сертификатом, чтобы увидеть жалобы &lt;strong&gt;CryptoAPI&lt;/strong&gt; на "плохой ключ". К сожалению, у этой проблемы есть только одно решение: необходимо сгенерировать или купить правильный сертификат.&lt;br /&gt;Каждый сертификат &lt;strong&gt;X.509&lt;/strong&gt; содержит следующие поля и расширения, описывающие назначение сертификата:&lt;br /&gt;&lt;ul style="text-align: left;"&gt;&lt;li&gt;&lt;strong&gt;Subject's Key Specification&lt;/strong&gt; -&amp;nbsp;свойство приватного ключа,&amp;nbsp;может принимать значения 1 (&lt;strong&gt;&lt;em&gt;AT_KEYEXCHANGE&lt;/em&gt;&lt;/strong&gt; - ключ для шифрования и подписи) или 2 (&lt;strong&gt;&lt;em&gt;AT_SIGNATURE&lt;/em&gt;&lt;/strong&gt; - ключ только для подписи); &lt;/li&gt;&lt;li&gt;&lt;strong&gt;Key Usage&lt;/strong&gt; - расширение сертификата &lt;strong&gt;X.509 v3&lt;/strong&gt;; значение представляет собой битовую маску, каждый бит которой определяет то или иное назначение; например, бит 2, если установлен,&amp;nbsp;определяет, что сертификат может использоваться в процедуре обмена ключами (Key Exchange).&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Extended Key Usage&lt;/strong&gt; - расширение сертификата &lt;strong&gt;X.509 v3&lt;/strong&gt;; представляет собой набор &lt;strong&gt;Object Identifier&lt;/strong&gt;`ов (&lt;strong&gt;OID&lt;/strong&gt;), определяющих дополнительные назначения сертификата; например, добавление &lt;strong&gt;OID&lt;/strong&gt;`а &lt;em&gt;1.3.6.1.5.5.7.3.2&lt;/em&gt; определяет, что сертификат может использоваться для аутентификации клиентов.&lt;/li&gt;&lt;/ul&gt;Примечательным является то, что&amp;nbsp;все вышеперечисленные свойства и расширения по сути является независимыми друг от друга. Они могут появляться в сертификате в разных комбинациях и&amp;nbsp;даже противоречить друг другу. К счастью подобные сертификаты - с противоречащими декларациями назначений - являются ошибочными. На сайте Technet`а есть хорошая статья, описывающая в частности, как можно сравнить разные спецификации назначения сертификата на предмет непротиворечивости: &lt;a href="http://technet.microsoft.com/en-us/library/dd277392.aspx"&gt;http://technet.microsoft.com/en-us/library/dd277392.aspx&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;Зачем же нужно такое многообразие&amp;nbsp;деклараций назначений сертификата? Всё очень просто. Как не сложно заметить, каждая последующая декларация расширяет предыдущую. Если &lt;strong&gt;Key Specification&lt;/strong&gt; задаёт только 2 назначения, то &lt;strong&gt;Key Usage&lt;/strong&gt; уже 8, в то время как &lt;strong&gt;Extended Key Usage&lt;/strong&gt; вообще не ограничена сверху. Таким образом, каждое приложение выбирает для проверки то поле, которое наиболее точно соответствует его целям. Если назначение сертификата не соответствует требованиям приложения, оно должно отказаться от его использования и сообщить об ошибке. То есть в общем случае подобная проверка возлагается на само приложение.&lt;br /&gt;&lt;br /&gt;К сожалению, в&amp;nbsp;документации&amp;nbsp;отсутствует упоминание того, какие спецификации использования &lt;strong&gt;CryptoAPI&lt;/strong&gt; проверяет автоматически и делает ли она это вообще. Но из этого правила есть, по крайней мере, одно исключение: проверка &lt;strong&gt;Key Specification&lt;/strong&gt;&amp;nbsp;выполняется автоматически. И происходит это вот почему.&amp;nbsp;В отличие от&amp;nbsp;расширений &lt;strong&gt;Key Usage&lt;/strong&gt; и &lt;strong&gt;Extended Key Usage&lt;/strong&gt;, которые являются по сути всего лишь декларациями о намерениях, &lt;strong&gt;Key Specification&lt;/strong&gt; определяет алгоритм, применяемый с ключом сертификата. Поэтому попытка применить для операций шифрования / де-шифрования ключ, предназначенный для формирования цифровой подписи, заканчивается ошибкой &lt;strong&gt;&lt;span style="color: red;"&gt;Bad key&lt;/span&gt;&lt;/strong&gt;.&lt;br /&gt;&lt;br /&gt;Напоследок приведу пример команды, позволяющей сгенерировать тестовый сертификат, который можно применять в операциях шифрования:&lt;br /&gt;&lt;div class="sourcecode"&gt;makecert -pe -sky Exchange -r -n "CN=&amp;lt;name&amp;gt;" -ss My&lt;/div&gt;Всё дело в дополнительном параметре &lt;em&gt;-sky Exchange&lt;/em&gt;, который заставляет утилиту &lt;em&gt;&lt;u&gt;makecert&lt;/u&gt;&lt;/em&gt; сгенерировать сертификат, пригодный для операций шифрования.&lt;br /&gt;&lt;br /&gt;&lt;div style="text-align: right;"&gt;&lt;a href="http://mrnone.blogspot.com/2011/04/iii.html"&gt;Продолжение следует...&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/04/ii.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5406950059007455601'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5406950059007455601'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/ii.html' title='Проблемы сертификации: Эпизод II - Правила использования'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5830870970891547</id><published>2011-04-06T02:50:00.001+07:00</published><updated>2011-05-15T21:27:17.621+07:00</updated><app:control xmlns:app='http://purl.org/atom/app#'><app:draft>yes</app:draft></app:control><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><title type='text'>Пример шаблона исходного кода</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;div class="sourcecode"&gt;$rootDSEObj = [adsi] "LDAP://RootDSE"&lt;br /&gt;$rootObj = [adsi] ("LDAP://{0}" -f $rootDSEObj.defaultNamingContext.ToString())&lt;br /&gt;$searcher = New-Object System.DirectoryServices.DirectorySearcher -argumentList $rootObj, "(name=SOME OU NAME)", ("name", "distinguishedName"), 2&lt;br /&gt;$result = $searcher.FindOne()&lt;br /&gt;echo $result.Properties["distinguishedName"]&lt;/div&gt;&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5830870970891547'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5830870970891547'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5257996481379688922</id><published>2011-04-03T15:52:00.011+07:00</published><updated>2011-04-13T22:20:49.281+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><category scheme='http://www.blogger.com/atom/ns#' term='Cryptography'/><category scheme='http://www.blogger.com/atom/ns#' term='.NET'/><category scheme='http://www.blogger.com/atom/ns#' term='X.509'/><title type='text'>Проблемы сертификации: Эпизод I - Потеряный ключ</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;Вы когда-нибудь пытались разобраться, что от вас хочет &lt;strong&gt;CryptoAPI&lt;/strong&gt;, когда сообщает невразумительное &lt;em&gt;"Bad key"&lt;/em&gt;? Иногда бывает проще ответить на вопрос о смысле жизни, чем понять странные желания этой библиотеки. Не является исключением и &lt;strong&gt;.NET Framework&lt;/strong&gt;, криптографическая часть которого более чем полностью, является всего лишь обёрткой над &lt;strong&gt;CryptoAPI&lt;/strong&gt;. Поэтому, предоставляя пользователю весьма удобные интерфейсы, он наследует от своей старшей сестры ужасные сообщения об ошибках. Наиболее неприятным в моей практике был небольшой набор ошибок, связанных с криптованием и декриптованием данных, которые с завидной регулярностью&amp;nbsp;возникали после начала эксплуатации программы клиентом или в лучшем случае вводили в ступор отдел контроля качества.&lt;br /&gt;&lt;br /&gt;&lt;a name='more'&gt;&lt;/a&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style="color: red;"&gt;Keyset does not exist&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;Из текста сообщения можно предположить, что проблема заключается в отсутствии приватного ключа, который вы пытаетесь использовать для расшифровки данных (например, с помощью метода &lt;a href="http://msdn.microsoft.com/en-us/library/system.security.cryptography.rsacryptoserviceprovider.decrypt.aspx"&gt;&lt;strong&gt;&lt;em&gt;Decrypt&lt;/em&gt;&lt;/strong&gt;&lt;/a&gt; класса &lt;strong&gt;&lt;em&gt;RSACryptoServiceProvider&lt;/em&gt;&lt;/strong&gt; из пространства имён &lt;strong&gt;&lt;em&gt;System.Security.Cryptography&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&lt;/span&gt;&lt;/em&gt;&lt;/strong&gt;).&amp;nbsp;Но при этом &lt;strong&gt;MMC&lt;/strong&gt;-оснастка&amp;nbsp;&lt;em&gt;Сертификаты&lt;/em&gt; (&lt;em&gt;Certificates&lt;/em&gt;) утверждает обратное:&amp;nbsp;&lt;u&gt;все ключи - публичный и приватный - на месте&lt;/u&gt;. Дело в том, что &lt;strong&gt;CryptoAPI&lt;/strong&gt; сообщает об отсутствии ключа в том числе и тогда, когда у запрашивающего его пользователя нет прав для доступа. Вспомните - аналогичным образом &lt;strong&gt;ADSI&lt;/strong&gt; сообщает, что запрашиваемый объект не найден, если у вас нет прав на чтение каталога, в котором он располагается.&lt;br /&gt;&lt;br /&gt;Приватный ключ является&amp;nbsp;обычным файлом. Ключи, принадлежащие&amp;nbsp;сертификатам из&amp;nbsp;хранилища конкретного пользователя, располагаются&amp;nbsp;в специальной&amp;nbsp;папке внутри&amp;nbsp;директории &lt;em&gt;Application Data&lt;/em&gt; данного пользователя, а именно:&lt;br /&gt;&lt;em&gt;&lt;span style="background-color: #cccccc; font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;%AppData%\Microsoft\Crypto\RSA\&amp;lt;SID&amp;gt;&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;где &lt;em&gt;&amp;lt;SID&amp;gt;&lt;/em&gt; - это SID данного пользователя в строковом формате (например, &lt;em&gt;S-1-5-21-791563612-412897595-89479398972505&lt;/em&gt;).&lt;br /&gt;Это правило справедливо и для ключей, относящихся к сертификатам из хранилища &lt;em&gt;Local Computer&lt;/em&gt;, только искать их нужно внутри &lt;em&gt;Application Data&lt;/em&gt; профайла &lt;em&gt;All Users&lt;/em&gt; (или как её ещё называют &lt;em&gt;Common Application Data&lt;/em&gt;), на моей &lt;strong&gt;Windows 7&lt;/strong&gt; это:&lt;br /&gt;&lt;em&gt;&lt;span style="background-color: #cccccc; font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;%ALLUSERSPROFILE%&lt;/span&gt;&lt;span style="background-color: #cccccc; font-family: Courier New;"&gt;\Microsoft\Crypto\RSA\MachineKeys&lt;/span&gt;&lt;/em&gt;&lt;br /&gt;обратите внимание, что вместо SID`а пользователя используется фиксированное название папки - &lt;em&gt;MachineKeys&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Имя файла сертификата совпадает с уникальным именем криптографического контейнера, соответствующего данному ключу. Получить его можно, запросив параметр контейнера &lt;strong&gt;&lt;em&gt;PP_UNIQUE_CONTAINER&lt;/em&gt;&lt;/strong&gt; с помощью функции &lt;strong&gt;CryptoAPI&lt;/strong&gt; &lt;a href="http://msdn.microsoft.com/en-us/library/aa380196(VS.85).aspx"&gt;&lt;strong&gt;&lt;em&gt;CryptGetProvParam&lt;/em&gt;&lt;/strong&gt;&lt;/a&gt;. Или через свойство &lt;strong&gt;&lt;em&gt;UniqueKeyContainerName&lt;/em&gt;&lt;/strong&gt; класса &lt;strong&gt;&lt;em&gt;CspKeyContainerInfo&lt;/em&gt;&lt;/strong&gt; в &lt;strong&gt;.NET&lt;/strong&gt;:&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace; font-size: small;"&gt;&lt;span style="color: blue;"&gt;private string&lt;/span&gt; GetPrivateKeyFileName(X509Certificate2 cert)&lt;br /&gt;{&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; RSACryptoServiceProvider rsa = cert.PrivateKey&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;as&lt;/span&gt; RSACryptoServiceProvider;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (rsa != null)&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; rsa.CspKeyContainerInfo.UniqueKeyContainerName;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace; font-size: small;"&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw new&lt;/span&gt; ApplicationException(&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; "The certificate does not have an RSA private key.");&lt;br /&gt;}&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;Единственный способ получить полный путь к файлу сертификата - это выполнить поиск файла с данным именем во всех возможных местах размещения файла ключа, а именно: в каталогах ключей системы и текущего пользователя:&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&lt;span style="font-size: small;"&gt;&lt;span style="color: blue;"&gt;private string&lt;/span&gt; FindPrivateKeyFile(&lt;span style="color: blue;"&gt;string&lt;/span&gt; keyFileName)&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace; font-size: small;"&gt;{&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&lt;span style="font-size: small;"&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #999999;"&gt;// try to search in the local machine store&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt;&amp;nbsp;commonAppData = Environment.GetFolderPath(&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Environment.SpecialFolder.CommonApplicationData);&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt;&amp;nbsp;localMachineStore = Path.Combine(&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; commonAppData,&lt;/span&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;"Microsoft\Crypto\RSA\MachineKeys");&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (Directory.GetFiles(&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; localMachineStore, keyFileName).Length &amp;gt; 0)&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; Path.Combine(localMachineStore, keyFileName);&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/span&gt;&lt;/span&gt;&lt;span style="font-family: Courier New;"&gt;&lt;span style="font-size: small;"&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: #999999;"&gt;// try to search in the&amp;nbsp;current user&amp;nbsp;store&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;string&lt;/span&gt; currUserAppData = Environment.GetFolderPath(&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Environment.SpecialFolder.ApplicationData);&lt;/span&gt;&lt;br /&gt;&lt;span style="color: #999999;"&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // you can detect the current user SID, or&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // you can enumerate all directories within the RSA&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; // directory&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&lt;span style="font-family: Courier New;"&gt;&lt;span style="font-size: small;"&gt;&lt;span style="color: #999999;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;/span&gt;&lt;span style="font-family: Courier New;"&gt;&lt;span style="color: blue;"&gt;string&lt;/span&gt; currentUserStore = Path.Combine(&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; currUserAppData, @"Microsoft\Crypto\RSA\");&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;foreach&lt;/span&gt; (string directory &lt;span style="color: blue;"&gt;in&lt;/span&gt; Directory.GetDirectories(&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; currentUserStore))&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;if&lt;/span&gt; (Directory.GetFiles(&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; directory, keyFileName).Length &amp;gt; 0)&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; {&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;return&lt;/span&gt; Path.Combine(directory, keyFileName);&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span style="color: blue;"&gt;throw new&lt;/span&gt; ApplicationException(&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: Courier New;"&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; "The private key file does not exist");&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;&lt;span style="font-family: Courier New;"&gt;&lt;br /&gt;&lt;/span&gt;&lt;/span&gt;&lt;br /&gt;Также весьма полезной для поиска сертификата может оказаться утилита &lt;a href="http://msdn.microsoft.com/en-us/library/ms732026.aspx"&gt;Find Private Key Tool&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;Правами доступа к ключу являются права доступа к данному файлу. Чтобы разрешить определённому пользователю использовать ключ, необходимо предоставить ему право &lt;em&gt;Full Control&lt;/em&gt;.&lt;br /&gt;&lt;br /&gt;Как правило, типичным примером воспроизведения данной ошибки является следующий сценарий. Вы пишете и отлаживаете свой сервис, прекрасно работающий под аккаунтом локальной системы. Затем незадолго до релиза, вы вспоминаете о правиле минимальных привилегий и меняете аккаунт сервиса с &lt;em&gt;Local System&lt;/em&gt; на &lt;em&gt;Network Service&lt;/em&gt;. И ваш сервис перестаёт работать! Вы просто не учли тот факт, что аккаунт &lt;em&gt;Network Service&lt;/em&gt; по-умолчанию не имеет прав для доступа ни к одному приватному ключу в системе. Позаботиться о предоставлении таких прав вам придётся самостоятельно.&lt;br /&gt;&lt;br /&gt;Второй типичный сценарий связан с последующей эксплуатацией приложения. Вы вроде всё сделали правильно: своевременно позаботились о правах для доступа пользователя к приватному ключу, но приложение всё равно падает с сообщением &lt;em&gt;"Keyset does not exist"&lt;/em&gt;. Причина может крыться в следующем: отсутствие прав доступа может означать в том числе и отсутствие прав доступа к контейнеру объекта (в данном случае к каталогу, где лежит ключ). Если сертификат заимпортировать, кликнув на &lt;em&gt;pfx&lt;/em&gt; файл и пройдя через визард импорта, то он попадёт в хранилище текущего пользователя. Переместив затем его в хранилище &lt;em&gt;Local Computer&lt;/em&gt; (или хранилище того пользователя, под которым будет запускаться сервис), используя &lt;strong&gt;MMC&lt;/strong&gt;-оснастку &lt;em&gt;Сертификаты&lt;/em&gt; (&lt;em&gt;Certificates&lt;/em&gt;),&amp;nbsp;вы переместите лишь сам сертификат с публичным ключом; приватный ключ так и&amp;nbsp;останется лежать внутри&amp;nbsp;вашего хранилища, куда изначально&amp;nbsp;он&amp;nbsp;был заимпортирован. Как не сложно догадаться, даже если вы предоставите пользователю, под которым запускается сервис, все права на этот файл, доступа к нему у него не будет всё равно, поскольку у него нет доступа к каталогам, где он располагается. Поэтому вам необходимо либо позаботиться о своей собственной процедуре импорта, либо научить отдел поддержки клиентов правильному способу импорта сертификатов: выбирать конкретное хранилище через оснастку &lt;strong&gt;MMC&lt;/strong&gt;-оснастку &lt;em&gt;Сертификаты&lt;/em&gt; (&lt;em&gt;Certificates&lt;/em&gt;) и импортировать сертификат непосредственно в него.&lt;br /&gt;&lt;br /&gt;&lt;div style="text-align: right;"&gt;&lt;a href="http://mrnone.blogspot.com/2011/04/ii.html"&gt;Продолжение следует...&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='replies' type='text/html' href='http://mrnone.blogspot.com/2011/04/i.html#comment-form' title='Комментарии: 0'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5257996481379688922'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/5257996481379688922'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/i.html' title='Проблемы сертификации: Эпизод I - Потеряный ключ'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-4643690860684854069</id><published>2011-04-02T23:18:00.002+07:00</published><updated>2011-05-01T15:53:29.819+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#post'/><title type='text'>Hello, world!</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;span style="font-family: inherit;"&gt;Чтобы не быть банальным, я не стал в первом сообщении описывать, зачем мне это нужно. Я просто завёл для этого отдельную страницу: &lt;/span&gt;&lt;a href="http://mrnone.blogspot.com/p/blog-page.html"&gt;&lt;span style="font-family: inherit;"&gt;Зачем и для кого&lt;/span&gt;&lt;/a&gt;&lt;span style="font-family: inherit;"&gt;.&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: inherit;"&gt;&lt;br /&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style="font-family: inherit;"&gt;Итак&lt;/span&gt;&lt;br /&gt;&lt;span style="background-color: white; font-family: &amp;quot;Courier New&amp;quot;, Courier, monospace;"&gt;Hello, world!&lt;/span&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/4643690860684854069'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/posts/default/4643690860684854069'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/04/hello-world.html' title='Hello, world!'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.page-2160341906533816871</id><published>2011-11-14T00:11:00.000+07:00</published><updated>2011-11-14T00:11:43.624+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#page'/><title type='text'>Что почитать</title><content type='html'>&lt;div dir="ltr" style="text-align: left;" trbidi="on"&gt;&lt;script src="http://feeds.feedburner.com/MrNone/Usefulllinks?format=sigpro" type="text/javascript" &gt;&lt;/script&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/pages/default/2160341906533816871'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/pages/default/2160341906533816871'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/p/blog-page_06.html' title='Что почитать'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.page-6408953110657558233</id><published>2011-07-28T15:51:00.000+07:00</published><updated>2011-07-28T17:40:28.888+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#page'/><title type='text'>Как это работает?</title><content type='html'>&lt;script src="http://feeds.feedburner.com/howtoViaMrNoneInGoogleReader?format=sigpro" type="text/javascript"&gt;&lt;/script&gt;&lt;noscript&gt;&amp;lt;p&amp;gt;Подпишитесь на обновления RSS заголовков от: &amp;lt;a href="http://feeds.feedburner.com/howtoViaMrNoneInGoogleReader"&amp;gt;&amp;lt;/a&amp;gt;&amp;lt;br /&amp;gt; Создано FeedBurner&amp;lt;/p&amp;gt;&lt;/noscript&gt;&lt;br /&gt;&lt;br /&gt;&lt;a href="http://www.google.com/reader/shared/user%2F09784943413048395556%2Flabel%2FHowTo" imageanchor="1" target="_blank"&gt;&lt;img border="0" height="12" src="https://lh4.googleusercontent.com/-5mUUvJvnemE/TjEqhLDOb9I/AAAAAAAAAHs/ljWM21cs0LQ/s800/609622892-feed-icon-12%25255B1%25255D.png" width="12" /&gt; Подписаться на обновления&lt;/a&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/pages/default/6408953110657558233'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/pages/default/6408953110657558233'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/p/blog-page_28.html' title='Как это работает?'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author><media:thumbnail xmlns:media='http://search.yahoo.com/mrss/' url='https://lh4.googleusercontent.com/-5mUUvJvnemE/TjEqhLDOb9I/AAAAAAAAAHs/ljWM21cs0LQ/s72-c/609622892-feed-icon-12%25255B1%25255D.png' height='72' width='72'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.page-739485467688184321</id><published>2011-04-02T21:49:00.000+07:00</published><updated>2011-04-21T00:55:39.145+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#page'/><title type='text'>Зачем и для кого</title><content type='html'>&lt;div style="text-align: justify;"&gt;В процессе разработки ПО постоянно приходится решать различные технические проблемы, в срочном порядке изучать новые технологии, чтобы&amp;nbsp;применив их один раз, забыть на месяцы, а то и годы. Такова уж особенность человеческой памяти: помнить лишь то, что нужно в данный момент.&amp;nbsp;И вот когда спустя полгода вы окончательно забываете не только решение, но и саму проблему, она возникает повторно. В такие моменты я всегда ощущаю странное и неприятное чувство дежавю: я помню что это уже было, но где и когда... Раньше&amp;nbsp;я начинал судорожно искать по исходным кодам проектов и&amp;nbsp;тестовых наработок. Тогда я был молодой и зелёный, информации было мало - искать было просто.&lt;/div&gt;&lt;div style="text-align: justify;"&gt;&lt;br /&gt;&lt;/div&gt;&lt;div style="text-align: justify;"&gt;Время шло, объём информации возрастал. Чтобы сократить время поиска,&amp;nbsp;я пытался сохранять информацию в виде документов в отдельную папку у себя на диске, вёл записки в&amp;nbsp;One Note. Появление Exchange и Outlook`а упросило мою жизнь. Я стал писать письма: сначала себе, потом коллегам. Я надеялся, что коллективный разум сработает эффективнее поиска по папкам Outlook`а или каталогам диска.&lt;/div&gt;&lt;div style="text-align: justify;"&gt;&lt;br /&gt;&lt;/div&gt;&lt;div style="text-align: justify;"&gt;Но вот настал момент, когда объём информации превысил некую критическую массу, и появилась необходимость иметь доступ к ней более чем в одном месте. Находясь в командировке, мне было ничуть не легче от осознания того факта, что ответ на мучающий меня вопрос лежит в паке "My Documents" на моём домашнем компьютере. Я осознал, что пора выходить на новый уровень: локальные документы, One Note и даже почти что глобальный Exchange уже не спасали. У меня возникла потребность в глобальном хранилище информации.&lt;/div&gt;&lt;div style="text-align: justify;"&gt;&lt;br /&gt;&lt;/div&gt;&lt;div style="text-align: justify;"&gt;Так что можно сказать, что блог я завёл для себя. Но если информация, которую я планирую здесь публиковать, окажется полезной ещё кому-нибудь, мои усилия окупятся сторицей. А полезной она может оказаться любому программисту, занимающемуся разработкой для операционной системы Windows.&lt;/div&gt;&lt;div style="text-align: justify;"&gt;&lt;br /&gt;&lt;/div&gt;&lt;div style="text-align: justify;"&gt;О тематике блога несложно догадаться по названию и аннотации блога, а также по краткому описанию моих профессиональных интересов. Речь будет идти о различных технологиях, проблемах и их решениях, с которыми мне приходится сталкиваться ежедневно в моей профессиональной деятельности. Преимущественно это&amp;nbsp;системные и серверные технологии компании Microsoft, языки C++ и C#, платформа .NET и многое другое.&lt;/div&gt;&lt;br /&gt;&lt;div style="text-align: right;"&gt;&lt;br /&gt;&lt;span style="color: #666666; font-size: x-small;"&gt;Компьютер сделает всё, что вы ему скажете, но это может сильно отличаться от того, что вы имели в виду.&lt;/span&gt;&lt;/div&gt;&lt;div class="blogger-post-footer"&gt;Перепечатка материалов допустима с указанием ссылки на первоисточник.&lt;/div&gt;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/pages/default/739485467688184321'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/pages/default/739485467688184321'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/p/blog-page.html' title='Зачем и для кого'/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>akorotaeff@gmail.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1796647076748825077</id><published>2011-05-30T13:25:22.092+07:00</published><updated>2011-05-30T13:25:22.092+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Другое дело, что этот контролер может быть опущен ...</title><content type='html'>Другое дело, что этот контролер может быть опущен или не работоспособен по каким-то причинам. И придется усложнять логику.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/1796647076748825077'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/1796647076748825077'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservices.html?showComment=1306736722092#c1796647076748825077' title=''/><author><name>otto-on-pandora</name><uri>http://otto-on-pandora.livejournal.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/05/directoryservices.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-593018713968120811' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/593018713968120811' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-206538405'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7082548605003835046</id><published>2011-05-30T15:42:57.293+07:00</published><updated>2011-05-30T15:42:57.293+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Именно поэтому и предлагается использовать тот кон...</title><content type='html'>Именно поэтому и предлагается использовать тот контроллер домена, через который был осуществлён вход. С большой долей вероятности он будет жив. А вообще да, вы правы, - это всегда компромис. Либо усложняем логику и получаем шустрое приложение, либо полагаемся на стандартные механизмы и имеем простую логику, но в довесок получаем нарекания клиента.&lt;br /&gt;Пример с замерами реальный, причём результат усреднён. В пределах значения были ещё более впечетляющие: 3 и 40 секунд. С моей точки зрения - это весьма неплохой аргумент в пользу усложнения.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/7082548605003835046'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/7082548605003835046'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservices.html?showComment=1306744977293#c7082548605003835046' title=''/><author><name>Mr. None</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/05/directoryservices.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-593018713968120811' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/593018713968120811' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7240281923231203230</id><published>2011-06-06T13:38:14.849+07:00</published><updated>2011-06-06T13:38:14.849+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Это тоже не оптимально?)
this.entry = new Director...</title><content type='html'>Это тоже не оптимально?)&lt;br /&gt;this.entry = new DirectoryEntry(this.LDAPStr, this.Login, this.Pass, AuthenticationTypes.Secure);&lt;br /&gt;this.Searcher = new DirectorySearcher(entry);&lt;br /&gt;this.Searcher.Filter = Filter;&lt;br /&gt;Searcher.PropertiesToLoad.Add(&amp;quot;givenName&amp;quot;);&lt;br /&gt;Searcher.PropertiesToLoad.Add(&amp;quot;displayName&amp;quot;);&lt;br /&gt;Searcher.PropertiesToLoad.Add(&amp;quot;sn&amp;quot;);</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/8054678116893339981/comments/default/7240281923231203230'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/8054678116893339981/comments/default/7240281923231203230'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices.html?showComment=1307342294849#c7240281923231203230' title=''/><author><name>Александр</name><uri>http://www.blogger.com/profile/16074606090289742000</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/06/directoryservices.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-8054678116893339981' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/8054678116893339981' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1501901196'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-642735495246518935</id><published>2011-06-06T17:24:45.814+07:00</published><updated>2011-06-06T17:24:45.814+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Здесь с производительностью вроде всё в порядке. В...</title><content type='html'>Здесь с производительностью вроде всё в порядке. В данном случае вы используете не DirectoryEntry, а DirectorySearcher - это принципиально иной способ доступа, реализуемый другим ADSI объектом. Более того, если вы не добавите эти свойства в список ззагружаемых, то вы и не получите их значения на выходе, даже если они содержат значения в AD – DirectorySearcher не содержит никакого внутреннего кэша и ничего не подгружает дополнительно. Необходимо только помнить про предыдущий совет и правильно выбрать контроллер домена, на котором будете выполнять поиск.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/8054678116893339981/comments/default/642735495246518935'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/8054678116893339981/comments/default/642735495246518935'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices.html?showComment=1307355885814#c642735495246518935' title=''/><author><name>Mr. None</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/06/directoryservices.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-8054678116893339981' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/8054678116893339981' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7258696095183664083</id><published>2011-06-26T00:31:12.359+07:00</published><updated>2011-06-26T00:31:12.359+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Несколько офисов со связью, качество которой может...</title><content type='html'>Несколько офисов со связью, качество которой может повлиять на скорость доступа к AD, находящиеся в одном сайте - грубое нарушение принципов построения инфраструктуры AD. Так что по-моему лучше оставлять выбор контроллера по умолчанию.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/7258696095183664083'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/7258696095183664083'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservices.html?showComment=1309023072359#c7258696095183664083' title=''/><author><name>Mykhaylo Khodorev</name><uri>http://www.blogger.com/profile/01375247696901263122</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/05/directoryservices.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-593018713968120811' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/593018713968120811' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-2083672136'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7261060388452133061</id><published>2011-06-27T01:25:00.346+07:00</published><updated>2011-06-27T01:25:00.346+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Обычно это мало волнует клиента, потому что сама о...</title><content type='html'>Обычно это мало волнует клиента, потому что сама операционная система не так часто обращается к AD и проблем со скоростью он не замечает, а проблемы с производительностью будут наблюдаться именно у вашего приложения. И ваше абсолютно правильное заявление о &amp;quot;грубом нарушении принципов построения инфраструктуры&amp;quot; будет выглядеть как оправдание и обвинение его системного администратора в некомпетентности, как вы думаете, кому поверят больше? Поэтому лучше использовать то значение, которое с максимальной долей вероятности будет наиболее оптимальным, чем полагаться на некий механизм определения по-умолчанию.&lt;br /&gt;Кстати, явное указание контроллера доменов имеет под собой ещё один плюс: таким образом вы всегда будете осуществлять доступ через один и тот же сервер и не столкнётесь с проблемами репликации. Представьте себе, что первой операцией вы изменили свойство, а второй захотели его прочитать. Без явного указания контроллера доменов, ваши запросы при определнённых условиях могут пойти к разным серверам. Эффект от этого очень непредсказуемый. При решении задач автоматизации сторонних сервисов, мы в Parallels достаточно часто сталкивался с такой проблемой, чтобы навсегда расхотеть пользоваться механизмом поиска контроллера домена по умолчанию.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/7261060388452133061'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/593018713968120811/comments/default/7261060388452133061'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/05/directoryservices.html?showComment=1309112700346#c7261060388452133061' title=''/><author><name>Mr. None</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/05/directoryservices.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-593018713968120811' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/593018713968120811' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-2733359280114478520</id><published>2011-07-02T10:14:37.107+07:00</published><updated>2011-07-02T10:14:37.107+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Зачем нужна еще одна RPC? Ну ребятам из Facebook п...</title><content type='html'>Зачем нужна еще одна RPC? Ну ребятам из Facebook понадобилась легкая и подходящая им, вот и реализовали :)</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/2733359280114478520'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/2733359280114478520'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html?showComment=1309576477107#c2733359280114478520' title=''/><author><name>Vadimmer's blog</name><uri>http://www.blogger.com/profile/09668904834643121405</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/apache-thrift.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-1873272504733193060' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-2003457676'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-4333130204508317466</id><published>2011-07-05T18:56:56.437+07:00</published><updated>2011-07-05T18:56:56.437+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Назвать RPC-фреймворк &amp;quot;аналогом SOAP&amp;quot; эт...</title><content type='html'>Назвать RPC-фреймворк &amp;quot;аналогом SOAP&amp;quot; это конечно сильно.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/4333130204508317466'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/4333130204508317466'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html?showComment=1309867016437#c4333130204508317466' title=''/><author><name>nesteruk</name><uri>http://nesteruk.wordpress.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/apache-thrift.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-1873272504733193060' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1181998828'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5008294768602363586</id><published>2011-07-06T22:18:33.112+07:00</published><updated>2011-07-06T22:18:33.112+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>&amp;gt; Назвать RPC-фреймворк &amp;quot;аналогом SOAP&amp;quo...</title><content type='html'>&amp;gt; Назвать RPC-фреймворк &amp;quot;аналогом SOAP&amp;quot; это конечно сильно&lt;br /&gt;&lt;br /&gt;Хм... Что именно вам показалось странным или &amp;quot;сильным&amp;quot;? Или вы считаете, что SOAP - это не RPC?</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/5008294768602363586'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/5008294768602363586'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html?showComment=1309965513112#c5008294768602363586' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/apache-thrift.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-1873272504733193060' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-3052657704187096871</id><published>2011-07-13T13:48:09.883+07:00</published><updated>2011-07-13T13:48:09.883+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>А я вот покрутил Protobuf с Thrift&amp;#39;ом и заюзал...</title><content type='html'>А я вот покрутил Protobuf с Thrift&amp;#39;ом и заюзал BSON :) И менее формально, и схемы нет, и никаких тебе стаб-генераторов ... но так оказалось удобно в использовании, что на нём и остался.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/3052657704187096871'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/3052657704187096871'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html?showComment=1310539689883#c3052657704187096871' title=''/><author><name>Buran</name><uri>http://www.blogger.com/profile/06706565293093644403</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/apache-thrift.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-1873272504733193060' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-2041704534'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-3287537380233815432</id><published>2011-07-14T09:49:26.486+07:00</published><updated>2011-07-14T09:49:26.486+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Так в наличие схемы и сгенерированных стабов и зак...</title><content type='html'>Так в наличие схемы и сгенерированных стабов и заключаются все плюшки Protobuf`а (как я уже сказал, зачем нужен Thrift, я не понимаю :-) ). Вот как вы будете описывать синтаксис своего протокола, чтобы передать его другому участнику разработки или вообще 3-ей стороне? В Word`е? А как добьётесь гарантий, что это описание актуально? А тут всё в одном флаконе - idl ровно для этих целей в своё время и придумали.&lt;br /&gt;&lt;br /&gt;В любом случае спасибо за инфу: надо будет тоже покрутить. Кстати, ссылку не дадите какой именно реализацией вы пользуетесь? Я именно BSON к стыду своему ещё ни разу не пробовал :-)</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/3287537380233815432'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/1873272504733193060/comments/default/3287537380233815432'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/apache-thrift.html?showComment=1310611766486#c3287537380233815432' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/apache-thrift.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-1873272504733193060' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/1873272504733193060' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1652997663134637977</id><published>2011-07-16T10:32:40.458+07:00</published><updated>2011-07-16T10:32:40.458+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>А можно формат поуниверсальней? А то среди нас, ст...</title><content type='html'>А можно формат поуниверсальней? А то среди нас, студентов, есть и линуксоиды тоже... :)</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/1652997663134637977'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/1652997663134637977'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html?showComment=1310787160458#c1652997663134637977' title=''/><author><name>h-sphingidae</name><uri>http://h-sphingidae.livejournal.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/blog-post.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2917122871198736080' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-66098454'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-2910947736046131364</id><published>2011-07-16T10:34:46.210+07:00</published><updated>2011-07-16T10:34:46.210+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>(например, pdf)</title><content type='html'>(например, pdf)</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/2910947736046131364'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/2910947736046131364'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html?showComment=1310787286210#c2910947736046131364' title=''/><author><name>h-sphingidae</name><uri>http://h-sphingidae.livejournal.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/blog-post.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2917122871198736080' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-66098454'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-8903414550302664993</id><published>2011-07-16T13:49:44.675+07:00</published><updated>2011-07-16T13:49:44.675+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Попробую сконвертировать, если получится, то вылож...</title><content type='html'>Попробую сконвертировать, если получится, то выложу здесь же и свистну в твитер и здесь в комментариях, как будет готово. Просто презентация была готова имено в PowerPoint&amp;#39;е.Попробую сконвертировать, если получится, то выложу здесь же и свистну в твитер и здесь в комментариях, как будет готово. Просто презентация была готова имено в PowerPoint&amp;#39;е.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/8903414550302664993'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/8903414550302664993'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html?showComment=1310798984675#c8903414550302664993' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/blog-post.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2917122871198736080' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-8621374026644444256</id><published>2011-07-16T14:12:00.800+07:00</published><updated>2011-07-16T14:12:00.800+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Ха, всё оказалось не так страшно: PowerPoint умеет...</title><content type='html'>Ха, всё оказалось не так страшно: PowerPoint умеет легко конвертировать в PDF. Так что ловите: поправил заметку - ссылка там. Удачи.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/8621374026644444256'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/8621374026644444256'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html?showComment=1310800320800#c8621374026644444256' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/blog-post.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2917122871198736080' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-104702962036709509</id><published>2011-07-16T17:21:41.599+07:00</published><updated>2011-07-16T17:21:41.599+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Ой, такое вам спасибо, вы не представляете какое. ...</title><content type='html'>Ой, такое вам спасибо, вы не представляете какое. :)))</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/104702962036709509'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2917122871198736080/comments/default/104702962036709509'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/07/blog-post.html?showComment=1310811701599#c104702962036709509' title=''/><author><name>h-sphingidae</name><uri>http://h-sphingidae.livejournal.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/07/blog-post.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2917122871198736080' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2917122871198736080' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-66098454'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-8775759474889556557</id><published>2011-08-19T19:04:09.099+07:00</published><updated>2011-08-19T19:04:09.099+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Если pagesize &amp;lt; 1000, а запрос выбирает записей...</title><content type='html'>Если pagesize &amp;lt; 1000, а запрос выбирает записей больше, чем на 1 страницу, то &lt;br /&gt;paging.Cookie.Length было 0 не смотря на это, пока не дописала:&lt;br /&gt;var searchOptions = new SearchOptionsControl(SearchOption.DomainScope);&lt;br /&gt;    request.Controls.Add(searchOptions);</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/8775759474889556557'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/8775759474889556557'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html?showComment=1313755449099#c8775759474889556557' title=''/><author><name>O</name><uri>http://www.blogger.com/profile/14826635849882048281</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-277763288564627600' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/277763288564627600' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-67827453'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-4618301655841833081</id><published>2011-08-22T11:34:23.162+07:00</published><updated>2011-08-22T11:34:23.162+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Я извиняюсь за задержку с ответом: я был вне досяг...</title><content type='html'>Я извиняюсь за задержку с ответом: я был вне досягаемости интернета последнии 3 дня.&lt;br /&gt;&lt;br /&gt;А контекст поиска у вас при этом был глобальный (DN=neverhood,DN=local)? Бьюсь об заклад, что так и было :). В этом случае сработал механизм следования за рефералами, и вам вернулись результаты в том числе и из подчинённых контекстов, например: схема и конфигурация.&lt;br /&gt;&lt;br /&gt;Вот тут возникает одно интересное НО: постарничный поиск и обработка рефералов на стороне сервера не совместимые вещи в рамках Active Directory. Этим и объясняется ваш результат: вам вернулось по одной странице от нескольких контекстов, после чего поиск был прерван.&lt;br /&gt;&lt;br /&gt;Применив опцию поиска DomainScope, вы запретили обрабатывать рефералы и тем самым вернули постраничный поиск в норму. Вот и всё - никакой магии :).&lt;br /&gt;&lt;br /&gt;Вобщем это скользкий путь, про рефералы я планировал написать отдельно.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/4618301655841833081'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/4618301655841833081'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html?showComment=1313987663162#c4618301655841833081' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-277763288564627600' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/277763288564627600' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-8305108298827793947</id><published>2011-08-22T11:53:14.747+07:00</published><updated>2011-08-22T11:53:14.747+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Кстати, есть альтернативный и более гибкий способ ...</title><content type='html'>Кстати, есть альтернативный и более гибкий способ управления рефералами. Использование SearchOption.DomainScope позволяет только включать и выключать обработку рефералов и только для операций поиска. Но вы можете воспользоваться опцией следования за рефералами на уровне всей LDAP сессии: LdapConnection.SessionOptions.ReferralChasing. Эта опция принимает аж 4 значения: None, All, Subordinate и External. Аналогом использования SearchOption.DomainScope будет использования значения None для ReferralChasing. Вы можете использовать и другие опции, но имейте в виду, что AD не поддерживает подчинённых рефералов (Subordinate) при постраничном поиске. Но при этом поддерживает внешних - вот такой он странный зверёк :).</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/8305108298827793947'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/8305108298827793947'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html?showComment=1313988794747#c8305108298827793947' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-277763288564627600' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/277763288564627600' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-3722823241297724624</id><published>2011-08-25T19:04:42.591+07:00</published><updated>2011-08-25T19:04:42.591+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Вы подняли совсем неизведанную мной тему :) Это оч...</title><content type='html'>Вы подняли совсем неизведанную мной тему :) Это очень интересно, особенно учитывая то, что мне еще предстоит реализовать поиск по 2-м доменам.&lt;br /&gt;Комментарий написала, т.к. встречала подобные моей проблемы в разных топиках без ответа, но честно говоря, без глубокого понимания, почему так. Спасибо за разъяснения и буду ждать темы про рефералы.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/3722823241297724624'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/277763288564627600/comments/default/3722823241297724624'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html?showComment=1314273882591#c3722823241297724624' title=''/><author><name>O</name><uri>http://www.blogger.com/profile/14826635849882048281</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/06/directoryservices_22.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-277763288564627600' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/277763288564627600' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-67827453'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-583967157252305924</id><published>2011-09-04T00:22:30.216+07:00</published><updated>2011-09-04T00:22:30.216+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>самое интересное в законе Амдала – зависимость мак...</title><content type='html'>самое интересное в законе Амдала – зависимость максимального прироста производительности для задач с некоторым известным значением нераспараллеливаемой части вычислительного процесса от увеличения числа процессоров. Например, для задачи, всего 40% кода которой (α = 0,4) не допускает распараллеливания, картина выглядит, мягко говоря, не многообещающей - http://skynin.blogspot.com/2009/12/blog-post_8299.html</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/743359487197980193/comments/default/583967157252305924'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/743359487197980193/comments/default/583967157252305924'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post.html?showComment=1315070550216#c583967157252305924' title=''/><author><name>Skynin</name><uri>http://www.blogger.com/profile/17691734889443418349</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='31' src='http://1.bp.blogspot.com/_TGrx9qoSu7M/SuahYW770oI/AAAAAAAABUI/ehqeCCpWzfc/S220/barv2.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/09/blog-post.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-743359487197980193' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/743359487197980193' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1369361952'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-3112306453912865863</id><published>2011-09-14T14:16:08.060+07:00</published><updated>2011-09-14T14:16:08.060+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>А если 4 ядра или 64?</title><content type='html'>А если 4 ядра или 64?</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/3112306453912865863'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/3112306453912865863'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html?showComment=1315984568060#c3112306453912865863' title=''/><author><name>otto-on-pandora</name><uri>http://otto-on-pandora.livejournal.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/09/blog-post_14.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-284730263263096821' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-206538405'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-7494453135123620132</id><published>2011-09-14T14:53:23.164+07:00</published><updated>2011-09-14T14:53:23.164+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Ну если я не ошибаюсь, то Windows не поддерживает ...</title><content type='html'>Ну если я не ошибаюсь, то Windows не поддерживает 64 ядра вообще (по крайней мере 32-ух разрядная), максимум 32 ;-). Но если вынести за скобки это ограничение, то можно создавать, например, по одному counter-агенту на каждую строку (AAL имеет внутренний пул и сама прекрасно позаботится о правильно выделении потоков), тогда удасться загрузить все ядра. Я не стал излишне усложнять пример.&lt;br /&gt;&lt;br /&gt;Опять же, если приложение само по себе содержит много разных агентов (много задач, выполняемых одновременно), то все ядра загрузятся сами по себе без специальных ухищрений. Просто конкретно в данном случае задачи ровно 2 :-). А, например, в случае компьютерной игры (;-)) хороший кандидат на то, чтобы быть агентом - это любой NPC :-).&lt;br /&gt;&lt;br /&gt;Главный посыл в том, что асинхронные агенты позволяют достаточно легко реализовать многопоточное масштабируемое приложение и организовать хранение и передачу состояния между потоками. При этом вы вообще не заморачиваетесь с многопоточностью как таковой.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/7494453135123620132'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/7494453135123620132'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html?showComment=1315986803164#c7494453135123620132' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/09/blog-post_14.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-284730263263096821' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-6110124533806714373</id><published>2011-09-14T15:07:16.135+07:00</published><updated>2011-09-14T15:07:16.135+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Вот на этом примере как раз выглядит достаточно сл...</title><content type='html'>Вот на этом примере как раз выглядит достаточно сложно в плане масштабируемости той же самой задачи.&lt;br /&gt;&lt;br /&gt;Обобщенных средств нет для реализации  параллелизма, все делается от конкретной задачи. Агенты красиво выглядят на синтетических задачах с точки зрения ООА/ООП, но имеют недостатки.&lt;br /&gt;&lt;br /&gt;Как нетрудно увидеть, функциональный подход (PLINQ) выглядит более естественно, оперирует абстракциями высокого уровня и самое главное он масштабируемый, даже на такой синтетической задаче выше:&lt;br /&gt;&lt;br /&gt;var lines = File.ReadLines(&amp;quot;bigtest.txt&amp;quot;).AsParallel();&lt;br /&gt;var counts = lines.SelectMany(line =&amp;gt; line.Split(new char[] { &amp;#39; &amp;#39; }))&lt;br /&gt;    .GroupBy(word =&amp;gt; word)&lt;br /&gt;    .SelectMany(group =&amp;gt; new[] { new KeyValuePair(group.Key, group.Count()) });&lt;br /&gt;&lt;br /&gt;Данный код масштабируется на большее кол-во ядер/процессоров чем два. Опять же - это решение практически в лоб, там можно еще всякого навернуть.&lt;br /&gt;&lt;br /&gt;Еще есть трудности отладки агентов (когда их много).</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/6110124533806714373'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/6110124533806714373'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html?showComment=1315987636135#c6110124533806714373' title=''/><author><name>otto-on-pandora</name><uri>http://otto-on-pandora.livejournal.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/09/blog-post_14.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-284730263263096821' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-206538405'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-251410259647665264</id><published>2011-09-14T15:28:35.322+07:00</published><updated>2011-09-14T15:28:35.322+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Как вы правильно заметили, любое средство параллел...</title><content type='html'>Как вы правильно заметили, любое средство параллелизма имеет свои недостатки и достоинства. И функциональный подход совсем не панацея. Если говорить именно за эффективную масштабируемость данного примера, то тут вообще всё легко решается с помощью одного цикла и старого доброго task-based подхода (см. предыдущий пост). А пример с LINQ такой же синтетический в данном случае, как и мой, потому что он именно это и делает - обходит циклом файл и на каждую строку ставит задачу.&lt;br /&gt;&lt;br /&gt;Мне нужен был достаточно наглядный и простой пример, для демонстрации того, что же такое асинхронные агенты и как они могут взаимодействовать. Я не случайно в самом начале подчеркнул, что главная выгода агентов именно во взаимодействии друг с другом, реализовать которое гораздо проще, как ни крути (вот как вы сделаете многопоточный обсчёт персонажей компьютерной игры в функциональном стиле или с помощью LINQ, особенно если они взаимодействуют друг с другом). Если же делать агенты достаточно атомарными, реализующими некоторую простую задачу, то вы получите и масштабируемость просто за счёт того, что их много.&lt;br /&gt;&lt;br /&gt;Священную войну про отладку лучше вообще не начинать ;-), ибо просто отлаживать только однопоточное приложение. Но у агентов в этом плане есть один неоспаримый плюс: за счёт своей атомарности и замкнутости они легко покрываются unit-тестами. Опять же отладить один агент в однопоточном окружении в контексте тестового приложения можно и сделать это достаточно просто.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/251410259647665264'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/251410259647665264'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html?showComment=1315988915322#c251410259647665264' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/09/blog-post_14.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-284730263263096821' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5922928647181317585</id><published>2011-09-14T15:34:44.035+07:00</published><updated>2011-09-14T15:34:44.035+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>А вообще у меня предложение. Если у вас есть, что ...</title><content type='html'>А вообще у меня предложение. Если у вас есть, что сказать интересного на эту тему, давайте вы где-нибудь напишете и опубликуете свои мысли, а я дам у себя ссылку. Это будет конструктивнее и полезнее, для читающего сообщества, чем вести священные войны на тему кто круче: ООП или функциональщина ;-).</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/5922928647181317585'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/284730263263096821/comments/default/5922928647181317585'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/09/blog-post_14.html?showComment=1315989284035#c5922928647181317585' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://1.bp.blogspot.com/-6MvfG-vgdZ4/Tb7ELKyoLBI/AAAAAAAAADg/17b04AhouFg/s220/avatar-Alesha-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/09/blog-post_14.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-284730263263096821' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/284730263263096821' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-2749474779841040918</id><published>2011-11-01T22:56:44.282+07:00</published><updated>2011-11-01T22:56:44.282+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>И все таки, при всем моем уважении к &amp;quot;плюсам&amp;...</title><content type='html'>И все таки, при всем моем уважении к &amp;quot;плюсам&amp;quot;, ООП в них явно страдает. Я еще я совсем не понимаю зачем везде префиксы пространств имен - в .Net так не делают, просто делают using, в С++ это наверное using namespace xyz;</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/493042754671777293/comments/default/2749474779841040918'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/493042754671777293/comments/default/2749474779841040918'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/10/data-flow_24.html?showComment=1320163004282#c2749474779841040918' title=''/><author><name>nesteruk</name><uri>http://nesteruk.wordpress.com/</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img1.blogblog.com/img/openid16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/10/data-flow_24.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-493042754671777293' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/493042754671777293' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1181998828'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-1671943293293280422</id><published>2011-12-12T19:55:15.065+07:00</published><updated>2011-12-12T19:55:15.065+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>хорошее описание.
небольшое уточнение - а какой сл...</title><content type='html'>хорошее описание.&lt;br /&gt;небольшое уточнение - а какой случай ты имеешь ввиду под &amp;quot;не хватит памяти&amp;quot;? &lt;br /&gt;такое может случиться, если, например, делаем &amp;quot;в лоб&amp;quot; и в память не влезет полный набор уникальных слов (+ счетчик и специфичные для коллекции накладные расходы), но как тогда та же мастер машина сможет скопить все пары вида {Hello, (1, 1)}?</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2652208706618021890/comments/default/1671943293293280422'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2652208706618021890/comments/default/1671943293293280422'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/12/mapreduce.html?showComment=1323694515065#c1671943293293280422' title=''/><author><name>Никита</name><uri>http://www.blogger.com/profile/11833135556978350444</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/12/mapreduce.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2652208706618021890' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2652208706618021890' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-501660701'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-5622115720058726345</id><published>2011-12-12T23:36:34.719+07:00</published><updated>2011-12-12T23:36:34.719+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Она будет накапливать результат, одновременно сорт...</title><content type='html'>Она будет накапливать результат, одновременно сортируя его по ключу, пока хватит памяти. Зате сбросит текущее состояние в файл и начнет накапливать очередную порцию. В результате получим множество отсортированных файлов с ответами. Выбрать для определенного ключа все ответы из всех ОТСОРТИРОВАННЫХ файлов не составляет труда (предполагаем, что список ответов для одного ключа влезает в память :) ). Далее все очевидно и не так мрачно.&lt;br /&gt;Все попытки оптимизировать аналогичным образом решение &amp;quot;в лоб&amp;quot; (с хэш таблицей) приведут вас в конце концов к тому или иному аналогу MapReduce :).</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2652208706618021890/comments/default/5622115720058726345'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2652208706618021890/comments/default/5622115720058726345'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/12/mapreduce.html?showComment=1323707794719#c5622115720058726345' title=''/><author><name>Алексей Коротаев</name><uri>http://www.blogger.com/profile/07894235073825323676</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='32' height='32' src='http://4.bp.blogspot.com/-E_-syarL5HA/Tsky-tbKkKI/AAAAAAAAAJ8/2-Sq7FOJ-mU/s220/Mr.None-180x180.png'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/12/mapreduce.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2652208706618021890' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2652208706618021890' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-1693789961'/></entry><entry><id>tag:blogger.com,1999:blog-5426686223573941509.post-9200602537695697462</id><published>2011-12-13T05:42:35.002+07:00</published><updated>2011-12-13T05:42:35.002+07:00</updated><category scheme='http://schemas.google.com/g/2005#kind' term='http://schemas.google.com/blogger/2008/kind#comment'/><title type='text'>Под решением &amp;#39;в лоб&amp;#39; я понимал простое нак...</title><content type='html'>Под решением &amp;#39;в лоб&amp;#39; я понимал простое накопление, без сброса на диск. Обрати внимание, что описанное тобой решение применимо и в случае с тупым индексирующим алгоритмом, который точно так же может сортировать, сбрасывать и выгребать в итоге. Обрати также внимание, что в худшем случае, при достаточной уникальности слов, память будет заполняться в основном парами вида (слово, 1), причем в обоих алгоритмах, а в лучшем, при маленьком словаре, оба алгоритма избегут сброса.</content><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2652208706618021890/comments/default/9200602537695697462'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5426686223573941509/2652208706618021890/comments/default/9200602537695697462'/><link rel='alternate' type='text/html' href='http://mrnone.blogspot.com/2011/12/mapreduce.html?showComment=1323729755002#c9200602537695697462' title=''/><author><name>Никита</name><uri>http://www.blogger.com/profile/11833135556978350444</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='http://img2.blogblog.com/img/b16-rounded.gif'/></author><thr:in-reply-to href='http://mrnone.blogspot.com/2011/12/mapreduce.html' ref='tag:blogger.com,1999:blog-5426686223573941509.post-2652208706618021890' source='http://www.blogger.com/feeds/5426686223573941509/posts/default/2652208706618021890' type='text/html'/><gd:extendedProperty name='blogger.itemClass' value='pid-501660701'/></entry></feed>